---
title: "Rustç¨‹åºè®¾è®¡è¯­è¨€"
date: 2024-09-16
author: liwener
---
### å‰è¨€
æœ¬æ–‡æ˜¯æˆ‘åœ¨é˜…è¯»[Rustè¯­è¨€åœ£ç»](https://kaisery.github.io/trpl-zh-cn/)è¿‡ç¨‹ä¸­çš„ä¸€äº›æ€»ç»“ï¼Œä¾§é‡ç‚¹åœ¨äºå¯¹æ¯”Rustå’ŒC++çš„è¯­è¨€ç‰¹æ€§ï¼š
> æ ‡æ³¨ğŸ§ä»£è¡¨ç›¸æ¯”äºC/C++ï¼Œrustçš„æ¯”è¾ƒæ˜æ˜¾çš„ä¸åŒä¹‹å¤„ã€‚  
>
> æ ‡æ³¨ğŸ¤”ä»£è¡¨æˆ‘è‡ªå·±æ¢ç´¢çš„ä¸€äº›å‘
>
> æ ‡æ³¨â—ä»£è¡¨unsafeç›¸å…³çš„ç‰¹æ€§

### Cargoå…¥é—¨

```shell
cargo new <project name>  // äºŒè¿›åˆ¶crate
cargo new --lib <project name> // åº“crate
```

è¯¥å‘½ä»¤ç”Ÿæˆçš„é¡¹ç›®ç›®å½•ç»“æ„ï¼š  
src æºä»£ç ç›®å½•  
Cargo.toml è®°å½•é¡¹ç›®åŒ…ä¾èµ–  
.gitignore  

#### æ„å»ºcargoé¡¹ç›®

```shell
cargo build             // debugæ¨¡å¼
cargo build âˆ’âˆ’release   // releaseæ¨¡å¼ï¼Œé€Ÿåº¦æ›´å¿«
```

è¯¥å‘½ä»¤é¢å¤–ç”Ÿæˆçš„æ–‡ä»¶å’Œç›®å½•ï¼š  
target  ç›®æ ‡æ–‡ä»¶ç›®å½•  
Cargo.lock è®°å½•ä¾èµ–åŒ…ç‰ˆæœ¬ï¼Œç¡®ä¿å¯é‡ç°æ„å»º  

#### æ„å»ºå¹¶è¿è¡Œcargoé¡¹ç›®

```shell
cargo run
```

#### æ£€æŸ¥cargoé¡¹ç›®æ˜¯å¦æœ‰ç¼–è¯‘é”™è¯¯ï¼Œä¸ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

```shell
cargo check
```

### å˜é‡å’Œå¯å˜æ€§

#### å˜é‡

ğŸ§rustä¸­å˜é‡ä½¿ç”¨*let*å…³é”®å­—åˆ›å»ºï¼Œé»˜è®¤æ˜¯ä¸å¯å˜çš„ï¼ˆimmutableï¼‰ã€‚è‹¥å¸Œæœ›åˆ›å»ºå¯å˜å˜é‡ï¼Œéœ€æ·»åŠ *mut*å…³é”®å­—ã€‚

```rust
let mut x = 5;
println!("The value of x is: {x}");
x = 6;
println!("The value of x is: {x}");
_____________________________________
The value of x is: 5
The value of x is: 6
```

#### å¸¸é‡

rustä¸­å¸¸é‡ä½¿ç”¨*const*å…³é”®å­—åˆ›å»ºï¼Œ**å¿…é¡»æ³¨æ˜å€¼çš„ç±»å‹**ï¼Œå¿…é¡»èµ‹å€¼ï¼Œä¸€å®šæ˜¯ä¸å¯å˜çš„ï¼Œæ— æ³•æ·»åŠ *mut*å…³é”®å­—ã€‚  

```rust
const THREE_HOURS_IN_SECONDS: u32 = 60 * 60 * 3;
```

#### éšè— shadowingğŸ§

åœ¨rustä¸­ï¼Œé‡æ–°å¯¹åŒåå˜é‡è¿›è¡Œé‡å¤å£°æ˜ï¼Œæ–°å£°æ˜çš„å˜é‡ä¼šè¦†ç›–æ—§å˜é‡ï¼Œç§°ä¸ºéšè—ï¼ˆshadowingï¼‰ã€‚å¯ä»¥å¯¹åŒä¸€ä¸ªå˜é‡éšè—å¤šæ¬¡ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ä¸åŒç±»å‹è¿›è¡Œéšè—ã€‚éœ€è¦æ³¨æ„éšè—æ˜¯æœ‰ä½œç”¨åŸŸçš„ã€‚    

```rust
fn main() {
    let x = 5;
    let x = x + 1;
    {
        let x = x * 2;
        println!("The value of x in the inner scope is: {x}");
    }
    println!("The value of x is: {x}");
}
________________________________________________________________________
The value of x in the inner scope is: 12
The value of x is: 6
```

éšè—å’Œmutçš„åŒºåˆ«ï¼š  

```rust
// éšè—: å¯é€šè¿‡ç¼–è¯‘
let spaces = "   ";           // stringç±»å‹
let spaces = spaces.len();    // usizeç±»å‹

// mut: ç¼–è¯‘é”™è¯¯
let mut spaces = "   ";
let spaces = spaces.len();
```

### æ•°æ®ç±»å‹  

rustçš„æ•°æ®ç±»å‹åˆ†ä¸ºä¸¤ç±»ï¼šæ ‡é‡ï¼ˆscalarï¼‰å’Œå¤åˆï¼ˆcompoundï¼‰ã€‚  

#### æ ‡é‡ç±»å‹  

å››ç§åŸºæœ¬æ ‡é‡ç±»å‹ï¼šæ•´å‹ã€æµ®ç‚¹å‹ã€å¸ƒå°”ç±»å‹å’Œå­—ç¬¦ç±»å‹ã€‚

- **æ•´å‹**  
  i32æ˜¯æ•´å‹æ•°å­—é»˜è®¤ç±»å‹  

<table>
    <tr>
        <td>é•¿åº¦</td> <td>æœ‰ç¬¦å·</td> <td>æ— ç¬¦å·</td>
    </tr>
     <tr>
        <td>8-bit</td> <td>i8</td> <td>u8</td>
    </tr>
     <tr>
        <td>16-bit</td> <td>i16</td> <td>u16</td>
    </tr>
     <tr>
        <td>32-bit</td> <td>i32</td> <td>u32</td>
    </tr>
     <tr>
        <td>64-bit</td> <td>i64</td> <td>u64</td>
    </tr>
    <tr>
        <td>128-bit</td> <td>i128</td> <td>u128</td>
    </tr>
    <tr>
        <td>arch</td> <td>isize</td> <td>usize</td>
    </tr>
</table>  


<table>
<tr>
     <td>Decimal (åè¿›åˆ¶)</td>    <td>98_222</td>
</tr>
<tr>
 <td>Hex (åå…­è¿›åˆ¶)</td>    <td>0xff</td>
</tr>
<tr>
 <td>Octal (å…«è¿›åˆ¶)</td>	    <td>0o77</td>
</tr>
<tr>
 <td>Binary (äºŒè¿›åˆ¶)</td>    <td>0b1111_0000</td>
</tr>
<tr>
 <td>Byte (å•å­—èŠ‚å­—ç¬¦)(ä»…é™äºu8)</td>	 <td>b'A'</td>
</tr>
</table>

> æ•°å­—å­—é¢é‡å¯ä»¥æ·»åŠ ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰åˆ†å‰²æ–¹ä¾¿é˜…è¯»ï¼Œå¦‚1000_0000ç­‰åŒäº10000000  

- **æµ®ç‚¹å‹**  
  IEEE-754æ ‡å‡†ï¼Œf32å’Œf64ï¼Œé»˜è®¤ä¸ºf64ã€‚

- **å¸ƒå°”å‹**  
  boolç±»å‹å¤§å°ä¸º1ä¸ªå­—èŠ‚ã€‚

- **å­—ç¬¦å‹**  
  ğŸ§charç±»å‹å¤§å°ä¸º4ä¸ªå­—èŠ‚ï¼Œä»£è¡¨ä¸€ä¸ªUnicodeæ ‡é‡å€¼ã€‚

```rust
let c = 'z';
let z: char = 'â„¤'; // with explicit type annotation
let heart_eyed_cat = 'ğŸ˜»';
```

#### å¤åˆç±»å‹  

å¤åˆç±»å‹å¯ä»¥å°†å¤šä¸ªå€¼ç»„åˆæˆä¸€ä¸ªç±»å‹ã€‚rustæœ‰ä¸¤ä¸ªåŸç”Ÿçš„å¤åˆç±»å‹ï¼šå…ƒç»„ï¼ˆtupleï¼‰å’Œæ•°ç»„ï¼ˆarrayï¼‰ã€‚

- **å…ƒç»„ç±»å‹**  
  å…ƒç»„æ˜¯ä¸€ä¸ªå°†å¤šä¸ªå…¶ä»–ç±»å‹çš„å€¼ç»„åˆè¿›ä¸€ä¸ªå¤åˆç±»å‹çš„ä¸»è¦æ–¹å¼ã€‚å…ƒç»„é•¿åº¦å›ºå®šï¼Œä¸€æ—¦å£°æ˜ï¼Œå…¶é•¿åº¦ä¸ä¼šå¢å¤§æˆ–ç¼©å°ã€‚

```rust
let tup: (i32, f64, u8) = (500, 6.4, 1);
```

ä¸ºäº†ä»å…ƒç»„ä¸­è·å–å•ä¸ªå€¼ï¼Œå¯ä»¥ä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼ˆpattern matchingï¼‰æ¥è§£æ„ï¼ˆdestructureï¼‰å…ƒç»„å€¼ï¼š

```rust
let tup = (500, 6.4, 1);
let (x, y, z) = tup;
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç‚¹å·ï¼ˆ.ï¼‰åè·Ÿå€¼çš„ç´¢å¼•æ¥ç›´æ¥è®¿é—®å®ƒä»¬ã€‚ä¾‹å¦‚ï¼š

```rust
let x: (i32, f64, u8) = (500, 6.4, 1);
let five_hundred = x.0;
let six_point_four = x.1;
let one = x.2;
```

ğŸ§ä¸å¸¦ä»»ä½•å€¼çš„å…ƒç»„æœ‰ä¸ªç‰¹æ®Šçš„åç§°ï¼Œå«åš**å•å…ƒï¼ˆunitï¼‰å…ƒç»„**ã€‚è¿™ç§å€¼ä»¥åŠå¯¹åº”çš„ç±»å‹éƒ½å†™ä½œ `()`ï¼Œè¡¨ç¤ºç©ºå€¼æˆ–ç©ºçš„è¿”å›ç±»å‹ã€‚**å¦‚æœè¡¨è¾¾å¼ä¸è¿”å›ä»»ä½•å…¶ä»–å€¼ï¼Œåˆ™ä¼šéšå¼è¿”å›å•å…ƒå€¼**ã€‚

- **æ•°ç»„ç±»å‹**  
  ä¸å…ƒç»„ä¸åŒï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ çš„ç±»å‹å¿…é¡»ç›¸åŒã€‚Rustä¸­çš„æ•°ç»„é•¿åº¦æ˜¯å›ºå®šçš„ã€‚

```rust
let a = [1, 2, 3, 4, 5];
```

å¯ä»¥åƒè¿™æ ·ç¼–å†™æ•°ç»„çš„ç±»å‹ï¼šåœ¨æ–¹æ‹¬å·ä¸­åŒ…å«æ¯ä¸ªå…ƒç´ çš„ç±»å‹ï¼Œåè·Ÿåˆ†å·ï¼Œå†åè·Ÿæ•°ç»„å…ƒç´ çš„æ•°é‡ï¼š

```rust
let a: [i32; 5] = [1, 2, 3, 4, 5];
```

å¯ä»¥é€šè¿‡åœ¨æ–¹æ‹¬å·ä¸­æŒ‡å®šåˆå§‹å€¼åŠ åˆ†å·å†åŠ å…ƒç´ ä¸ªæ•°çš„æ–¹å¼æ¥åˆ›å»ºä¸€ä¸ªæ¯ä¸ªå…ƒç´ éƒ½ä¸ºç›¸åŒå€¼çš„æ•°ç»„ï¼š

```rust
let a = [3; 5]; // [3, 3, 3, 3, 3]
```

è®¿é—®æ•°ç»„å…ƒç´ ï¼š

```rust
let a = [1, 2, 3, 4, 5];

let first = a[0];
let second = a[1];
```

ğŸ§åœ¨æ•°ç»„ä¸­è¶Šç•Œè®¿é—®å…ƒç´ ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªè¿è¡Œæ—¶é”™è¯¯ï¼Œç¨‹åºç«‹å³åœ¨é”™è¯¯å¤„é€€å‡ºã€‚åœ¨Rustä¸­ï¼Œè¿™ç§æƒ…å†µç§°ä¸º*panic*ï¼ŒæŒ‡ç¨‹åºå› ä¸ºé”™è¯¯è€Œé€€å‡ºçš„æƒ…å†µã€‚  

### å‡½æ•°

åœ¨ Rust ä¸­é€šè¿‡è¾“å…¥ `fn` åé¢è·Ÿç€å‡½æ•°åå’Œä¸€å¯¹åœ†æ‹¬å·æ¥å®šä¹‰å‡½æ•°ã€‚  
Rust ä¸å…³å¿ƒå‡½æ•°å®šä¹‰æ‰€åœ¨çš„ä½ç½®ï¼Œåªè¦å‡½æ•°è¢«è°ƒç”¨æ—¶å‡ºç°åœ¨è°ƒç”¨ä¹‹å¤„å¯è§çš„ä½œç”¨åŸŸå†…å°±è¡Œã€‚  

#### å‚æ•°  

ğŸ§åœ¨å‡½æ•°ç­¾åä¸­ï¼Œ**å¿…é¡»** å£°æ˜æ¯ä¸ªå‚æ•°çš„ç±»å‹ã€‚è¿™æ˜¯ Rust è®¾è®¡ä¸­ä¸€ä¸ªç»è¿‡æ…é‡è€ƒè™‘çš„å†³å®šï¼šè¦æ±‚åœ¨å‡½æ•°å®šä¹‰ä¸­æä¾›ç±»å‹æ³¨è§£ã€‚  

```rust
fn main() {
    print_labeled_measurement(5, 'h');
}

fn print_labeled_measurement(value: i32, unit_label: char) {
    println!("The measurement is: {value}{unit_label}");
}
```

#### è¯­å¥å’Œè¡¨è¾¾å¼

ğŸ§Rust æ˜¯ä¸€é—¨åŸºäºè¡¨è¾¾å¼ï¼ˆexpression-basedï¼‰çš„è¯­è¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦ç†è§£çš„ä¸åŒäºå…¶ä»–è¯­è¨€çš„é‡è¦åŒºåˆ«ã€‚   
**è¯­å¥**ï¼ˆ*Statements*ï¼‰æ˜¯æ‰§è¡Œä¸€äº›æ“ä½œä½†ä¸è¿”å›å€¼çš„æŒ‡ä»¤ã€‚ **è¡¨è¾¾å¼**ï¼ˆ*Expressions*ï¼‰è®¡ç®—å¹¶äº§ç”Ÿä¸€ä¸ªå€¼ã€‚  

```rust
fn main() {
    let x = (let y = 6);
}
_________________________________
compile error!
```

ğŸ§`let y = 6` è¯­å¥å¹¶ä¸è¿”å›å€¼ï¼Œæ‰€ä»¥æ²¡æœ‰å¯ä»¥ç»‘å®šåˆ° `x` ä¸Šçš„å€¼ã€‚è¿™ä¸å…¶ä»–è¯­è¨€ä¸åŒï¼Œä¾‹å¦‚ C å’Œ Rubyï¼Œå®ƒä»¬çš„èµ‹å€¼è¯­å¥ä¼šè¿”å›æ‰€èµ‹çš„å€¼ã€‚åœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œå¯ä»¥è¿™ä¹ˆå†™ `x = y = 6`ï¼Œè¿™æ · `x` å’Œ `y` çš„å€¼éƒ½æ˜¯ `6`ï¼›Rust ä¸­ä¸èƒ½è¿™æ ·å†™ã€‚  

```rust
fn main() {
    let y = {
        let x = 3;
        x + 1
    };

    println!("The value of y is: {y}");
}
```

>ğŸ§æ³¨æ„ `x+1` è¿™ä¸€è¡Œåœ¨ç»“å°¾æ²¡æœ‰åˆ†å·ï¼Œä¸è§è¿‡çš„å¤§éƒ¨åˆ†ä»£ç è¡Œä¸åŒã€‚**è¡¨è¾¾å¼çš„ç»“å°¾æ²¡æœ‰åˆ†å·ã€‚å¦‚æœåœ¨è¡¨è¾¾å¼çš„ç»“å°¾åŠ ä¸Šåˆ†å·ï¼Œå®ƒå°±å˜æˆäº†è¯­å¥ï¼Œè€Œè¯­å¥ä¸ä¼šè¿”å›å€¼ã€‚**

#### å…·æœ‰è¿”å›å€¼çš„å‡½æ•°  

  æˆ‘ä»¬å¹¶ä¸å¯¹å‡½æ•°è¿”å›å€¼å‘½åï¼Œä½†è¦åœ¨ç®­å¤´ï¼ˆ`->`ï¼‰åå£°æ˜å®ƒçš„ç±»å‹ã€‚åœ¨ Rust ä¸­ï¼Œå‡½æ•°çš„è¿”å›å€¼ç­‰åŒäºå‡½æ•°ä½“æœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ã€‚ä½¿ç”¨ `return` å…³é”®å­—å’ŒæŒ‡å®šå€¼ï¼Œå¯ä»å‡½æ•°ä¸­æå‰è¿”å›ï¼›ä½†å¤§éƒ¨åˆ†å‡½æ•°éšå¼çš„è¿”å›æœ€åçš„è¡¨è¾¾å¼ã€‚  

  ```rust
fn main() {
    let x = plus_one(5);
    println!("The value of x is: {x}");
}

fn plus_one(x: i32) -> i32 {
    x + 1
}
  ```

### æ§åˆ¶æµ

#### ifè¡¨è¾¾å¼

ğŸ§`if`åçš„æ¡ä»¶ **å¿…é¡»** æ˜¯ `bool` å€¼ã€‚å¦‚æœæ¡ä»¶ä¸æ˜¯ `bool` å€¼ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªé”™è¯¯ã€‚

- **åœ¨letè¯­å¥ä¸­ä½¿ç”¨if**  
  å› ä¸º `if` æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `let` è¯­å¥çš„å³ä¾§ä½¿ç”¨å®ƒã€‚

  ```rust
  fn main() {
      let condition = true;
      let number = if condition { 5 } else { 6 };
  
      println!("The value of number is: {number}");
  }
  ```

  è®°ä½ï¼Œä»£ç å—çš„å€¼æ˜¯å…¶æœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œè€Œæ•°å­—æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ•´ä¸ª `if` è¡¨è¾¾å¼çš„å€¼å–å†³äºå“ªä¸ªä»£ç å—è¢«æ‰§è¡Œã€‚**è¿™æ„å‘³ç€ `if` çš„æ¯ä¸ªåˆ†æ”¯çš„å¯èƒ½çš„è¿”å›å€¼éƒ½å¿…é¡»æ˜¯ç›¸åŒç±»å‹ã€‚**å¦‚æœå®ƒä»¬çš„ç±»å‹ä¸åŒ¹é…ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œåˆ™ä¼šå‡ºç°ä¸€ä¸ªé”™è¯¯ï¼š  

    ```rust
  fn main() {
      let condition = true;
  
      let number = if condition { 5 } else { "six" };
  
      println!("The value of number is: {number}");
  }
    ```

#### å¾ªç¯  

- **loopå¾ªç¯ï¼ˆæ— é™å¾ªç¯ï¼‰**  

  ```rust
  fn main() {
      loop {
          println!("again!");
      }
  }
  ```

  å¦‚æœå°†è¿”å›å€¼åŠ å…¥ä½ ç”¨æ¥åœæ­¢å¾ªç¯çš„ `break` è¡¨è¾¾å¼ï¼Œå®ƒä¼šè¢«åœæ­¢çš„å¾ªç¯è¿”å›ï¼š

  ```rust
  fn main() {
      let mut counter = 0;
  
      let result = loop {
          counter += 1;
  
          if counter == 10 {
              break counter * 2;
          }
      };
  
      println!("The result is {result}");
  }
  ___________________________________________
  The result is 20
  ```

- **ğŸ§å¾ªç¯æ ‡ç­¾**  
  å¦‚æœå­˜åœ¨åµŒå¥—å¾ªç¯ï¼Œ`break` å’Œ `continue` åº”ç”¨äºæ­¤æ—¶æœ€å†…å±‚çš„å¾ªç¯ã€‚ä½ å¯ä»¥é€‰æ‹©åœ¨ä¸€ä¸ªå¾ªç¯ä¸ŠæŒ‡å®šä¸€ä¸ª **å¾ªç¯æ ‡ç­¾**ï¼ˆ*loop label*ï¼‰ï¼Œç„¶åå°†æ ‡ç­¾ä¸ `break` æˆ– `continue` ä¸€èµ·ä½¿ç”¨ï¼Œä½¿è¿™äº›å…³é”®å­—åº”ç”¨äºå·²æ ‡è®°çš„å¾ªç¯è€Œä¸æ˜¯æœ€å†…å±‚çš„å¾ªç¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªåµŒå¥—å¾ªç¯çš„ç¤ºä¾‹ï¼š

  ```rust
  fn main() {
      let mut count = 0;
      'counting_up: loop {
          println!("count = {count}");
          let mut remaining = 10;
  
          loop {
              println!("remaining = {remaining}");
              if remaining == 9 {
                  break;
              }
              if count == 2 {
                  break 'counting_up;
              }
              remaining -= 1;
          }
  
          count += 1;
      }
      println!("End count = {count}");
  }
  ____________________________________________________________
  count = 0
  remaining = 10
  remaining = 9
  count = 1
  remaining = 10
  remaining = 9
  count = 2
  remaining = 10
  End count = 2
  ```

- **whileå¾ªç¯**  

  ```rust
  fn main() {
      let mut number = 3;
  
      while number != 0 {
          println!("{number}!");
  
          number -= 1;
      }
  
      println!("LIFTOFF!!!");
  }
  __________________________________
  3!
  2!
  1!
  LIFTOFF!!!
  ```

- **forå¾ªç¯**  

  ```rust
  fn main() {
      let a = [10, 20, 30, 40, 50];
  
      for element in a {
          println!("the value is: {element}");
      }
  }
  __________________________________________________
  the value is: 10
  the value is: 20
  the value is: 30
  the value is: 40
  the value is: 50
  ```

  é€šè¿‡ä½¿ç”¨ rangeï¼Œå®ƒæ˜¯æ ‡å‡†åº“æä¾›çš„ç±»å‹ï¼Œç”¨æ¥ç”Ÿæˆä»ä¸€ä¸ªæ•°å­—å¼€å§‹åˆ°å¦ä¸€ä¸ªæ•°å­—ä¹‹å‰ç»“æŸçš„æ‰€æœ‰æ•°å­—çš„åºåˆ—ï¼Œå¹¶ä½¿ç”¨`rev`åè½¬ rangeï¼š

  ```rust
  fn main() {
      for number in (1..4).rev() {
          println!("{number}!");
      }
      println!("LIFTOFF!!!");
  }
  _______________________________
  3!
  2!
  1!
  LIFTOFF!!!
  ```

##### Rangeç±»å‹

1. **Rangeï¼ˆ..ï¼‰å·¦é—­å³å¼€**

   ```rust
   fn main() {
       for i in 1..5 {
           println!("{}", i); // è¾“å‡º1, 2, 3, 4
       }
   }
   ```

2. **RangeInclusiveï¼ˆ..=ï¼‰å·¦é—­å³é—­**

   ```rust
   fn main() {
       for i in 1..=5 {
           println!("{}", i); // è¾“å‡º1, 2, 3, 4, 5
       }
   }
   ```

3. **RangeToï¼ˆ..endï¼‰0åˆ°æŸä¸ªç»“æŸå€¼ï¼ˆä¸åŒ…æ‹¬ï¼‰**

   ```rust
   fn main() {
       for i in ..5 {
           println!("{}", i); // è¾“å‡º0, 1, 2, 3, 4
       }
   }
   ```

4. **RangeToInclusiveï¼ˆ..=endï¼‰ï¼‰0åˆ°æŸä¸ªç»“æŸå€¼ï¼ˆåŒ…æ‹¬ï¼‰**

   ```rust
   fn main() {
       for i in ..=5 {
           println!("{}", i); // è¾“å‡º0, 1, 2, 3, 4, 5
       }
   }
   ```

### æ‰€æœ‰æƒğŸ§

æ‰€æœ‰æƒï¼ˆ*ownership*ï¼‰æ˜¯ Rust æœ€ä¸ºä¸ä¼—ä¸åŒçš„ç‰¹æ€§ï¼Œå¯¹è¯­è¨€çš„å…¶ä»–éƒ¨åˆ†æœ‰ç€æ·±åˆ»å«ä¹‰ã€‚å®ƒè®© Rust æ— éœ€åƒåœ¾å›æ”¶å³å¯ä¿éšœå†…å­˜å®‰å…¨ï¼Œå› æ­¤ç†è§£ Rust ä¸­æ‰€æœ‰æƒå¦‚ä½•å·¥ä½œæ˜¯ååˆ†é‡è¦çš„ã€‚  
è·Ÿè¸ªå“ªéƒ¨åˆ†ä»£ç æ­£åœ¨ä½¿ç”¨å †ä¸Šçš„å“ªäº›æ•°æ®ï¼Œæœ€å¤§é™åº¦çš„å‡å°‘å †ä¸Šçš„é‡å¤æ•°æ®çš„æ•°é‡ï¼Œä»¥åŠæ¸…ç†å †ä¸Šä¸å†ä½¿ç”¨çš„æ•°æ®ç¡®ä¿ä¸ä¼šè€—å°½ç©ºé—´ï¼Œè¿™äº›é—®é¢˜æ­£æ˜¯æ‰€æœ‰æƒç³»ç»Ÿè¦å¤„ç†çš„ã€‚ä¸€æ—¦ç†è§£äº†æ‰€æœ‰æƒï¼Œä½ å°±ä¸éœ€è¦ç»å¸¸è€ƒè™‘æ ˆå’Œå †äº†ï¼Œä¸è¿‡æ˜ç™½äº†**æ‰€æœ‰æƒçš„ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†ç®¡ç†å †æ•°æ®**ï¼Œèƒ½å¤Ÿå¸®åŠ©è§£é‡Šä¸ºä»€ä¹ˆæ‰€æœ‰æƒè¦ä»¥è¿™ç§æ–¹å¼å·¥ä½œã€‚

#### æ‰€æœ‰æƒè§„åˆ™

1. Rust ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ª **æ‰€æœ‰è€…**ï¼ˆ*owner*ï¼‰ã€‚
2. å€¼åœ¨ä»»ä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…ã€‚
3. å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒã€‚

#### å†…å­˜ä¸åˆ†é…

å†…å­˜åœ¨æ‹¥æœ‰å®ƒçš„å˜é‡ç¦»å¼€ä½œç”¨åŸŸåå°±è¢«è‡ªåŠ¨é‡Šæ”¾ï¼š

```rust
fn main() {
    {
        let s = String::from("hello"); // ä»æ­¤å¤„èµ·ï¼Œs æ˜¯æœ‰æ•ˆçš„
        // ä½¿ç”¨ s
    }                                  // æ­¤ä½œç”¨åŸŸå·²ç»“æŸï¼Œ
                                       // s ä¸å†æœ‰æ•ˆ
}
```

å½“ `s` ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ã€‚å½“å˜é‡ç¦»å¼€ä½œç”¨åŸŸï¼ŒRust ä¸ºæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å«åš [`drop`](https://doc.rust-lang.org/std/ops/trait.Drop.html#tymethod.drop)ï¼Œåœ¨è¿™é‡Œ `String` çš„ä½œè€…å¯ä»¥æ”¾ç½®é‡Šæ”¾å†…å­˜çš„ä»£ç ã€‚Rust åœ¨ç»“å°¾çš„ `}` å¤„è‡ªåŠ¨è°ƒç”¨ `drop`ã€‚

è¿™ä¸ªæ¨¡å¼å¯¹ç¼–å†™ Rust ä»£ç çš„æ–¹å¼æœ‰ç€æ·±è¿œçš„å½±å“ã€‚ç°åœ¨å®ƒçœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä¸è¿‡åœ¨æ›´å¤æ‚çš„åœºæ™¯ä¸‹ä»£ç çš„è¡Œä¸ºå¯èƒ½æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œæ¯”å¦‚å½“æœ‰å¤šä¸ªå˜é‡ä½¿ç”¨åœ¨å †ä¸Šåˆ†é…çš„å†…å­˜æ—¶ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¢ç´¢ä¸€äº›è¿™æ ·çš„åœºæ™¯ã€‚

- **å˜é‡ä¸æ•°æ®äº¤äº’çš„æ–¹å¼ï¼ˆä¸€ï¼‰ï¼šç§»åŠ¨**    

  ```rust
  fn main() {
      let s1 = String::from("hello");
      let s2 = s1;
  
      println!("{}, world!", s1);
  
  }
  _______________________________________
  compile error !
  ```
    
  ![s1å’Œs2çš„å†…å­˜åˆ†å¸ƒ](assets\img\post-images\20240916-Rust-liwener\Rust_4-1.png)  
  `s1` `s2`æŒ‡å‘åŒä¸€å—å †å†…å­˜ï¼Œå½“å®ƒä»¬ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå®ƒä»¬éƒ½ä¼šå°è¯•é‡Šæ”¾ç›¸åŒçš„å†…å­˜ã€‚è¿™æ˜¯ä¸€ä¸ªå«åš**äºŒæ¬¡é‡Šæ”¾ï¼ˆdouble free)**çš„é”™è¯¯ã€‚ä¸¤æ¬¡é‡Šæ”¾ç›¸åŒå†…å­˜ä¼šå¯¼è‡´å†…å­˜æ±¡æŸ“ï¼Œå®ƒå¯èƒ½ä¼šå¯¼è‡´æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚
  ä¸ºäº†ç¡®ä¿å†…å­˜å®‰å…¨ï¼Œåœ¨ `let s2 = s1;` ä¹‹åï¼ŒRust è®¤ä¸º `s1` ä¸å†æœ‰æ•ˆï¼Œå› æ­¤ Rust ä¸éœ€è¦åœ¨ `s1` ç¦»å¼€ä½œç”¨åŸŸåæ¸…ç†ä»»ä½•ä¸œè¥¿ã€‚è¿™æ ·å°±è§£å†³äº†æˆ‘ä»¬çš„é—®é¢˜ï¼å› ä¸ºåªæœ‰ `s2` æ˜¯æœ‰æ•ˆçš„ï¼Œå½“å…¶ç¦»å¼€ä½œç”¨åŸŸï¼Œå®ƒå°±é‡Šæ”¾è‡ªå·±çš„å†…å­˜ã€‚

  å¦å¤–ï¼Œè¿™é‡Œè¿˜éšå«äº†ä¸€ä¸ªè®¾è®¡é€‰æ‹©ï¼š**Rust æ°¸è¿œä¹Ÿä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®çš„ â€œæ·±æ‹·è´â€**ã€‚å› æ­¤ï¼Œä»»ä½• **è‡ªåŠ¨** çš„å¤åˆ¶å¯ä»¥è¢«è®¤ä¸ºå¯¹è¿è¡Œæ—¶æ€§èƒ½å½±å“è¾ƒå°ã€‚

- **å˜é‡ä¸æ•°æ®äº¤äº’çš„æ–¹å¼ï¼ˆäºŒï¼‰ï¼šå…‹éš†**  

  ```rust
  fn main() {
      let s1 = String::from("hello");
      let s2 = s1.clone();
  
      println!("s1 = {}, s2 = {}", s1, s2);
  }
  ```

  è¿™æ®µä»£ç èƒ½æ­£å¸¸è¿è¡Œï¼Œè¿™é‡Œå †ä¸Šçš„æ•°æ®ç¡®å®è¢«å¤åˆ¶äº†ã€‚å½“å‡ºç° `clone` è°ƒç”¨æ—¶ï¼Œä¼šè¿›è¡Œæ·±æ‹·è´ã€‚

- **åªåœ¨æ ˆä¸Šçš„æ‹·è´**  

  ```rust
  fn main() {
      let x = 5;
      let y = x;
  
      println!("x = {}, y = {}", x, y);
  }
  ```

  è¿™æ®µä»£ç ä¼¼ä¹ä¸æˆ‘ä»¬åˆšåˆšå­¦åˆ°çš„å†…å®¹ç›¸çŸ›ç›¾ï¼šæ²¡æœ‰è°ƒç”¨ `clone`ï¼Œä¸è¿‡ `x` ä¾ç„¶æœ‰æ•ˆä¸”æ²¡æœ‰è¢«ç§»åŠ¨åˆ° `y` ä¸­ã€‚

  åŸå› æ˜¯åƒæ•´å‹è¿™æ ·çš„åœ¨ç¼–è¯‘æ—¶å·²çŸ¥å¤§å°çš„ç±»å‹è¢«æ•´ä¸ªå­˜å‚¨åœ¨æ ˆä¸Šï¼Œè¿™é‡Œæ²¡æœ‰æ·±æµ…æ‹·è´çš„åŒºåˆ«ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨ `clone` å¹¶ä¸ä¼šä¸é€šå¸¸çš„æµ…æ‹·è´æœ‰ä»€ä¹ˆä¸åŒã€‚

  ç¬¦åˆè¯¥ç‰¹å¾çš„æ•°æ®ç±»å‹æœ‰ï¼š

  - æ‰€æœ‰æ•´æ•°ç±»å‹ï¼Œæ¯”å¦‚ `u32`ã€‚
  - å¸ƒå°”ç±»å‹ï¼Œ`bool`ï¼Œå®ƒçš„å€¼æ˜¯ `true` å’Œ `false`ã€‚
  - æ‰€æœ‰æµ®ç‚¹æ•°ç±»å‹ï¼Œæ¯”å¦‚ `f64`ã€‚
  - å­—ç¬¦ç±»å‹ï¼Œ`char`ã€‚
  - å…ƒç»„ï¼Œå½“ä¸”ä»…å½“å…¶åŒ…å«çš„ç±»å‹ä¹Ÿéƒ½å®ç° `Copy` çš„æ—¶å€™ã€‚æ¯”å¦‚ï¼Œ`(i32, i32)` å®ç°äº† `Copy`ï¼Œä½† `(i32, String)` å°±æ²¡æœ‰ã€‚

#### éšå¼ç§»åŠ¨å‘ç”Ÿçš„æ—¶æœºğŸ¤”

- match æ¨¡å¼åŒ¹é…

  ```rust
  fn main() {
      let v: String = String::from("hello");
      let r = &v;
  
      match v {
          value => println!("{v}") // æ­¤å¤„vè¢«ç§»åŠ¨åˆ°valueï¼Œå› æ­¤æ— æ³•æ‰“å°v
      } // é‡Šæ”¾valueçš„å †ç©ºé—´
      println!("{v}") // æ­¤å¤„vå†…å­˜è¢«é‡Šæ”¾ï¼ŒåŒæ ·æ— æ³•æ‰“å°
  }
  ```

  ```rust
  fn main() {
      let v: String = String::from("hello");
      let r = &v;
  
      match r { // æ›¿æ¢ä¸ºå¼•ç”¨å³å¯æ­£å¸¸è¿è¡Œ
          value => println!("{v}") 
      } 
      println!("{v}") 
  }
  ```

- æ–¹æ³•å‚æ•°

  `self` ä¼šæ‹¿èµ°å½“å‰ç»“æ„ä½“å®ä¾‹(è°ƒç”¨å¯¹è±¡)çš„æ‰€æœ‰æƒï¼Œè€Œ `&self` å´åªä¼šå€Ÿç”¨ä¸€ä¸ªä¸å¯å˜å¼•ç”¨ï¼Œ`&mut self` ä¼šå€Ÿç”¨ä¸€ä¸ªå¯å˜å¼•ç”¨

- forå¾ªç¯

  ```rust
  fn main() {
      let v = vec![1, 2, 3];
      let mut v1 = Vec::new();
      
      for item in v { // æ­¤å¤„å‘ç”Ÿç§»åŠ¨
          v1.push(item);
      }
      assert_eq!(v, v1);
  }
  ```

- 

#### æ‰€æœ‰æƒä¸å‡½æ•°

å°†å€¼ä¼ é€’ç»™å‡½æ•°ä¸ç»™å˜é‡èµ‹å€¼çš„åŸç†ç›¸ä¼¼ã€‚å‘å‡½æ•°ä¼ é€’å€¼å¯èƒ½ä¼šç§»åŠ¨æˆ–è€…å¤åˆ¶ï¼Œå°±åƒèµ‹å€¼è¯­å¥ä¸€æ ·ã€‚ä¸‹é¢çš„æ³¨é‡Šå±•ç¤ºå˜é‡ä½•æ—¶è¿›å…¥å’Œç¦»å¼€ä½œç”¨åŸŸï¼š

```rust
fn main() {
    let s = String::from("hello");  // s è¿›å…¥ä½œç”¨åŸŸ

    takes_ownership(s);             // s çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°é‡Œ ...
                                    // ... æ‰€ä»¥åˆ°è¿™é‡Œä¸å†æœ‰æ•ˆ

    let x = 5;                      // x è¿›å…¥ä½œç”¨åŸŸ

    makes_copy(x);                  // x åº”è¯¥ç§»åŠ¨å‡½æ•°é‡Œï¼Œ
                                    // ä½† i32 æ˜¯ Copy çš„ï¼Œ
                                    // æ‰€ä»¥åœ¨åé¢å¯ç»§ç»­ä½¿ç”¨ x

} // è¿™é‡Œï¼Œx å…ˆç§»å‡ºäº†ä½œç”¨åŸŸï¼Œç„¶åæ˜¯ sã€‚ä½†å› ä¸º s çš„å€¼å·²è¢«ç§»èµ°ï¼Œ
  // æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„

fn takes_ownership(some_string: String) { // some_string è¿›å…¥ä½œç”¨åŸŸ
    println!("{}", some_string);
} // è¿™é‡Œï¼Œsome_string ç§»å‡ºä½œç”¨åŸŸå¹¶è°ƒç”¨ `drop` æ–¹æ³•ã€‚
  // å ç”¨çš„å†…å­˜è¢«é‡Šæ”¾

fn makes_copy(some_integer: i32) { // some_integer è¿›å…¥ä½œç”¨åŸŸ
    println!("{}", some_integer);
} // è¿™é‡Œï¼Œsome_integer ç§»å‡ºä½œç”¨åŸŸã€‚æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„
```

#### å¼•ç”¨å’Œå€Ÿç”¨

**å¼•ç”¨**ï¼ˆ*reference*ï¼‰åƒä¸€ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç”±æ­¤è®¿é—®å‚¨å­˜äºè¯¥åœ°å€çš„å±äºå…¶ä»–å˜é‡çš„æ•°æ®ã€‚ ä¸æŒ‡é’ˆä¸åŒï¼Œå¼•ç”¨ç¡®ä¿æŒ‡å‘æŸä¸ªç‰¹å®šç±»å‹çš„æœ‰æ•ˆå€¼ã€‚**å¼•ç”¨å…è®¸ä½ ä½¿ç”¨å€¼ä½†ä¸è·å–å…¶æ‰€æœ‰æƒ**ã€‚

```rust
fn main() {
    let s1 = String::from("hello");

    let len = calculate_length(&s1);

    println!("The length of '{}' is {}.", s1, len);
}

fn calculate_length(s: &String) -> usize {
    s.len()
}
```

![å¼•ç”¨](assets\img\post-images\20240916-Rust-liwener\Rust_4-2.png)  
åŒç†ï¼Œå‡½æ•°ç­¾åä½¿ç”¨ `&` æ¥è¡¨æ˜å‚æ•° `s`çš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ã€‚è®©æˆ‘ä»¬å¢åŠ ä¸€äº›è§£é‡Šæ€§çš„æ³¨é‡Šï¼š

```rust
fn main() {
    let s1 = String::from("hello");

    let len = calculate_length(&s1);

    println!("The length of '{}' is {}.", s1, len);
}

fn calculate_length(s: &String) -> usize { // s æ˜¯ String çš„å¼•ç”¨
    s.len()
} // è¿™é‡Œï¼Œs ç¦»å¼€äº†ä½œç”¨åŸŸã€‚ä½†å› ä¸ºå®ƒå¹¶ä¸æ‹¥æœ‰å¼•ç”¨å€¼çš„æ‰€æœ‰æƒï¼Œ
  // æ‰€ä»¥ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿ
```

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå¼•ç”¨çš„è¡Œä¸ºç§°ä¸º **å€Ÿç”¨**ï¼ˆ*borrowing*ï¼‰ã€‚æ­£å¦‚ç°å®ç”Ÿæ´»ä¸­ï¼Œå¦‚æœä¸€ä¸ªäººæ‹¥æœ‰æŸæ ·ä¸œè¥¿ï¼Œä½ å¯ä»¥ä»ä»–é‚£é‡Œå€Ÿæ¥ã€‚å½“ä½ ä½¿ç”¨å®Œæ¯•ï¼Œå¿…é¡»è¿˜å›å»ã€‚æˆ‘ä»¬å¹¶ä¸æ‹¥æœ‰å®ƒï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ä¿®æ”¹å¼•ç”¨çš„å˜é‡ï¼š

```rust
fn main() {
    let s = String::from("hello");
    change(&s);
}

fn change(some_string: &String) {
    some_string.push_str(", world");
}
________________________________________
compile error !
```

#### å¯å˜å¼•ç”¨

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå°è°ƒæ•´å°±èƒ½ä¿®å¤ç¤ºä¾‹ 4-6 ä»£ç ä¸­çš„é”™è¯¯ï¼Œå…è®¸æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸ªå€Ÿç”¨çš„å€¼ï¼Œè¿™å°±æ˜¯ **å¯å˜å¼•ç”¨**ï¼ˆ*mutable reference*ï¼‰ï¼š

```rust
fn main() {
    let mut s = String::from("hello");

    change(&mut s);
}

fn change(some_string: &mut String) {
    some_string.push_str(", world");
}
```

å¯å˜å¼•ç”¨æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é™åˆ¶ï¼šå¦‚æœä½ æœ‰ä¸€ä¸ªå¯¹è¯¥å˜é‡çš„å¯å˜å¼•ç”¨ï¼Œä½ å°±ä¸èƒ½ä½¿ç”¨è¯¥å˜é‡çš„å¦ä¸€ä¸ªå¯å˜å¼•ç”¨ã€‚åŒæ—¶ä½¿ç”¨ä¸¤ä¸ª `s` çš„å¯å˜å¼•ç”¨çš„ä»£ç ä¼šå¤±è´¥ï¼š

```rust
fn main() {
    let mut s = String::from("hello");

    let r1 = &mut s;
    let r2 = &mut s;

    println!("{}, {}", r1, r2); // compile error !
    
    println!("{}", r1); // compile error !
    println!("{}", r2); // å¯ä»¥
}
```

è¿™ä¸€é™åˆ¶ä»¥ä¸€ç§éå¸¸å°å¿ƒè°¨æ…çš„æ–¹å¼å…è®¸å¯å˜æ€§ï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¯¹åŒä¸€æ•°æ®å­˜åœ¨å¤šä¸ªå¯å˜å¼•ç”¨ã€‚æ–° Rustacean ä»¬ç»å¸¸éš¾ä»¥é€‚åº”è¿™ä¸€ç‚¹ï¼Œå› ä¸ºå¤§éƒ¨åˆ†è¯­è¨€ä¸­å˜é‡ä»»ä½•æ—¶å€™éƒ½æ˜¯å¯å˜çš„ã€‚è¿™ä¸ªé™åˆ¶çš„å¥½å¤„æ˜¯ Rust å¯ä»¥åœ¨ç¼–è¯‘æ—¶å°±é¿å…æ•°æ®ç«äº‰ã€‚**æ•°æ®ç«äº‰**ï¼ˆ*data race*ï¼‰ç±»ä¼¼äºç«æ€æ¡ä»¶ï¼Œå®ƒå¯ç”±è¿™ä¸‰ä¸ªè¡Œä¸ºé€ æˆï¼š

- ä¸¤ä¸ªæˆ–æ›´å¤šæŒ‡é’ˆåŒæ—¶è®¿é—®åŒä¸€æ•°æ®ã€‚
- è‡³å°‘æœ‰ä¸€ä¸ªæŒ‡é’ˆè¢«ç”¨æ¥å†™å…¥æ•°æ®ã€‚
- æ²¡æœ‰åŒæ­¥æ•°æ®è®¿é—®çš„æœºåˆ¶ã€‚

æ•°æ®ç«äº‰ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼Œéš¾ä»¥åœ¨è¿è¡Œæ—¶è¿½è¸ªï¼Œå¹¶ä¸”éš¾ä»¥è¯Šæ–­å’Œä¿®å¤ï¼›Rust é¿å…äº†è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œå› ä¸ºå®ƒç”šè‡³ä¸ä¼šç¼–è¯‘å­˜åœ¨æ•°æ®ç«äº‰çš„ä»£ç ï¼

ä¸€å¦‚æ—¢å¾€ï¼Œå¯ä»¥ä½¿ç”¨å¤§æ‹¬å·æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼Œä»¥å…è®¸æ‹¥æœ‰å¤šä¸ªå¯å˜å¼•ç”¨ï¼Œåªæ˜¯ä¸èƒ½ **åŒæ—¶** æ‹¥æœ‰ï¼šï¼ˆå†™å†™å†²çªï¼‰

```rust
    let mut s = String::from("hello");

    {
        let r1 = &mut s;
    } // r1 åœ¨è¿™é‡Œç¦»å¼€äº†ä½œç”¨åŸŸï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¼•ç”¨

    let r2 = &mut s;
```

æˆ‘ä»¬ä¹Ÿä¸èƒ½åœ¨æ‹¥æœ‰ä¸å¯å˜å¼•ç”¨çš„åŒæ—¶æ‹¥æœ‰å¯å˜å¼•ç”¨ã€‚Rust åœ¨åŒæ—¶ä½¿ç”¨å¯å˜ä¸ä¸å¯å˜å¼•ç”¨æ—¶ä¹Ÿé‡‡ç”¨çš„ç±»ä¼¼çš„è§„åˆ™ã€‚è¿™äº›ä»£ç ä¼šå¯¼è‡´ä¸€ä¸ªé”™è¯¯ï¼šï¼ˆè¯»å†™å†²çªï¼‰

```rust
    let mut s = String::from("hello");

    let r1 = &s; // æ²¡é—®é¢˜
    let r2 = &s; // æ²¡é—®é¢˜
    let r3 = &mut s; // å¤§é—®é¢˜

    println!("{}, {}, and {}", r1, r2, r3);
____________________________________________________
compile error !
```

#### æ‚¬ç©ºå¼•ç”¨

åœ¨å…·æœ‰æŒ‡é’ˆçš„è¯­è¨€ä¸­ï¼Œå¾ˆå®¹æ˜“é€šè¿‡é‡Šæ”¾å†…å­˜æ—¶ä¿ç•™æŒ‡å‘å®ƒçš„æŒ‡é’ˆè€Œé”™è¯¯åœ°ç”Ÿæˆä¸€ä¸ª **æ‚¬å‚æŒ‡é’ˆ**ï¼ˆ*dangling pointer*ï¼‰ï¼Œæ‰€è°“æ‚¬å‚æŒ‡é’ˆæ˜¯å…¶æŒ‡å‘çš„å†…å­˜å¯èƒ½å·²ç»è¢«åˆ†é…ç»™å…¶å®ƒæŒæœ‰è€…ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ Rust ä¸­ç¼–è¯‘å™¨ç¡®ä¿å¼•ç”¨æ°¸è¿œä¹Ÿä¸ä¼šå˜æˆæ‚¬å‚çŠ¶æ€ï¼šå½“ä½ æ‹¥æœ‰ä¸€äº›æ•°æ®çš„å¼•ç”¨ï¼Œç¼–è¯‘å™¨ç¡®ä¿æ•°æ®ä¸ä¼šåœ¨å…¶å¼•ç”¨ä¹‹å‰ç¦»å¼€ä½œç”¨åŸŸã€‚

è®©æˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªæ‚¬å‚å¼•ç”¨ï¼ŒRust ä¼šé€šè¿‡ä¸€ä¸ªç¼–è¯‘æ—¶é”™è¯¯æ¥é¿å…ï¼š

æ–‡ä»¶åï¼šsrc/main.rs

```rust
fn main() {
    let reference_to_nothing = dangle();
}

fn dangle() -> &String { // dangle è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²çš„å¼•ç”¨

    let s = String::from("hello"); // s æ˜¯ä¸€ä¸ªæ–°å­—ç¬¦ä¸²

    &s // è¿”å›å­—ç¬¦ä¸² s çš„å¼•ç”¨
} // è¿™é‡Œ s ç¦»å¼€ä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒï¼Œå…¶å†…å­˜è¢«é‡Šæ”¾ï¼Œæˆä¸ºæ‚¬ç©ºå¼•ç”¨
________________________________________________________
compile error !
```

è¿™é‡Œçš„è§£å†³æ–¹æ³•æ˜¯ç›´æ¥è¿”å› `String`ï¼š

```rust
fn no_dangle() -> String {
    let s = String::from("hello");

    s
}
```

#### åˆ‡ç‰‡ SliceğŸ§

*slice* å…è®¸ä½ å¼•ç”¨é›†åˆä¸­ä¸€æ®µè¿ç»­çš„å…ƒç´ åºåˆ—ï¼Œè€Œä¸ç”¨å¼•ç”¨æ•´ä¸ªé›†åˆã€‚slice æ˜¯ä¸€ç±»å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰æ‰€æœ‰æƒã€‚

ä¸€ä¸ªåˆ‡ç‰‡å¼•ç”¨å ç”¨äº†2ä¸ªå­—å¤§å°çš„å†…å­˜ç©ºé—´( ä»ç°åœ¨å¼€å§‹ï¼Œä¸ºäº†ç®€æ´æ€§è€ƒè™‘ï¼Œå¦‚æ— ç‰¹æ®ŠåŸå› ï¼Œ**æˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨åˆ‡ç‰‡æ¥ç‰¹æŒ‡åˆ‡ç‰‡å¼•ç”¨** )ã€‚ è¯¥åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå­—æ˜¯æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå­—æ˜¯åˆ‡ç‰‡çš„é•¿åº¦ã€‚å­—çš„å¤§å°å–å†³äºå¤„ç†å™¨æ¶æ„ï¼Œä¾‹å¦‚åœ¨ `x86-64` ä¸Šï¼Œå­—çš„å¤§å°æ˜¯ 64 ä½ä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆä¸€ä¸ªåˆ‡ç‰‡å¼•ç”¨å°±æ˜¯ 16 ä¸ªå­—èŠ‚å¤§å°ã€‚

- **å­—ç¬¦ä¸²slice**   
  **å­—ç¬¦ä¸² slice**ï¼ˆ*string slice*ï¼‰æ˜¯ `String` ä¸­ä¸€éƒ¨åˆ†å€¼çš„å¼•ç”¨ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

  ```rust
      let s = String::from("hello world");
  
      let hello = &s[0..5];
      let world = &s[6..11];
  ```

  å¯¹äº Rust çš„ `..` range è¯­æ³•ï¼Œå¦‚æœæƒ³è¦ä»ç´¢å¼• 0 å¼€å§‹ï¼Œå¯ä»¥ä¸å†™ä¸¤ä¸ªç‚¹å·ä¹‹å‰çš„å€¼ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚ä¸‹ä¸¤ä¸ªè¯­å¥æ˜¯ç›¸åŒçš„ï¼š

  ```rust
  let s = String::from("hello");
  
  let slice = &s[0..2];
  let slice = &s[..2];
  ```

  ä¾æ­¤ç±»æ¨ï¼Œå¦‚æœ slice åŒ…å« `String` çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå¯ä»¥èˆå¼ƒå°¾éƒ¨çš„æ•°å­—ã€‚è¿™æ„å‘³ç€å¦‚ä¸‹ä¹Ÿæ˜¯ç›¸åŒçš„ï¼š

  ```rust
  let s = String::from("hello");
  
  let len = s.len();
  
  let slice = &s[3..len];
  let slice = &s[3..];
  ```

  ä¹Ÿå¯ä»¥åŒæ—¶èˆå¼ƒè¿™ä¸¤ä¸ªå€¼æ¥è·å–æ•´ä¸ªå­—ç¬¦ä¸²çš„ sliceã€‚æ‰€ä»¥å¦‚ä¸‹äº¦æ˜¯ç›¸åŒçš„ï¼š

  ```rust
  let s = String::from("hello");
  
  let len = s.len();
  
  let slice = &s[0..len];
  let slice = &s[..];
  ```

- ğŸ§**å­—ç¬¦ä¸²å­—é¢å€¼å°±æ˜¯ slice**

  ```rust
  let s = "Hello, world!";
  ```

  è¿™é‡Œ s çš„ç±»å‹æ˜¯ &strï¼šå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘äºŒè¿›åˆ¶ç¨‹åºç‰¹å®šä½ç½®çš„ sliceã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²å­—é¢å€¼æ˜¯ä¸å¯å˜çš„ï¼š&str æ˜¯ä¸€ä¸ªä¸å¯å˜å¼•ç”¨ã€‚

##### å…¶ä»–ç±»å‹çš„slice

  å­—ç¬¦ä¸² sliceï¼Œæ­£å¦‚ä½ æƒ³è±¡çš„é‚£æ ·ï¼Œæ˜¯é’ˆå¯¹å­—ç¬¦ä¸²çš„ã€‚ä¸è¿‡ä¹Ÿæœ‰æ›´é€šç”¨çš„ slice ç±»å‹ã€‚è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªæ•°ç»„ï¼š

  ```rust
let a = [1, 2, 3, 4, 5];
  ```

  å°±è·Ÿæˆ‘ä»¬æƒ³è¦è·å–å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†é‚£æ ·ï¼Œæˆ‘ä»¬ä¹Ÿä¼šæƒ³è¦å¼•ç”¨æ•°ç»„çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š

  ```rust
let a = [1, 2, 3, 4, 5];

let slice = &a[1..3];

assert_eq!(slice, &[2, 3]);
  ```

  è¿™ä¸ª slice çš„ç±»å‹æ˜¯ `&[i32]`ã€‚å®ƒè·Ÿå­—ç¬¦ä¸² slice çš„å·¥ä½œæ–¹å¼ä¸€æ ·ï¼Œé€šè¿‡å­˜å‚¨ç¬¬ä¸€ä¸ªé›†åˆå…ƒç´ çš„å¼•ç”¨å’Œä¸€ä¸ªé›†åˆæ€»é•¿åº¦ã€‚ä½ å¯ä»¥å¯¹å…¶ä»–æ‰€æœ‰é›†åˆä½¿ç”¨è¿™ç±» sliceã€‚ç¬¬å…«ç« è®²åˆ° vector æ—¶ä¼šè¯¦ç»†è®¨è®ºè¿™äº›é›†åˆã€‚

  

### ç»“æ„ä½“

```rust
struct User {
    active: bool,
    username: String,
    email: String,
    sign_in_count: u64,
}
```

é€šè¿‡ä¸ºæ¯ä¸ªå­—æ®µæŒ‡å®šå…·ä½“å€¼æ¥åˆ›å»ºè¿™ä¸ªç»“æ„ä½“çš„å®ä¾‹ã€‚åˆ›å»ºä¸€ä¸ªå®ä¾‹éœ€è¦ä»¥ç»“æ„ä½“çš„åå­—å¼€å¤´ï¼Œæ¥ç€åœ¨å¤§æ‹¬å·ä¸­ä½¿ç”¨ key: value é”® - å€¼å¯¹çš„å½¢å¼æä¾›å­—æ®µã€‚å®ä¾‹ä¸­å­—æ®µçš„é¡ºåºä¸éœ€è¦å’Œå®ƒä»¬åœ¨ç»“æ„ä½“ä¸­å£°æ˜çš„é¡ºåºä¸€è‡´ã€‚

```rust
fn main() {
    let mut user1 = User {
        active: true,
        username: String::from("someusername123"),
        email: String::from("someone@example.com"),
        sign_in_count: 1,
    };
    
    user1.email = String::from("anotheremail@example.com");
}
```

æ³¨æ„å¯å˜æ€§å¿…é¡»ä½œç”¨åœ¨æ•´ä¸ªå®ä¾‹ï¼›Rust å¹¶ä¸å…è®¸åªå°†æŸä¸ªå­—æ®µæ ‡è®°ä¸ºå¯å˜ã€‚

#### ä½¿ç”¨å­—æ®µåˆå§‹åŒ–

`build_user` å‡½æ•°è·å– email å’Œç”¨æˆ·åå¹¶è¿”å› `User` å®ä¾‹ï¼š

```rust
fn build_user(email: String, username: String) -> User {
    User {
        active: true,
        username: username,
        email: email,
        sign_in_count: 1,
    }
}
```

ä¸ºå‡½æ•°å‚æ•°èµ·ä¸ç»“æ„ä½“å­—æ®µç›¸åŒçš„åå­—æ˜¯å¯ä»¥ç†è§£çš„ï¼Œä½†æ˜¯ä¸å¾—ä¸é‡å¤ `email` å’Œ `username` å­—æ®µåç§°ä¸å˜é‡æœ‰äº›å•°å—¦ã€‚å¦‚æœç»“æ„ä½“æœ‰æ›´å¤šå­—æ®µï¼Œé‡å¤æ¯ä¸ªåç§°å°±æ›´åŠ çƒ¦äººäº†ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªæ–¹ä¾¿çš„ç®€å†™è¯­æ³•ï¼Œ **å­—æ®µåˆå§‹åŒ–ç®€å†™è¯­æ³•**ï¼š

```rust
fn build_user(email: String, username: String) -> User {
    User {
        active: true,
        username,
        email,
        sign_in_count: 1,
    }
}
```

#### ä½¿ç”¨ç»“æ„ä½“æ›´æ–°è¯­æ³•

ä½¿ç”¨æ—§å®ä¾‹çš„å¤§éƒ¨åˆ†å€¼ä½†æ”¹å˜å…¶éƒ¨åˆ†å€¼æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ä½“å®ä¾‹é€šå¸¸æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚è¿™å¯ä»¥é€šè¿‡ **ç»“æ„ä½“æ›´æ–°è¯­æ³•**ï¼ˆ*struct update syntax*ï¼‰å®ç°ã€‚

ä¸‹é¢æ¼”ç¤ºäº†å¦‚ä½•åœ¨ `user2` ä¸­åˆ›å»ºä¸€ä¸ªæ–° `User` å®ä¾‹ã€‚æˆ‘ä»¬ä¸º `email` è®¾ç½®äº†æ–°çš„å€¼ï¼Œå…¶ä»–å€¼åˆ™ä½¿ç”¨äº†å®ä¾‹ 5-2 ä¸­åˆ›å»ºçš„ `user1` ä¸­çš„åŒåå€¼ï¼š

```rust
fn main() {
    // --snip--

    let user2 = User {
        active: user1.active,
        username: user1.username,
        email: String::from("another@example.com"),
        sign_in_count: user1.sign_in_count,
    };
}
```

ä½¿ç”¨ç»“æ„ä½“æ›´æ–°è¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´å°‘çš„ä»£ç æ¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœï¼Œå¦‚ç¤ºä¾‹ 5-7 æ‰€ç¤ºã€‚`..` è¯­æ³•æŒ‡å®šäº†å‰©ä½™æœªæ˜¾å¼è®¾ç½®å€¼çš„å­—æ®µåº”æœ‰ä¸ç»™å®šå®ä¾‹å¯¹åº”å­—æ®µç›¸åŒçš„å€¼ã€‚  

```rust
fn main() {
    // --snip--

    let user2 = User {
        email: String::from("another@example.com"),
        ..user1
    };
}
```

ğŸ§æ³¨æ„ï¼Œç»“æ„æ›´æ–°è¯­æ³•å°±åƒå¸¦æœ‰ `=` çš„èµ‹å€¼ï¼Œå› ä¸ºå®ƒç§»åŠ¨äº†æ•°æ®ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ€»ä½“ä¸Šè¯´æˆ‘ä»¬åœ¨åˆ›å»º `user2` åä¸èƒ½å°±å†ä½¿ç”¨ `user1` äº†ï¼Œå› ä¸º `user1` çš„ `username` å­—æ®µä¸­çš„ `String` è¢«ç§»åˆ° `user2` ä¸­ã€‚å¦‚æœæˆ‘ä»¬ç»™ `user2` çš„ `email` å’Œ `username` éƒ½èµ‹äºˆæ–°çš„ `String` å€¼ï¼Œä»è€Œåªä½¿ç”¨ `user1` çš„ `active` å’Œ `sign_in_count` å€¼ï¼Œé‚£ä¹ˆ `user1` åœ¨åˆ›å»º `user2` åä»ç„¶æœ‰æ•ˆã€‚

#### å…ƒç»„ç»“æ„ä½“

å¯ä»¥å®šä¹‰ä¸å…ƒç»„ç±»ä¼¼çš„ç»“æ„ä½“ï¼Œç§°ä¸º **å…ƒç»„ç»“æ„ä½“**ï¼ˆ*tuple structs*ï¼‰ã€‚å…ƒç»„ç»“æ„ä½“æœ‰ç€ç»“æ„ä½“åç§°æä¾›çš„å«ä¹‰ï¼Œä½†æ²¡æœ‰å…·ä½“çš„å­—æ®µåï¼Œåªæœ‰å­—æ®µçš„ç±»å‹ã€‚å½“ä½ æƒ³ç»™æ•´ä¸ªå…ƒç»„å–ä¸€ä¸ªåå­—ï¼Œå¹¶ä½¿å…ƒç»„æˆä¸ºä¸å…¶ä»–å…ƒç»„ä¸åŒçš„ç±»å‹æ—¶ï¼Œå…ƒç»„ç»“æ„ä½“æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œè¿™æ—¶åƒå¸¸è§„ç»“æ„ä½“é‚£æ ·ä¸ºæ¯ä¸ªå­—æ®µå‘½åå°±æ˜¾å¾—å¤šä½™å’Œå½¢å¼åŒ–äº†ã€‚

è¦å®šä¹‰å…ƒç»„ç»“æ„ä½“ï¼Œä»¥ `struct` å…³é”®å­—å’Œç»“æ„ä½“åå¼€å¤´å¹¶åè·Ÿå…ƒç»„ä¸­çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªåˆ†åˆ«å«åš `Color` å’Œ `Point` å…ƒç»„ç»“æ„ä½“çš„å®šä¹‰å’Œç”¨æ³•ï¼š

```rust
struct Color(i32, i32, i32);
struct Point(i32, i32, i32);

fn main() {
    let black = Color(0, 0, 0);
    let origin = Point(0, 0, 0);
}
```

#### ç±»å•å…ƒç»“æ„ä½“

æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å­—æ®µçš„ç»“æ„ä½“ï¼å®ƒä»¬è¢«ç§°ä¸º **ç±»å•å…ƒç»“æ„ä½“**ï¼ˆ*unit-like structs*ï¼‰ç±»ä¼¼äº `()`ã€‚

```rust
struct AlwaysEqual;

fn main() {
    let subject = AlwaysEqual;
}
```

#### ç»“æ„ä½“æ•°æ®çš„æ‰€æœ‰æƒ

åœ¨ `User` ç»“æ„ä½“çš„å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è‡ªèº«æ‹¥æœ‰æ‰€æœ‰æƒçš„ `String` ç±»å‹è€Œä¸æ˜¯ `&str` å­—ç¬¦ä¸² slice ç±»å‹ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰æ„è€Œä¸ºä¹‹çš„é€‰æ‹©ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦è¿™ä¸ªç»“æ„ä½“æ‹¥æœ‰å®ƒæ‰€æœ‰çš„æ•°æ®ï¼Œä¸ºæ­¤åªè¦æ•´ä¸ªç»“æ„ä½“æ˜¯æœ‰æ•ˆçš„è¯å…¶æ•°æ®ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚

å¯ä»¥ä½¿ç»“æ„ä½“å­˜å‚¨è¢«å…¶ä»–å¯¹è±¡æ‹¥æœ‰çš„æ•°æ®çš„å¼•ç”¨ï¼Œä¸è¿‡è¿™ä¹ˆåšçš„è¯éœ€è¦ç”¨ä¸Š **ç”Ÿå‘½å‘¨æœŸ**ï¼ˆ*lifetimes*ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç¬¬åç« ä¼šè®¨è®ºçš„ Rust åŠŸèƒ½ã€‚ç”Ÿå‘½å‘¨æœŸç¡®ä¿ç»“æ„ä½“å¼•ç”¨çš„æ•°æ®æœ‰æ•ˆæ€§è·Ÿç»“æ„ä½“æœ¬èº«ä¿æŒä¸€è‡´ã€‚å¦‚æœä½ å°è¯•åœ¨ç»“æ„ä½“ä¸­å­˜å‚¨ä¸€ä¸ªå¼•ç”¨è€Œä¸æŒ‡å®šç”Ÿå‘½å‘¨æœŸå°†æ˜¯æ— æ•ˆçš„ï¼Œæ¯”å¦‚è¿™æ ·ï¼š

```rust
struct User {
    active: bool,
    username: &str,
    email: &str,
    sign_in_count: u64,
}

fn main() {
    let user1 = User {
        active: true,
        username: "someusername123",
        email: "someone@example.com",
        sign_in_count: 1,
    };
}
```

ç¼–è¯‘å™¨ä¼šæŠ±æ€¨å®ƒéœ€è¦ç”Ÿå‘½å‘¨æœŸæ ‡è¯†ç¬¦ï¼š

```console
$ cargo run
   Compiling structs v0.1.0 (file:///projects/structs)
error[E0106]: missing lifetime specifier
 --> src/main.rs:3:15
  |
3 |     username: &str,
  |               ^ expected named lifetime parameter
  |
help: consider introducing a named lifetime parameter
  |
1 ~ struct User<'a> {
2 |     active: bool,
3 ~     username: &'a str,
  |

error[E0106]: missing lifetime specifier
 --> src/main.rs:4:12
  |
4 |     email: &str,
  |            ^ expected named lifetime parameter
  |
help: consider introducing a named lifetime parameter
  |
1 ~ struct User<'a> {
2 |     active: bool,
3 |     username: &str,
4 ~     email: &'a str,
  |

For more information about this error, try `rustc --explain E0106`.
error: could not compile `structs` due to 2 previous errors
```

ç¬¬åç« ä¼šè®²åˆ°å¦‚ä½•ä¿®å¤è¿™ä¸ªé—®é¢˜ä»¥ä¾¿åœ¨ç»“æ„ä½“ä¸­å­˜å‚¨å¼•ç”¨ï¼Œä¸è¿‡ç°åœ¨ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨åƒ `String` è¿™ç±»æ‹¥æœ‰æ‰€æœ‰æƒçš„ç±»å‹æ¥æ›¿ä»£ `&str` è¿™æ ·çš„å¼•ç”¨ä»¥ä¿®æ­£è¿™ä¸ªé”™è¯¯ã€‚

#### é€šè¿‡æ´¾ç”Ÿ trait å¢åŠ å®ç”¨åŠŸèƒ½ğŸ§

åœ¨è°ƒè¯•ç¨‹åºæ—¶æ‰“å°å‡º `Rectangle` å®ä¾‹æ¥æŸ¥çœ‹å…¶æ‰€æœ‰å­—æ®µçš„å€¼éå¸¸æœ‰ç”¨ã€‚ç¤ºä¾‹åƒå‰é¢ç« èŠ‚é‚£æ ·å°è¯•ä½¿ç”¨ [`println!` å®](https://doc.rust-lang.org/std/macro.println.html)ã€‚ä½†è¿™å¹¶ä¸è¡Œã€‚

```rust
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };

    println!("rect1 is {}", rect1);
}
```

å½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªä»£ç æ—¶ï¼Œä¼šå‡ºç°å¸¦æœ‰å¦‚ä¸‹æ ¸å¿ƒä¿¡æ¯çš„é”™è¯¯ï¼š

```text
error[E0277]: `Rectangle` doesn't implement `std::fmt::Display`
```

`println!` å®èƒ½å¤„ç†å¾ˆå¤šç±»å‹çš„æ ¼å¼ï¼Œ**ä½†`{}` é»˜è®¤å‘Šè¯‰ `println!` ä½¿ç”¨è¢«ç§°ä¸º `Display` çš„æ ¼å¼**ï¼Œç»“æ„ä½“å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªé»˜è®¤`Display` å®ç°æ¥ä½¿ç”¨ `println!` ä¸ `{}` å ä½ç¬¦ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç»§ç»­é˜…è¯»é”™è¯¯ï¼Œå°†ä¼šå‘ç°è¿™ä¸ªæœ‰å¸®åŠ©çš„ä¿¡æ¯ï¼š

```text
= help: the trait `std::fmt::Display` is not implemented for `Rectangle`
= note: in format strings you may be able to use `{:?}` (or {:#?} for pretty-print) instead
```

**`{:?}` æŒ‡ç¤ºç¬¦å‘Šè¯‰ `println!` æˆ‘ä»¬æƒ³è¦ä½¿ç”¨å«åš `Debug` çš„è¾“å‡ºæ ¼å¼**ã€‚`Debug` æ˜¯ä¸€ä¸ª traitï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»¥ä¸€ç§å¯¹å¼€å‘è€…æœ‰å¸®åŠ©çš„æ–¹å¼æ‰“å°ç»“æ„ä½“ï¼Œä»¥ä¾¿å½“æˆ‘ä»¬è°ƒè¯•ä»£ç æ—¶èƒ½çœ‹åˆ°å®ƒçš„å€¼ã€‚

è¿™æ ·è°ƒæ•´åå†æ¬¡è¿è¡Œç¨‹åºã€‚è§é¬¼äº†ï¼ä»ç„¶èƒ½çœ‹åˆ°ä¸€ä¸ªé”™è¯¯ï¼š

```text
error[E0277]: `Rectangle` doesn't implement `Debug`
```

ä¸è¿‡ç¼–è¯‘å™¨åˆä¸€æ¬¡ç»™å‡ºäº†ä¸€ä¸ªæœ‰å¸®åŠ©çš„ä¿¡æ¯ï¼š

```text
   = help: the trait `Debug` is not implemented for `Rectangle`
   = note: add `#[derive(Debug)]` to `Rectangle` or manually `impl Debug for Rectangle`
```

Rustç¡®å®åŒ…å«äº†æ‰“å°å‡ºè°ƒè¯•ä¿¡æ¯çš„åŠŸèƒ½ï¼Œä¸è¿‡æˆ‘ä»¬å¿…é¡»ä¸ºç»“æ„ä½“æ˜¾å¼é€‰æ‹©è¿™ä¸ªåŠŸèƒ½ã€‚**ä¸ºæ­¤ï¼Œåœ¨ç»“æ„ä½“å®šä¹‰ä¹‹å‰åŠ ä¸Šå¤–éƒ¨å±æ€§ `#[derive(Debug)]`**ï¼Œ

æ–‡ä»¶åï¼šsrc/main.rs

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };

    println!("rect1 is {:?}", rect1);
}
```

ç°åœ¨æˆ‘ä»¬å†è¿è¡Œè¿™ä¸ªç¨‹åºæ—¶ï¼Œå°±ä¸ä¼šæœ‰ä»»ä½•é”™è¯¯ï¼Œå¹¶ä¼šå‡ºç°å¦‚ä¸‹è¾“å‡ºï¼š

```console
rect1 is Rectangle { width: 30, height: 50 }
```

å½“æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´å¤§çš„ç»“æ„ä½“æ—¶ï¼Œèƒ½æœ‰æ›´æ˜“è¯»ä¸€ç‚¹çš„è¾“å‡ºå°±å¥½äº†ï¼Œ**ä¸ºæ­¤å¯ä»¥ä½¿ç”¨ `{:#?}` æ›¿æ¢ `println!` å­—ç¬¦ä¸²ä¸­çš„ `{:?}`å¢åŠ å¯è¯»æ€§ã€‚**åœ¨è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨ `{:#?}` é£æ ¼å°†ä¼šè¾“å‡ºå¦‚ä¸‹ï¼š

```console
rect1 is Rectangle {
    width: 30,
    height: 50,
}
```

å¦ä¸€ç§ä½¿ç”¨ `Debug` æ ¼å¼æ‰“å°æ•°å€¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨ [`dbg!` å®](https://doc.rust-lang.org/std/macro.dbg.html)ã€‚`dbg!` å®æ¥æ”¶ä¸€ä¸ªè¡¨è¾¾å¼çš„æ‰€æœ‰æƒï¼ˆä¸ `println!` å®ç›¸åï¼Œåè€…æ¥æ”¶çš„æ˜¯å¼•ç”¨ï¼‰ï¼Œæ‰“å°å‡ºä»£ç ä¸­è°ƒç”¨ dbg! å®æ—¶æ‰€åœ¨çš„æ–‡ä»¶å’Œè¡Œå·ï¼Œä»¥åŠè¯¥è¡¨è¾¾å¼çš„ç»“æœå€¼ï¼Œ**å¹¶è¿”å›è¯¥å€¼çš„æ‰€æœ‰æƒ**ã€‚

> æ³¨æ„ï¼šè°ƒç”¨ `dbg!` å®ä¼šæ‰“å°åˆ°æ ‡å‡†é”™è¯¯æ§åˆ¶å°æµï¼ˆ`stderr`ï¼‰ï¼Œä¸ `println!` ä¸åŒï¼Œåè€…ä¼šæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºæ§åˆ¶å°æµï¼ˆ`stdout`ï¼‰ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯¹åˆ†é…ç»™ `width` å­—æ®µçš„å€¼ä»¥åŠ `rect1` ä¸­æ•´ä¸ªç»“æ„çš„å€¼æ„Ÿå…´è¶£ã€‚

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let scale = 2;
    let rect1 = Rectangle {
        width: dbg!(30 * scale),
        height: 50,
    };

    dbg!(&rect1);
}
```

æˆ‘ä»¬å¯ä»¥æŠŠ `dbg!` æ”¾åœ¨è¡¨è¾¾å¼ `30 * scale` å‘¨å›´ï¼Œå› ä¸º `dbg!` è¿”å›è¡¨è¾¾å¼çš„å€¼çš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥ `width` å­—æ®µå°†è·å¾—ç›¸åŒçš„å€¼ï¼Œå°±åƒæˆ‘ä»¬åœ¨é‚£é‡Œæ²¡æœ‰ `dbg!` è°ƒç”¨ä¸€æ ·ã€‚æˆ‘ä»¬ä¸å¸Œæœ› `dbg!` æ‹¥æœ‰ `rect1` çš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨ `dbg!` æ—¶ä¼ é€’ä¸€ä¸ªå¼•ç”¨ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªä¾‹å­çš„è¾“å‡ºç»“æœï¼š

```console
[src/main.rs:10] 30 * scale = 60
[src/main.rs:14] &rect1 = Rectangle {
    width: 60,
    height: 50,
}
```

#### æ–¹æ³•

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    fn area(&self) -> u32 {
        self.width * self.height
    }
    
    fn can_hold(&self, other: &Rectangle) -> bool {
        self.width > other.width && self.height > other.height
    }
}

fn main() {
    let rect1 = Rectangle {
        width: 30,
        height: 50,
    };

    println!(
        "The area of the rectangle is {} square pixels.",
        rect1.area()
    );
}
```

ä¸ºäº†ä½¿å‡½æ•°å®šä¹‰äº `Rectangle` çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹äº†ä¸€ä¸ª `impl` å—ï¼Œè¿™ä¸ª `impl` å—ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½å°†ä¸ `Rectangle` ç±»å‹ç›¸å…³è”ã€‚æ¥ç€å°† `area` å‡½æ•°ç§»åŠ¨åˆ° `impl` å¤§æ‹¬å·ä¸­ï¼Œå¹¶å°†ç­¾åä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°å’Œå‡½æ•°ä½“ä¸­å…¶ä»–åœ°æ–¹çš„å¯¹åº”å‚æ•°æ”¹æˆ `self`ã€‚

åœ¨ `area` çš„ç­¾åä¸­ï¼Œä½¿ç”¨ `&self` æ¥æ›¿ä»£ `rectangle: &Rectangle`ï¼Œ`&self` å®é™…ä¸Šæ˜¯ `self: &Self` çš„ç¼©å†™ã€‚åœ¨ä¸€ä¸ª `impl` å—ä¸­ï¼Œ`Self` ç±»å‹æ˜¯ `impl` å—çš„ç±»å‹çš„åˆ«åã€‚æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æœ‰ä¸€ä¸ªåä¸º `self` çš„`Self` ç±»å‹çš„å‚æ•°ï¼Œæ‰€ä»¥ Rust è®©ä½ åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä½ç½®ä¸Šåªç”¨ `self` è¿™ä¸ªåå­—æ¥ç¼©å†™ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦åœ¨ `self` å‰é¢ä½¿ç”¨ `&` æ¥è¡¨ç¤ºè¿™ä¸ªæ–¹æ³•å€Ÿç”¨äº† `Self` å®ä¾‹ã€‚æ–¹æ³•å¯ä»¥é€‰æ‹©è·å¾— `self` çš„æ‰€æœ‰æƒï¼Œæˆ–è€…åƒæˆ‘ä»¬è¿™é‡Œä¸€æ ·ä¸å¯å˜åœ°å€Ÿç”¨ `self`ï¼Œæˆ–è€…å¯å˜åœ°å€Ÿç”¨ `self`ï¼Œå°±è·Ÿå…¶ä»–å‚æ•°ä¸€æ ·ã€‚

#### è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨ğŸ§

åœ¨ C/C++ è¯­è¨€ä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„è¿ç®—ç¬¦æ¥è°ƒç”¨æ–¹æ³•ï¼š`.` ç›´æ¥åœ¨å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•ï¼Œè€Œ `->` åœ¨ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆä¸Šè°ƒç”¨æ–¹æ³•ï¼Œè¿™æ—¶éœ€è¦å…ˆè§£å¼•ç”¨ï¼ˆdereferenceï¼‰æŒ‡é’ˆã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœ `object` æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆ `object->something()` å°±åƒ `(*object).something()` ä¸€æ ·ã€‚

Rust å¹¶æ²¡æœ‰ä¸€ä¸ªä¸ `->` ç­‰æ•ˆçš„è¿ç®—ç¬¦ï¼›ç›¸åï¼ŒRust æœ‰ä¸€ä¸ªå« **è‡ªåŠ¨å¼•ç”¨å’Œè§£å¼•ç”¨**ï¼ˆ*automatic referencing and dereferencing*ï¼‰çš„åŠŸèƒ½ã€‚æ–¹æ³•è°ƒç”¨æ˜¯ Rust ä¸­å°‘æ•°å‡ ä¸ªæ‹¥æœ‰è¿™ç§è¡Œä¸ºçš„åœ°æ–¹ã€‚

å®ƒæ˜¯è¿™æ ·å·¥ä½œçš„ï¼šå½“ä½¿ç”¨ `object.something()` è°ƒç”¨æ–¹æ³•æ—¶ï¼ŒRust ä¼šè‡ªåŠ¨ä¸º `object` æ·»åŠ  `&`ã€`&mut` æˆ– `*` ä»¥ä¾¿ä½¿ `object` ä¸æ–¹æ³•ç­¾ååŒ¹é…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›ä»£ç æ˜¯ç­‰ä»·çš„ï¼š

```rust
p1.distance(&p2);
(&p1).distance(&p2);
```

ç¬¬ä¸€è¡Œçœ‹èµ·æ¥ç®€æ´çš„å¤šã€‚è¿™ç§è‡ªåŠ¨å¼•ç”¨çš„è¡Œä¸ºä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºæ–¹æ³•æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ¥æ”¶è€…â€”â€”â€”â€” `self` çš„ç±»å‹ã€‚åœ¨ç»™å‡ºæ¥æ”¶è€…å’Œæ–¹æ³•åçš„å‰æä¸‹ï¼ŒRust å¯ä»¥æ˜ç¡®åœ°è®¡ç®—å‡ºæ–¹æ³•æ˜¯ä»…ä»…è¯»å–ï¼ˆ`&self`ï¼‰ï¼Œåšå‡ºä¿®æ”¹ï¼ˆ`&mut self`ï¼‰æˆ–è€…æ˜¯è·å–æ‰€æœ‰æƒï¼ˆ`self`ï¼‰ã€‚äº‹å®ä¸Šï¼ŒRust å¯¹æ–¹æ³•æ¥æ”¶è€…çš„éšå¼å€Ÿç”¨è®©æ‰€æœ‰æƒåœ¨å®è·µä¸­æ›´å‹å¥½ã€‚

#### å…³è”å‡½æ•°å’Œæ„é€ å‡½æ•°

æ‰€æœ‰åœ¨ `impl` å—ä¸­å®šä¹‰çš„å‡½æ•°è¢«ç§°ä¸º **å…³è”å‡½æ•°**ï¼ˆ*associated functions*ï¼‰ï¼Œå› ä¸ºå®ƒä»¬ä¸ `impl` åé¢å‘½åçš„ç±»å‹ç›¸å…³ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸ä»¥ `self` ä¸ºç¬¬ä¸€å‚æ•°çš„å…³è”å‡½æ•°ï¼ˆå› æ­¤ä¸æ˜¯æ–¹æ³•ï¼‰ï¼Œå› ä¸ºå®ƒä»¬å¹¶ä¸ä½œç”¨äºä¸€ä¸ªç»“æ„ä½“çš„å®ä¾‹ã€‚æˆ‘ä»¬å·²ç»ä½¿ç”¨äº†ä¸€ä¸ªè¿™æ ·çš„å‡½æ•°ï¼šåœ¨ `String` ç±»å‹ä¸Šå®šä¹‰çš„ `String::from` å‡½æ•°ã€‚

ä¸æ˜¯æ–¹æ³•çš„å…³è”å‡½æ•°ç»å¸¸è¢«ç”¨ä½œè¿”å›ä¸€ä¸ªç»“æ„ä½“æ–°å®ä¾‹çš„æ„é€ å‡½æ•°ã€‚è¿™äº›å‡½æ•°çš„åç§°é€šå¸¸ä¸º `new` ï¼Œä½† `new` å¹¶ä¸æ˜¯ä¸€ä¸ªå…³é”®å­—ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªå«åš `square` å…³è”å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªç»´åº¦å‚æ•°å¹¶ä¸”åŒæ—¶ä½œä¸ºå®½å’Œé«˜ï¼Œè¿™æ ·å¯ä»¥æ›´è½»æ¾çš„åˆ›å»ºä¸€ä¸ªæ­£æ–¹å½¢ `Rectangle` è€Œä¸å¿…æŒ‡å®šä¸¤æ¬¡åŒæ ·çš„å€¼ï¼š

æ–‡ä»¶åï¼šsrc/main.rs

```rust
impl Rectangle {
    fn square(size: u32) -> Self {
        Self {
            width: size,
            height: size,
        }
    }
}
```

å…³é”®å­— `Self` åœ¨å‡½æ•°çš„è¿”å›ç±»å‹ä¸­ä»£æŒ‡åœ¨ `impl` å…³é”®å­—åå‡ºç°çš„ç±»å‹ï¼Œåœ¨è¿™é‡Œæ˜¯ `Rectangle`ã€‚

ä½¿ç”¨ç»“æ„ä½“åå’Œ `::` è¯­æ³•æ¥è°ƒç”¨è¿™ä¸ªå…³è”å‡½æ•°ï¼šæ¯”å¦‚ `let sq = Rectangle::square(3);`ã€‚è¿™ä¸ªå‡½æ•°ä½äºç»“æ„ä½“çš„å‘½åç©ºé—´ä¸­ï¼š`::` è¯­æ³•ç”¨äºå…³è”å‡½æ•°å’Œæ¨¡å—åˆ›å»ºçš„å‘½åç©ºé—´ã€‚

### æšä¸¾

#### enumæšä¸¾

å¯ä»¥é€šè¿‡åœ¨ä»£ç ä¸­å®šä¹‰ä¸€ä¸ª `IpAddrKind` æšä¸¾æ¥è¡¨ç°è¿™ä¸ªæ¦‚å¿µå¹¶åˆ—å‡ºå¯èƒ½çš„ IP åœ°å€ç±»å‹ï¼Œ`V4` å’Œ `V6`ã€‚è¿™è¢«ç§°ä¸ºæšä¸¾çš„ **æˆå‘˜**ï¼ˆ*variants*ï¼‰ï¼š

```rust
enum IpAddrKind {
    V4,
    V6,
}
```

ç°åœ¨ `IpAddrKind` å°±æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ä»£ç ä¸­ä½¿ç”¨çš„è‡ªå®šä¹‰æ•°æ®ç±»å‹äº†ã€‚

å¯ä»¥åƒè¿™æ ·åˆ›å»º `IpAddrKind` ä¸¤ä¸ªä¸åŒæˆå‘˜çš„å®ä¾‹ï¼š

```rust
    let four = IpAddrKind::V4;
    let six = IpAddrKind::V6;
```

æˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥å°†æ•°æ®é™„åŠ åˆ°æšä¸¾çš„æ¯ä¸ªæˆå‘˜ä¸Šï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸€ä¸ªé¢å¤–çš„ç»“æ„ä½“äº†ã€‚è¿™é‡Œä¹Ÿå¾ˆå®¹æ˜“çœ‹å‡ºæšä¸¾å·¥ä½œçš„å¦ä¸€ä¸ªç»†èŠ‚ï¼šæ¯ä¸€ä¸ªæˆ‘ä»¬å®šä¹‰çš„æšä¸¾æˆå‘˜çš„åå­—ä¹Ÿå˜æˆäº†ä¸€ä¸ªæ„å»ºæšä¸¾çš„å®ä¾‹çš„å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`IpAddr::V4()` æ˜¯ä¸€ä¸ªè·å– `String` å‚æ•°å¹¶è¿”å› `IpAddr` ç±»å‹å®ä¾‹çš„å‡½æ•°è°ƒç”¨ã€‚ä½œä¸ºå®šä¹‰æšä¸¾çš„ç»“æœï¼Œè¿™äº›æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨è¢«å®šä¹‰ã€‚

`IpAddr` æšä¸¾çš„æ–°å®šä¹‰è¡¨æ˜äº† `V4` å’Œ `V6` æˆå‘˜éƒ½å…³è”äº† `String` å€¼ï¼š

```rust
    enum IpAddr {
        V4(String),
        V6(String),
    }

    let home = IpAddr::V4(String::from("127.0.0.1"));

    let loopback = IpAddr::V6(String::from("::1"));
```

ç”¨æšä¸¾æ›¿ä»£ç»“æ„ä½“è¿˜æœ‰å¦ä¸€ä¸ªä¼˜åŠ¿ï¼šæ¯ä¸ªæˆå‘˜å¯ä»¥å¤„ç†ä¸åŒç±»å‹å’Œæ•°é‡çš„æ•°æ®ã€‚IPv4 ç‰ˆæœ¬çš„ IP åœ°å€æ€»æ˜¯å«æœ‰å››ä¸ªå€¼åœ¨ 0 å’Œ 255 ä¹‹é—´çš„æ•°å­—éƒ¨åˆ†ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å°† `V4` åœ°å€å­˜å‚¨ä¸ºå››ä¸ª `u8` å€¼è€Œ `V6` åœ°å€ä»ç„¶è¡¨ç°ä¸ºä¸€ä¸ª `String`ï¼Œè¿™å°±ä¸èƒ½ä½¿ç”¨ç»“æ„ä½“äº†ã€‚æšä¸¾åˆ™å¯ä»¥è½»æ˜“çš„å¤„ç†è¿™ä¸ªæƒ…å†µï¼š

```rust
    enum IpAddr {
        V4(u8, u8, u8, u8),
        V6(String),
    }

    let home = IpAddr::V4(127, 0, 0, 1);

    let loopback = IpAddr::V6(String::from("::1"));
```

æˆ‘ä»¬å¯ä»¥å°†ä»»æ„ç±»å‹çš„æ•°æ®æ”¾å…¥æšä¸¾æˆå‘˜ä¸­ï¼šä¾‹å¦‚å­—ç¬¦ä¸²ã€æ•°å­—ç±»å‹æˆ–è€…ç»“æ„ä½“ã€‚ç”šè‡³å¯ä»¥åŒ…å«å¦ä¸€ä¸ªæšä¸¾ï¼

```rust
enum Message {
    Quit,
    Move { x: i32, y: i32 },
    Write(String),
    ChangeColor(i32, i32, i32),
}
```

ç»“æ„ä½“å’Œæšä¸¾è¿˜æœ‰å¦ä¸€ä¸ªç›¸ä¼¼ç‚¹ï¼šå°±åƒå¯ä»¥ä½¿ç”¨ `impl` æ¥ä¸ºç»“æ„ä½“å®šä¹‰æ–¹æ³•é‚£æ ·ï¼Œä¹Ÿå¯ä»¥åœ¨æšä¸¾ä¸Šå®šä¹‰æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªå®šä¹‰äºæˆ‘ä»¬ `Message` æšä¸¾ä¸Šçš„å«åš `call` çš„æ–¹æ³•ï¼š

```rust
enum Message {
    Quit,
    Move { x: i32, y: i32 },
    Write(String),
    ChangeColor(i32, i32, i32),
}    

impl Message {
    fn call(&self) {
       // åœ¨è¿™é‡Œå®šä¹‰æ–¹æ³•ä½“
    }
}

let m = Message::Write(String::from("hello"));
m.call();
```

æ–¹æ³•ä½“ä½¿ç”¨äº† `self` æ¥è·å–è°ƒç”¨æ–¹æ³•çš„å€¼ã€‚è¿™ä¸ªä¾‹å­ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå€¼ä¸º `Message::Write(String::from("hello"))` çš„å˜é‡ `m`ï¼Œè€Œä¸”è¿™å°±æ˜¯å½“ `m.call()` è¿è¡Œæ—¶ `call` æ–¹æ³•ä¸­çš„ `self` çš„å€¼ã€‚

#### Optionæšä¸¾ğŸ§

`Option` æ˜¯æ ‡å‡†åº“å®šä¹‰çš„å¦ä¸€ä¸ªæšä¸¾ã€‚`Option` ç±»å‹åº”ç”¨å¹¿æ³›å› ä¸ºå®ƒç¼–ç äº†ä¸€ä¸ªéå¸¸æ™®éçš„åœºæ™¯ï¼Œå³ä¸€ä¸ªå€¼è¦ä¹ˆæœ‰å€¼è¦ä¹ˆæ²¡å€¼ã€‚

ğŸ§**Rust å¹¶æ²¡æœ‰å¾ˆå¤šå…¶ä»–è¯­è¨€ä¸­æœ‰çš„ç©ºå€¼åŠŸèƒ½**ã€‚**ç©ºå€¼**ï¼ˆ*Null* ï¼‰æ˜¯ä¸€ä¸ªå€¼ï¼Œå®ƒä»£è¡¨æ²¡æœ‰å€¼ã€‚åœ¨æœ‰ç©ºå€¼çš„è¯­è¨€ä¸­ï¼Œå˜é‡æ€»æ˜¯è¿™ä¸¤ç§çŠ¶æ€ä¹‹ä¸€ï¼šç©ºå€¼å’Œéç©ºå€¼ã€‚Rust æ²¡æœ‰ç©ºå€¼ï¼Œä¸è¿‡å®ƒç¡®å®æ‹¥æœ‰ä¸€ä¸ªå¯ä»¥ç¼–ç å­˜åœ¨æˆ–ä¸å­˜åœ¨æ¦‚å¿µçš„æšä¸¾ã€‚è¿™ä¸ªæšä¸¾æ˜¯ `Option<T>`ï¼Œè€Œä¸”å®ƒ[å®šä¹‰äºæ ‡å‡†åº“ä¸­](https://doc.rust-lang.org/std/option/enum.Option.html)ï¼Œå¦‚ä¸‹ï¼š

```rust
enum Option<T> {
    None,
    Some(T),
}
```

`Option<T>` æšä¸¾æ˜¯å¦‚æ­¤æœ‰ç”¨ä»¥è‡³äºå®ƒç”šè‡³è¢«åŒ…å«åœ¨äº† prelude ä¹‹ä¸­ï¼Œä½ ä¸éœ€è¦å°†å…¶æ˜¾å¼å¼•å…¥ä½œç”¨åŸŸã€‚å¦å¤–ï¼Œå®ƒçš„æˆå‘˜ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¯ä»¥ä¸éœ€è¦ `Option::` å‰ç¼€æ¥ç›´æ¥ä½¿ç”¨ `Some` å’Œ `None`ã€‚å³ä¾¿å¦‚æ­¤ `Option<T>` ä¹Ÿä»æ˜¯å¸¸è§„çš„æšä¸¾ï¼Œ`Some(T)` å’Œ `None` ä»æ˜¯ `Option<T>` çš„æˆå‘˜ã€‚

`Option` å€¼çš„ä¾‹å­ï¼š

```rust
    let some_number = Some(5);
    let some_char = Some('e');

    let absent_number: Option<i32> = None;
```

å¯¹äº `absent_number`ï¼ŒRust éœ€è¦æˆ‘ä»¬æŒ‡å®š `Option` æ•´ä½“çš„ç±»å‹ï¼Œå› ä¸ºç¼–è¯‘å™¨åªé€šè¿‡ `None` å€¼æ— æ³•æ¨æ–­å‡º `Some` æˆå‘˜ä¿å­˜çš„å€¼çš„ç±»å‹ã€‚

å¦‚æœè¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œå°†å¾—åˆ°é”™è¯¯ä¿¡æ¯ï¼š

```rust
    let x: i8 = 5;
    let y: Option<i8> = Some(5);

    let sum = x + y;
```

```console
$ cargo run
   Compiling enums v0.1.0 (file:///projects/enums)
error[E0277]: cannot add `Option<i8>` to `i8`
 --> src/main.rs:5:17
  |
5 |     let sum = x + y;
  |                 ^ no implementation for `i8 + Option<i8>`
  |
  = help: the trait `Add<Option<i8>>` is not implemented for `i8`
  = help: the following other types implement trait `Add<Rhs>`:
            <&'a f32 as Add<f32>>
            <&'a f64 as Add<f64>>
            <&'a i128 as Add<i128>>
            <&'a i16 as Add<i16>>
            <&'a i32 as Add<i32>>
            <&'a i64 as Add<i64>>
            <&'a i8 as Add<i8>>
            <&'a isize as Add<isize>>
          and 48 others

For more information about this error, try `rustc --explain E0277`.
error: could not compile `enums` due to previous error
```

é”™è¯¯ä¿¡æ¯æ„å‘³ç€ Rust ä¸çŸ¥é“è¯¥å¦‚ä½•å°† `Option<i8>` ä¸ `i8` ç›¸åŠ ï¼Œå› ä¸ºå®ƒä»¬çš„ç±»å‹ä¸åŒã€‚å½“åœ¨ Rust ä¸­æ‹¥æœ‰ä¸€ä¸ªåƒ `i8` è¿™æ ·ç±»å‹çš„å€¼æ—¶ï¼Œç¼–è¯‘å™¨ç¡®ä¿å®ƒæ€»æ˜¯æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å€¼ã€‚æˆ‘ä»¬å¯ä»¥è‡ªä¿¡ä½¿ç”¨è€Œæ— éœ€åšç©ºå€¼æ£€æŸ¥ã€‚**åªæœ‰å½“ä½¿ç”¨ `Option<T>`çš„æ—¶å€™éœ€è¦æ‹…å¿ƒå¯èƒ½æ²¡æœ‰å€¼**ï¼Œè€Œç¼–è¯‘å™¨ä¼šç¡®ä¿æˆ‘ä»¬åœ¨ä½¿ç”¨å€¼ä¹‹å‰å¤„ç†äº†ä¸ºç©ºçš„æƒ…å†µã€‚æ¢å¥è¯è¯´ï¼Œ**åœ¨å¯¹ `Option<T>` è¿›è¡Œè¿ç®—ä¹‹å‰å¿…é¡»å°†å…¶è½¬æ¢ä¸º `T`**ã€‚é€šå¸¸è¿™èƒ½å¸®åŠ©æˆ‘ä»¬æ•è·åˆ°ç©ºå€¼æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ï¼šå‡è®¾æŸå€¼ä¸ä¸ºç©ºä½†å®é™…ä¸Šä¸ºç©ºçš„æƒ…å†µã€‚

æ€»çš„æ¥è¯´ï¼Œä¸ºäº†ä½¿ç”¨ `Option<T>` å€¼ï¼Œéœ€è¦ç¼–å†™å¤„ç†æ¯ä¸ªæˆå‘˜çš„ä»£ç ã€‚ä½ æƒ³è¦ä¸€äº›ä»£ç åªå½“æ‹¥æœ‰ `Some(T)` å€¼æ—¶è¿è¡Œï¼Œå…è®¸è¿™äº›ä»£ç ä½¿ç”¨å…¶ä¸­çš„ `T`ã€‚ä¹Ÿå¸Œæœ›ä¸€äº›ä»£ç åªåœ¨å€¼ä¸º `None` æ—¶è¿è¡Œï¼Œè¿™äº›ä»£ç å¹¶æ²¡æœ‰ä¸€ä¸ªå¯ç”¨çš„ `T` å€¼ã€‚`match` è¡¨è¾¾å¼å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªå¤„ç†æšä¸¾çš„æ§åˆ¶æµç»“æ„ï¼šå®ƒä¼šæ ¹æ®æšä¸¾çš„æˆå‘˜è¿è¡Œä¸åŒçš„ä»£ç ï¼Œè¿™äº›ä»£ç å¯ä»¥ä½¿ç”¨åŒ¹é…åˆ°çš„å€¼ä¸­çš„æ•°æ®ã€‚

#### matchæ§åˆ¶æµğŸ§

Rust æœ‰ä¸€ä¸ªå«åš `match` çš„æä¸ºå¼ºå¤§çš„æ§åˆ¶æµè¿ç®—ç¬¦ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†ä¸€ä¸ªå€¼ä¸ä¸€ç³»åˆ—çš„æ¨¡å¼ç›¸æ¯”è¾ƒï¼Œå¹¶æ ¹æ®ç›¸åŒ¹é…çš„æ¨¡å¼æ‰§è¡Œç›¸åº”ä»£ç ã€‚æ¨¡å¼å¯ç”±å­—é¢å€¼ã€å˜é‡ã€é€šé…ç¬¦å’Œè®¸å¤šå…¶ä»–å†…å®¹æ„æˆã€‚

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è·å–ä¸€ä¸ªæœªçŸ¥çš„ç¡¬å¸ï¼Œå¹¶ä»¥ä¸€ç§ç±»ä¼¼éªŒé’æœºçš„æ–¹å¼ï¼Œç¡®å®šå®ƒæ˜¯ä½•ç§ç¡¬å¸å¹¶è¿”å›å®ƒçš„ç¾åˆ†å€¼ï¼š

```rust
enum Coin {
    Penny,
    Nickel,
    Dime,
    Quarter,
}

fn value_in_cents(coin: Coin) -> u8 {
    match coin {
        Coin::Penny => 1,
        Coin::Nickel => 5,
        Coin::Dime => 10,
        Coin::Quarter => 25,
    }
}
```

æˆ‘ä»¬åˆ—å‡º `match` å…³é”®å­—åè·Ÿä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ `coin` çš„å€¼ã€‚è¿™çœ‹èµ·æ¥éå¸¸åƒ `if` æ‰€ä½¿ç”¨çš„æ¡ä»¶è¡¨è¾¾å¼ï¼Œä¸è¿‡è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å¤§çš„åŒºåˆ«ï¼š**å¯¹äº `if`ï¼Œè¡¨è¾¾å¼å¿…é¡»è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè€Œè¿™é‡Œå®ƒå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„**ã€‚

å½“ `match` è¡¨è¾¾å¼æ‰§è¡Œæ—¶ï¼Œå®ƒå°†ç»“æœå€¼æŒ‰é¡ºåºä¸æ¯ä¸€ä¸ªåˆ†æ”¯çš„æ¨¡å¼ç›¸æ¯”è¾ƒã€‚å¦‚æœæ¨¡å¼åŒ¹é…äº†è¿™ä¸ªå€¼ï¼Œè¿™ä¸ªæ¨¡å¼ç›¸å…³è”çš„ä»£ç å°†è¢«æ‰§è¡Œã€‚å¦‚æœæ¨¡å¼å¹¶ä¸åŒ¹é…è¿™ä¸ªå€¼ï¼Œå°†ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªåˆ†æ”¯ã€‚

å¦‚æœåˆ†æ”¯ä»£ç è¾ƒçŸ­çš„è¯é€šå¸¸ä¸ä½¿ç”¨å¤§æ‹¬å·ï¼Œæ­£å¦‚ç¤ºä¾‹ 6-3 ä¸­çš„æ¯ä¸ªåˆ†æ”¯éƒ½åªæ˜¯è¿”å›ä¸€ä¸ªå€¼ã€‚å¦‚æœæƒ³è¦åœ¨åˆ†æ”¯ä¸­è¿è¡Œå¤šè¡Œä»£ç ï¼Œå¯ä»¥ä½¿ç”¨å¤§æ‹¬å·ï¼Œè€Œåˆ†æ”¯åçš„é€—å·æ˜¯å¯é€‰çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚ä¸‹ä»£ç åœ¨æ¯æ¬¡ä½¿ç”¨`Coin::Penny` è°ƒç”¨æ—¶éƒ½ä¼šæ‰“å°å‡º â€œLucky penny!â€ï¼ŒåŒæ—¶ä»ç„¶è¿”å›ä»£ç å—æœ€åçš„å€¼ï¼Œ`1`ï¼š

```rust
fn value_in_cents(coin: Coin) -> u8 {
    match coin {
        Coin::Penny => {
            println!("Lucky penny!");
            1
        }
        Coin::Nickel => 5,
        Coin::Dime => 10,
        Coin::Quarter => 25,
    }
}
```

##### ç»‘å®šå€¼çš„æ¨¡å¼

  åŒ¹é…åˆ†æ”¯çš„å¦ä¸€ä¸ªæœ‰ç”¨çš„åŠŸèƒ½æ˜¯å¯ä»¥ç»‘å®šåŒ¹é…çš„æ¨¡å¼çš„éƒ¨åˆ†å€¼ã€‚è¿™ä¹Ÿå°±æ˜¯å¦‚ä½•ä»æšä¸¾æˆå‘˜ä¸­æå–å€¼çš„ã€‚

  ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹æšä¸¾çš„ä¸€ä¸ªæˆå‘˜æ¥å­˜æ”¾æ•°æ®ã€‚1999 å¹´åˆ° 2008 å¹´é—´ï¼Œç¾å›½åœ¨ 25 ç¾åˆ†çš„ç¡¬å¸çš„ä¸€ä¾§ä¸º 50 ä¸ªå·çš„æ¯ä¸€ä¸ªéƒ½å°åˆ·äº†ä¸åŒçš„è®¾è®¡ã€‚å…¶ä»–çš„ç¡¬å¸éƒ½æ²¡æœ‰è¿™ç§åŒºåˆ†å·çš„è®¾è®¡ï¼Œæ‰€ä»¥åªæœ‰è¿™äº› 25 ç¾åˆ†ç¡¬å¸æœ‰ç‰¹æ®Šçš„ä»·å€¼ã€‚å¯ä»¥å°†è¿™äº›ä¿¡æ¯åŠ å…¥æˆ‘ä»¬çš„ `enum`ï¼Œé€šè¿‡æ”¹å˜ `Quarter` æˆå‘˜æ¥åŒ…å«ä¸€ä¸ª `State` å€¼ï¼Œç¤ºä¾‹ 6-4 ä¸­å®Œæˆäº†è¿™äº›ä¿®æ”¹ï¼š

  ```rust
#[derive(Debug)] // è¿™æ ·å¯ä»¥ç«‹åˆ»çœ‹åˆ°å·çš„åç§°
enum UsState {
    Alabama,
    Alaska,
    // --snip--
}

enum Coin {
    Penny,
    Nickel,
    Dime,
    Quarter(UsState),
}
  ```

  ç¤ºä¾‹ 6-4ï¼š`Quarter` æˆå‘˜ä¹Ÿå­˜æ”¾äº†ä¸€ä¸ª `UsState` å€¼çš„ `Coin` æšä¸¾

  æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬çš„ä¸€ä¸ªæœ‹å‹å°è¯•æ”¶é›†æ‰€æœ‰ 50 ä¸ªå·çš„ 25 ç¾åˆ†ç¡¬å¸ã€‚åœ¨æ ¹æ®ç¡¬å¸ç±»å‹åˆ†ç±»é›¶é’±çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥æŠ¥å‘Šå‡ºæ¯ä¸ª 25 ç¾åˆ†ç¡¬å¸æ‰€å¯¹åº”çš„å·åç§°ï¼Œè¿™æ ·å¦‚æœæˆ‘ä»¬çš„æœ‹å‹æ²¡æœ‰çš„è¯ï¼Œä»–å¯ä»¥å°†å…¶åŠ å…¥æ”¶è—ã€‚

  åœ¨è¿™äº›ä»£ç çš„åŒ¹é…è¡¨è¾¾å¼ä¸­ï¼Œæˆ‘ä»¬åœ¨åŒ¹é… `Coin::Quarter` æˆå‘˜çš„åˆ†æ”¯çš„æ¨¡å¼ä¸­å¢åŠ äº†ä¸€ä¸ªå«åš `state` çš„å˜é‡ã€‚å½“åŒ¹é…åˆ° `Coin::Quarter` æ—¶ï¼Œå˜é‡ `state` å°†ä¼šç»‘å®š 25 ç¾åˆ†ç¡¬å¸æ‰€å¯¹åº”å·çš„å€¼ã€‚æ¥ç€åœ¨é‚£ä¸ªåˆ†æ”¯çš„ä»£ç ä¸­ä½¿ç”¨ `state`ï¼Œå¦‚ä¸‹ï¼š

  ```rust
fn value_in_cents(coin: Coin) -> u8 {
    match coin {
        Coin::Penny => 1,
        Coin::Nickel => 5,
        Coin::Dime => 10,
        Coin::Quarter(state) => {
            println!("State quarter from {:?}!", state);
            25
        }
    }
}
  ```

  å¦‚æœè°ƒç”¨ `value_in_cents(Coin::Quarter(UsState::Alaska))`ï¼Œ`coin` å°†æ˜¯ `Coin::Quarter(UsState::Alaska)`ã€‚å½“å°†å€¼ä¸æ¯ä¸ªåˆ†æ”¯ç›¸æ¯”è¾ƒæ—¶ï¼Œæ²¡æœ‰åˆ†æ”¯ä¼šåŒ¹é…ï¼Œç›´åˆ°é‡åˆ° `Coin::Quarter(state)`ã€‚è¿™æ—¶ï¼Œ`state` ç»‘å®šçš„å°†ä¼šæ˜¯å€¼ `UsState::Alaska`ã€‚æ¥ç€å°±å¯ä»¥åœ¨ `println!` è¡¨è¾¾å¼ä¸­ä½¿ç”¨è¿™ä¸ªç»‘å®šäº†ï¼Œåƒè¿™æ ·å°±å¯ä»¥è·å– `Coin` æšä¸¾çš„ `Quarter` æˆå‘˜ä¸­å†…éƒ¨çš„å·çš„å€¼ã€‚

##### åŒ¹é… `Option<T>`

```rust
    fn plus_one(x: Option<i32>) -> Option<i32> {
        match x {
            None => None,
            Some(i) => Some(i + 1),
        }
    }

    let five = Some(5);         
    let six = plus_one(five);	// Some(6)
    let none = plus_one(None);  // None
```

##### åŒ¹é…æ˜¯ç©·å°½çš„

  `match` è¿˜æœ‰å¦ä¸€æ–¹é¢éœ€è¦è®¨è®ºï¼šè¿™äº›åˆ†æ”¯å¿…é¡»è¦†ç›–äº†æ‰€æœ‰çš„å¯èƒ½æ€§ã€‚è€ƒè™‘ä¸€ä¸‹ `plus_one` å‡½æ•°çš„è¿™ä¸ªç‰ˆæœ¬ï¼Œå®ƒæœ‰ä¸€ä¸ª bug å¹¶ä¸èƒ½ç¼–è¯‘ï¼š

```rust
    fn plus_one(x: Option<i32>) -> Option<i32> {
        match x {
            Some(i) => Some(i + 1),
        }
    }
```

æˆ‘ä»¬æ²¡æœ‰å¤„ç† `None` çš„æƒ…å†µï¼Œæ‰€ä»¥è¿™äº›ä»£ç ä¼šé€ æˆä¸€ä¸ª bugã€‚

##### é€šé…æ¨¡å¼å’Œ `_` å ä½ç¬¦

  è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹ä¸€äº›ç‰¹å®šçš„å€¼é‡‡å–ç‰¹æ®Šæ“ä½œï¼Œè€Œå¯¹å…¶ä»–çš„å€¼é‡‡å–é»˜è®¤æ“ä½œã€‚æƒ³è±¡æˆ‘ä»¬æ­£åœ¨ç©ä¸€ä¸ªæ¸¸æˆï¼Œå¦‚æœä½ æ·å‡ºéª°å­çš„å€¼ä¸º 3ï¼Œè§’è‰²ä¸ä¼šç§»åŠ¨ï¼Œè€Œæ˜¯ä¼šå¾—åˆ°ä¸€é¡¶æ–°å¥‡çš„å¸½å­ã€‚å¦‚æœä½ æ·å‡ºäº† 7ï¼Œä½ çš„è§’è‰²å°†å¤±å»æ–°å¥‡çš„å¸½å­ã€‚å¯¹äºå…¶ä»–çš„æ•°å€¼ï¼Œä½ çš„è§’è‰²ä¼šåœ¨æ£‹ç›˜ä¸Šç§»åŠ¨ç›¸åº”çš„æ ¼å­ã€‚è¿™æ˜¯ä¸€ä¸ªå®ç°äº†ä¸Šè¿°é€»è¾‘çš„ `match`ï¼Œéª°å­çš„ç»“æœæ˜¯ç¡¬ç¼–ç è€Œä¸æ˜¯ä¸€ä¸ªéšæœºå€¼ï¼Œå…¶ä»–çš„é€»è¾‘éƒ¨åˆ†ä½¿ç”¨äº†æ²¡æœ‰å‡½æ•°ä½“çš„å‡½æ•°æ¥è¡¨ç¤ºï¼Œå®ç°å®ƒä»¬è¶…å‡ºäº†æœ¬ä¾‹çš„èŒƒå›´ï¼š

  ```rust
    let dice_roll = 9;
    match dice_roll {
        3 => add_fancy_hat(),
        7 => remove_fancy_hat(),
        other => move_player(other),
    }

    fn add_fancy_hat() {}
    fn remove_fancy_hat() {}
    fn move_player(num_spaces: u8) {}
  ```

  å¯¹äºå‰ä¸¤ä¸ªåˆ†æ”¯ï¼ŒåŒ¹é…æ¨¡å¼æ˜¯å­—é¢å€¼ `3` å’Œ `7`ï¼Œæœ€åä¸€ä¸ªåˆ†æ”¯åˆ™æ¶µç›–äº†æ‰€æœ‰å…¶ä»–å¯èƒ½çš„å€¼ï¼Œæ¨¡å¼æ˜¯æˆ‘ä»¬å‘½åä¸º `other` çš„ä¸€ä¸ªå˜é‡ã€‚`other` åˆ†æ”¯çš„ä»£ç é€šè¿‡å°†å…¶ä¼ é€’ç»™ `move_player` å‡½æ•°æ¥ä½¿ç”¨è¿™ä¸ªå˜é‡ã€‚

  å³ä½¿æˆ‘ä»¬æ²¡æœ‰åˆ—å‡º `u8` æ‰€æœ‰å¯èƒ½çš„å€¼ï¼Œè¿™æ®µä»£ç ä¾ç„¶èƒ½å¤Ÿç¼–è¯‘ï¼Œå› ä¸ºæœ€åä¸€ä¸ªæ¨¡å¼å°†åŒ¹é…æ‰€æœ‰æœªè¢«ç‰¹æ®Šåˆ—å‡ºçš„å€¼ã€‚è¿™ç§é€šé…æ¨¡å¼æ»¡è¶³äº† `match` å¿…é¡»è¢«ç©·å°½çš„è¦æ±‚ã€‚è¯·æ³¨æ„ï¼Œ**æˆ‘ä»¬å¿…é¡»å°†é€šé…åˆ†æ”¯æ”¾åœ¨æœ€åï¼Œå› ä¸ºæ¨¡å¼æ˜¯æŒ‰é¡ºåºåŒ¹é…çš„**ã€‚

  Rust è¿˜æä¾›äº†ä¸€ä¸ªæ¨¡å¼ï¼Œå½“æˆ‘ä»¬ä¸æƒ³ä½¿ç”¨é€šé…æ¨¡å¼è·å–çš„å€¼æ—¶ï¼Œè¯·ä½¿ç”¨ `_` ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¨¡å¼ï¼Œå¯ä»¥åŒ¹é…ä»»æ„å€¼è€Œä¸ç»‘å®šåˆ°è¯¥å€¼ã€‚è¿™å‘Šè¯‰ Rust æˆ‘ä»¬ä¸ä¼šä½¿ç”¨è¿™ä¸ªå€¼ï¼Œæ‰€ä»¥ Rust ä¹Ÿä¸ä¼šè­¦å‘Šæˆ‘ä»¬å­˜åœ¨æœªä½¿ç”¨çš„å˜é‡ã€‚

  è®©æˆ‘ä»¬æ”¹å˜æ¸¸æˆè§„åˆ™ï¼šç°åœ¨ï¼Œå½“ä½ æ·å‡ºçš„å€¼ä¸æ˜¯ 3 æˆ– 7 çš„æ—¶å€™ï¼Œä½ å¿…é¡»å†æ¬¡æ·å‡ºã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨è¿™ä¸ªå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ”¹åŠ¨ä»£ç ä½¿ç”¨ `_` æ¥æ›¿ä»£å˜é‡ `other` ï¼š

  ```rust
    let dice_roll = 9;
    match dice_roll {
        3 => add_fancy_hat(),
        7 => remove_fancy_hat(),
        _ => reroll(),
    }

    fn add_fancy_hat() {}
    fn remove_fancy_hat() {}
    fn reroll() {}
  ```

- **`if let` ç®€æ´æ§åˆ¶æµ** 

  è€ƒè™‘ä¸‹é¢çš„ç¨‹åºï¼Œå®ƒåŒ¹é…ä¸€ä¸ª `config_max` å˜é‡ä¸­çš„ `Option<u8>` å€¼å¹¶åªå¸Œæœ›å½“å€¼ä¸º `Some` æˆå‘˜æ—¶æ‰§è¡Œä»£ç ï¼š

  ```rust
      let config_max = Some(3u8);
      match config_max {
          Some(max) => println!("The maximum is configured to be {}", max),
          _ => (),
      }
  ```

  æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `if let` è¿™ç§æ›´çŸ­çš„æ–¹å¼ç¼–å†™ã€‚`if let` æ˜¯ `match` çš„ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå®ƒå½“å€¼åŒ¹é…æŸä¸€æ¨¡å¼æ—¶æ‰§è¡Œä»£ç è€Œå¿½ç•¥æ‰€æœ‰å…¶ä»–å€¼ã€‚å¦‚ä¸‹ä»£ç ä¸Šé¢çš„ `match` è¡Œä¸ºä¸€è‡´ï¼š

  ```rust
  	let config_max = Some(3u8);
  	if let Some(max) = config_max {
     		println!("The maximum is configured to be {}", max);
  	}
  ```

  å¯ä»¥åœ¨ `if let` ä¸­åŒ…å«ä¸€ä¸ª `else`ã€‚`else` å—ä¸­çš„ä»£ç ä¸ `match` è¡¨è¾¾å¼ä¸­çš„ `_` åˆ†æ”¯å—ä¸­çš„ä»£ç ç›¸åŒï¼Œè¿™æ ·çš„ `match` è¡¨è¾¾å¼å°±ç­‰åŒäº `if let` å’Œ `else`ï¼š

  ```rust
      let mut count = 0;
      match coin {
          Coin::Quarter(state) => println!("State quarter from {:?}!", state),
          _ => count += 1,
      }
  ```

  ç­‰ä»·äºï¼š

  ```rust
  	let mut count = 0;
  	if let Coin::Quarter(state) = coin {
      	println!("State quarter from {:?}!", state);
  	} else {
      	count += 1;
  	}
  ```

##### å¼•ç”¨è§£æ„ğŸ¤”

    1. ğŸŒŸğŸŒŸ ä½¿ç”¨æ¨¡å¼ `&mut V` å»åŒ¹é…ä¸€ä¸ªå¯å˜å¼•ç”¨æ—¶ï¼Œä½ éœ€è¦æ ¼å¤–å°å¿ƒï¼Œå› ä¸ºåŒ¹é…å‡ºæ¥çš„ `V` æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯å¯å˜å¼•ç”¨

  ```rust
fn main() {
    let mut v = String::from("hello,");
    let r = &mut v;

    match r {
     &mut value => value.push_str(" world!") // æ­¤å¤„valueè¢«è§£æ„ä¸ºä¸å¯å˜Stringç±»å‹ï¼ŒæŠ¥é”™
    }
}
  ```

### æ¨¡å—ç³»ç»Ÿ

Rust æœ‰è®¸å¤šåŠŸèƒ½å¯ä»¥è®©ä½ ç®¡ç†ä»£ç çš„ç»„ç»‡ï¼ŒåŒ…æ‹¬å“ªäº›å†…å®¹å¯ä»¥è¢«å…¬å¼€ï¼Œå“ªäº›å†…å®¹ä½œä¸ºç§æœ‰éƒ¨åˆ†ï¼Œä»¥åŠç¨‹åºæ¯ä¸ªä½œç”¨åŸŸä¸­çš„åå­—ã€‚è¿™äº›åŠŸèƒ½ã€‚è¿™æœ‰æ—¶è¢«ç§°ä¸º â€œæ¨¡å—ç³»ç»Ÿï¼ˆthe module systemï¼‰â€ï¼ŒåŒ…æ‹¬ï¼š

- **åŒ…**ï¼ˆ*Packages*ï¼‰ï¼šCargo çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ æ„å»ºã€æµ‹è¯•å’Œåˆ†äº« crateã€‚
- **Crates** ï¼šä¸€ä¸ªæ¨¡å—çš„æ ‘å½¢ç»“æ„ï¼Œå®ƒå½¢æˆäº†åº“æˆ–äºŒè¿›åˆ¶é¡¹ç›®ã€‚
- **æ¨¡å—**ï¼ˆ*Modules*ï¼‰å’Œ **use**ï¼šå…è®¸ä½ æ§åˆ¶ä½œç”¨åŸŸå’Œè·¯å¾„çš„ç§æœ‰æ€§ã€‚
- **è·¯å¾„**ï¼ˆ*path*ï¼‰ï¼šä¸€ä¸ªå‘½åä¾‹å¦‚ç»“æ„ä½“ã€å‡½æ•°æˆ–æ¨¡å—ç­‰é¡¹çš„æ–¹å¼

æœ¬ç« å°†ä¼šæ¶µç›–æ‰€æœ‰è¿™äº›æ¦‚å¿µï¼Œè®¨è®ºå®ƒä»¬å¦‚ä½•äº¤äº’ï¼Œå¹¶è¯´æ˜å¦‚ä½•ä½¿ç”¨å®ƒä»¬æ¥ç®¡ç†ä½œç”¨åŸŸã€‚åˆ°æœ€åï¼Œä½ ä¼šå¯¹æ¨¡å—ç³»ç»Ÿæœ‰æ·±å…¥çš„äº†è§£ï¼Œå¹¶ä¸”èƒ½å¤Ÿåƒä¸“ä¸šäººå£«ä¸€æ ·ä½¿ç”¨ä½œç”¨åŸŸï¼

#### åŒ…å’ŒCrate

**crate æ˜¯ Rust åœ¨ç¼–è¯‘æ—¶æœ€å°çš„ä»£ç å•ä½ã€‚**å¦‚æœä½ ç”¨ `rustc` è€Œä¸æ˜¯ `cargo` æ¥ç¼–è¯‘ä¸€ä¸ªæ–‡ä»¶ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šå°†é‚£ä¸ªæ–‡ä»¶è®¤ä½œä¸€ä¸ª crateã€‚crate å¯ä»¥åŒ…å«æ¨¡å—ï¼Œæ¨¡å—å¯ä»¥å®šä¹‰åœ¨å…¶ä»–æ–‡ä»¶ï¼Œç„¶åå’Œ crate ä¸€èµ·ç¼–è¯‘ã€‚

crate æœ‰ä¸¤ç§å½¢å¼ï¼š**äºŒè¿›åˆ¶é¡¹**å’Œ**åº“**ã€‚

**äºŒè¿›åˆ¶é¡¹** å¯ä»¥è¢«ç¼–è¯‘ä¸ºå¯æ‰§è¡Œç¨‹åºï¼Œæ¯”å¦‚ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åºæˆ–è€…ä¸€ä¸ªæœåŠ¡å™¨ã€‚å®ƒä»¬å¿…é¡»æœ‰ä¸€ä¸ª `main` å‡½æ•°æ¥å®šä¹‰å½“ç¨‹åºè¢«æ‰§è¡Œçš„æ—¶å€™æ‰€éœ€è¦åšçš„äº‹æƒ…ã€‚ç›®å‰æˆ‘ä»¬æ‰€åˆ›å»ºçš„ crate éƒ½æ˜¯äºŒè¿›åˆ¶é¡¹ã€‚

**åº“** å¹¶æ²¡æœ‰ `main` å‡½æ•°ï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šç¼–è¯‘ä¸ºå¯æ‰§è¡Œç¨‹åºï¼Œå®ƒä»¬æä¾›ä¸€äº›è¯¸å¦‚å‡½æ•°ä¹‹ç±»çš„ä¸œè¥¿ï¼Œä½¿å…¶ä»–é¡¹ç›®ä¹Ÿèƒ½ä½¿ç”¨è¿™äº›ä¸œè¥¿ã€‚æ¯”å¦‚ [ç¬¬äºŒç« ](https://kaisery.github.io/trpl-zh-cn/ch02-00-guessing-game-tutorial.html#ç”Ÿæˆä¸€ä¸ªéšæœºæ•°) çš„ `rand` crate å°±æä¾›äº†ç”Ÿæˆéšæœºæ•°çš„ä¸œè¥¿ã€‚å¤§å¤šæ•°æ—¶é—´ `Rustaceans` è¯´çš„ crate æŒ‡çš„éƒ½æ˜¯åº“ï¼Œè¿™ä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ library æ¦‚å¿µä¸€è‡´ã€‚

**åŒ…**ï¼ˆ*package*ï¼‰æ˜¯æä¾›ä¸€ç³»åˆ—åŠŸèƒ½çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ª crateã€‚**ä¸€ä¸ªåŒ…ä¼šåŒ…å«ä¸€ä¸ª *Cargo.toml* æ–‡ä»¶ï¼Œé˜è¿°å¦‚ä½•å»æ„å»ºè¿™äº› crate**ã€‚Cargo å°±æ˜¯ä¸€ä¸ªåŒ…å«æ„å»ºä½ ä»£ç çš„äºŒè¿›åˆ¶é¡¹çš„åŒ…ã€‚Cargo ä¹ŸåŒ…å«è¿™äº›äºŒè¿›åˆ¶é¡¹æ‰€ä¾èµ–çš„åº“ã€‚å…¶ä»–é¡¹ç›®ä¹Ÿèƒ½ç”¨ Cargo åº“æ¥å®ç°ä¸ Cargo å‘½ä»¤è¡Œç¨‹åºä¸€æ ·çš„é€»è¾‘ã€‚

#### æ¨¡å—

åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†è®¨è®ºæ¨¡å—å’Œå…¶å®ƒä¸€äº›å…³äºæ¨¡å—ç³»ç»Ÿçš„éƒ¨åˆ†ï¼Œå¦‚å…è®¸ä½ å‘½åé¡¹çš„ *è·¯å¾„*ï¼ˆ*paths*ï¼‰ï¼›ç”¨æ¥å°†è·¯å¾„å¼•å…¥ä½œç”¨åŸŸçš„ `use` å…³é”®å­—ï¼›ä»¥åŠä½¿é¡¹å˜ä¸ºå…¬æœ‰çš„ `pub` å…³é”®å­—ã€‚æˆ‘ä»¬è¿˜å°†è®¨è®º `as` å…³é”®å­—ã€å¤–éƒ¨åŒ…å’Œ glob è¿ç®—ç¬¦ã€‚

è¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªç®€å•çš„å‚è€ƒï¼Œç”¨æ¥è§£é‡Šæ¨¡å—ã€è·¯å¾„ã€`use`å…³é”®è¯å’Œ`pub`å…³é”®è¯å¦‚ä½•åœ¨ç¼–è¯‘å™¨ä¸­å·¥ä½œï¼Œä»¥åŠå¤§éƒ¨åˆ†å¼€å‘è€…å¦‚ä½•ç»„ç»‡ä»–ä»¬çš„ä»£ç ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ç« èŠ‚ä¸­ä¸¾ä¾‹è¯´æ˜æ¯æ¡è§„åˆ™ï¼Œä¸è¿‡è¿™æ˜¯ä¸€ä¸ªè§£é‡Šæ¨¡å—å·¥ä½œæ–¹å¼çš„è‰¯å¥½å‚è€ƒã€‚

  - **ä» crate æ ¹èŠ‚ç‚¹å¼€å§‹**: å½“ç¼–è¯‘ä¸€ä¸ª crate, ç¼–è¯‘å™¨é¦–å…ˆåœ¨ crate æ ¹æ–‡ä»¶ï¼ˆé€šå¸¸ï¼Œå¯¹äºä¸€ä¸ªåº“ crate è€Œè¨€æ˜¯*src/lib.rs*ï¼Œå¯¹äºä¸€ä¸ªäºŒè¿›åˆ¶ crate è€Œè¨€æ˜¯*src/main.rs*ï¼‰ä¸­å¯»æ‰¾éœ€è¦è¢«ç¼–è¯‘çš„ä»£ç ã€‚

  - **å£°æ˜æ¨¡å—**: åœ¨ crate æ ¹æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥å£°æ˜ä¸€ä¸ªæ–°æ¨¡å—ï¼›æ¯”å¦‚ï¼Œä½ ç”¨`mod garden`å£°æ˜äº†ä¸€ä¸ªå«åš`garden`çš„æ¨¡å—ã€‚ç¼–è¯‘å™¨ä¼šåœ¨ä¸‹åˆ—è·¯å¾„ä¸­å¯»æ‰¾æ¨¡å—ä»£ç ï¼š
    - å†…è”ï¼Œåœ¨å¤§æ‹¬å·ä¸­ï¼Œå½“`mod garden`åæ–¹ä¸æ˜¯ä¸€ä¸ªåˆ†å·è€Œæ˜¯ä¸€ä¸ªå¤§æ‹¬å·
    - åœ¨æ–‡ä»¶ *src/garden.rs*
    - åœ¨æ–‡ä»¶ *src/garden/mod.rs*

  - **å£°æ˜å­æ¨¡å—**: åœ¨é™¤äº† crate æ ¹èŠ‚ç‚¹ä»¥å¤–çš„å…¶ä»–æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰å­æ¨¡å—ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½åœ¨src/garden.rsä¸­å®šä¹‰äº†`mod vegetables;`ã€‚ç¼–è¯‘å™¨ä¼šåœ¨ä»¥çˆ¶æ¨¡å—å‘½åçš„ç›®å½•ä¸­å¯»æ‰¾å­æ¨¡å—ä»£ç ï¼š
    - å†…è”ï¼Œåœ¨å¤§æ‹¬å·ä¸­ï¼Œå½“`mod vegetables`åæ–¹ä¸æ˜¯ä¸€ä¸ªåˆ†å·è€Œæ˜¯ä¸€ä¸ªå¤§æ‹¬å·
    - åœ¨æ–‡ä»¶ *src/garden/vegetables.rs*
    - åœ¨æ–‡ä»¶ *src/garden/vegetables/mod.rs*

  - **æ¨¡å—ä¸­çš„ä»£ç è·¯å¾„**: ä¸€æ—¦ä¸€ä¸ªæ¨¡å—æ˜¯ä½  crate çš„ä¸€éƒ¨åˆ†ï¼Œä½ å¯ä»¥åœ¨éšç§è§„åˆ™å…è®¸çš„å‰æä¸‹ï¼Œä»åŒä¸€ä¸ª crate å†…çš„ä»»æ„åœ°æ–¹ï¼Œé€šè¿‡ä»£ç è·¯å¾„å¼•ç”¨è¯¥æ¨¡å—çš„ä»£ç ã€‚ä¸¾ä¾‹è€Œè¨€ï¼Œä¸€ä¸ª garden vegetables æ¨¡å—ä¸‹çš„`Asparagus`ç±»å‹å¯ä»¥åœ¨`crate::garden::vegetables::Asparagus`è¢«æ‰¾åˆ°ã€‚

  - **ç§æœ‰ vs å…¬ç”¨**: ä¸€ä¸ªæ¨¡å—é‡Œçš„ä»£ç é»˜è®¤å¯¹å…¶çˆ¶æ¨¡å—ç§æœ‰ã€‚ä¸ºäº†ä½¿ä¸€ä¸ªæ¨¡å—å…¬ç”¨ï¼Œåº”å½“åœ¨å£°æ˜æ—¶ä½¿ç”¨`pub mod`æ›¿ä»£`mod`ã€‚ä¸ºäº†ä½¿ä¸€ä¸ªå…¬ç”¨æ¨¡å—å†…éƒ¨çš„æˆå‘˜å…¬ç”¨ï¼Œåº”å½“åœ¨å£°æ˜å‰ä½¿ç”¨`pub`ã€‚

  - **`use` å…³é”®å­—**: åœ¨ä¸€ä¸ªä½œç”¨åŸŸå†…ï¼Œ`use`å…³é”®å­—åˆ›å»ºäº†ä¸€ä¸ªæˆå‘˜çš„å¿«æ·æ–¹å¼ï¼Œç”¨æ¥å‡å°‘é•¿è·¯å¾„çš„é‡å¤ã€‚åœ¨ä»»ä½•å¯ä»¥å¼•ç”¨`crate::garden::vegetables::Asparagus`çš„ä½œç”¨åŸŸï¼Œä½ å¯ä»¥é€šè¿‡ `use crate::garden::vegetables::Asparagus;`åˆ›å»ºä¸€ä¸ªå¿«æ·æ–¹å¼ï¼Œç„¶åä½ å°±å¯ä»¥åœ¨ä½œç”¨åŸŸä¸­åªå†™`Asparagus`æ¥ä½¿ç”¨è¯¥ç±»å‹ã€‚

#### åœ¨æ¨¡å—ä¸­å¯¹ç›¸å…³ä»£ç è¿›è¡Œåˆ†ç»„

*æ¨¡å—* è®©æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ª crate ä¸­çš„ä»£ç è¿›è¡Œåˆ†ç»„ï¼Œä»¥æé«˜å¯è¯»æ€§ä¸é‡ç”¨æ€§ã€‚å› ä¸ºä¸€ä¸ªæ¨¡å—ä¸­çš„ä»£ç é»˜è®¤æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥è¿˜å¯ä»¥åˆ©ç”¨æ¨¡å—æ§åˆ¶é¡¹çš„ *ç§æœ‰æ€§*ã€‚ç§æœ‰é¡¹æ˜¯ä¸å¯ä¸ºå¤–éƒ¨ä½¿ç”¨çš„å†…åœ¨è¯¦ç»†å®ç°ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ¨¡å—å’Œå®ƒå…¶ä¸­çš„é¡¹æ ‡è®°ä¸ºå…¬å¼€çš„ï¼Œè¿™æ ·ï¼Œå¤–éƒ¨ä»£ç å°±å¯ä»¥ä½¿ç”¨å¹¶ä¾èµ–ä¸å®ƒä»¬ã€‚

åœ¨é¤é¥®ä¸šï¼Œé¤é¦†ä¸­ä¼šæœ‰ä¸€äº›åœ°æ–¹è¢«ç§°ä¹‹ä¸º *å‰å°*ï¼ˆ*front of house*ï¼‰ï¼Œè¿˜æœ‰å¦å¤–ä¸€äº›åœ°æ–¹è¢«ç§°ä¹‹ä¸º *åå°*ï¼ˆ*back of house*ï¼‰ã€‚å‰å°æ˜¯æ‹›å¾…é¡¾å®¢çš„åœ°æ–¹ï¼Œåœ¨è¿™é‡Œï¼Œåº—ä¸»å¯ä»¥ä¸ºé¡¾å®¢å®‰æ’åº§ä½ï¼ŒæœåŠ¡å‘˜æ¥å—é¡¾å®¢ä¸‹å•å’Œä»˜æ¬¾ï¼Œè°ƒé…’å¸ˆä¼šåˆ¶ä½œé¥®å“ã€‚åå°åˆ™æ˜¯ç”±å¨å¸ˆå·¥ä½œçš„å¨æˆ¿ï¼Œæ´—ç¢—å·¥çš„å·¥ä½œåœ°ç‚¹ï¼Œä»¥åŠç»ç†åšè¡Œæ”¿å·¥ä½œçš„åœ°æ–¹ç»„æˆã€‚

æˆ‘ä»¬å¯ä»¥å°†å‡½æ•°æ”¾ç½®åˆ°åµŒå¥—çš„æ¨¡å—ä¸­ï¼Œæ¥ä½¿æˆ‘ä»¬çš„ crate ç»“æ„ä¸å®é™…çš„é¤å…ç»“æ„ç›¸åŒã€‚é€šè¿‡æ‰§è¡Œ `cargo new --lib restaurant`ï¼Œæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„åä¸º `restaurant` çš„åº“ã€‚ç„¶åå°†ç¤ºä¾‹ 7-1 ä¸­æ‰€ç½—åˆ—å‡ºæ¥çš„ä»£ç æ”¾å…¥ *src/lib.rs* ä¸­ï¼Œæ¥å®šä¹‰ä¸€äº›æ¨¡å—å’Œå‡½æ•°ã€‚

æ–‡ä»¶åï¼šsrc/lib.rs

```rust
mod front_of_house {
    mod hosting {
        fn add_to_waitlist() {}

        fn seat_at_table() {}
    }

    mod serving {
        fn take_order() {}

        fn serve_order() {}

        fn take_payment() {}
    }
}
```

ç¤ºä¾‹ 7-1ï¼šä¸€ä¸ªåŒ…å«äº†å…¶ä»–å†…ç½®äº†å‡½æ•°çš„æ¨¡å—çš„ `front_of_house` æ¨¡å—

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¨¡å—ï¼Œæ˜¯ä»¥ `mod` å…³é”®å­—ä¸ºèµ·å§‹ï¼Œç„¶åæŒ‡å®šæ¨¡å—çš„åå­—ï¼ˆæœ¬ä¾‹ä¸­å«åš `front_of_house`ï¼‰ï¼Œå¹¶ä¸”ç”¨èŠ±æ‹¬å·åŒ…å›´æ¨¡å—çš„ä¸»ä½“ã€‚åœ¨æ¨¡å—å†…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å®šä¹‰å…¶ä»–çš„æ¨¡å—ï¼Œå°±åƒæœ¬ä¾‹ä¸­çš„ `hosting` å’Œ `serving` æ¨¡å—ã€‚æ¨¡å—è¿˜å¯ä»¥ä¿å­˜ä¸€äº›å®šä¹‰çš„å…¶ä»–é¡¹ï¼Œæ¯”å¦‚ç»“æ„ä½“ã€æšä¸¾ã€å¸¸é‡ã€ç‰¹æ€§ã€æˆ–è€…å‡½æ•°ã€‚

ä¸‹é¢å±•ç¤ºäº†ç¤ºä¾‹ 7-1 ä¸­çš„æ¨¡å—æ ‘çš„ç»“æ„ï¼š

```text
crate
 â””â”€â”€ front_of_house
     â”œâ”€â”€ hosting
     â”‚   â”œâ”€â”€ add_to_waitlist
     â”‚   â””â”€â”€ seat_at_table
     â””â”€â”€ serving
         â”œâ”€â”€ take_order
         â”œâ”€â”€ serve_order
         â””â”€â”€ take_payment
```

#### å¼•ç”¨æ¨¡å—é¡¹ç›®çš„è·¯å¾„

æ¥çœ‹ä¸€ä¸‹ Rust å¦‚ä½•åœ¨æ¨¡å—æ ‘ä¸­æ‰¾åˆ°ä¸€ä¸ªé¡¹çš„ä½ç½®ï¼Œæˆ‘ä»¬ä½¿ç”¨è·¯å¾„çš„æ–¹å¼ï¼Œå°±åƒåœ¨æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨è·¯å¾„ä¸€æ ·ã€‚ä¸ºäº†è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å®ƒçš„è·¯å¾„ã€‚

è·¯å¾„æœ‰ä¸¤ç§å½¢å¼ï¼š

- **ç»å¯¹è·¯å¾„**ï¼ˆ*absolute path*ï¼‰æ˜¯ä»¥ crate æ ¹ï¼ˆrootï¼‰å¼€å¤´çš„å…¨è·¯å¾„ï¼›å¯¹äºå¤–éƒ¨ crate çš„ä»£ç ï¼Œæ˜¯ä»¥ crate åå¼€å¤´çš„ç»å¯¹è·¯å¾„ï¼Œå¯¹äºå½“å‰ crate çš„ä»£ç ï¼Œåˆ™ä»¥å­—é¢å€¼ `crate` å¼€å¤´ã€‚
- **ç›¸å¯¹è·¯å¾„**ï¼ˆ*relative path*ï¼‰ä»å½“å‰æ¨¡å—å¼€å§‹ï¼Œä»¥ `self`ã€`super` æˆ–å½“å‰æ¨¡å—çš„æ ‡è¯†ç¬¦å¼€å¤´ã€‚

ç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„éƒ½åè·Ÿä¸€ä¸ªæˆ–å¤šä¸ªç”±åŒå†’å·ï¼ˆ`::`ï¼‰åˆ†å‰²çš„æ ‡è¯†ç¬¦ã€‚

æˆ‘ä»¬åœ¨ crate æ ¹å®šä¹‰äº†ä¸€ä¸ªæ–°å‡½æ•° `eat_at_restaurant`ï¼Œå¹¶åœ¨å…¶ä¸­å±•ç¤ºè°ƒç”¨ `add_to_waitlist` å‡½æ•°çš„ä¸¤ç§æ–¹æ³•ã€‚`eat_at_restaurant` å‡½æ•°æ˜¯æˆ‘ä»¬ crate åº“çš„ä¸€ä¸ªå…¬å…± APIï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ `pub` å…³é”®å­—æ¥æ ‡è®°å®ƒã€‚æ³¨æ„ï¼Œè¿™ä¸ªä¾‹å­æ— æ³•ç¼–è¯‘é€šè¿‡ï¼Œæˆ‘ä»¬ç¨åä¼šè§£é‡ŠåŸå› ã€‚

```rust
mod front_of_house {
    mod hosting {
        fn add_to_waitlist() {}
    }
}

pub fn eat_at_restaurant() {
    // ç»å¯¹è·¯å¾„
    crate::front_of_house::hosting::add_to_waitlist();

    // ç›¸å¯¹è·¯å¾„
    front_of_house::hosting::add_to_waitlist();
}
```

é”™è¯¯ä¿¡æ¯è¯´ `hosting` æ¨¡å—æ˜¯ç§æœ‰çš„ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æ‹¥æœ‰ `hosting` æ¨¡å—å’Œ `add_to_waitlist` å‡½æ•°çš„çš„æ­£ç¡®è·¯å¾„ï¼Œä½†æ˜¯ Rust ä¸è®©æˆ‘ä»¬ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¸èƒ½è®¿é—®ç§æœ‰ç‰‡æ®µã€‚**åœ¨ Rust ä¸­ï¼Œé»˜è®¤æ‰€æœ‰é¡¹ï¼ˆå‡½æ•°ã€æ–¹æ³•ã€ç»“æ„ä½“ã€æšä¸¾ã€æ¨¡å—å’Œå¸¸é‡ï¼‰å¯¹çˆ¶æ¨¡å—éƒ½æ˜¯ç§æœ‰çš„ã€‚**å¦‚æœå¸Œæœ›åˆ›å»ºä¸€ä¸ªç§æœ‰å‡½æ•°æˆ–ç»“æ„ä½“ï¼Œä½ å¯ä»¥å°†å…¶æ”¾å…¥ä¸€ä¸ªæ¨¡å—ã€‚

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

pub fn eat_at_restaurant() {
    // ç»å¯¹è·¯å¾„
    crate::front_of_house::hosting::add_to_waitlist();

    // ç›¸å¯¹è·¯å¾„
    front_of_house::hosting::add_to_waitlist();
}
```

ç°åœ¨ä»£ç å¯ä»¥ç¼–è¯‘é€šè¿‡äº†ï¼æ¨¡å—å…¬æœ‰å¹¶ä¸ä½¿å…¶å†…å®¹ä¹Ÿæ˜¯å…¬æœ‰çš„ã€‚æ¨¡å—ä¸Šçš„ `pub` å…³é”®å­—åªå…è®¸å…¶çˆ¶æ¨¡å—å¼•ç”¨å®ƒï¼Œè€Œä¸å…è®¸è®¿é—®å†…éƒ¨ä»£ç ã€‚å› ä¸ºæ¨¡å—æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œåªæ˜¯å°†æ¨¡å—å˜ä¸ºå…¬æœ‰èƒ½åšçš„å…¶å®å¹¶ä¸å¤ªå¤šï¼›åŒæ—¶éœ€è¦æ›´æ·±å…¥åœ°é€‰æ‹©å°†ä¸€ä¸ªæˆ–å¤šä¸ªé¡¹å˜ä¸ºå…¬æœ‰ã€‚



> #### äºŒè¿›åˆ¶å’Œåº“ crate åŒ…çš„æœ€ä½³å®è·µ
>
> æˆ‘ä»¬æåˆ°è¿‡åŒ…å¯ä»¥åŒæ—¶åŒ…å«ä¸€ä¸ª *src/main.rs* äºŒè¿›åˆ¶ crate æ ¹å’Œä¸€ä¸ª *src/lib.rs* åº“ crate æ ¹ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ª crate é»˜è®¤ä»¥åŒ…åæ¥å‘½åã€‚é€šå¸¸ï¼Œè¿™ç§åŒ…å«äºŒè¿›åˆ¶ crate å’Œåº“ crate çš„æ¨¡å¼çš„åŒ…ï¼Œåœ¨äºŒè¿›åˆ¶ crate ä¸­åªæœ‰è¶³å¤Ÿçš„ä»£ç æ¥å¯åŠ¨ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯æ‰§è¡Œæ–‡ä»¶è°ƒç”¨åº“ crate çš„ä»£ç ã€‚åˆå› ä¸ºåº“ crate å¯ä»¥å…±äº«ï¼Œè¿™ä½¿å¾—å…¶å®ƒé¡¹ç›®ä»åŒ…æä¾›çš„å¤§éƒ¨åˆ†åŠŸèƒ½ä¸­å—ç›Šã€‚
>
> æ¨¡å—æ ‘åº”è¯¥å®šä¹‰åœ¨ *src/lib.rs* ä¸­ã€‚è¿™æ ·é€šè¿‡ä»¥åŒ…åå¼€å¤´çš„è·¯å¾„ï¼Œå…¬æœ‰é¡¹å°±å¯ä»¥åœ¨äºŒè¿›åˆ¶ crate ä¸­ä½¿ç”¨ã€‚äºŒè¿›åˆ¶ crate å°±å®Œå…¨å˜æˆäº†åŒå…¶å®ƒ å¤–éƒ¨ crate ä¸€æ ·çš„åº“ crate çš„ç”¨æˆ·ï¼šå®ƒåªèƒ½ä½¿ç”¨å…¬æœ‰ APIã€‚è¿™æœ‰åŠ©äºä½ è®¾è®¡ä¸€ä¸ªå¥½çš„ APIï¼›ä½ ä¸ä»…ä»…æ˜¯ä½œè€…ï¼Œä¹Ÿæ˜¯ç”¨æˆ·ï¼

#### super å¼€å§‹çš„ç›¸å¯¹è·¯å¾„

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è·¯å¾„çš„å¼€å¤´ä½¿ç”¨ `super` ï¼Œä»çˆ¶æ¨¡å—å¼€å§‹æ„å»ºç›¸å¯¹è·¯å¾„ï¼Œè€Œä¸æ˜¯ä»å½“å‰æ¨¡å—æˆ–è€… crate æ ¹å¼€å§‹ã€‚è¿™ç±»ä¼¼ä»¥ `..` è¯­æ³•å¼€å§‹ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè·¯å¾„ã€‚

è€ƒè™‘ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼Œå®ƒæ¨¡æ‹Ÿäº†å¨å¸ˆæ›´æ­£äº†ä¸€ä¸ªé”™è¯¯è®¢å•ï¼Œå¹¶äº²è‡ªå°†å…¶æä¾›ç»™å®¢æˆ·çš„æƒ…å†µã€‚`back_of_house` æ¨¡å—ä¸­çš„å®šä¹‰çš„ `fix_incorrect_order` å‡½æ•°é€šè¿‡æŒ‡å®šçš„ `super` èµ·å§‹çš„ `serve_order` è·¯å¾„ï¼Œæ¥è°ƒç”¨çˆ¶æ¨¡å—ä¸­çš„ `deliver_order` å‡½æ•°ï¼š

```rust
fn deliver_order() {}

mod back_of_house {
    fn fix_incorrect_order() {
        cook_order();
        super::deliver_order();
    }

    fn cook_order() {}
}
```

å› ä¸ºæˆ‘ä»¬åˆ›å»ºäº†åä¸º `Appetizer` çš„å…¬æœ‰æšä¸¾ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ `eat_at_restaurant` ä¸­ä½¿ç”¨ `Soup` å’Œ `Salad` æˆå‘˜ã€‚

#### åˆ›å»ºå…¬æœ‰çš„ç»“æ„ä½“å’Œæšä¸¾

å¦‚æœæšä¸¾æˆå‘˜ä¸æ˜¯å…¬æœ‰çš„ï¼Œé‚£ä¹ˆæšä¸¾ä¼šæ˜¾å¾—ç”¨å¤„ä¸å¤§ï¼›ç»™æšä¸¾çš„æ‰€æœ‰æˆå‘˜æŒ¨ä¸ªæ·»åŠ  `pub` æ˜¯å¾ˆä»¤äººæ¼ç«çš„ï¼Œå› æ­¤æšä¸¾æˆå‘˜é»˜è®¤å°±æ˜¯å…¬æœ‰çš„ã€‚ç»“æ„ä½“é€šå¸¸ä½¿ç”¨æ—¶ï¼Œä¸å¿…å°†å®ƒä»¬çš„å­—æ®µå…¬æœ‰åŒ–ï¼Œå› æ­¤ç»“æ„ä½“éµå¾ªå¸¸è§„ï¼Œå†…å®¹å…¨éƒ¨æ˜¯ç§æœ‰çš„ï¼Œé™¤éä½¿ç”¨ `pub` å…³é”®å­—ã€‚

```rust
mod back_of_house {
    pub enum Appetizer {
        Soup,
        Salad,
    }
}

pub fn eat_at_restaurant() {
    let order1 = back_of_house::Appetizer::Soup;
    let order2 = back_of_house::Appetizer::Salad;
}
```

#### ä½¿ç”¨ `use` å…³é”®å­—å°†è·¯å¾„å¼•å…¥ä½œç”¨åŸŸ

ä¸å¾—ä¸ç¼–å†™è·¯å¾„æ¥è°ƒç”¨å‡½æ•°æ˜¾å¾—ä¸ä¾¿ä¸”é‡å¤ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæ— è®ºæˆ‘ä»¬é€‰æ‹© `add_to_waitlist` å‡½æ•°çš„ç»å¯¹è·¯å¾„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ¯æ¬¡æˆ‘ä»¬æƒ³è¦è°ƒç”¨ `add_to_waitlist` æ—¶ï¼Œéƒ½å¿…é¡»æŒ‡å®š`front_of_house` å’Œ `hosting`ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `use` å…³é”®å­—åˆ›å»ºä¸€ä¸ªçŸ­è·¯å¾„ï¼Œç„¶åå°±å¯ä»¥åœ¨ä½œç”¨åŸŸä¸­çš„ä»»ä½•åœ°æ–¹ä½¿ç”¨è¿™ä¸ªæ›´çŸ­çš„åå­—ã€‚

åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† `crate::front_of_house::hosting` æ¨¡å—å¼•å…¥äº† `eat_at_restaurant` å‡½æ•°çš„ä½œç”¨åŸŸï¼Œè€Œæˆ‘ä»¬åªéœ€è¦æŒ‡å®š `hosting::add_to_waitlist` å³å¯åœ¨ `eat_at_restaurant` ä¸­è°ƒç”¨ `add_to_waitlist` å‡½æ•°ã€‚

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

use crate::front_of_house::hosting;

pub fn eat_at_restaurant() {
    hosting::add_to_waitlist();
}
```

åœ¨ä½œç”¨åŸŸä¸­å¢åŠ  `use` å’Œè·¯å¾„ç±»ä¼¼äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºè½¯è¿æ¥ï¼ˆç¬¦å·è¿æ¥ï¼Œsymbolic linkï¼‰ã€‚é€šè¿‡åœ¨ crate æ ¹å¢åŠ  `use crate::front_of_house::hosting`ï¼Œç°åœ¨ `hosting` åœ¨ä½œç”¨åŸŸä¸­å°±æ˜¯æœ‰æ•ˆçš„åç§°äº†ï¼Œå¦‚åŒ `hosting` æ¨¡å—è¢«å®šä¹‰äº crate æ ¹ä¸€æ ·ã€‚é€šè¿‡ `use` å¼•å…¥ä½œç”¨åŸŸçš„è·¯å¾„ä¹Ÿä¼šæ£€æŸ¥ç§æœ‰æ€§ï¼ŒåŒå…¶å®ƒè·¯å¾„ä¸€æ ·ã€‚

æ³¨æ„ `use` åªèƒ½åˆ›å»º `use` æ‰€åœ¨çš„ç‰¹å®šä½œç”¨åŸŸå†…çš„çŸ­è·¯å¾„ã€‚ä¸‹é¢çš„ç¤ºä¾‹å°† `eat_at_restaurant` å‡½æ•°ç§»åŠ¨åˆ°äº†ä¸€ä¸ªå« `customer` çš„å­æ¨¡å—ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªä¸åŒäº `use` è¯­å¥çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥å‡½æ•°ä½“ä¸èƒ½ç¼–è¯‘ã€‚

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

use crate::front_of_house::hosting;

mod customer {
    pub fn eat_at_restaurant() {
        hosting::add_to_waitlist();
    }
}
```

#### ä½¿ç”¨ `as` å…³é”®å­—æä¾›æ–°çš„åç§°

ä½¿ç”¨ `use` å°†ä¸¤ä¸ªåŒåç±»å‹å¼•å…¥åŒä¸€ä½œç”¨åŸŸè¿™ä¸ªé—®é¢˜è¿˜æœ‰å¦ä¸€ä¸ªè§£å†³åŠæ³•ï¼šåœ¨è¿™ä¸ªç±»å‹çš„è·¯å¾„åé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ `as` æŒ‡å®šä¸€ä¸ªæ–°çš„æœ¬åœ°åç§°æˆ–è€…åˆ«åã€‚ç¤ºä¾‹å±•ç¤ºäº†å¦ä¸€ä¸ªç¼–å†™çš„æ–¹æ³•ï¼Œé€šè¿‡ `as` é‡å‘½åå…¶ä¸­ä¸€ä¸ª `Result` ç±»å‹ã€‚

```rust
use std::fmt::Result;
use std::io::Result as IoResult;

fn function1() -> Result {
    // --snip--
}

fn function2() -> IoResult<()> {
    // --snip--
}
```

#### ä½¿ç”¨ `pub use` é‡å¯¼å‡ºåç§°

ä½¿ç”¨ `use` å…³é”®å­—ï¼Œå°†æŸä¸ªåç§°å¯¼å…¥å½“å‰ä½œç”¨åŸŸåï¼Œè¿™ä¸ªåç§°åœ¨æ­¤ä½œç”¨åŸŸä¸­å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œä½†å®ƒå¯¹æ­¤ä½œç”¨åŸŸä¹‹å¤–è¿˜æ˜¯ç§æœ‰çš„ã€‚å¦‚æœæƒ³è®©å…¶ä»–äººè°ƒç”¨æˆ‘ä»¬çš„ä»£ç æ—¶ï¼Œä¹Ÿèƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨è¿™ä¸ªåç§°ï¼Œå°±å¥½åƒå®ƒæœ¬æ¥å°±åœ¨å½“å‰ä½œç”¨åŸŸä¸€æ ·ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å°† `pub` å’Œ `use` åˆèµ·æ¥ä½¿ç”¨ã€‚è¿™ç§æŠ€æœ¯è¢«ç§°ä¸º â€œ**é‡å¯¼å‡º**ï¼ˆ*re-exporting*ï¼‰â€ï¼šæˆ‘ä»¬ä¸ä»…å°†ä¸€ä¸ªåç§°å¯¼å…¥äº†å½“å‰ä½œç”¨åŸŸï¼Œè¿˜å…è®¸åˆ«äººæŠŠå®ƒå¯¼å…¥ä»–ä»¬è‡ªå·±çš„ä½œç”¨åŸŸã€‚

ç¤ºä¾‹ 7-17 å°†ç¤ºä¾‹ 7-11 æ ¹æ¨¡å—ä¸­çš„ `use` æ”¹ä¸º `pub use` ã€‚

æ–‡ä»¶åï¼šsrc/lib.rs

```rust
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

pub use crate::front_of_house::hosting;

pub fn eat_at_restaurant() {
    hosting::add_to_waitlist();
}
```

åœ¨è¿™ä¸ªä¿®æ”¹ä¹‹å‰ï¼Œå¤–éƒ¨ä»£ç éœ€è¦ä½¿ç”¨è·¯å¾„ `restaurant::front_of_house::hosting::add_to_waitlist()` æ¥è°ƒç”¨ `add_to_waitlist` å‡½æ•°ã€‚ç°åœ¨è¿™ä¸ª `pub use` ä»æ ¹æ¨¡å—é‡å¯¼å‡ºäº† `hosting` æ¨¡å—ï¼Œå¤–éƒ¨ä»£ç ç°åœ¨å¯ä»¥ä½¿ç”¨è·¯å¾„ `restaurant::hosting::add_to_waitlist`ã€‚

#### ä½¿ç”¨å¤–éƒ¨åŒ…

åœ¨ç¬¬äºŒç« ä¸­æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªçŒœçŒœçœ‹æ¸¸æˆã€‚é‚£ä¸ªé¡¹ç›®ä½¿ç”¨äº†ä¸€ä¸ªå¤–éƒ¨åŒ…ï¼Œ`rand`ï¼Œæ¥ç”Ÿæˆéšæœºæ•°ã€‚ä¸ºäº†åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ `rand`ï¼Œåœ¨ *Cargo.toml* ä¸­åŠ å…¥äº†å¦‚ä¸‹è¡Œï¼š

æ–‡ä»¶åï¼šCargo.toml

```toml
rand = "0.8.5"
```

åœ¨ *Cargo.toml* ä¸­åŠ å…¥ `rand` ä¾èµ–å‘Šè¯‰äº† Cargo è¦ä» [crates.io](https://crates.io/) ä¸‹è½½ `rand` å’Œå…¶ä¾èµ–ï¼Œå¹¶ä½¿å…¶å¯åœ¨é¡¹ç›®ä»£ç ä¸­ä½¿ç”¨ã€‚

æ¥ç€ï¼Œä¸ºäº†å°† `rand` å®šä¹‰å¼•å…¥é¡¹ç›®åŒ…çš„ä½œç”¨åŸŸï¼Œæˆ‘ä»¬åŠ å…¥ä¸€è¡Œ `use` èµ·å§‹çš„åŒ…åï¼Œå®ƒä»¥ `rand` åŒ…åå¼€å¤´å¹¶åˆ—å‡ºäº†éœ€è¦å¼•å…¥ä½œç”¨åŸŸçš„é¡¹ã€‚å›å¿†ä¸€ä¸‹ç¬¬äºŒç« çš„ â€œç”Ÿæˆä¸€ä¸ªéšæœºæ•°â€ éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ›¾å°† `Rng` trait å¼•å…¥ä½œç”¨åŸŸå¹¶è°ƒç”¨äº† `rand::thread_rng` å‡½æ•°ï¼š

```rust
use rand::Rng;

fn main() {
    let secret_number = rand::thread_rng().gen_range(1..=100);
}
```

#### åµŒå¥—è·¯å¾„æ¥æ¶ˆé™¤å¤§é‡çš„ `use` è¡Œ

å½“éœ€è¦å¼•å…¥å¾ˆå¤šå®šä¹‰äºç›¸åŒåŒ…æˆ–ç›¸åŒæ¨¡å—çš„é¡¹æ—¶ï¼Œä¸ºæ¯ä¸€é¡¹å•ç‹¬åˆ—å‡ºä¸€è¡Œä¼šå ç”¨æºç å¾ˆå¤§çš„ç©ºé—´ã€‚ä¾‹å¦‚çŒœçŒœçœ‹ç« èŠ‚ç¤ºä¾‹ 2-4 ä¸­æœ‰ä¸¤è¡Œ `use` è¯­å¥éƒ½ä» `std` å¼•å…¥é¡¹åˆ°ä½œç”¨åŸŸï¼š

æ–‡ä»¶åï¼šsrc/main.rs

```rust
// --snip--
use std::cmp::Ordering;
use std::io;
// --snip--
```

ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå¥—è·¯å¾„å°†ç›¸åŒçš„é¡¹åœ¨ä¸€è¡Œä¸­å¼•å…¥ä½œç”¨åŸŸã€‚è¿™ä¹ˆåšéœ€è¦æŒ‡å®šè·¯å¾„çš„ç›¸åŒéƒ¨åˆ†ï¼Œæ¥ç€æ˜¯ä¸¤ä¸ªå†’å·ï¼Œæ¥ç€æ˜¯å¤§æ‹¬å·ä¸­çš„å„è‡ªä¸åŒçš„è·¯å¾„éƒ¨åˆ†ï¼Œå¦‚ç¤ºä¾‹ 7-18 æ‰€ç¤ºã€‚

æ–‡ä»¶åï¼šsrc/main.rs

```rust
// --snip--
use std::{cmp::Ordering, io};
// --snip--
```

ç¤ºä¾‹ 7-18: æŒ‡å®šåµŒå¥—çš„è·¯å¾„åœ¨ä¸€è¡Œä¸­å°†å¤šä¸ªå¸¦æœ‰ç›¸åŒå‰ç¼€çš„é¡¹å¼•å…¥ä½œç”¨åŸŸ

åœ¨è¾ƒå¤§çš„ç¨‹åºä¸­ï¼Œä½¿ç”¨åµŒå¥—è·¯å¾„ä»ç›¸åŒåŒ…æˆ–æ¨¡å—ä¸­å¼•å…¥å¾ˆå¤šé¡¹ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æ‰€éœ€çš„ç‹¬ç«‹ `use` è¯­å¥çš„æ•°é‡ï¼

æˆ‘ä»¬å¯ä»¥åœ¨è·¯å¾„çš„ä»»ä½•å±‚çº§ä½¿ç”¨åµŒå¥—è·¯å¾„ï¼Œè¿™åœ¨ç»„åˆä¸¤ä¸ªå…±äº«å­è·¯å¾„çš„ `use` è¯­å¥æ—¶éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ 7-19 ä¸­å±•ç¤ºäº†ä¸¤ä¸ª `use` è¯­å¥ï¼šä¸€ä¸ªå°† `std::io` å¼•å…¥ä½œç”¨åŸŸï¼Œå¦ä¸€ä¸ªå°† `std::io::Write` å¼•å…¥ä½œç”¨åŸŸï¼š

```rust
use std::io;
use std::io::Write;
```

ç¤ºä¾‹ 7-19: é€šè¿‡ä¸¤è¡Œ `use` è¯­å¥å¼•å…¥ä¸¤ä¸ªè·¯å¾„ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å¦ä¸€ä¸ªçš„å­è·¯å¾„

ä¸¤ä¸ªè·¯å¾„çš„ç›¸åŒéƒ¨åˆ†æ˜¯ `std::io`ï¼Œè¿™æ­£æ˜¯ç¬¬ä¸€ä¸ªè·¯å¾„ã€‚ä¸ºäº†åœ¨ä¸€è¡Œ `use` è¯­å¥ä¸­å¼•å…¥è¿™ä¸¤ä¸ªè·¯å¾„ï¼Œå¯ä»¥åœ¨åµŒå¥—è·¯å¾„ä¸­ä½¿ç”¨ `self`ï¼Œå¦‚ç¤ºä¾‹ 7-20 æ‰€ç¤ºã€‚

æ–‡ä»¶åï¼šsrc/lib.rs

```rust
use std::io::{self, Write};
```

ç¤ºä¾‹ 7-20: å°†ç¤ºä¾‹ 7-19 ä¸­éƒ¨åˆ†é‡å¤çš„è·¯å¾„åˆå¹¶ä¸ºä¸€ä¸ª `use` è¯­å¥

è¿™ä¸€è¡Œä¾¿å°† `std::io` å’Œ `std::io::Write` åŒæ—¶å¼•å…¥ä½œç”¨åŸŸã€‚

#### é€šè¿‡`*`è¿ç®—ç¬¦å°†æ‰€æœ‰çš„å…¬æœ‰å®šä¹‰å¼•å…¥ä½œç”¨åŸŸ

å¦‚æœå¸Œæœ›å°†ä¸€ä¸ªè·¯å¾„ä¸‹ **æ‰€æœ‰** å…¬æœ‰é¡¹å¼•å…¥ä½œç”¨åŸŸï¼Œå¯ä»¥æŒ‡å®šè·¯å¾„åè·Ÿ `*`ï¼Œglob è¿ç®—ç¬¦ï¼š

```rust
use std::collections::*;
```

è¿™ä¸ª `use` è¯­å¥å°† `std::collections` ä¸­å®šä¹‰çš„æ‰€æœ‰å…¬æœ‰é¡¹å¼•å…¥å½“å‰ä½œç”¨åŸŸã€‚

#### å°†æ¨¡å—æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶

æˆ‘ä»¬ä»ç¤ºä¾‹ 7-17 ä¸­åŒ…å«å¤šä¸ªé¤å…æ¨¡å—çš„ä»£ç å¼€å§‹ã€‚æˆ‘ä»¬ä¼šå°†æ¨¡å—æå–åˆ°å„è‡ªçš„æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰æ¨¡å—éƒ½å®šä¹‰åˆ° crate æ ¹æ–‡ä»¶ä¸­ã€‚åœ¨è¿™é‡Œï¼Œcrate æ ¹æ–‡ä»¶æ˜¯ *src/lib.rs*ï¼Œä¸è¿‡è¿™ä¸ªè¿‡ç¨‹ä¹Ÿé€‚ç”¨äº crate æ ¹æ–‡ä»¶æ˜¯ *src/main.rs* çš„äºŒè¿›åˆ¶ crateã€‚

é¦–å…ˆå°† `front_of_house` æ¨¡å—æå–åˆ°å…¶è‡ªå·±çš„æ–‡ä»¶ä¸­ã€‚åˆ é™¤ `front_of_house` æ¨¡å—çš„å¤§æ‹¬å·ä¸­çš„ä»£ç ï¼Œåªç•™ä¸‹ `mod front_of_house;` å£°æ˜ï¼Œè¿™æ · *src/lib.rs* ä¼šåŒ…å«å¦‚ç¤ºä¾‹ 7-21 æ‰€ç¤ºçš„ä»£ç ã€‚æ³¨æ„ç›´åˆ°åˆ›å»ºç¤ºä¾‹ 7-22 ä¸­çš„ *src/front_of_house.rs* æ–‡ä»¶ä¹‹å‰ä»£ç éƒ½ä¸èƒ½ç¼–è¯‘ã€‚

æ–‡ä»¶åï¼šsrc/lib.rs

```rust
mod front_of_house;

pub use crate::front_of_house::hosting;

pub fn eat_at_restaurant() {
    hosting::add_to_waitlist();
}
```

ç¤ºä¾‹ 7-21: å£°æ˜ `front_of_house` æ¨¡å—ï¼Œå…¶å†…å®¹å°†ä½äº *src/front_of_house.rs*

æ¥ä¸‹æ¥å°†ä¹‹å‰å¤§æ‹¬å·å†…çš„ä»£ç æ”¾å…¥ä¸€ä¸ªåå« *src/front_of_house.rs* çš„æ–°æ–‡ä»¶ä¸­ï¼Œå¦‚ç¤ºä¾‹ 7-22 æ‰€ç¤ºã€‚å› ä¸ºç¼–è¯‘å™¨æ‰¾åˆ°äº† crate æ ¹ä¸­åå« `front_of_house` çš„æ¨¡å—å£°æ˜ï¼Œå®ƒå°±çŸ¥é“å»æœå¯»è¿™ä¸ªæ–‡ä»¶ã€‚

æ–‡ä»¶åï¼šsrc/front_of_house.rs

```rust
pub mod hosting {
    pub fn add_to_waitlist() {}
}
```

ç¤ºä¾‹ 7-22: åœ¨ *src/front_of_house.rs* ä¸­å®šä¹‰ `front_of_house` æ¨¡å—

æ³¨æ„ä½ åªéœ€åœ¨æ¨¡å—æ ‘ä¸­çš„æŸå¤„ä½¿ç”¨ä¸€æ¬¡ `mod` å£°æ˜å°±å¯ä»¥åŠ è½½è¿™ä¸ªæ–‡ä»¶ã€‚ä¸€æ—¦ç¼–è¯‘å™¨çŸ¥é“äº†è¿™ä¸ªæ–‡ä»¶æ˜¯é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼ˆå¹¶ä¸”é€šè¿‡ `mod` è¯­å¥çš„ä½ç½®çŸ¥é“äº†ä»£ç åœ¨æ¨¡å—æ ‘ä¸­çš„ä½ç½®ï¼‰ï¼Œé¡¹ç›®ä¸­çš„å…¶ä»–æ–‡ä»¶åº”è¯¥ä½¿ç”¨å…¶æ‰€å£°æ˜çš„ä½ç½®çš„è·¯å¾„æ¥å¼•ç”¨é‚£ä¸ªæ–‡ä»¶çš„ä»£ç ï¼Œè¿™åœ¨[â€œå¼•ç”¨æ¨¡å—é¡¹ç›®çš„è·¯å¾„â€](https://kaisery.github.io/trpl-zh-cn/ch07-03-paths-for-referring-to-an-item-in-the-module-tree.html)éƒ¨åˆ†æœ‰è®²åˆ°ã€‚**æ¢å¥è¯è¯´ï¼Œ`mod` ä¸æ˜¯ä½ å¯èƒ½ä¼šåœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­çœ‹åˆ°çš„ "include" æ“ä½œã€‚**

> #### å¦ä¸€ç§æ–‡ä»¶è·¯å¾„
>
> ç›®å‰ä¸ºæ­¢æˆ‘ä»¬ä»‹ç»äº† Rust ç¼–è¯‘å™¨æ‰€æœ€å¸¸ç”¨çš„æ–‡ä»¶è·¯å¾„ï¼›ä¸è¿‡ä¸€ç§æ›´è€çš„æ–‡ä»¶è·¯å¾„ä¹Ÿä»ç„¶æ˜¯æ”¯æŒçš„ã€‚
>
> å¯¹äºå£°æ˜äº crate æ ¹çš„ `front_of_house` æ¨¡å—ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å¦‚ä¸‹ä½ç½®æŸ¥æ‰¾æ¨¡å—ä»£ç ï¼š
>
> - *src/front_of_house.rs*ï¼ˆæˆ‘ä»¬æ‰€ä»‹ç»çš„ï¼‰
> - *src/front_of_house/mod.rs*ï¼ˆè€é£æ ¼ï¼Œä¸è¿‡ä»ç„¶æ”¯æŒï¼‰
>
> å¯¹äº `front_of_house` çš„å­æ¨¡å— `hosting`ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å¦‚ä¸‹ä½ç½®æŸ¥æ‰¾æ¨¡å—ä»£ç ï¼š
>
> - *src/front_of_house/hosting.rs*ï¼ˆæˆ‘ä»¬æ‰€ä»‹ç»çš„ï¼‰
> - *src/front_of_house/hosting/mod.rs*ï¼ˆè€é£æ ¼ï¼Œä¸è¿‡ä»ç„¶æ”¯æŒï¼‰
>
> å¦‚æœä½ å¯¹åŒä¸€æ¨¡å—åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§è·¯å¾„é£æ ¼ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚åœ¨åŒä¸€é¡¹ç›®ä¸­çš„ä¸åŒæ¨¡å—æ··ç”¨ä¸åŒçš„è·¯å¾„é£æ ¼æ˜¯å…è®¸çš„ï¼Œä¸è¿‡è¿™ä¼šä½¿ä»–äººæ„Ÿåˆ°ç–‘æƒ‘ã€‚
>
> ä½¿ç”¨ *mod.rs* è¿™ä¸€æ–‡ä»¶åçš„é£æ ¼çš„ä¸»è¦ç¼ºç‚¹æ˜¯ä¼šå¯¼è‡´é¡¹ç›®ä¸­å‡ºç°å¾ˆå¤š *mod.rs* æ–‡ä»¶ï¼Œå½“ä½ åœ¨ç¼–è¾‘å™¨ä¸­åŒæ—¶æ‰“å¼€å®ƒä»¬æ—¶ä¼šæ„Ÿåˆ°ç–‘æƒ‘ã€‚



### é›†åˆ

####  Vector 

##### åˆ›å»ºVector

  åˆ›å»ºä¸€ä¸ªæ–°çš„ç©º vectorï¼Œå¯ä»¥è°ƒç”¨ `Vec::new` å‡½æ•°ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªç±»å‹æ³¨è§£ã€‚å› ä¸ºæ²¡æœ‰å‘è¿™ä¸ª vector ä¸­æ’å…¥ä»»ä½•å€¼ï¼ŒRust å¹¶ä¸çŸ¥é“æˆ‘ä»¬æƒ³è¦å‚¨å­˜ä»€ä¹ˆç±»å‹çš„å…ƒç´ ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ã€‚

  ```rust
    let v: Vec<i32> = Vec::new();
  ```

  é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šç”¨åˆå§‹å€¼æ¥åˆ›å»ºä¸€ä¸ª `Vec<T>`ï¼Œ è€Œ Rust ä¼šæ¨æ–­å‡ºå‚¨å­˜å€¼çš„ç±»å‹ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šéœ€è¦è¿™äº›ç±»å‹æ³¨è§£ã€‚ä¸ºäº†æ–¹ä¾¿ Rust æä¾›äº† `vec!` å®ï¼Œè¿™ä¸ªå®ä¼šæ ¹æ®æˆ‘ä»¬æä¾›çš„å€¼æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ vectorã€‚

   ```rust
   let v = vec![1, 2, 3];
   ```


##### æ›´æ–°Vector

  å¯¹äºæ–°å»ºä¸€ä¸ª vector å¹¶å‘å…¶å¢åŠ å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨ `push` æ–¹æ³•ï¼š

  ```rust
    let mut v = Vec::new();

    v.push(5);
    v.push(6);
  ```

  ç¤ºä¾‹ 8-3ï¼šä½¿ç”¨ `push` æ–¹æ³•å‘ vector å¢åŠ å€¼

  å¦‚ç¬¬ä¸‰ç« ä¸­è®¨è®ºçš„ä»»ä½•å˜é‡ä¸€æ ·ï¼Œå¦‚æœæƒ³è¦èƒ½å¤Ÿæ”¹å˜å®ƒçš„å€¼ï¼Œå¿…é¡»ä½¿ç”¨ `mut` å…³é”®å­—ä½¿å…¶å¯å˜ã€‚æ”¾å…¥å…¶ä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ `i32` ç±»å‹çš„ï¼Œè€Œä¸” Rust ä¹Ÿæ ¹æ®æ•°æ®åšå‡ºå¦‚æ­¤åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸éœ€è¦ `Vec<i32>` æ³¨è§£ã€‚

##### è¯»å– vector

  æœ‰ä¸¤ç§æ–¹æ³•å¼•ç”¨ vector ä¸­å‚¨å­˜çš„å€¼ï¼šé€šè¿‡ç´¢å¼•æˆ–ä½¿ç”¨ `get` æ–¹æ³•ï¼š

  ```rust
    let v = vec![1, 2, 3, 4, 5];

    let third: &i32 = &v[2];
    println!("The third element is {third}");

    let third: Option<&i32> = v.get(2);
    match third {
        Some(third) => println!("The third element is {third}"),
        None => println!("There is no third element."),
    }
  ```

  ç´¢å¼•è¶Šç•Œä¼šå¯¼è‡´panicï¼Œ`get`è¶Šç•Œåªä¼šè¿”å›Noneã€‚

  ğŸ§ä¸€æ—¦ç¨‹åºè·å–äº†ä¸€ä¸ªæœ‰æ•ˆçš„å¼•ç”¨ï¼Œå€Ÿç”¨æ£€æŸ¥å™¨å°†ä¼šæ‰§è¡Œæ‰€æœ‰æƒå’Œå€Ÿç”¨è§„åˆ™æ¥ç¡®ä¿ vector å†…å®¹çš„è¿™ä¸ªå¼•ç”¨å’Œä»»ä½•å…¶ä»–å¼•ç”¨ä¿æŒæœ‰æ•ˆã€‚å½“æˆ‘ä»¬è·å–äº† vector çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ä¸å¯å˜å¼•ç”¨å¹¶å°è¯•åœ¨ vector æœ«å°¾å¢åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœå°è¯•åœ¨å‡½æ•°çš„åé¢å¼•ç”¨è¿™ä¸ªå…ƒç´ æ˜¯è¡Œä¸é€šçš„ï¼š

  ```rust
    let mut v = vec![1, 2, 3, 4, 5];

    let first = &v[0];

    v.push(6);

    println!("The first element is: {first}");
___________________________________________________________
compile error !
  ```

  åœ¨ vector çš„ç»“å°¾å¢åŠ æ–°å…ƒç´ æ—¶ï¼Œåœ¨æ²¡æœ‰è¶³å¤Ÿç©ºé—´å°†æ‰€æœ‰å…ƒç´ ä¾æ¬¡ç›¸é‚»å­˜æ”¾çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šè¦æ±‚åˆ†é…æ–°å†…å­˜å¹¶å°†è€çš„å…ƒç´ æ‹·è´åˆ°æ–°çš„ç©ºé—´ä¸­ã€‚è¿™æ—¶ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ çš„å¼•ç”¨å°±æŒ‡å‘äº†è¢«é‡Šæ”¾çš„å†…å­˜ã€‚å€Ÿç”¨è§„åˆ™é˜»æ­¢ç¨‹åºé™·å…¥è¿™ç§çŠ¶å†µã€‚

##### éå† vector

  å¦‚æœæƒ³è¦ä¾æ¬¡è®¿é—® vector ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥éå†å…¶æ‰€æœ‰çš„å…ƒç´ è€Œæ— éœ€é€šè¿‡ç´¢å¼•ä¸€æ¬¡ä¸€ä¸ªçš„è®¿é—®ï¼š

  ```rust
    let v = vec![100, 32, 57];
    for i in &v {
        println!("{i}");
    }
  ```

  æˆ‘ä»¬ä¹Ÿå¯ä»¥éå†å¯å˜ vector çš„æ¯ä¸€ä¸ªå…ƒç´ çš„å¯å˜å¼•ç”¨ä»¥ä¾¿èƒ½æ”¹å˜å®ƒä»¬ï¼š

  ```rust
    let mut v = vec![100, 32, 57];
    for i in &mut v {
        *i += 50;
    }
  ```

##### ä½¿ç”¨æšä¸¾æ¥å‚¨å­˜å¤šç§ç±»å‹

  vector åªèƒ½å‚¨å­˜ç›¸åŒç±»å‹çš„å€¼ã€‚è¿™æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼›ç»å¯¹ä¼šæœ‰éœ€è¦å‚¨å­˜ä¸€ç³»åˆ—ä¸åŒç±»å‹çš„å€¼çš„ç”¨ä¾‹ã€‚å½“éœ€è¦åœ¨ vector ä¸­å‚¨å­˜ä¸åŒç±»å‹å€¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¹¶ä½¿ç”¨ä¸€ä¸ªæšä¸¾ï¼š

```rust
    enum SpreadsheetCell {
        Int(i32),
        Float(f64),
        Text(String),
    }

    let row = vec![
        SpreadsheetCell::Int(3),
        SpreadsheetCell::Text(String::from("blue")),
        SpreadsheetCell::Float(10.12),
    ];
```

##### ä¸¢å¼ƒ vector æ—¶ä¹Ÿä¼šä¸¢å¼ƒå…¶æ‰€æœ‰å…ƒç´ 

  ç±»ä¼¼äºä»»ä½•å…¶ä»–çš„ `struct`ï¼Œvector åœ¨å…¶ç¦»å¼€ä½œç”¨åŸŸæ—¶ä¼šè¢«é‡Šæ”¾ï¼š

  ```rust
    {
        let v = vec![1, 2, 3, 4];

        // do stuff with v
    } // <- v goes out of scope and is freed here
  ```

  å½“ vector è¢«ä¸¢å¼ƒæ—¶ï¼Œæ‰€æœ‰å…¶å†…å®¹ä¹Ÿä¼šè¢«ä¸¢å¼ƒï¼Œè¿™æ„å‘³ç€è¿™é‡Œå®ƒåŒ…å«çš„æ•´æ•°å°†è¢«æ¸…ç†ã€‚å€Ÿç”¨æ£€æŸ¥å™¨ç¡®ä¿äº†ä»»ä½• vector ä¸­å†…å®¹çš„å¼•ç”¨ä»…åœ¨ vector æœ¬èº«æœ‰æ•ˆæ—¶æ‰å¯ç”¨ã€‚

#### å­—ç¬¦ä¸²

å­—ç¬¦ä¸²å°±æ˜¯ä½œä¸ºå­—èŠ‚çš„é›†åˆå¤–åŠ ä¸€äº›æ–¹æ³•å®ç°çš„ï¼Œå¾ˆå¤š `Vec` å¯ç”¨çš„æ–¹æ³•åœ¨ `String` ä¸­åŒæ ·å¯ç”¨ï¼Œå½“è¿™äº›å­—èŠ‚è¢«è§£é‡Šä¸ºæ–‡æœ¬æ—¶ï¼Œè¿™äº›æ–¹æ³•æä¾›äº†å®ç”¨çš„åŠŸèƒ½ã€‚

åœ¨å¼€å§‹æ·±å…¥è¿™äº›æ–¹é¢ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è®¨è®ºä¸€ä¸‹æœ¯è¯­ **å­—ç¬¦ä¸²** çš„å…·ä½“æ„ä¹‰ã€‚Rust çš„æ ¸å¿ƒè¯­è¨€ä¸­åªæœ‰ä¸€ç§å­—ç¬¦ä¸²ç±»å‹ï¼šå­—ç¬¦ä¸² slice `str`ï¼Œå®ƒé€šå¸¸ä»¥è¢«å€Ÿç”¨çš„å½¢å¼å‡ºç°ï¼Œ`&str`ã€‚ç¬¬å››ç« è®²åˆ°äº† **å­—ç¬¦ä¸² slices**ï¼šå®ƒä»¬æ˜¯ä¸€äº›å¯¹å‚¨å­˜åœ¨åˆ«å¤„çš„ UTF-8 ç¼–ç å­—ç¬¦ä¸²æ•°æ®çš„å¼•ç”¨ã€‚ç”±äºå­—ç¬¦ä¸²å­—é¢å€¼è¢«å‚¨å­˜åœ¨ç¨‹åºçš„äºŒè¿›åˆ¶è¾“å‡ºä¸­ï¼Œå› æ­¤å­—ç¬¦ä¸²å­—é¢å€¼ä¹Ÿæ˜¯å­—ç¬¦ä¸² slicesã€‚

##### åˆ›å»ºå­—ç¬¦ä¸²

  äº‹å®ä¸Š `String` è¢«å®ç°ä¸ºä¸€ä¸ªå¸¦æœ‰ä¸€äº›é¢å¤–ä¿è¯ã€é™åˆ¶å’ŒåŠŸèƒ½çš„å­—èŠ‚ vector çš„å°è£…ã€‚å…¶ä¸­ä¸€ä¸ªåŒæ ·ä½œç”¨äº `Vec<T>` å’Œ `String` å‡½æ•°çš„ä¾‹å­æ˜¯ç”¨æ¥æ–°å»ºä¸€ä¸ªå®ä¾‹çš„ `new` å‡½æ•°ï¼š

  ```rust
    let mut s = String::new();
  ```

  è¿™æ–°å»ºäº†ä¸€ä¸ªå«åš `s` çš„ç©ºçš„å­—ç¬¦ä¸²ã€‚

  é€šå¸¸å­—ç¬¦ä¸²ä¼šæœ‰åˆå§‹æ•°æ®ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›ä¸€å¼€å§‹å°±æœ‰è¿™ä¸ªå­—ç¬¦ä¸²ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ `to_string` æ–¹æ³•ï¼Œå®ƒèƒ½ç”¨äºä»»ä½•å®ç°äº† `Display` trait çš„ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å­—é¢å€¼ï¼š

  ```rust
    let data = "initial contents";

    let s = data.to_string();

    // è¯¥æ–¹æ³•ä¹Ÿå¯ç›´æ¥ç”¨äºå­—ç¬¦ä¸²å­—é¢å€¼ï¼š
    let s = "initial contents".to_string();
  ```

##### æ›´æ–°å­—ç¬¦ä¸²

  - ä½¿ç”¨ `push_str` å’Œ `push` é™„åŠ å­—ç¬¦ä¸²

    `String` çš„å¤§å°å¯ä»¥å¢åŠ ï¼Œå…¶å†…å®¹ä¹Ÿå¯ä»¥æ”¹å˜ï¼Œå°±åƒå¯ä»¥æ”¾å…¥æ›´å¤šæ•°æ®æ¥æ”¹å˜ `Vec` çš„å†…å®¹ä¸€æ ·ã€‚å¦å¤–ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ `+` è¿ç®—ç¬¦æˆ– `format!` å®æ¥æ‹¼æ¥ `String` å€¼ã€‚

    å¯ä»¥é€šè¿‡ `push_str` æ–¹æ³•æ¥é™„åŠ å­—ç¬¦ä¸² sliceï¼Œä»è€Œä½¿ `String` å˜é•¿ï¼Œå¦‚ç¤ºä¾‹ 8-15 æ‰€ç¤ºã€‚

    ```rust
        let mut s = String::from("foo");
        s.push_str("bar");
    ```

    æ‰§è¡Œè¿™ä¸¤è¡Œä»£ç ä¹‹åï¼Œ`s` å°†ä¼šåŒ…å« `foobar`ã€‚`push_str` æ–¹æ³•é‡‡ç”¨å­—ç¬¦ä¸² sliceï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸éœ€è¦è·å–å‚æ•°çš„æ‰€æœ‰æƒã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å°† `s2` çš„å†…å®¹é™„åŠ åˆ° `s1` ä¹‹åè¿˜èƒ½ä½¿ç”¨å®ƒï¼š

    ```rust
        let mut s1 = String::from("foo");
        let s2 = "bar";
        s1.push_str(s2);
        println!("s2 is {s2}");
    ```

    `push` æ–¹æ³•è¢«å®šä¹‰ä¸ºè·å–ä¸€ä¸ªå•ç‹¬çš„å­—ç¬¦ä½œä¸ºå‚æ•°ï¼Œå¹¶é™„åŠ åˆ° `String` ä¸­ï¼š

    ```rust
        let mut s = String::from("lo");
        s.push('l');
    ```

  -  ä½¿ç”¨ `+` è¿ç®—ç¬¦æˆ– `format!` å®æ‹¼æ¥å­—ç¬¦ä¸²ğŸ§

     é€šå¸¸ä½ ä¼šå¸Œæœ›å°†ä¸¤ä¸ªå·²çŸ¥çš„å­—ç¬¦ä¸²åˆå¹¶åœ¨ä¸€èµ·ã€‚ä¸€ç§åŠæ³•æ˜¯åƒè¿™æ ·ä½¿ç”¨ `+` è¿ç®—ç¬¦ï¼š

     ```rust
         let s1 = String::from("Hello, ");
         let s2 = String::from("world!");
         let s3 = s1 + &s2; // æ³¨æ„ s1 è¢«ç§»åŠ¨äº†ï¼Œä¸èƒ½ç»§ç»­ä½¿ç”¨
     ```

     æ‰§è¡Œå®Œè¿™äº›ä»£ç ä¹‹åï¼Œå­—ç¬¦ä¸² `s3` å°†ä¼šåŒ…å« `Hello, world!`ã€‚`s1` åœ¨ç›¸åŠ åä¸å†æœ‰æ•ˆçš„åŸå› ï¼Œå’Œä½¿ç”¨ `s2` çš„å¼•ç”¨çš„åŸå› ï¼Œä¸ä½¿ç”¨ `+` è¿ç®—ç¬¦æ—¶è°ƒç”¨çš„å‡½æ•°ç­¾åæœ‰å…³ã€‚`+` è¿ç®—ç¬¦ä½¿ç”¨äº† `add` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç­¾åçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

     ```rust
     fn add(self, s: &str) -> String {
     ```

     é¦–å…ˆï¼Œ`s2` ä½¿ç”¨äº† `&`ï¼Œæ„å‘³ç€æˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒä¸ªå­—ç¬¦ä¸²çš„ **å¼•ç”¨** ä¸ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç›¸åŠ ã€‚è¿™æ˜¯å› ä¸º `add` å‡½æ•°çš„ `s` å‚æ•°ï¼šåªèƒ½å°† `&str` å’Œ `String` ç›¸åŠ ï¼Œä¸èƒ½å°†ä¸¤ä¸ª `String` å€¼ç›¸åŠ ã€‚ä¸è¿‡ç­‰ä¸€ä¸‹ â€”â€” æ­£å¦‚ `add` çš„ç¬¬äºŒä¸ªå‚æ•°æ‰€æŒ‡å®šçš„ï¼Œ`&s2` çš„ç±»å‹æ˜¯ `&String` è€Œä¸æ˜¯ `&str`ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆç¤ºä¾‹è¿˜èƒ½ç¼–è¯‘å‘¢ï¼Ÿ

     ä¹‹æ‰€ä»¥èƒ½å¤Ÿåœ¨ `add` è°ƒç”¨ä¸­ä½¿ç”¨ `&s2` æ˜¯å› ä¸º **`&String` å¯ä»¥è¢« å¼ºè½¬ï¼ˆ*coerced*ï¼‰æˆ `&str`**ã€‚å½“`add`å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼ŒRust ä½¿ç”¨äº†ä¸€ä¸ªè¢«ç§°ä¸º **Deref å¼ºåˆ¶è½¬æ¢**ï¼ˆ*deref coercion*ï¼‰çš„æŠ€æœ¯ï¼Œä½ å¯ä»¥å°†å…¶ç†è§£ä¸ºå®ƒæŠŠ `&s2` å˜æˆäº† `&s2[..]`ã€‚

     å…¶æ¬¡ï¼Œå¯ä»¥å‘ç°ç­¾åä¸­ `add` è·å–äº† `self` çš„æ‰€æœ‰æƒï¼Œå› ä¸º `self` **æ²¡æœ‰** ä½¿ç”¨ `&`ã€‚è¿™æ„å‘³ç€ç¤ºä¾‹ 8-18 ä¸­çš„ `s1` çš„æ‰€æœ‰æƒå°†è¢«ç§»åŠ¨åˆ° `add` è°ƒç”¨ä¸­ï¼Œä¹‹åå°±ä¸å†æœ‰æ•ˆã€‚æ‰€ä»¥è™½ç„¶ `let s3 = s1 + &s2;` çœ‹èµ·æ¥å°±åƒå®ƒä¼šå¤åˆ¶ä¸¤ä¸ªå­—ç¬¦ä¸²å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œè€Œå®é™…ä¸Šè¿™ä¸ªè¯­å¥ä¼šè·å– `s1` çš„æ‰€æœ‰æƒï¼Œé™„åŠ ä¸Šä» `s2` ä¸­æ‹·è´çš„å†…å®¹ï¼Œå¹¶è¿”å›ç»“æœçš„æ‰€æœ‰æƒã€‚æ¢å¥è¯è¯´ï¼Œå®ƒçœ‹èµ·æ¥å¥½åƒç”Ÿæˆäº†å¾ˆå¤šæ‹·è´ï¼Œä¸è¿‡å®é™…ä¸Šå¹¶æ²¡æœ‰ï¼Œè¿™ä¸ªå®ç°æ¯”æ‹·è´è¦æ›´é«˜æ•ˆã€‚

     å¦‚æœæƒ³è¦çº§è”å¤šä¸ªå­—ç¬¦ä¸²ï¼Œ`+` çš„è¡Œä¸ºå°±æ˜¾å¾—ç¬¨é‡äº†ï¼š

     ```rust
         let s1 = String::from("tic");
         let s2 = String::from("tac");
         let s3 = String::from("toe");
     
         let s = s1 + "-" + &s2 + "-" + &s3;
     ```

     è¿™æ—¶ `s` çš„å†…å®¹ä¼šæ˜¯ â€œtic-tac-toeâ€ã€‚åœ¨æœ‰è¿™ä¹ˆå¤š `+` å’Œ `"` å­—ç¬¦çš„æƒ…å†µä¸‹ï¼Œå¾ˆéš¾ç†è§£å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆã€‚å¯¹äºæ›´ä¸ºå¤æ‚çš„å­—ç¬¦ä¸²é“¾æ¥ï¼Œå¯ä»¥ä½¿ç”¨ `format!` å®ï¼š

     ```rust
         let s1 = String::from("tic");
         let s2 = String::from("tac");
         let s3 = String::from("toe");
     
         let s = format!("{s1}-{s2}-{s3}");
     ```

     è¿™äº›ä»£ç ä¹Ÿä¼šå°† `s` è®¾ç½®ä¸º â€œtic-tac-toeâ€ã€‚`format!` ä¸ `println!` çš„å·¥ä½œåŸç†ç›¸åŒï¼Œä¸è¿‡ä¸åŒäºå°†è¾“å‡ºæ‰“å°åˆ°å±å¹•ä¸Šï¼Œå®ƒè¿”å›ä¸€ä¸ªå¸¦æœ‰ç»“æœå†…å®¹çš„ `String`ã€‚è¿™ä¸ªç‰ˆæœ¬å°±å¥½ç†è§£çš„å¤šï¼Œå® `format!` ç”Ÿæˆçš„ä»£ç ä½¿ç”¨å¼•ç”¨æ‰€ä»¥ä¸ä¼šè·å–ä»»ä½•å‚æ•°çš„æ‰€æœ‰æƒã€‚

##### ç´¢å¼•å­—ç¬¦ä¸²

  åœ¨å¾ˆå¤šè¯­è¨€ä¸­ï¼Œé€šè¿‡ç´¢å¼•æ¥å¼•ç”¨å­—ç¬¦ä¸²ä¸­çš„å•ç‹¬å­—ç¬¦æ˜¯æœ‰æ•ˆä¸”å¸¸è§çš„æ“ä½œã€‚ç„¶è€Œåœ¨ Rust ä¸­ï¼Œå¦‚æœä½ å°è¯•ä½¿ç”¨ç´¢å¼•è¯­æ³•è®¿é—® `String` çš„ä¸€éƒ¨åˆ†ï¼Œä¼šå‡ºç°ä¸€ä¸ªé”™è¯¯ï¼š

  ```rust
    let s1 = String::from("hello");
    let h = s1[0];
______________________________________
compile error !
  ```

  **ğŸ§Rust çš„å­—ç¬¦ä¸²ä¸æ”¯æŒç´¢å¼•ï¼Œå› ä¸ºRustå­—ç¬¦ä¸²é‡‡ç”¨å˜é•¿çš„UTF-8ç¼–ç ã€‚**ç´¢å¼•æ“ä½œé¢„æœŸæ€»æ˜¯éœ€è¦å¸¸æ•°æ—¶é—´ï¼ˆO(1)ï¼‰ã€‚ä½†æ˜¯å¯¹äº `String` ä¸å¯èƒ½ä¿è¯è¿™æ ·çš„æ€§èƒ½ï¼Œå› ä¸º Rust å¿…é¡»ä»å¼€å¤´åˆ°ç´¢å¼•ä½ç½®éå†æ¥ç¡®å®šæœ‰å¤šå°‘æœ‰æ•ˆçš„å­—ç¬¦ã€‚

  ç´¢å¼•å­—ç¬¦ä¸²é€šå¸¸æ˜¯ä¸€ä¸ªåç‚¹å­ï¼Œå› ä¸ºå­—ç¬¦ä¸²ç´¢å¼•åº”è¯¥è¿”å›çš„ç±»å‹æ˜¯ä¸æ˜ç¡®çš„ï¼šå­—èŠ‚å€¼ã€å­—ç¬¦ã€å­—å½¢ç°‡æˆ–è€…å­—ç¬¦ä¸² sliceã€‚å› æ­¤ï¼Œå¦‚æœä½ çœŸçš„å¸Œæœ›ä½¿ç”¨ç´¢å¼•åˆ›å»ºå­—ç¬¦ä¸² slice æ—¶ï¼ŒRust ä¼šè¦æ±‚ä½ æ›´æ˜ç¡®ä¸€äº›ã€‚ä¸ºäº†æ›´æ˜ç¡®ç´¢å¼•å¹¶è¡¨æ˜ä½ éœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸² sliceï¼Œç›¸æ¯”ä½¿ç”¨ `[]` å’Œå•ä¸ªå€¼çš„ç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ `[]` å’Œä¸€ä¸ª range æ¥åˆ›å»ºå«ç‰¹å®šå­—èŠ‚çš„å­—ç¬¦ä¸² sliceï¼š

  ```rust
let hello = "Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ";

let s = &hello[0..4];
  ```

  è¿™é‡Œï¼Œ`s` ä¼šæ˜¯ä¸€ä¸ª `&str`ï¼Œå®ƒåŒ…å«å­—ç¬¦ä¸²çš„å¤´å››ä¸ªå­—èŠ‚ã€‚æ—©äº›æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°äº†è¿™äº›å­—æ¯éƒ½æ˜¯ä¸¤ä¸ªå­—èŠ‚é•¿çš„ï¼Œæ‰€ä»¥è¿™æ„å‘³ç€ `s` å°†ä¼šæ˜¯ â€œĞ—Ğ´â€ã€‚å¦‚æœè·å– `&hello[0..1]` ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šRust åœ¨è¿è¡Œæ—¶ä¼š panicï¼Œå°±è·Ÿè®¿é—® vector ä¸­çš„æ— æ•ˆç´¢å¼•æ—¶ä¸€æ ·ã€‚

##### éå†å­—ç¬¦ä¸²

  æ“ä½œå­—ç¬¦ä¸²æ¯ä¸€éƒ¨åˆ†çš„æœ€å¥½çš„æ–¹æ³•æ˜¯æ˜ç¡®è¡¨ç¤ºéœ€è¦å­—ç¬¦è¿˜æ˜¯å­—èŠ‚ã€‚å¯¹äºå•ç‹¬çš„ Unicode æ ‡é‡å€¼ä½¿ç”¨ `chars` æ–¹æ³•ã€‚å¯¹ â€œĞ—Ğ´â€ è°ƒç”¨ `chars` æ–¹æ³•ä¼šå°†å…¶åˆ†å¼€å¹¶è¿”å›ä¸¤ä¸ª `char` ç±»å‹çš„å€¼ï¼Œæ¥ç€å°±å¯ä»¥éå†å…¶ç»“æœæ¥è®¿é—®æ¯ä¸€ä¸ªå…ƒç´ äº†ï¼š

  ```rust
for c in "Ğ—Ğ´".chars() {
    println!("{c}");
}
  ```

  è¿™äº›ä»£ç ä¼šæ‰“å°å‡ºå¦‚ä¸‹å†…å®¹ï¼š

  ```text
Ğ—
Ğ´
  ```

  å¦å¤– `bytes` æ–¹æ³•è¿”å›æ¯ä¸€ä¸ªåŸå§‹å­—èŠ‚ï¼Œè¿™å¯èƒ½ä¼šé€‚åˆä½ çš„ä½¿ç”¨åœºæ™¯ï¼š

    ```rust

  for b in "Ğ—Ğ´".bytes() {
      println!("{b}");
  }
    ```

  è¿™äº›ä»£ç ä¼šæ‰“å°å‡ºç»„æˆ `String` çš„ 4 ä¸ªå­—èŠ‚ï¼š

  ```text
208
151
208
180
  ```

  ä¸è¿‡è¯·è®°ä½æœ‰æ•ˆçš„ Unicode æ ‡é‡å€¼å¯èƒ½ä¼šç”±ä¸æ­¢ä¸€ä¸ªå­—èŠ‚ç»„æˆã€‚

  ä»å­—ç¬¦ä¸²ä¸­è·å–å¦‚åŒå¤©åŸæ–‡è¿™æ ·çš„å­—å½¢ç°‡æ˜¯å¾ˆå¤æ‚çš„ï¼Œæ‰€ä»¥æ ‡å‡†åº“å¹¶æ²¡æœ‰æä¾›è¿™ä¸ªåŠŸèƒ½ã€‚

##### Stringå’Œ&sträº’è½¬ğŸ¤”

  `String` to ``&str`ï¼š

  ```rust
    let string: String = String::new();
    let slice: &str = string.as_str();
  ```

  `&str` to `String`ï¼š

  ```rust
    let slice: &str = "hello";
    let string: String = slice.to_string();
    let string: String = slice.to_owned();
    let string: String = slice.into();
  ```

#### Hash Map

##### åˆ›å»ºHash Map

  å¯ä»¥ä½¿ç”¨ `new` åˆ›å»ºä¸€ä¸ªç©ºçš„ `HashMap`ï¼Œå¹¶ä½¿ç”¨ `insert` å¢åŠ å…ƒç´ ï¼š

  ```rust
    use std::collections::HashMap;

    let mut scores = HashMap::new();

    scores.insert(String::from("Blue"), 10);
    scores.insert(String::from("Yellow"), 50);
  ```

  **æ³¨æ„å¿…é¡»é¦–å…ˆ `use` æ ‡å‡†åº“ä¸­é›†åˆéƒ¨åˆ†çš„ `HashMap`**ã€‚åœ¨è¿™ä¸‰ä¸ªå¸¸ç”¨é›†åˆä¸­ï¼Œ`HashMap` æ˜¯æœ€ä¸å¸¸ç”¨çš„ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è¢« prelude è‡ªåŠ¨å¼•ç”¨ã€‚

-  **è¯»å–Hash Map**

   å¯ä»¥é€šè¿‡ `get` æ–¹æ³•å¹¶æä¾›å¯¹åº”çš„é”®æ¥ä»å“ˆå¸Œ map ä¸­è·å–å€¼ï¼Œå¦‚ç¤ºä¾‹ 8-21 æ‰€ç¤ºï¼š

   ```rust
       use std::collections::HashMap;
   
       let mut scores = HashMap::new();
   
       scores.insert(String::from("Blue"), 10);
       scores.insert(String::from("Yellow"), 50);
   
       let team_name = String::from("Blue");
       let score = scores.get(&team_name).copied().unwrap_or(0);
   ```

   å¯ä»¥ä½¿ç”¨ä¸ vector ç±»ä¼¼çš„æ–¹å¼æ¥éå†å“ˆå¸Œ map ä¸­çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œä¹Ÿå°±æ˜¯ `for` å¾ªç¯ï¼š

   ```rust
       use std::collections::HashMap;
   
       let mut scores = HashMap::new();
   
       scores.insert(String::from("Blue"), 10);
       scores.insert(String::from("Yellow"), 50);
   
       for (key, value) in &scores {
           println!("{key}: {value}");
       }
   ```

   è¿™ä¼šä»¥ä»»æ„é¡ºåºæ‰“å°å‡ºæ¯ä¸€ä¸ªé”®å€¼å¯¹ï¼š

   ```text
   Yellow: 50
   Blue: 10
   ```

##### æ›´æ–°Hash Map

  - è¦†ç›–ä¸€ä¸ªå€¼

    å¦‚æœæˆ‘ä»¬æ’å…¥äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ¥ç€ç”¨ç›¸åŒçš„é”®æ’å…¥ä¸€ä¸ªä¸åŒçš„å€¼ï¼Œä¸è¿™ä¸ªé”®ç›¸å…³è”çš„æ—§å€¼å°†è¢«æ›¿æ¢ã€‚å³ä¾¿ç¤ºä¾‹ 8-23 ä¸­çš„ä»£ç è°ƒç”¨äº†ä¸¤æ¬¡ `insert`ï¼Œå“ˆå¸Œ map ä¹Ÿåªä¼šåŒ…å«ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå› ä¸ºä¸¤æ¬¡éƒ½æ˜¯å¯¹è“é˜Ÿçš„é”®æ’å…¥çš„å€¼ï¼š

    ```rust
      use std::collections::HashMap;
    
      let mut scores = HashMap::new();
    
      scores.insert(String::from("Blue"), 10);
      scores.insert(String::from("Blue"), 25);
    
      println!("{:?}", scores);
    ```

    è¿™ä¼šæ‰“å°å‡º `{"Blue": 25}`ã€‚åŸå§‹çš„å€¼ `10` åˆ™è¢«è¦†ç›–äº†ã€‚

  - åªåœ¨é”®æ²¡æœ‰å¯¹åº”å€¼æ—¶æ’å…¥é”®å€¼å¯¹

    æˆ‘ä»¬ç»å¸¸ä¼šæ£€æŸ¥æŸä¸ªç‰¹å®šçš„é”®æ˜¯å¦å·²ç»å­˜åœ¨äºå“ˆå¸Œ map ä¸­å¹¶è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šå¦‚æœå“ˆå¸Œ map ä¸­é”®å·²ç»å­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œã€‚å¦‚æœä¸å­˜åœ¨åˆ™è¿åŒå€¼ä¸€å—æ’å…¥ã€‚

    ä¸ºæ­¤å“ˆå¸Œ map æœ‰ä¸€ä¸ªç‰¹æœ‰çš„ APIï¼Œå«åš `entry`ï¼Œå®ƒè·å–æˆ‘ä»¬æƒ³è¦æ£€æŸ¥çš„é”®ä½œä¸ºå‚æ•°ã€‚`entry` å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæšä¸¾ï¼Œ`Entry`ï¼Œå®ƒä»£è¡¨äº†å¯èƒ½å­˜åœ¨ä¹Ÿå¯èƒ½ä¸å­˜åœ¨çš„å€¼ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬æƒ³è¦æ£€æŸ¥é»„é˜Ÿçš„é”®æ˜¯å¦å…³è”äº†ä¸€ä¸ªå€¼ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±æ’å…¥å€¼ 50ï¼Œå¯¹äºè“é˜Ÿä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä½¿ç”¨ `entry` API çš„ä»£ç çœ‹èµ·æ¥åƒç¤ºä¾‹ 8-24 è¿™æ ·ï¼š

    ```rust
        use std::collections::HashMap;
    
        let mut scores = HashMap::new();
        scores.insert(String::from("Blue"), 10);
    
        scores.entry(String::from("Yellow")).or_insert(50);
        scores.entry(String::from("Blue")).or_insert(50);
    
        println!("{:?}", scores);
    ```

### é”™è¯¯å¤„ç†

#### panic

æ‰§è¡Œä¼šé€ æˆä»£ç  panic çš„æ“ä½œï¼ˆæ¯”å¦‚è®¿é—®è¶…è¿‡æ•°ç»„ç»“å°¾çš„å†…å®¹ï¼‰æˆ–è€…æ˜¾å¼è°ƒç”¨ `panic!` å®ã€‚è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šä½¿ç¨‹åº panicã€‚é€šå¸¸æƒ…å†µä¸‹è¿™äº› panic ä¼šæ‰“å°å‡ºä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå±•å¼€å¹¶æ¸…ç†æ ˆæ•°æ®ï¼Œç„¶åé€€å‡ºã€‚

å½“å‡ºç° panic æ—¶ï¼Œç¨‹åºé»˜è®¤ä¼šå¼€å§‹ **å±•å¼€**ï¼ˆ*unwinding*ï¼‰ï¼Œè¿™æ„å‘³ç€ Rust ä¼šå›æº¯æ ˆå¹¶æ¸…ç†å®ƒé‡åˆ°çš„æ¯ä¸€ä¸ªå‡½æ•°çš„æ•°æ®ï¼Œä¸è¿‡è¿™ä¸ªå›æº¯å¹¶æ¸…ç†çš„è¿‡ç¨‹æœ‰å¾ˆå¤šå·¥ä½œã€‚å¦ä¸€ç§é€‰æ‹©æ˜¯ç›´æ¥ **ç»ˆæ­¢**ï¼ˆ*abort*ï¼‰ï¼Œè¿™ä¼šä¸æ¸…ç†æ•°æ®å°±é€€å‡ºç¨‹åºã€‚é‚£ä¹ˆç¨‹åºæ‰€ä½¿ç”¨çš„å†…å­˜éœ€è¦ç”±æ“ä½œç³»ç»Ÿæ¥æ¸…ç†ã€‚

å¦‚æœä½ éœ€è¦é¡¹ç›®çš„æœ€ç»ˆäºŒè¿›åˆ¶æ–‡ä»¶è¶Šå°è¶Šå¥½ï¼Œpanic æ—¶é€šè¿‡åœ¨ *Cargo.toml* çš„ `[profile]` éƒ¨åˆ†å¢åŠ  `panic = 'abort'`ï¼Œå¯ä»¥ç”±å±•å¼€åˆ‡æ¢ä¸ºç»ˆæ­¢ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³è¦åœ¨ release æ¨¡å¼ä¸­ panic æ—¶ç›´æ¥ç»ˆæ­¢ï¼š

```toml
[profile.release]
panic = 'abort'
```

##### ä½¿ç”¨ `panic!` çš„ backtrace

  é”™è¯¯æŒ‡å‘ `main.rs` çš„ç¬¬ 4 è¡Œï¼Œè¿™é‡Œæˆ‘ä»¬å°è¯•è®¿é—®ç´¢å¼• 99ã€‚ä¸‹é¢çš„è¯´æ˜ï¼ˆnoteï¼‰è¡Œæé†’æˆ‘ä»¬å¯ä»¥è®¾ç½® `RUST_BACKTRACE` ç¯å¢ƒå˜é‡æ¥å¾—åˆ°ä¸€ä¸ª backtraceã€‚*backtrace* æ˜¯ä¸€ä¸ªæ‰§è¡Œåˆ°ç›®å‰ä½ç½®æ‰€æœ‰è¢«è°ƒç”¨çš„å‡½æ•°çš„åˆ—è¡¨ã€‚Rust çš„ backtrace è·Ÿå…¶ä»–è¯­è¨€ä¸­çš„ä¸€æ ·ï¼šé˜…è¯» backtrace çš„å…³é”®æ˜¯ä»å¤´å¼€å§‹è¯»ç›´åˆ°å‘ç°ä½ ç¼–å†™çš„æ–‡ä»¶ã€‚è¿™å°±æ˜¯é—®é¢˜çš„å‘æºåœ°ã€‚è¿™ä¸€è¡Œå¾€ä¸Šæ˜¯ä½ çš„ä»£ç æ‰€è°ƒç”¨çš„ä»£ç ï¼›å¾€ä¸‹åˆ™æ˜¯è°ƒç”¨ä½ çš„ä»£ç çš„ä»£ç ã€‚è¿™äº›è¡Œå¯èƒ½åŒ…å«æ ¸å¿ƒ Rust ä»£ç ï¼Œæ ‡å‡†åº“ä»£ç æˆ–ç”¨åˆ°çš„ crate ä»£ç ã€‚

  è®©æˆ‘ä»¬å°† `RUST_BACKTRACE` ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºä»»ä½•ä¸æ˜¯ 0 çš„å€¼æ¥è·å– backtrace çœ‹çœ‹ï¼š

  ```console
$ RUST_BACKTRACE=1 cargo run
thread 'main' panicked at 'index out of bounds: the len is 3 but the index is 99', src/main.rs:4:5
stack backtrace:
   0: rust_begin_unwind
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/core/src/panicking.rs:142:14
   2: core::panicking::panic_bounds_check
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/core/src/panicking.rs:84:5
   3: <usize as core::slice::index::SliceIndex<[T]>>::index
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/core/src/slice/index.rs:242:10
   4: core::slice::index::<impl core::ops::index::Index<I> for [T]>::index
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/core/src/slice/index.rs:18:9
   5: <alloc::vec::Vec<T,A> as core::ops::index::Index<I>>::index
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/alloc/src/vec/mod.rs:2591:9
   6: panic::main
             at ./src/main.rs:4:5
   7: core::ops::function::FnOnce::call_once
             at /rustc/e092d0b6b43f2de967af0887873151bb1c0b18d3/library/core/src/ops/function.rs:248:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
  ```

  è¿™é‡Œæœ‰å¤§é‡çš„è¾“å‡ºï¼ä½ å®é™…çœ‹åˆ°çš„è¾“å‡ºå¯èƒ½å› ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œ Rust ç‰ˆæœ¬è€Œæœ‰æ‰€ä¸åŒã€‚ä¸ºäº†è·å–å¸¦æœ‰è¿™äº›ä¿¡æ¯çš„ backtraceï¼Œå¿…é¡»å¯ç”¨ debug æ ‡è¯†ã€‚å½“ä¸ä½¿ç”¨ `--release` å‚æ•°è¿è¡Œ cargo build æˆ– cargo run æ—¶ debug æ ‡è¯†ä¼šé»˜è®¤å¯ç”¨ï¼Œå°±åƒè¿™é‡Œä¸€æ ·ã€‚

#### Result

 `Result` æšä¸¾ï¼Œå®ƒå®šä¹‰æœ‰å¦‚ä¸‹ä¸¤ä¸ªæˆå‘˜ï¼Œ`Ok` å’Œ `Err`ï¼Œ `T` ä»£è¡¨æˆåŠŸæ—¶è¿”å›çš„ `Ok` æˆå‘˜ä¸­çš„æ•°æ®çš„ç±»å‹ï¼Œè€Œ `E` ä»£è¡¨å¤±è´¥æ—¶è¿”å›çš„ `Err` æˆå‘˜ä¸­çš„é”™è¯¯çš„ç±»å‹ï¼š

```rust
enum Result<T, E> {
    Ok(T),
    Err(E),
}
```

è®©æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªè¿”å› `Result` çš„å‡½æ•°ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¤±è´¥ï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼š

```rust
use std::fs::File;

fn main() {
    let greeting_file_result = File::open("hello.txt");
}
```

å½“ `File::open` æˆåŠŸæ—¶ï¼Œ`greeting_file_result` å˜é‡å°†ä¼šæ˜¯ä¸€ä¸ªåŒ…å«æ–‡ä»¶å¥æŸ„çš„ `Ok` å®ä¾‹ã€‚å½“å¤±è´¥æ—¶ï¼Œ`greeting_file_result` å˜é‡å°†ä¼šæ˜¯ä¸€ä¸ªåŒ…å«äº†æ›´å¤šå…³äºå‘ç”Ÿäº†ä½•ç§é”™è¯¯çš„ä¿¡æ¯çš„ `Err` å®ä¾‹ã€‚

æˆ‘ä»¬éœ€è¦åœ¨ä¸‹é¢çš„ä»£ç ä¸­å¢åŠ æ ¹æ® `File::open` è¿”å›å€¼è¿›è¡Œä¸åŒå¤„ç†çš„é€»è¾‘ï¼š

```rust
use std::fs::File;

fn main() {
    let greeting_file_result = File::open("hello.txt");

    let greeting_file = match greeting_file_result {
        Ok(file) => file,
        Err(error) => panic!("Problem opening the file: {:?}", error),
    };
}
```

æ³¨æ„ä¸ `Option` æšä¸¾ä¸€æ ·ï¼Œ`Result` æšä¸¾å’Œå…¶æˆå‘˜ä¹Ÿè¢«å¯¼å…¥åˆ°äº† prelude ä¸­ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦åœ¨ `match` åˆ†æ”¯ä¸­çš„ `Ok` å’Œ `Err` ä¹‹å‰æŒ‡å®š `Result::`ã€‚è¿™é‡Œæˆ‘ä»¬å‘Šè¯‰ Rust å½“ç»“æœæ˜¯ `Ok` æ—¶ï¼Œè¿”å› `Ok` æˆå‘˜ä¸­çš„ `file` å€¼ï¼Œç„¶åå°†è¿™ä¸ªæ–‡ä»¶å¥æŸ„èµ‹å€¼ç»™å˜é‡ `greeting_file`ã€‚`match` ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ–‡ä»¶å¥æŸ„æ¥è¿›è¡Œè¯»å†™ã€‚`match` çš„å¦ä¸€ä¸ªåˆ†æ”¯å¤„ç†ä» `File::open` å¾—åˆ° `Err` å€¼çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€‰æ‹©è°ƒç”¨ `panic!` å®ã€‚

##### åŒ¹é…ä¸åŒçš„é”™è¯¯

  ä¸Šé¢çš„ä»£ç ä¸ç®¡ `File::open` æ˜¯å› ä¸ºä»€ä¹ˆåŸå› å¤±è´¥éƒ½ä¼š `panic!`ã€‚æˆ‘ä»¬çœŸæ­£å¸Œæœ›çš„æ˜¯å¯¹ä¸åŒçš„é”™è¯¯åŸå› é‡‡å–ä¸åŒçš„è¡Œä¸ºï¼šå¦‚æœ `File::open `å› ä¸ºæ–‡ä»¶ä¸å­˜åœ¨è€Œå¤±è´¥ï¼Œæˆ‘ä»¬å¸Œæœ›åˆ›å»ºè¿™ä¸ªæ–‡ä»¶å¹¶è¿”å›æ–°æ–‡ä»¶çš„å¥æŸ„ã€‚å¦‚æœ `File::open` å› ä¸ºä»»ä½•å…¶ä»–åŸå› å¤±è´¥ï¼Œä¾‹å¦‚æ²¡æœ‰æ‰“å¼€æ–‡ä»¶çš„æƒé™ï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ› `panic!`ï¼š

  ```rust
use std::fs::File;
use std::io::ErrorKind;

fn main() {
    let greeting_file_result = File::open("hello.txt");

    let greeting_file = match greeting_file_result {
        Ok(file) => file,
        Err(error) => match error.kind() {
            ErrorKind::NotFound => match File::create("hello.txt") {
                Ok(fc) => fc,
                Err(e) => panic!("Problem creating the file: {:?}", e),
            },
            other_error => {
                panic!("Problem opening the file: {:?}", other_error);
            }
        },
    };
}
  ```

##### `unwrap` å’Œ `expect`

  `match` èƒ½å¤Ÿèƒœä»»å®ƒçš„å·¥ä½œï¼Œä¸è¿‡å®ƒå¯èƒ½æœ‰ç‚¹å†—é•¿å¹¶ä¸”ä¸æ€»æ˜¯èƒ½å¾ˆå¥½çš„è¡¨æ˜å…¶æ„å›¾ã€‚`Result<T, E>` ç±»å‹å®šä¹‰äº†å¾ˆå¤šè¾…åŠ©æ–¹æ³•æ¥å¤„ç†å„ç§æƒ…å†µã€‚å…¶ä¸­ä¹‹ä¸€å«åš `unwrap`ï¼Œå®ƒçš„å®ç°å°±ç±»ä¼¼äºä¸‹é¢çš„ `match` è¯­å¥ã€‚å¦‚æœ `Result` å€¼æ˜¯æˆå‘˜ `Ok`ï¼Œ`unwrap` ä¼šè¿”å› `Ok` ä¸­çš„å€¼ã€‚å¦‚æœ `Result` æ˜¯æˆå‘˜ `Err`ï¼Œ`unwrap` ä¼šä¸ºæˆ‘ä»¬è°ƒç”¨ `panic!`ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªå®è·µ `unwrap` çš„ä¾‹å­ï¼š


  ```rust
fn main() {
    let greeting_file_result = File::open("hello.txt");
    let greeting_file = match greeting_file_result {
        Ok(file) => file,
        Err(error) => panic!("Problem opening the file: {:?}", error),
    };
}
  ```

  ```rust
fn main() {
    let greeting_file = File::open("hello.txt").unwrap();
}
  ```

  å¦‚æœè°ƒç”¨è¿™æ®µä»£ç æ—¶ä¸å­˜åœ¨ *hello.txt* æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ä¸€ä¸ª `unwrap` è°ƒç”¨ `panic!` æ—¶æä¾›çš„é”™è¯¯ä¿¡æ¯ï¼š

  ```text
thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Os {
code: 2, kind: NotFound, message: "No such file or directory" }',
src/main.rs:4:49
  ```

  è¿˜æœ‰å¦ä¸€ä¸ªç±»ä¼¼äº `unwrap` çš„æ–¹æ³•å®ƒè¿˜å…è®¸æˆ‘ä»¬é€‰æ‹© `panic!` çš„é”™è¯¯ä¿¡æ¯ï¼š`expect`ã€‚ä½¿ç”¨ `expect` è€Œä¸æ˜¯ `unwrap` å¹¶æä¾›ä¸€ä¸ªå¥½çš„é”™è¯¯ä¿¡æ¯å¯ä»¥è¡¨æ˜ä½ çš„æ„å›¾å¹¶æ›´æ˜“äºè¿½è¸ª panic çš„æ ¹æºã€‚`expect` çš„è¯­æ³•çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

  ```rust
use std::fs::File;

fn main() {
    let greeting_file = File::open("hello.txt")
        .expect("hello.txt should be included in this project");
}
  ```

  `expect` ä¸ `unwrap` çš„ä½¿ç”¨æ–¹å¼ä¸€æ ·ï¼šè¿”å›æ–‡ä»¶å¥æŸ„æˆ–è°ƒç”¨ `panic!` å®ã€‚`expect` åœ¨è°ƒç”¨ `panic!` æ—¶ä½¿ç”¨çš„é”™è¯¯ä¿¡æ¯å°†æ˜¯æˆ‘ä»¬ä¼ é€’ç»™ `expect` çš„å‚æ•°ï¼Œè€Œä¸åƒ `unwrap` é‚£æ ·ä½¿ç”¨é»˜è®¤çš„ `panic!` ä¿¡æ¯ã€‚å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

  ```text
thread 'main' panicked at 'hello.txt should be included in this project: Error
{ repr: Os { code: 2, message: "No such file or directory" } }',
src/libcore/result.rs:906:4
  ```

#### ä¼ æ’­é”™è¯¯

å½“ç¼–å†™ä¸€ä¸ªå…¶å®å…ˆä¼šè°ƒç”¨ä¸€äº›å¯èƒ½ä¼šå¤±è´¥çš„æ“ä½œçš„å‡½æ•°æ—¶ï¼Œé™¤äº†åœ¨è¿™ä¸ªå‡½æ•°ä¸­å¤„ç†é”™è¯¯å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©è®©è°ƒç”¨è€…çŸ¥é“è¿™ä¸ªé”™è¯¯å¹¶å†³å®šè¯¥å¦‚ä½•å¤„ç†ã€‚è¿™è¢«ç§°ä¸º **ä¼ æ’­**ï¼ˆ*propagating*ï¼‰é”™è¯¯ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªä»æ–‡ä»¶ä¸­è¯»å–ç”¨æˆ·åçš„å‡½æ•°ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸èƒ½è¯»å–ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°†è¿™äº›é”™è¯¯è¿”å›ç»™è°ƒç”¨å®ƒçš„ä»£ç ï¼š

```rust
use std::fs::File;
use std::io::{self, Read};

fn read_username_from_file() -> Result<String, io::Error> {
    let username_file_result = File::open("hello.txt");

    let mut username_file = match username_file_result {
        Ok(file) => file,
        Err(e) => return Err(e),
    };

    let mut username = String::new();

    match username_file.read_to_string(&mut username) {
        Ok(_) => Ok(username),
        Err(e) => Err(e),
    }
}
```

##### `?`è¿ç®—ç¬¦

  è¿™ä¸ªå‡½æ•°å¯ä»¥ç¼–å†™æˆæ›´åŠ ç®€çŸ­çš„å½¢å¼ï¼Œ Rust æä¾›äº† `?` é—®å·è¿ç®—ç¬¦æ¥è¡¨ç¤ºé”™è¯¯ä¼ æ’­ï¼š

  ```rust
use std::fs::File;
use std::io::{self, Read};

fn read_username_from_file() -> Result<String, io::Error> {
    let mut username_file = File::open("hello.txt")?;
    let mut username = String::new();
    username_file.read_to_string(&mut username)?;
    Ok(username)
}
  ```

  å¦‚æœ `Result` çš„å€¼æ˜¯ `Ok`ï¼Œè¿™ä¸ªå¸¦`?`çš„è¡¨è¾¾å¼å°†ä¼šè¿”å› `Ok` ä¸­çš„å€¼è€Œç¨‹åºå°†ç»§ç»­æ‰§è¡Œã€‚å¦‚æœå€¼æ˜¯ `Err`ï¼Œ`Err` ä¸­çš„å€¼å°†ä½œä¸ºæ•´ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå°±å¥½åƒä½¿ç”¨äº† `return` å…³é”®å­—ä¸€æ ·ï¼Œè¿™æ ·é”™è¯¯å€¼å°±è¢«ä¼ æ’­ç»™äº†è°ƒç”¨è€…ã€‚

  `match` è¡¨è¾¾å¼ä¸ `?` è¿ç®—ç¬¦æ‰€åšçš„æœ‰ä¸€ç‚¹ä¸åŒï¼š**`?` è¿ç®—ç¬¦æ‰€ä½¿ç”¨çš„é”™è¯¯å€¼è¢«ä¼ é€’ç»™äº† `from` å‡½æ•°**ï¼Œå®ƒå®šä¹‰äºæ ‡å‡†åº“çš„ `From` trait ä¸­ï¼Œå…¶ç”¨æ¥å°†é”™è¯¯ä»ä¸€ç§ç±»å‹è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ã€‚å½“ `?` è¿ç®—ç¬¦è°ƒç”¨ `from` å‡½æ•°æ—¶ï¼Œæ”¶åˆ°çš„é”™è¯¯ç±»å‹è¢«è½¬æ¢ä¸ºç”±å½“å‰å‡½æ•°è¿”å›ç±»å‹æ‰€æŒ‡å®šçš„é”™è¯¯ç±»å‹ã€‚

  æˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨ `?` ä¹‹åç›´æ¥ä½¿ç”¨é“¾å¼æ–¹æ³•è°ƒç”¨æ¥è¿›ä¸€æ­¥ç¼©çŸ­ä»£ç ï¼š

  ```rust
use std::fs::File;
use std::io::{self, Read};

fn read_username_from_file() -> Result<String, io::Error> {
    let mut username = String::new();

    File::open("hello.txt")?.read_to_string(&mut username)?;

    Ok(username)
}
  ```

  

### æ³›å‹ã€Traitå’Œç”Ÿå‘½å‘¨æœŸ

#### æ³›å‹

##### åœ¨å‡½æ•°ä¸­ä½¿ç”¨æ³›å‹

  å‡½æ•° `largest` æœ‰æ³›å‹ç±»å‹ `T`ã€‚å®ƒæœ‰ä¸ªå‚æ•° `list`ï¼Œå…¶ç±»å‹æ˜¯å…ƒç´ ä¸º `T` çš„ sliceã€‚`largest` å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªä¸ `T` ç›¸åŒç±»å‹çš„å¼•ç”¨ã€‚

  ```rust
  fn largest<T>(list: &[T]) -> &T {
      let mut largest = &list[0];

      for item in list {
          if item > largest {
              largest = item;
          }
      }

      largest
  }

  fn main() {
      let number_list = vec![34, 50, 25, 100, 65];

      let result = largest(&number_list);
      println!("The largest number is {}", result);

      let char_list = vec!['y', 'm', 'a', 'q'];

      let result = largest(&char_list);
      println!("The largest char is {}", result);
  }
  ```

  å¦‚æœç°åœ¨å°±ç¼–è¯‘è¿™ä¸ªä»£ç ï¼Œä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š

  ```console
  error[E0369]: binary operation `>` cannot be applied to type `&T`
   --> src/main.rs:5:17
    |
  5 |         if item > largest {
    |            ---- ^ ------- &T
    |            |
    |            &T
    |
  help: consider restricting type parameter `T`
    |
  1 | fn largest<T: std::cmp::PartialOrd>(list: &[T]) -> &T {
    |             ++++++++++++++++++++++

  ```

  è¿™ä¸ªé”™è¯¯è¡¨æ˜ `largest` çš„å‡½æ•°ä½“ä¸èƒ½é€‚ç”¨äº `T` çš„æ‰€æœ‰å¯èƒ½çš„ç±»å‹ã€‚å› ä¸ºåœ¨å‡½æ•°ä½“éœ€è¦æ¯”è¾ƒ `T` ç±»å‹çš„å€¼ï¼Œä¸è¿‡å®ƒåªèƒ½ç”¨äºæˆ‘ä»¬çŸ¥é“å¦‚ä½•æ’åºçš„ç±»å‹ã€‚ä¸ºäº†å¼€å¯æ¯”è¾ƒåŠŸèƒ½ï¼Œæ ‡å‡†åº“ä¸­å®šä¹‰çš„ `std::cmp::PartialOrd` trait å¯ä»¥å®ç°ç±»å‹çš„æ¯”è¾ƒåŠŸèƒ½ã€‚ä¾ç…§å¸®åŠ©è¯´æ˜ä¸­çš„å»ºè®®ï¼Œæˆ‘ä»¬é™åˆ¶ `T` åªå¯¹å®ç°äº† `PartialOrd` çš„ç±»å‹æœ‰æ•ˆåä»£ç å°±å¯ä»¥ç¼–è¯‘äº†ï¼Œå› ä¸ºæ ‡å‡†åº“ä¸º `i32` å’Œ `char` å®ç°äº† `PartialOrd`ã€‚

##### åœ¨ç»“æ„ä½“ä¸­ä½¿ç”¨æ³›å‹

  ```rust
struct Point<T> {
    x: T,
    y: T,
}

fn main() {
    let integer = Point { x: 5, y: 10 };
    let float = Point { x: 1.0, y: 4.0 };
}
  ```

  æ³¨æ„ `Point<T>` çš„å®šä¹‰ä¸­åªä½¿ç”¨äº†ä¸€ä¸ªæ³›å‹ç±»å‹ï¼Œè¿™ä¸ªå®šä¹‰è¡¨æ˜ç»“æ„ä½“ `Point<T>` å¯¹äºä¸€äº›ç±»å‹ `T` æ˜¯æ³›å‹çš„ï¼Œè€Œä¸”å­—æ®µ `x` å’Œ `y` éƒ½æ˜¯ç›¸åŒç±»å‹çš„ï¼Œæ— è®ºå®ƒå…·ä½“æ˜¯ä½•ç±»å‹ã€‚

  å¦‚æœæƒ³è¦å®šä¹‰ä¸€ä¸ª `x` å’Œ `y` å¯ä»¥æœ‰ä¸åŒç±»å‹ä¸”ä»ç„¶æ˜¯æ³›å‹çš„ `Point` ç»“æ„ä½“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªæ³›å‹ç±»å‹å‚æ•°ã€‚åœ¨ç¤ºä¾‹ 10-8 ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹ `Point` çš„å®šä¹‰ä¸ºæ‹¥æœ‰ä¸¤ä¸ªæ³›å‹ç±»å‹ `T` å’Œ `U`ã€‚å…¶ä¸­å­—æ®µ `x` æ˜¯ `T` ç±»å‹çš„ï¼Œè€Œå­—æ®µ `y` æ˜¯ `U` ç±»å‹çš„ï¼š

  ```rust
struct Point<T, U> {
    x: T,
    y: U,
}

fn main() {
    let both_integer = Point { x: 5, y: 10 };
    let both_float = Point { x: 1.0, y: 4.0 };
    let integer_and_float = Point { x: 5, y: 4.0 };
}
  ```

##### åœ¨æšä¸¾ä¸­ä½¿ç”¨æ³›å‹

  å’Œç»“æ„ä½“ç±»ä¼¼ï¼Œæšä¸¾ä¹Ÿå¯ä»¥åœ¨æˆå‘˜ä¸­å­˜æ”¾æ³›å‹æ•°æ®ç±»å‹ã€‚ç¬¬å…­ç« æˆ‘ä»¬æ›¾ç”¨è¿‡æ ‡å‡†åº“æä¾›çš„ `Option<T>` æšä¸¾ï¼Œè¿™é‡Œå†å›é¡¾ä¸€ä¸‹ï¼š

  ```rust
enum Option<T> {
    Some(T),
    None,
}
  ```

  ç°åœ¨è¿™ä¸ªå®šä¹‰åº”è¯¥æ›´å®¹æ˜“ç†è§£äº†ã€‚å¦‚ä½ æ‰€è§ `Option<T>` æ˜¯ä¸€ä¸ªæ‹¥æœ‰æ³›å‹ `T` çš„æšä¸¾ï¼Œå®ƒæœ‰ä¸¤ä¸ªæˆå‘˜ï¼š`Some`ï¼Œå®ƒå­˜æ”¾äº†ä¸€ä¸ªç±»å‹ `T` çš„å€¼ï¼Œå’Œä¸å­˜åœ¨ä»»ä½•å€¼çš„`None`ã€‚é€šè¿‡ `Option<T>` æšä¸¾å¯ä»¥è¡¨è¾¾æœ‰ä¸€ä¸ªå¯èƒ½çš„å€¼çš„æŠ½è±¡æ¦‚å¿µï¼ŒåŒæ—¶å› ä¸º `Option<T>` æ˜¯æ³›å‹çš„ï¼Œæ— è®ºè¿™ä¸ªå¯èƒ½çš„å€¼æ˜¯ä»€ä¹ˆç±»å‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŠ½è±¡ã€‚

  æšä¸¾ä¹Ÿå¯ä»¥æ‹¥æœ‰å¤šä¸ªæ³›å‹ç±»å‹ã€‚ç¬¬ä¹ç« ä½¿ç”¨è¿‡çš„ `Result` æšä¸¾å®šä¹‰å°±æ˜¯ä¸€ä¸ªè¿™æ ·çš„ä¾‹å­ï¼š

  ```rust
enum Result<T, E> {
    Ok(T),
    Err(E),
}
  ```

  `Result` æšä¸¾æœ‰ä¸¤ä¸ªæ³›å‹ç±»å‹ï¼Œ`T` å’Œ `E`ã€‚`Result` æœ‰ä¸¤ä¸ªæˆå‘˜ï¼š`Ok`ï¼Œå®ƒå­˜æ”¾ä¸€ä¸ªç±»å‹ `T` çš„å€¼ï¼Œè€Œ `Err` åˆ™å­˜æ”¾ä¸€ä¸ªç±»å‹ `E` çš„å€¼ã€‚è¿™ä¸ªå®šä¹‰ä½¿å¾— `Result` æšä¸¾èƒ½å¾ˆæ–¹ä¾¿çš„è¡¨è¾¾ä»»ä½•å¯èƒ½æˆåŠŸï¼ˆè¿”å› `T` ç±»å‹çš„å€¼ï¼‰ä¹Ÿå¯èƒ½å¤±è´¥ï¼ˆè¿”å› `E` ç±»å‹çš„å€¼ï¼‰çš„æ“ä½œã€‚å®é™…ä¸Šï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨ç¤ºä¾‹ 9-3 ç”¨æ¥æ‰“å¼€æ–‡ä»¶çš„æ–¹å¼ï¼šå½“æˆåŠŸæ‰“å¼€æ–‡ä»¶çš„æ—¶å€™ï¼Œ`T` å¯¹åº”çš„æ˜¯ `std::fs::File` ç±»å‹ï¼›è€Œå½“æ‰“å¼€æ–‡ä»¶å‡ºç°é—®é¢˜æ—¶ï¼Œ`E` çš„å€¼åˆ™æ˜¯ `std::io::Error` ç±»å‹ã€‚

  å½“ä½ æ„è¯†åˆ°ä»£ç ä¸­å®šä¹‰äº†å¤šä¸ªç»“æ„ä½“æˆ–æšä¸¾ï¼Œå®ƒä»¬ä¸ä¸€æ ·çš„åœ°æ–¹åªæ˜¯å…¶ä¸­çš„å€¼çš„ç±»å‹çš„æ—¶å€™ï¼Œä¸å¦¨é€šè¿‡æ³›å‹ç±»å‹æ¥é¿å…é‡å¤ã€‚

##### åœ¨æ–¹æ³•ä¸­ä½¿ç”¨æ³›å‹

  åœ¨ä¸ºç»“æ„ä½“å’Œæšä¸¾å®ç°æ–¹æ³•æ—¶ï¼Œä¸€æ ·ä¹Ÿå¯ä»¥ç”¨æ³›å‹ï¼Œæ³¨æ„å¿…é¡»åœ¨ `impl` åé¢å£°æ˜ `T`ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ `Point<T>` ä¸Šå®ç°çš„æ–¹æ³•ä¸­ä½¿ç”¨ `T` äº†ã€‚ï¼š

  ```rust
struct Point<T> {
    x: T,
    y: T,
}

impl<T> Point<T> {
    fn x(&self) -> &T {
        &self.x
    }
}

fn main() {
    let p = Point { x: 5, y: 10 };

    println!("p.x = {}", p.x());
}
  ```

  å®šä¹‰æ–¹æ³•æ—¶ä¹Ÿå¯ä»¥ä¸ºæ³›å‹æŒ‡å®šé™åˆ¶ï¼ˆconstraintï¼‰ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€‰æ‹©ä¸º `Point<f32>` å®ä¾‹å®ç°æ–¹æ³•ï¼Œè€Œä¸æ˜¯ä¸ºæ³›å‹ `Point` å®ä¾‹ï¼Œè¿™æ®µä»£ç æ„å‘³ç€ `Point<f32>` ç±»å‹ä¼šæœ‰ä¸€ä¸ªæ–¹æ³• `distance_from_origin`ï¼Œè€Œå…¶ä»– `T` ä¸æ˜¯ `f32` ç±»å‹çš„ `Point<T>` å®ä¾‹åˆ™æ²¡æœ‰å®šä¹‰æ­¤æ–¹æ³•ï¼š

  ```rust
impl Point<f32> {
    fn distance_from_origin(&self) -> f32 {
        (self.x.powi(2) + self.y.powi(2)).sqrt()
    }
}
  ```

  ç»“æ„ä½“å®šä¹‰ä¸­çš„æ³›å‹ç±»å‹å‚æ•°å¹¶ä¸æ€»æ˜¯ä¸ç»“æ„ä½“æ–¹æ³•ç­¾åä¸­ä½¿ç”¨çš„æ³›å‹æ˜¯åŒä¸€ç±»å‹ã€‚è¿™ä¸ªæ–¹æ³•ç”¨ `self` çš„ `Point` ç±»å‹çš„ `x` å€¼ï¼ˆç±»å‹ `X1`ï¼‰å’Œå‚æ•°çš„ `Point` ç±»å‹çš„ `y` å€¼ï¼ˆç±»å‹ `Y2`ï¼‰æ¥åˆ›å»ºä¸€ä¸ªæ–° `Point` ç±»å‹çš„å®ä¾‹ï¼š

  ```rust
struct Point<X1, Y1> {
    x: X1,
    y: Y1,
}

impl<X1, Y1> Point<X1, Y1> {
    fn mixup<X2, Y2>(self, other: Point<X2, Y2>) -> Point<X1, Y2> {
        Point {
            x: self.x,
            y: other.y,
        }
    }
}

fn main() {
    let p1 = Point { x: 5, y: 10.4 };
    let p2 = Point { x: "Hello", y: 'c' };

    let p3 = p1.mixup(p2);

    println!("p3.x = {}, p3.y = {}", p3.x, p3.y);
}
  ```

  ç¤ºä¾‹ 10-11ï¼šæ–¹æ³•ä½¿ç”¨äº†ä¸ç»“æ„ä½“å®šä¹‰ä¸­ä¸åŒç±»å‹çš„æ³›å‹

##### æ³›å‹ä»£ç çš„æ€§èƒ½

  æ³›å‹å¹¶ä¸ä¼šä½¿ç¨‹åºæ¯”å…·ä½“ç±»å‹è¿è¡Œå¾—æ…¢ã€‚Rust é€šè¿‡åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ³›å‹ä»£ç çš„ **å•æ€åŒ–**ï¼ˆ*monomorphization*ï¼‰æ¥ä¿è¯æ•ˆç‡ã€‚å•æ€åŒ–æ˜¯ä¸€ä¸ªé€šè¿‡å¡«å……ç¼–è¯‘æ—¶ä½¿ç”¨çš„å…·ä½“ç±»å‹ï¼Œå°†é€šç”¨ä»£ç è½¬æ¢ä¸ºç‰¹å®šä»£ç çš„è¿‡ç¨‹ã€‚

  è®©æˆ‘ä»¬çœ‹çœ‹è¿™å¦‚ä½•ç”¨äºæ ‡å‡†åº“ä¸­çš„ `Option` æšä¸¾ï¼š

  ```rust
let integer = Some(5);
let float = Some(5.0);
  ```

  å½“ Rust ç¼–è¯‘è¿™äº›ä»£ç çš„æ—¶å€™ï¼Œå®ƒä¼šè¿›è¡Œå•æ€åŒ–ã€‚ç¼–è¯‘å™¨ä¼šè¯»å–ä¼ é€’ç»™ `Option<T>` çš„å€¼å¹¶å‘ç°æœ‰ä¸¤ç§ `Option<T>`ï¼šä¸€ä¸ªå¯¹åº” `i32` å¦ä¸€ä¸ªå¯¹åº” `f64`ã€‚ä¸ºæ­¤ï¼Œå®ƒä¼šå°†æ³›å‹å®šä¹‰ `Option<T>` å±•å¼€ä¸ºä¸¤ä¸ªé’ˆå¯¹ `i32` å’Œ `f64` çš„å®šä¹‰ï¼Œæ¥ç€å°†æ³›å‹å®šä¹‰æ›¿æ¢ä¸ºè¿™ä¸¤ä¸ªå…·ä½“çš„å®šä¹‰ã€‚

  ç¼–è¯‘å™¨ç”Ÿæˆçš„å•æ€åŒ–ç‰ˆæœ¬çš„ä»£ç çœ‹èµ·æ¥åƒè¿™æ ·ï¼ˆç¼–è¯‘å™¨ä¼šä½¿ç”¨ä¸åŒäºå¦‚ä¸‹å‡æƒ³çš„åå­—ï¼‰ï¼š

  ```rust
enum Option_i32 {
    Some(i32),
    None,
}

enum Option_f64 {
    Some(f64),
    None,
}

fn main() {
    let integer = Option_i32::Some(5);
    let float = Option_f64::Some(5.0);
}
  ```

  æ³›å‹ `Option<T>` è¢«ç¼–è¯‘å™¨æ›¿æ¢ä¸ºäº†å…·ä½“çš„å®šä¹‰ã€‚å› ä¸º Rust ä¼šå°†æ¯ç§æƒ…å†µä¸‹çš„æ³›å‹ä»£ç ç¼–è¯‘ä¸ºå…·ä½“ç±»å‹ï¼Œä½¿ç”¨æ³›å‹æ²¡æœ‰è¿è¡Œæ—¶å¼€é”€ã€‚å½“ä»£ç è¿è¡Œæ—¶ï¼Œå®ƒçš„æ‰§è¡Œæ•ˆç‡å°±è·Ÿå¥½åƒæ‰‹å†™æ¯ä¸ªå…·ä½“å®šä¹‰çš„é‡å¤ä»£ç ä¸€æ ·ã€‚è¿™ä¸ªå•æ€åŒ–è¿‡ç¨‹æ­£æ˜¯ Rust æ³›å‹åœ¨è¿è¡Œæ—¶æå…¶é«˜æ•ˆçš„åŸå› ã€‚

#### Trait

##### å®šä¹‰trait

  ä¸€ä¸ªç±»å‹çš„è¡Œä¸ºç”±å…¶å¯ä¾›è°ƒç”¨çš„æ–¹æ³•æ„æˆã€‚å¦‚æœå¯ä»¥å¯¹ä¸åŒç±»å‹è°ƒç”¨ç›¸åŒçš„æ–¹æ³•çš„è¯ï¼Œè¿™äº›ç±»å‹å°±å¯ä»¥å…±äº«ç›¸åŒçš„è¡Œä¸ºäº†ã€‚trait å®šä¹‰æ˜¯ä¸€ç§å°†æ–¹æ³•ç­¾åç»„åˆèµ·æ¥çš„æ–¹æ³•ï¼Œç›®çš„æ˜¯å®šä¹‰ä¸€ä¸ªå®ç°æŸäº›ç›®çš„æ‰€å¿…éœ€çš„è¡Œä¸ºçš„é›†åˆã€‚

  æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªåä¸º `aggregator` çš„å¤šåª’ä½“èšåˆåº“ç”¨æ¥æ˜¾ç¤ºå¯èƒ½å‚¨å­˜åœ¨ `NewsArticle` æˆ– `Tweet` å®ä¾‹ä¸­çš„æ•°æ®æ‘˜è¦ã€‚ä¸ºäº†å®ç°åŠŸèƒ½ï¼Œæ¯ä¸ªç»“æ„ä½“éƒ½è¦èƒ½å¤Ÿè·å–æ‘˜è¦ï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥è°ƒç”¨å®ä¾‹çš„ `summarize` æ–¹æ³•æ¥è¯·æ±‚æ‘˜è¦ã€‚

  ```rust
pub trait Summary {
    fn summarize(&self) -> String;
}
  ```

##### å®ç°trait

  ç°åœ¨æˆ‘ä»¬å®šä¹‰äº† `Summary` trait çš„ç­¾åï¼Œæ¥ç€å°±å¯ä»¥åœ¨å¤šåª’ä½“èšåˆåº“ä¸­å®ç°è¿™ä¸ªç±»å‹äº†ã€‚ç¤ºä¾‹ä¸­å±•ç¤ºäº† `NewsArticle` ç»“æ„ä½“ä¸Š `Summary` trait çš„ä¸€ä¸ªå®ç°ï¼Œå®ƒä½¿ç”¨æ ‡é¢˜ã€ä½œè€…å’Œåˆ›å»ºçš„ä½ç½®ä½œä¸º `summarize` çš„è¿”å›å€¼ã€‚å¯¹äº `Tweet` ç»“æ„ä½“ï¼Œæˆ‘ä»¬é€‰æ‹©å°† `summarize` å®šä¹‰ä¸ºç”¨æˆ·ååè·Ÿæ¨æ–‡çš„å…¨éƒ¨æ–‡æœ¬ä½œä¸ºè¿”å›å€¼ã€‚

  ```rust
pub struct NewsArticle {
    pub headline: String,
    pub location: String,
    pub author: String,
    pub content: String,
}

impl Summary for NewsArticle {
    fn summarize(&self) -> String {
        format!("{}, by {} ({})", self.headline, self.author, self.location)
    }
}

pub struct Tweet {
    pub username: String,
    pub content: String,
    pub reply: bool,
    pub retweet: bool,
}

impl Summary for Tweet {
    fn summarize(&self) -> String {
        format!("{}: {}", self.username, self.content)
    }
}
  ```

  ç°åœ¨åº“åœ¨ `NewsArticle` å’Œ `Tweet` ä¸Šå®ç°äº†`Summary` traitï¼Œcrate çš„ç”¨æˆ·å¯ä»¥åƒè°ƒç”¨å¸¸è§„æ–¹æ³•ä¸€æ ·è°ƒç”¨ `NewsArticle` å’Œ `Tweet` å®ä¾‹çš„ trait æ–¹æ³•äº†ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ trait å¿…é¡»å’Œç±»å‹ä¸€èµ·å¼•å…¥ä½œç”¨åŸŸä»¥ä¾¿ä½¿ç”¨é¢å¤–çš„ trait æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ crate å¦‚ä½•åˆ©ç”¨ `aggregator` åº“ crate çš„ä¾‹å­ï¼š

  ```rust
use aggregator::{Summary, Tweet};

fn main() {
    let tweet = Tweet {
        username: String::from("horse_ebooks"),
        content: String::from(
            "of course, as you probably already know, people",
        ),
        reply: false,
        retweet: false,
    };

    println!("1 new tweet: {}", tweet.summarize());
}
  ```

  è¿™ä¼šæ‰“å°å‡º `1 new tweet: horse_ebooks: of course, as you probably already know, people`ã€‚

  å®ç° trait æ—¶éœ€è¦æ³¨æ„çš„ä¸€ä¸ªé™åˆ¶æ˜¯ï¼Œåªæœ‰å½“è‡³å°‘ä¸€ä¸ª trait æˆ–è€…è¦å®ç° trait çš„ç±»å‹ä½äº crate çš„æœ¬åœ°ä½œç”¨åŸŸæ—¶ï¼Œæ‰èƒ½ä¸ºè¯¥ç±»å‹å®ç° traitã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä¸º `aggregator` crate çš„è‡ªå®šä¹‰ç±»å‹ `Tweet` å®ç°å¦‚æ ‡å‡†åº“ä¸­çš„ `Display` traitï¼Œè¿™æ˜¯å› ä¸º `Tweet` ç±»å‹ä½äº `aggregator` crate æœ¬åœ°çš„ä½œç”¨åŸŸä¸­ã€‚ç±»ä¼¼åœ°ï¼Œä¹Ÿå¯ä»¥åœ¨ `aggregator` crate ä¸­ä¸º `Vec<T>` å®ç° `Summary`ï¼Œè¿™æ˜¯å› ä¸º `Summary` trait ä½äº `aggregator` crate æœ¬åœ°ä½œç”¨åŸŸä¸­ã€‚

  ä¸èƒ½ä¸ºå¤–éƒ¨ç±»å‹å®ç°å¤–éƒ¨ traitã€‚ä¾‹å¦‚ï¼Œä¸èƒ½åœ¨ `aggregator` crate ä¸­ä¸º `Vec<T>` å®ç° `Display` traitã€‚è¿™æ˜¯å› ä¸º `Display` å’Œ `Vec<T>` éƒ½å®šä¹‰äºæ ‡å‡†åº“ä¸­ï¼Œå®ƒä»¬å¹¶ä¸ä½äº `aggregator` crate æœ¬åœ°ä½œç”¨åŸŸä¸­ã€‚è¿™ä¸ªé™åˆ¶æ˜¯è¢«ç§°ä¸º **ç›¸å¹²æ€§**ï¼ˆ*coherence*ï¼‰çš„ç¨‹åºå±æ€§çš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…æ›´å…·ä½“çš„è¯´æ˜¯ **å­¤å„¿è§„åˆ™**ï¼ˆ*orphan rule*ï¼‰ï¼Œå…¶å¾—åäºä¸å­˜åœ¨çˆ¶ç±»å‹ã€‚è¿™æ¡è§„åˆ™ç¡®ä¿äº†å…¶ä»–äººç¼–å†™çš„ä»£ç ä¸ä¼šç ´åä½ ä»£ç ï¼Œåä¹‹äº¦ç„¶ã€‚æ²¡æœ‰è¿™æ¡è§„åˆ™çš„è¯ï¼Œä¸¤ä¸ª crate å¯ä»¥åˆ†åˆ«å¯¹ç›¸åŒç±»å‹å®ç°ç›¸åŒçš„ traitï¼Œè€Œ Rust å°†æ— ä»å¾—çŸ¥åº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ªå®ç°ã€‚

##### traité»˜è®¤å®ç°

  ç¤ºä¾‹ä¸­æˆ‘ä»¬ä¸º `Summary` trait çš„ `summarize` æ–¹æ³•æŒ‡å®šä¸€ä¸ªé»˜è®¤çš„å­—ç¬¦ä¸²å€¼ï¼Œè€Œä¸æ˜¯åªå®šä¹‰æ–¹æ³•ç­¾åï¼š

  ```rust
pub trait Summary {
      fn summarize(&self) -> String {
          String::from("(Read more...)")
      }
  }
  ```

  å¦‚æœæƒ³è¦å¯¹ `NewsArticle` å®ä¾‹ä½¿ç”¨è¿™ä¸ªé»˜è®¤å®ç°ï¼Œå¯ä»¥é€šè¿‡ `impl Summary for NewsArticle {}` æŒ‡å®šä¸€ä¸ªç©ºçš„ `impl` å—ã€‚

  **é»˜è®¤å®ç°å…è®¸è°ƒç”¨ç›¸åŒ trait ä¸­çš„å…¶ä»–æ–¹æ³•ï¼Œå“ªæ€•è¿™äº›æ–¹æ³•æ²¡æœ‰é»˜è®¤å®ç°ã€‚**å¦‚æ­¤ï¼Œtrait å¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„åŠŸèƒ½è€Œåªéœ€è¦å®ç°æŒ‡å®šä¸€å°éƒ¨åˆ†å†…å®¹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ `Summary` traitï¼Œä½¿å…¶å…·æœ‰ä¸€ä¸ªéœ€è¦å®ç°çš„ `summarize_author` æ–¹æ³•ï¼Œç„¶åå®šä¹‰ä¸€ä¸ª `summarize` æ–¹æ³•ï¼Œæ­¤æ–¹æ³•çš„é»˜è®¤å®ç°è°ƒç”¨ `summarize_author` æ–¹æ³•ï¼š

  ```rust
pub trait Summary {
      fn summarize_author(&self) -> String;
  
      fn summarize(&self) -> String {
          format!("(Read more from {}...)", self.summarize_author())
      }
  }
  ```

  ä¸ºäº†ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„ `Summary`ï¼Œåªéœ€åœ¨å®ç° trait æ—¶å®šä¹‰ `summarize_author` å³å¯ï¼š

  ```rust
impl Summary for Tweet {
      fn summarize_author(&self) -> String {
          format!("@{}", self.username)
      }
  }
  ```

  ä¸€æ—¦å®šä¹‰äº† `summarize_author`ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ `Tweet` ç»“æ„ä½“çš„å®ä¾‹è°ƒç”¨ `summarize` äº†ï¼Œè€Œ `summarize` çš„é»˜è®¤å®ç°ä¼šè°ƒç”¨æˆ‘ä»¬æä¾›çš„ `summarize_author` å®šä¹‰ã€‚å› ä¸ºå®ç°äº† `summarize_author`ï¼Œ`Summary` trait å°±æä¾›äº† `summarize` æ–¹æ³•çš„åŠŸèƒ½ï¼Œä¸”æ— éœ€ç¼–å†™æ›´å¤šçš„ä»£ç ã€‚

  ```rust
  let tweet = Tweet {
        username: String::from("horse_ebooks"),
        content: String::from(
            "of course, as you probably already know, people",
        ),
        reply: false,
        retweet: false,
    };

    println!("1 new tweet: {}", tweet.summarize());
  ```

  è¿™ä¼šæ‰“å°å‡º `1 new tweet: (Read more from @horse_ebooks...)`ã€‚

-  **`impl Trait` è¯­æ³•**

   ä½¿ç”¨ `impl Trait` è¯­æ³•ï¼Œä½¿å¾—å‚æ•°æ”¯æŒä»»ä½•å®ç°äº†æŒ‡å®š trait çš„ç±»å‹ã€‚ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’ä»»ä½• `NewsArticle` æˆ– `Tweet` çš„å®ä¾‹æ¥è°ƒç”¨ `notify`ï¼Œåœ¨ `notify` å‡½æ•°ä½“ä¸­ï¼Œå¯ä»¥è°ƒç”¨ä»»ä½•æ¥è‡ª `Summary` trait çš„æ–¹æ³•ï¼Œæ¯”å¦‚ `summarize`ã€‚ä»»ä½•ç”¨å…¶å®ƒå¦‚ `String` æˆ– `i32` çš„ç±»å‹è°ƒç”¨è¯¥å‡½æ•°çš„ä»£ç éƒ½ä¸èƒ½ç¼–è¯‘ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰å®ç° `Summary`ï¼š

   ```rust
   pub fn notify(item: &impl Summary) {
       println!("Breaking news! {}", item.summarize());
   }
   ```

   `impl Trait` è¯­æ³•é€‚ç”¨äºç›´è§‚çš„ä¾‹å­ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ç§è¾ƒé•¿å½¢å¼è¯­æ³•çš„è¯­æ³•ç³–ã€‚æˆ‘ä»¬ç§°ä¸º ***trait bound***ï¼Œå®ƒçœ‹èµ·æ¥åƒï¼š

   ```rust
   pub fn notify<T: Summary>(item: &T) {
       println!("Breaking news! {}", item.summarize());
   }
   ```

   è¿™ä¸ä¹‹å‰çš„ä¾‹å­ç›¸åŒï¼Œä¸è¿‡ç¨å¾®å†—é•¿äº†ä¸€äº›ã€‚trait bound ä¸æ³›å‹å‚æ•°å£°æ˜åœ¨ä¸€èµ·ï¼Œä½äºå°–æ‹¬å·ä¸­çš„å†’å·åé¢ã€‚

   ç„¶è€Œï¼Œä½¿ç”¨è¿‡å¤šçš„ trait bound ä¹Ÿæœ‰ç¼ºç‚¹ã€‚æ¯ä¸ªæ³›å‹æœ‰å…¶è‡ªå·±çš„ trait boundï¼Œæ‰€ä»¥æœ‰å¤šä¸ªæ³›å‹å‚æ•°çš„å‡½æ•°åœ¨åç§°å’Œå‚æ•°åˆ—è¡¨ä¹‹é—´ä¼šæœ‰å¾ˆé•¿çš„ trait bound ä¿¡æ¯ï¼Œè¿™ä½¿å¾—å‡½æ•°ç­¾åéš¾ä»¥é˜…è¯»ã€‚ä¸ºæ­¤ï¼ŒRust æœ‰å¦ä¸€ä¸ªåœ¨å‡½æ•°ç­¾åä¹‹åçš„ **`where` ä»å¥**ä¸­æŒ‡å®š trait bound çš„è¯­æ³•ã€‚æ‰€ä»¥é™¤äº†è¿™ä¹ˆå†™ï¼š

   ```rust
   fn some_function<T: Display + Clone, U: Clone + Debug>(t: &T, u: &U) -> i32 {
   ```

   è¿˜å¯ä»¥åƒè¿™æ ·ä½¿ç”¨ `where` ä»å¥ï¼š

   ```rust
   fn some_function<T, U>(t: &T, u: &U) -> i32
   where
       T: Display + Clone,
       U: Clone + Debug,
   {
   ```

   è¿™ä¸ªå‡½æ•°ç­¾åå°±æ˜¾å¾—ä¸é‚£ä¹ˆæ‚ä¹±ï¼Œå‡½æ•°åã€å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹éƒ½ç¦»å¾—å¾ˆè¿‘ï¼Œçœ‹èµ·æ¥è·Ÿæ²¡æœ‰é‚£ä¹ˆå¤š trait bounds çš„å‡½æ•°å¾ˆåƒã€‚

   

   ä¹Ÿå¯ä»¥åœ¨è¿”å›å€¼ä¸­ä½¿ç”¨ `impl Trait` è¯­æ³•ï¼Œæ¥è¿”å›å®ç°äº†æŸä¸ª trait çš„ç±»å‹ï¼š

   ```rust
   fn returns_summarizable() -> impl Summary {
       Tweet {
           username: String::from("horse_ebooks"),
           content: String::from(
               "of course, as you probably already know, people",
           ),
           reply: false,
           retweet: false,
       }
   }
   ```

   é€šè¿‡ä½¿ç”¨ `impl Summary` ä½œä¸ºè¿”å›å€¼ç±»å‹ï¼Œæˆ‘ä»¬æŒ‡å®šäº† `returns_summarizable` å‡½æ•°è¿”å›æŸä¸ªå®ç°äº† `Summary` trait çš„ç±»å‹ï¼Œä½†æ˜¯ä¸ç¡®å®šå…¶å…·ä½“çš„ç±»å‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ `returns_summarizable` è¿”å›äº†ä¸€ä¸ª `Tweet`ï¼Œä¸è¿‡è°ƒç”¨æ–¹å¹¶ä¸çŸ¥æƒ…ã€‚

   

   é€šè¿‡ä½¿ç”¨å¸¦æœ‰ trait bound çš„æ³›å‹å‚æ•°çš„ `impl` å—ï¼Œå¯ä»¥æœ‰æ¡ä»¶åœ°åªä¸ºé‚£äº›å®ç°äº†ç‰¹å®š trait çš„ç±»å‹å®ç°æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢ä»£ç ä¸­çš„ç±»å‹ `Pair<T>` æ€»æ˜¯å®ç°äº† `new` æ–¹æ³•å¹¶è¿”å›ä¸€ä¸ª `Pair<T>` çš„å®ä¾‹ã€‚ä¸è¿‡åœ¨ä¸‹ä¸€ä¸ª `impl` å—ä¸­ï¼Œåªæœ‰é‚£äº›ä¸º `T` ç±»å‹å®ç°äº† `PartialOrd` traitï¼ˆæ¥å…è®¸æ¯”è¾ƒï¼‰ **å’Œ** `Display` traitï¼ˆæ¥å¯ç”¨æ‰“å°ï¼‰çš„ `Pair<T>` æ‰ä¼šå®ç° `cmp_display` æ–¹æ³•ï¼š

   ```rust
   use std::fmt::Display;
   
   struct Pair<T> {
       x: T,
       y: T,
   }
   
   impl<T> Pair<T> {
       fn new(x: T, y: T) -> Self {
           Self { x, y }
       }
   }
   
   impl<T: Display + PartialOrd> Pair<T> {
       fn cmp_display(&self) {
           if self.x >= self.y {
               println!("The largest member is x = {}", self.x);
           } else {
               println!("The largest member is y = {}", self.y);
           }
       }
   }
   ```

   ä¹Ÿå¯ä»¥å¯¹ä»»ä½•å®ç°äº†ç‰¹å®š trait çš„ç±»å‹æœ‰æ¡ä»¶åœ°å®ç° traitã€‚å¯¹ä»»ä½•æ»¡è¶³ç‰¹å®š trait bound çš„ç±»å‹å®ç° trait è¢«ç§°ä¸º *blanket implementations*ï¼Œå®ƒä»¬è¢«å¹¿æ³›çš„ç”¨äº Rust æ ‡å‡†åº“ä¸­ã€‚ä¾‹å¦‚ï¼Œæ ‡å‡†åº“ä¸ºä»»ä½•å®ç°äº† `Display` trait çš„ç±»å‹å®ç°äº† `ToString` traitã€‚è¿™ä¸ª `impl` å—çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

   ```rust
   impl<T: Display> ToString for T {
       // --snip--
   }
   ```

#### ç”Ÿå‘½å‘¨æœŸğŸ§

ç”Ÿå‘½å‘¨æœŸæ˜¯å¦ä¸€ç±»æˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡çš„æ³›å‹ã€‚ä¸åŒäºç¡®ä¿ç±»å‹æœ‰æœŸæœ›çš„è¡Œä¸ºï¼Œç”Ÿå‘½å‘¨æœŸç¡®ä¿å¼•ç”¨å¦‚é¢„æœŸä¸€ç›´æœ‰æ•ˆã€‚**ç”Ÿå‘½å‘¨æœŸçš„ä¸»è¦ç›®æ ‡æ˜¯é¿å…æ‚¬å‚å¼•ç”¨**ã€‚è€ƒè™‘ä¸‹é¢çš„ç¨‹åºï¼Œå®ƒæœ‰ä¸€ä¸ªå¤–éƒ¨ä½œç”¨åŸŸå’Œä¸€ä¸ªå†…éƒ¨ä½œç”¨åŸŸï¼š

```rust
fn main() {
    let r;

    {
        let x = 5;
        r = &x;
    }

    println!("r: {}", r);
}
```

å¤–éƒ¨ä½œç”¨åŸŸå£°æ˜äº†ä¸€ä¸ªæ²¡æœ‰åˆå€¼çš„å˜é‡ `r`ï¼Œè€Œå†…éƒ¨ä½œç”¨åŸŸå£°æ˜äº†ä¸€ä¸ªåˆå€¼ä¸º 5 çš„å˜é‡`x`ã€‚åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­ï¼Œæˆ‘ä»¬å°è¯•å°† `r` çš„å€¼è®¾ç½®ä¸ºä¸€ä¸ª `x` çš„å¼•ç”¨ã€‚æ¥ç€åœ¨å†…éƒ¨ä½œç”¨åŸŸç»“æŸåï¼Œå°è¯•æ‰“å°å‡º `r` çš„å€¼ã€‚è¿™æ®µä»£ç ä¸èƒ½ç¼–è¯‘å› ä¸º `r` å¼•ç”¨çš„å€¼åœ¨å°è¯•ä½¿ç”¨ä¹‹å‰å°±ç¦»å¼€äº†ä½œç”¨åŸŸã€‚å¦‚ä¸‹æ˜¯é”™è¯¯ä¿¡æ¯ï¼š

```console
error[E0597]: `x` does not live long enough
 --> src/main.rs:6:13
  |
6 |         r = &x;
  |             ^^ borrowed value does not live long enough
7 |     }
  |     - `x` dropped here while still borrowed
8 |
9 |     println!("r: {}", r);
  |                       - borrow later used here
```

å˜é‡ `x` å¹¶æ²¡æœ‰ â€œå­˜åœ¨çš„è¶³å¤Ÿä¹…â€ã€‚å…¶åŸå› æ˜¯ `x` åœ¨åˆ°è¾¾ç¬¬ 7 è¡Œå†…éƒ¨ä½œç”¨åŸŸç»“æŸæ—¶å°±ç¦»å¼€äº†ä½œç”¨åŸŸã€‚ä¸è¿‡ `r` åœ¨å¤–éƒ¨ä½œç”¨åŸŸä»æ˜¯æœ‰æ•ˆçš„ï¼›ä½œç”¨åŸŸè¶Šå¤§æˆ‘ä»¬å°±è¯´å®ƒ â€œå­˜åœ¨çš„è¶Šä¹…â€ã€‚å¦‚æœ Rust å…è®¸è¿™æ®µä»£ç å·¥ä½œï¼Œ`r` å°†ä¼šå¼•ç”¨åœ¨ `x` ç¦»å¼€ä½œç”¨åŸŸæ—¶è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œè¿™æ—¶å°è¯•å¯¹ `r` åšä»»ä½•æ“ä½œéƒ½ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚é‚£ä¹ˆ Rust æ˜¯å¦‚ä½•å†³å®šè¿™æ®µä»£ç æ˜¯ä¸è¢«å…è®¸çš„å‘¢ï¼Ÿè¿™å¾—ç›Šäºå€Ÿç”¨æ£€æŸ¥å™¨ã€‚

- **å€Ÿç”¨æ£€æŸ¥å™¨**ï¼ˆ*borrow checker*ï¼‰

  Rust ç¼–è¯‘å™¨æœ‰ä¸€ä¸ª **å€Ÿç”¨æ£€æŸ¥å™¨**ï¼ˆ*borrow checker*ï¼‰ï¼Œå®ƒæ¯”è¾ƒä½œç”¨åŸŸæ¥ç¡®ä¿æ‰€æœ‰çš„å€Ÿç”¨éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚

  ```rust
  fn main() {
      let r;                // ---------+-- 'a
                            //          |
      {                     //          |
          let x = 5;        // -+-- 'b  |
          r = &x;           //  |       |
      }                     // -+       |
                            //          |
      println!("r: {}", r); //          |
  }                         // ---------+
  ```

  è¿™é‡Œå°† `r` çš„ç”Ÿå‘½å‘¨æœŸæ ‡è®°ä¸º `'a` å¹¶å°† `x` çš„ç”Ÿå‘½å‘¨æœŸæ ‡è®°ä¸º `'b`ã€‚å¦‚ä½ æ‰€è§ï¼Œå†…éƒ¨çš„ `'b` å—è¦æ¯”å¤–éƒ¨çš„ç”Ÿå‘½å‘¨æœŸ `'a` å°å¾—å¤šã€‚åœ¨ç¼–è¯‘æ—¶ï¼ŒRust æ¯”è¾ƒè¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸçš„å¤§å°ï¼Œå¹¶å‘ç° `r` æ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸ `'a`ï¼Œä¸è¿‡å®ƒå¼•ç”¨äº†ä¸€ä¸ªæ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸ `'b` çš„å¯¹è±¡ã€‚ç¨‹åºè¢«æ‹’ç»ç¼–è¯‘ï¼Œå› ä¸ºç”Ÿå‘½å‘¨æœŸ `'b` æ¯”ç”Ÿå‘½å‘¨æœŸ `'a` è¦å°ï¼š**è¢«å¼•ç”¨çš„å¯¹è±¡æ¯”å®ƒçš„å¼•ç”¨è€…å­˜åœ¨çš„æ—¶é—´æ›´çŸ­ï¼Œå¯¼è‡´æ‚¬å‚æŒ‡é’ˆ**ã€‚

  è®©æˆ‘ä»¬çœ‹çœ‹ä¸‹é¢è¿™ä¸ªå¹¶æ²¡æœ‰äº§ç”Ÿæ‚¬å‚å¼•ç”¨ä¸”å¯ä»¥æ­£ç¡®ç¼–è¯‘çš„ä¾‹å­ï¼š

  ```rust
  fn main() {
      let x = 5;            // ----------+-- 'b
                            //           |
      let r = &x;           // --+-- 'a  |
                            //   |       |
      println!("r: {}", r); //   |       |
                            // --+       |
  }                         // ----------+
  ```

  è¿™é‡Œ `x` æ‹¥æœ‰ç”Ÿå‘½å‘¨æœŸ `'b`ï¼Œæ¯” `'a` è¦å¤§ã€‚è¿™å°±æ„å‘³ç€ `r` å¯ä»¥å¼•ç”¨ `x`ï¼šRust çŸ¥é“ `r` ä¸­çš„å¼•ç”¨åœ¨ `x` æœ‰æ•ˆçš„æ—¶å€™ä¹Ÿæ€»æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸º**æ•°æ®æ¯”å¼•ç”¨æœ‰ç€æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸ**ã€‚

##### å‡½æ•°ä¸­çš„æ³›å‹ç”Ÿå‘½å‘¨æœŸ

  æˆ‘ä»¬å®ç°ä¸€ä¸ª `longest` å‡½æ•°ï¼Œå®ƒè¿”å›ä¸¤ä¸ªå­—ç¬¦ä¸² slice ä¸­è¾ƒé•¿è€…ï¼Œç°åœ¨è¿˜ä¸èƒ½ç¼–è¯‘ï¼š

  ```rust
fn longest(x: &str, y: &str) -> &str {
    if x.len() > y.len() {
        x
    } else {
        y
    }
}
  ```

  ä¼šå‡ºç°å¦‚ä¸‹æœ‰å…³ç”Ÿå‘½å‘¨æœŸçš„é”™è¯¯ï¼š

  ```console
error[E0106]: missing lifetime specifier
 --> src/main.rs:9:33
  |
9 | fn longest(x: &str, y: &str) -> &str {
  |               ----     ----     ^ expected named lifetime parameter
  |
  = help: this function's return type contains a borrowed value, but the signature does not say whether it is borrowed from `x` or `y`
help: consider introducing a named lifetime parameter
  |
9 | fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
  |           ++++     ++          ++          ++

  ```

  æç¤ºæ–‡æœ¬æ­ç¤ºäº†è¿”å›å€¼éœ€è¦ä¸€ä¸ªæ³›å‹ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œå› ä¸º Rust å¹¶ä¸çŸ¥é“å°†è¦è¿”å›çš„å¼•ç”¨æ˜¯æŒ‡å‘ `x` æˆ– `y`ã€‚å€Ÿç”¨æ£€æŸ¥å™¨è‡ªèº«åŒæ ·ä¹Ÿæ— æ³•ç¡®å®šï¼Œå› ä¸ºå®ƒä¸çŸ¥é“ `x` å’Œ `y` çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¦‚ä½•ä¸è¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³è”çš„ã€‚ä¸ºäº†ä¿®å¤è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å°†å¢åŠ æ³›å‹ç”Ÿå‘½å‘¨æœŸå‚æ•°æ¥å®šä¹‰å¼•ç”¨é—´çš„å…³ç³»ä»¥ä¾¿å€Ÿç”¨æ£€æŸ¥å™¨å¯ä»¥è¿›è¡Œåˆ†æã€‚

##### ç”Ÿå‘½å‘¨æœŸæ³¨è§£è¯­æ³•

  ç”Ÿå‘½å‘¨æœŸæ³¨è§£å¹¶ä¸æ”¹å˜ä»»ä½•å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸçš„é•¿çŸ­ã€‚ç›¸åå®ƒä»¬æè¿°äº†å¤šä¸ªå¼•ç”¨ç”Ÿå‘½å‘¨æœŸç›¸äº’çš„å…³ç³»ï¼Œè€Œä¸å½±å“å…¶ç”Ÿå‘½å‘¨æœŸã€‚ä¸å½“å‡½æ•°ç­¾åä¸­æŒ‡å®šäº†æ³›å‹ç±»å‹å‚æ•°åå°±å¯ä»¥æ¥å—ä»»ä½•ç±»å‹ä¸€æ ·ï¼Œå½“æŒ‡å®šäº†æ³›å‹ç”Ÿå‘½å‘¨æœŸåå‡½æ•°ä¹Ÿèƒ½æ¥å—ä»»ä½•ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ã€‚

  **ç”Ÿå‘½å‘¨æœŸå‚æ•°åç§°å¿…é¡»ä»¥æ’‡å·ï¼ˆ`'`ï¼‰å¼€å¤´ï¼Œå…¶åç§°é€šå¸¸å…¨æ˜¯å°å†™**ã€‚ç”Ÿå‘½å‘¨æœŸå‚æ•°æ³¨è§£ä½äºå¼•ç”¨çš„ `&` ä¹‹åï¼Œå¹¶æœ‰ä¸€ä¸ªç©ºæ ¼æ¥å°†å¼•ç”¨ç±»å‹ä¸ç”Ÿå‘½å‘¨æœŸæ³¨è§£åˆ†éš”å¼€ã€‚

  å•ä¸ªçš„ç”Ÿå‘½å‘¨æœŸæ³¨è§£æœ¬èº«æ²¡æœ‰å¤šå°‘æ„ä¹‰ï¼Œå› ä¸ºç”Ÿå‘½å‘¨æœŸæ³¨è§£å‘Šè¯‰ Rust å¤šä¸ªå¼•ç”¨çš„æ³›å‹ç”Ÿå‘½å‘¨æœŸå‚æ•°å¦‚ä½•ç›¸äº’è”ç³»çš„ã€‚è®©æˆ‘ä»¬åœ¨ `longest` å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸­ç†è§£ç”Ÿå‘½å‘¨æœŸæ³¨è§£å¦‚ä½•ç›¸äº’è”ç³»ã€‚

  ä¸ºäº†åœ¨å‡½æ•°ç­¾åä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ³¨è§£ï¼Œéœ€è¦åœ¨å‡½æ•°åå’Œå‚æ•°åˆ—è¡¨é—´çš„å°–æ‹¬å·ä¸­å£°æ˜æ³›å‹ç”Ÿå‘½å‘¨æœŸï¼ˆ*lifetime*ï¼‰å‚æ•°ï¼Œå°±åƒæ³›å‹ç±»å‹ï¼ˆ*type*ï¼‰å‚æ•°ä¸€æ ·ã€‚

  æˆ‘ä»¬å¸Œæœ›å‡½æ•°ç­¾åè¡¨è¾¾å¦‚ä¸‹é™åˆ¶ï¼šä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªå‚æ•°å’Œè¿”å›çš„å¼•ç”¨å­˜æ´»çš„ä¸€æ ·ä¹…ï¼Œä¸¤ä¸ªå‚æ•°å’Œè¿”å›çš„å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç›¸å…³çš„ï¼Œå°±åƒä¸‹é¢çš„å‡½æ•°ç­¾ååœ¨æ¯ä¸ªå¼•ç”¨ä¸­éƒ½åŠ ä¸Šäº† `'a` é‚£æ ·ï¼Œè¿™æ®µä»£ç èƒ½å¤Ÿç¼–è¯‘å¹¶ä¼šäº§ç”Ÿæˆ‘ä»¬å¸Œæœ›å¾—åˆ°çš„ç»“æœï¼š

  ```rust
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() {
        x
    } else {
        y
    }
}
  ```

  ç°åœ¨å‡½æ•°ç­¾åè¡¨æ˜å¯¹äºæŸäº›ç”Ÿå‘½å‘¨æœŸ `'a`ï¼Œå‡½æ•°ä¼šè·å–ä¸¤ä¸ªå‚æ•°ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸ç”Ÿå‘½å‘¨æœŸ `'a` å­˜åœ¨çš„ä¸€æ ·é•¿çš„å­—ç¬¦ä¸² sliceã€‚å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªåŒæ ·ä¹Ÿä¸ç”Ÿå‘½å‘¨æœŸ `'a` å­˜åœ¨çš„ä¸€æ ·é•¿çš„å­—ç¬¦ä¸² sliceã€‚

  å½“å…·ä½“çš„å¼•ç”¨è¢«ä¼ é€’ç»™ `longest` æ—¶ï¼Œè¢« `'a` æ‰€æ›¿ä»£çš„å…·ä½“ç”Ÿå‘½å‘¨æœŸæ˜¯ `x` çš„ä½œç”¨åŸŸä¸ `y` çš„ä½œç”¨åŸŸç›¸é‡å çš„é‚£ä¸€éƒ¨åˆ†ã€‚æ¢ä¸€ç§è¯´æ³•å°±æ˜¯æ³›å‹ç”Ÿå‘½å‘¨æœŸ `'a` çš„å…·ä½“ç”Ÿå‘½å‘¨æœŸç­‰åŒäº `x` å’Œ `y` çš„ç”Ÿå‘½å‘¨æœŸä¸­è¾ƒå°çš„é‚£ä¸€ä¸ªã€‚

  è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é€šè¿‡ä¼ é€’æ‹¥æœ‰ä¸åŒå…·ä½“ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨æ¥é™åˆ¶ `longest` å‡½æ•°çš„ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ˆç›´è§‚çš„ä¾‹å­ï¼š

  ```rust
fn main() {
    let string1 = String::from("long string is long");

    {
        let string2 = String::from("xyz");
        let result = longest(string1.as_str(), string2.as_str());
        println!("The longest string is {}", result);
    }
}
  ```

  åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`string1` ç›´åˆ°å¤–éƒ¨ä½œç”¨åŸŸç»“æŸéƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œ`string2` åˆ™åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œ `result` åˆ™å¼•ç”¨äº†ä¸€äº›ç›´åˆ°å†…éƒ¨ä½œç”¨åŸŸç»“æŸéƒ½æ˜¯æœ‰æ•ˆçš„å€¼ã€‚å€Ÿç”¨æ£€æŸ¥å™¨è®¤å¯è¿™äº›ä»£ç ï¼›å®ƒèƒ½å¤Ÿç¼–è¯‘å’Œè¿è¡Œï¼Œå¹¶æ‰“å°å‡º `The longest string is long string is long`ã€‚

  æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å°è¯•å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œè¯¥ä¾‹å­æ­ç¤ºäº† `result` çš„å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ä¸­è¾ƒçŸ­çš„é‚£ä¸ªã€‚ä»¥ä¸‹ä»£ç å°† `result` å˜é‡çš„å£°æ˜ç§»åŠ¨å‡ºå†…éƒ¨ä½œç”¨åŸŸï¼Œä½†æ˜¯å°† `result` å’Œ `string2` å˜é‡çš„èµ‹å€¼è¯­å¥ä¸€åŒç•™åœ¨å†…éƒ¨ä½œç”¨åŸŸä¸­ã€‚æ¥ç€ï¼Œä½¿ç”¨äº†å˜é‡ `result` çš„ `println!` ä¹Ÿè¢«ç§»åŠ¨åˆ°å†…éƒ¨ä½œç”¨åŸŸä¹‹å¤–ã€‚æ³¨æ„ä¸‹é¢çš„ä»£ç ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼š

  ```rust
fn main() {
    let string1 = String::from("long string is long");
    let result;
    {
        let string2 = String::from("xyz");
        result = longest(string1.as_str(), string2.as_str());
    }
    println!("The longest string is {}", result);
}
  ```

##### ç»“æ„ä½“å®šä¹‰ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ³¨è§£

  ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å®šä¹‰çš„ç»“æ„ä½“å…¨éƒ½åŒ…å«æ‹¥æœ‰æ‰€æœ‰æƒçš„ç±»å‹ã€‚ä¹Ÿå¯ä»¥å®šä¹‰åŒ…å«å¼•ç”¨çš„ç»“æ„ä½“ï¼Œä¸è¿‡è¿™éœ€è¦ä¸ºç»“æ„ä½“å®šä¹‰ä¸­çš„æ¯ä¸€ä¸ªå¼•ç”¨æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ³¨è§£ã€‚ä¸‹é¢æœ‰ä¸€ä¸ªå­˜æ”¾äº†ä¸€ä¸ªå­—ç¬¦ä¸² slice çš„ç»“æ„ä½“ `ImportantExcerpt`ï¼š

  ```rust
struct ImportantExcerpt<'a> {
    part: &'a str,
}

fn main() {
    let novel = String::from("Call me Ishmael. Some years ago...");
    let first_sentence = novel.split('.').next().expect("Could not find a '.'");
    let i = ImportantExcerpt {
        part: first_sentence,
    };
}
  ```

  è¿™ä¸ªç»“æ„ä½“æœ‰å”¯ä¸€ä¸€ä¸ªå­—æ®µ `part`ï¼Œå®ƒå­˜æ”¾äº†ä¸€ä¸ªå­—ç¬¦ä¸² sliceï¼Œè¿™æ˜¯ä¸€ä¸ªå¼•ç”¨ã€‚ç±»ä¼¼äºæ³›å‹å‚æ•°ç±»å‹ï¼Œå¿…é¡»åœ¨ç»“æ„ä½“åç§°åé¢çš„å°–æ‹¬å·ä¸­å£°æ˜æ³›å‹ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œä»¥ä¾¿åœ¨ç»“æ„ä½“å®šä¹‰ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚è¿™ä¸ªæ³¨è§£æ„å‘³ç€ `ImportantExcerpt` çš„å®ä¾‹ä¸èƒ½æ¯”å…¶ `part` å­—æ®µä¸­çš„å¼•ç”¨å­˜åœ¨çš„æ›´ä¹…ã€‚

  è¿™é‡Œçš„ `main` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª `ImportantExcerpt` çš„å®ä¾‹ï¼Œå®ƒå­˜æ”¾äº†å˜é‡ `novel` æ‰€æ‹¥æœ‰çš„ `String` çš„ç¬¬ä¸€ä¸ªå¥å­çš„å¼•ç”¨ã€‚`novel` çš„æ•°æ®åœ¨ `ImportantExcerpt` å®ä¾‹åˆ›å»ºä¹‹å‰å°±å­˜åœ¨ã€‚å¦å¤–ï¼Œç›´åˆ° `ImportantExcerpt` ç¦»å¼€ä½œç”¨åŸŸä¹‹å `novel` éƒ½ä¸ä¼šç¦»å¼€ä½œç”¨åŸŸï¼Œæ‰€ä»¥ `ImportantExcerpt` å®ä¾‹ä¸­çš„å¼•ç”¨æ˜¯æœ‰æ•ˆçš„ã€‚

##### ç”Ÿå‘½å‘¨æœŸçœç•¥ï¼ˆLifetime Elisionï¼‰

  å‡½æ•°æˆ–æ–¹æ³•çš„å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸè¢«ç§°ä¸º **è¾“å…¥ç”Ÿå‘½å‘¨æœŸ**ï¼ˆ*input lifetimes*ï¼‰ï¼Œè€Œè¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸè¢«ç§°ä¸º **è¾“å‡ºç”Ÿå‘½å‘¨æœŸ**ï¼ˆ*output lifetimes*ï¼‰ã€‚ç¼–è¯‘å™¨é‡‡ç”¨ä¸‰æ¡è§„åˆ™æ¥åˆ¤æ–­å¼•ç”¨ä½•æ—¶ä¸éœ€è¦æ˜ç¡®çš„æ³¨è§£ã€‚ç¬¬ä¸€æ¡è§„åˆ™é€‚ç”¨äºè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œåä¸¤æ¡è§„åˆ™é€‚ç”¨äºè¾“å‡ºç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœç¼–è¯‘å™¨æ£€æŸ¥å®Œè¿™ä¸‰æ¡è§„åˆ™åä»ç„¶å­˜åœ¨æ²¡æœ‰è®¡ç®—å‡ºç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ï¼Œç¼–è¯‘å™¨å°†ä¼šåœæ­¢å¹¶ç”Ÿæˆé”™è¯¯ã€‚è¿™äº›è§„åˆ™é€‚ç”¨äº `fn` å®šä¹‰ï¼Œä»¥åŠ `impl` å—ã€‚

    1. ç¬¬ä¸€æ¡è§„åˆ™æ˜¯ç¼–è¯‘å™¨ä¸ºæ¯ä¸€ä¸ªå¼•ç”¨å‚æ•°éƒ½åˆ†é…ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼Œå‡½æ•°æœ‰ä¸€ä¸ªå¼•ç”¨å‚æ•°çš„å°±æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼š`fn foo<'a>(x: &'a i32)`ï¼Œæœ‰ä¸¤ä¸ªå¼•ç”¨å‚æ•°çš„å‡½æ•°å°±æœ‰ä¸¤ä¸ªä¸åŒçš„ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œ`fn foo<'a, 'b>(x: &'a i32, y: &'b i32)`ï¼Œä¾æ­¤ç±»æ¨ã€‚

    2. ç¬¬äºŒæ¡è§„åˆ™æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œé‚£ä¹ˆå®ƒè¢«èµ‹äºˆæ‰€æœ‰è¾“å‡ºç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼š`fn foo<'a>(x: &'a i32) -> &'a i32`ã€‚

    3. ç¬¬ä¸‰æ¡è§„åˆ™æ˜¯å¦‚æœæ–¹æ³•æœ‰å¤šä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸå‚æ•°å¹¶ä¸”å…¶ä¸­ä¸€ä¸ªå‚æ•°æ˜¯ `&self` æˆ– `&mut self`ï¼Œè¯´æ˜æ˜¯ä¸ªå¯¹è±¡çš„æ–¹æ³• ï¼Œé‚£ä¹ˆæ‰€æœ‰è¾“å‡ºç”Ÿå‘½å‘¨æœŸå‚æ•°è¢«èµ‹äºˆ `self` çš„ç”Ÿå‘½å‘¨æœŸã€‚ç¬¬ä¸‰æ¡è§„åˆ™ä½¿å¾—æ–¹æ³•æ›´å®¹æ˜“è¯»å†™ï¼Œå› ä¸ºåªéœ€æ›´å°‘çš„ç¬¦å·ã€‚

##### æ–¹æ³•ä¸­å®šä¹‰çš„ç”Ÿå‘½å‘¨æœŸæ³¨è§£

  å®ç°æ–¹æ³•æ—¶ç»“æ„ä½“å­—æ®µçš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»æ€»æ˜¯åœ¨ `impl` å…³é”®å­—ä¹‹åå£°æ˜å¹¶åœ¨ç»“æ„ä½“åç§°ä¹‹åè¢«ä½¿ç”¨ï¼Œå› ä¸ºè¿™äº›ç”Ÿå‘½å‘¨æœŸæ˜¯ç»“æ„ä½“ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚

  `impl` å—é‡Œçš„æ–¹æ³•ç­¾åä¸­ï¼Œå¼•ç”¨å¯èƒ½ä¸ç»“æ„ä½“å­—æ®µä¸­çš„å¼•ç”¨ç›¸å…³è”ï¼Œä¹Ÿå¯èƒ½æ˜¯ç‹¬ç«‹çš„ã€‚å¦å¤–ï¼Œç”Ÿå‘½å‘¨æœŸçœç•¥è§„åˆ™ä¹Ÿç»å¸¸è®©æˆ‘ä»¬æ— éœ€åœ¨æ–¹æ³•ç­¾åä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ³¨è§£ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä¸€äº›ä½¿ç”¨ç¤ºä¾‹ 10-24 ä¸­å®šä¹‰çš„ç»“æ„ä½“ `ImportantExcerpt` çš„ä¾‹å­ã€‚

  é¦–å…ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ–¹æ³• `level`ã€‚å…¶å”¯ä¸€çš„å‚æ•°æ˜¯ `self` çš„å¼•ç”¨ï¼Œè€Œä¸”è¿”å›å€¼åªæ˜¯ä¸€ä¸ª `i32`ï¼Œå¹¶ä¸å¼•ç”¨ä»»ä½•å€¼ï¼š

  ```rust
impl<'a> ImportantExcerpt<'a> {
    fn level(&self) -> i32 {
        3
    }
}
  ```

  `impl` ä¹‹åå’Œç±»å‹åç§°ä¹‹åçš„ç”Ÿå‘½å‘¨æœŸå‚æ•°æ˜¯å¿…è¦çš„ï¼Œä¸è¿‡å› ä¸ºç¬¬ä¸€æ¡ç”Ÿå‘½å‘¨æœŸè§„åˆ™æˆ‘ä»¬å¹¶ä¸å¿…é¡»æ ‡æ³¨ `self` å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸã€‚

##### é™æ€ç”Ÿå‘½å‘¨æœŸ

  è¿™é‡Œæœ‰ä¸€ç§ç‰¹æ®Šçš„ç”Ÿå‘½å‘¨æœŸå€¼å¾—è®¨è®ºï¼š`'static`ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸ**èƒ½å¤Ÿ**å­˜æ´»äºæ•´ä¸ªç¨‹åºæœŸé—´ã€‚æ‰€æœ‰çš„å­—ç¬¦ä¸²å­—é¢å€¼éƒ½æ‹¥æœ‰ `'static` ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©åƒä¸‹é¢è¿™æ ·æ ‡æ³¨å‡ºæ¥ï¼š

  ```rust
let s: &'static str = "I have a static lifetime.";
  ```

  è¿™ä¸ªå­—ç¬¦ä¸²çš„æ–‡æœ¬è¢«ç›´æ¥å‚¨å­˜åœ¨ç¨‹åºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è€Œè¿™ä¸ªæ–‡ä»¶æ€»æ˜¯å¯ç”¨çš„ã€‚å› æ­¤**æ‰€æœ‰çš„å­—ç¬¦ä¸²å­—é¢å€¼éƒ½æ˜¯ `'static` çš„**ã€‚

##### æ€»ç»“

  è®©æˆ‘ä»¬ç®€è¦çš„çœ‹ä¸€ä¸‹åœ¨åŒä¸€å‡½æ•°ä¸­æŒ‡å®šæ³›å‹ç±»å‹å‚æ•°ã€trait bounds å’Œç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•ï¼

  ```rust
use std::fmt::Display;

fn longest_with_an_announcement<'a, T>(
    x: &'a str,
    y: &'a str,
    ann: T,
) -> &'a str
where
    T: Display,
{
    println!("Announcement! {}", ann);
    if x.len() > y.len() {
        x
    } else {
        y
    }
}
  ```

  è¿™ä¸ªæ˜¯ç¤ºä¾‹ 10-21 ä¸­é‚£ä¸ªè¿”å›ä¸¤ä¸ªå­—ç¬¦ä¸² slice ä¸­è¾ƒé•¿è€…çš„ `longest` å‡½æ•°ï¼Œä¸è¿‡å¸¦æœ‰ä¸€ä¸ªé¢å¤–çš„å‚æ•° `ann`ã€‚`ann` çš„ç±»å‹æ˜¯æ³›å‹ `T`ï¼Œå®ƒå¯ä»¥è¢«æ”¾å…¥ä»»ä½•å®ç°äº† `where` ä»å¥ä¸­æŒ‡å®šçš„ `Display` trait çš„ç±»å‹ã€‚è¿™ä¸ªé¢å¤–çš„å‚æ•°ä¼šä½¿ç”¨ `{}` æ‰“å°ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ `Display` trait bound æ˜¯å¿…é¡»çš„ã€‚å› ä¸ºç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯æ³›å‹ï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸå‚æ•° `'a` å’Œæ³›å‹ç±»å‹å‚æ•° `T` éƒ½ä½äºå‡½æ•°ååçš„åŒä¸€å°–æ‹¬å·åˆ—è¡¨ä¸­ã€‚

### æ™ºèƒ½æŒ‡é’ˆ

**æ™ºèƒ½æŒ‡é’ˆ**ï¼ˆ*smart pointers*ï¼‰æ˜¯ä¸€ç±»æ•°æ®ç»“æ„ï¼Œå®ƒä»¬çš„è¡¨ç°ç±»ä¼¼æŒ‡é’ˆï¼Œä½†æ˜¯ä¹Ÿæ‹¥æœ‰é¢å¤–çš„å…ƒæ•°æ®å’ŒåŠŸèƒ½ã€‚åœ¨ Rust ä¸­å› ä¸ºå¼•ç”¨å’Œå€Ÿç”¨ï¼Œæ™®é€šå¼•ç”¨å’Œæ™ºèƒ½æŒ‡é’ˆçš„ä¸€ä¸ªé¢å¤–çš„åŒºåˆ«æ˜¯å¼•ç”¨æ˜¯ä¸€ç±»åªå€Ÿç”¨æ•°æ®çš„æŒ‡é’ˆï¼›ç›¸åï¼Œ**åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ™ºèƒ½æŒ‡é’ˆæ‹¥æœ‰å®ƒä»¬æŒ‡å‘çš„æ•°æ®ã€‚**

- `Rc<T>` å…è®¸ç›¸åŒæ•°æ®æœ‰å¤šä¸ªæ‰€æœ‰è€…ï¼›`Box<T>` å’Œ `RefCell<T>` æœ‰å•ä¸€æ‰€æœ‰è€…ã€‚
- `Box<T>` å…è®¸åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œä¸å¯å˜æˆ–å¯å˜å€Ÿç”¨æ£€æŸ¥ï¼›`Rc<T>`ä»…å…è®¸åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œä¸å¯å˜å€Ÿç”¨æ£€æŸ¥ï¼›`RefCell<T>` å…è®¸åœ¨è¿è¡Œæ—¶æ‰§è¡Œä¸å¯å˜æˆ–å¯å˜å€Ÿç”¨æ£€æŸ¥ã€‚
- å› ä¸º `RefCell<T>` å…è®¸åœ¨è¿è¡Œæ—¶æ‰§è¡Œå¯å˜å€Ÿç”¨æ£€æŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å³ä¾¿ `RefCell<T>` è‡ªèº«æ˜¯ä¸å¯å˜çš„æƒ…å†µä¸‹ä¿®æ”¹å…¶å†…éƒ¨çš„å€¼ã€‚

#### `Box<T>`

æœ€ç®€å•ç›´æ¥çš„æ™ºèƒ½æŒ‡é’ˆæ˜¯ *box*ï¼Œå…¶ç±»å‹æ˜¯ `Box<T>`ã€‚box å…è®¸ä½ å°†ä¸€ä¸ªå€¼æ”¾åœ¨å †ä¸Šè€Œä¸æ˜¯æ ˆä¸Šï¼Œç•™åœ¨æ ˆä¸Šçš„åˆ™æ˜¯æŒ‡å‘å †æ•°æ®çš„æŒ‡é’ˆã€‚`Box<T>` ç±»å‹æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå› ä¸ºå®ƒå®ç°äº† `Deref` traitï¼Œå®ƒå…è®¸ `Box<T>` å€¼è¢«å½“ä½œå¼•ç”¨å¯¹å¾…ã€‚å½“ `Box<T>` å€¼ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œç”±äº `Box<T>` ç±»å‹ `Drop` trait çš„å®ç°ï¼Œbox æ‰€æŒ‡å‘çš„å †æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚

**box åªæä¾›äº†é—´æ¥å­˜å‚¨å’Œå †åˆ†é…**ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å…¶ä»–ç‰¹æ®Šçš„åŠŸèƒ½ã€‚box æ²¡æœ‰æ€§èƒ½æŸå¤±ï¼Œå®ƒå¤šç”¨äºå¦‚ä¸‹åœºæ™¯ï¼š

- å½“æœ‰ä¸€ä¸ªåœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„ç±»å‹ï¼Œè€Œåˆæƒ³è¦åœ¨éœ€è¦ç¡®åˆ‡å¤§å°çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨è¿™ä¸ªç±»å‹å€¼çš„æ—¶å€™
- å½“æœ‰å¤§é‡æ•°æ®å¹¶å¸Œæœ›åœ¨ç¡®ä¿æ•°æ®ä¸è¢«æ‹·è´çš„æƒ…å†µä¸‹è½¬ç§»æ‰€æœ‰æƒçš„æ—¶å€™
- å½“å¸Œæœ›æ‹¥æœ‰ä¸€ä¸ªå€¼å¹¶åªå…³å¿ƒå®ƒçš„ç±»å‹æ˜¯å¦å®ç°äº†ç‰¹å®š trait è€Œä¸æ˜¯å…¶å…·ä½“ç±»å‹çš„æ—¶å€™

##### ä½¿ç”¨Boxåˆ›å»ºé€’å½’ç±»å‹

**é€’å½’ç±»å‹**ï¼ˆ*recursive type*ï¼‰çš„å€¼å¯ä»¥æ‹¥æœ‰å¦ä¸€ä¸ªåŒç±»å‹çš„å€¼ä½œä¸ºå…¶è‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯è¿™ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸º Rust éœ€è¦åœ¨ç¼–è¯‘æ—¶çŸ¥é“ç±»å‹å ç”¨å¤šå°‘ç©ºé—´ã€‚é€’å½’ç±»å‹çš„å€¼åµŒå¥—ç†è®ºä¸Šå¯ä»¥æ— é™åœ°è¿›è¡Œä¸‹å»ï¼Œæ‰€ä»¥ Rust ä¸çŸ¥é“é€’å½’ç±»å‹éœ€è¦å¤šå°‘ç©ºé—´ã€‚å› ä¸º box æœ‰ä¸€ä¸ªå·²çŸ¥çš„å¤§å°ï¼Œæ‰€ä»¥é€šè¿‡åœ¨å¾ªç¯ç±»å‹å®šä¹‰ä¸­æ’å…¥ boxï¼Œå°±å¯ä»¥åˆ›å»ºé€’å½’ç±»å‹äº†ã€‚

*cons list* æ˜¯ä¸€ä¸ªæ¥æºäº Lisp ç¼–ç¨‹è¯­è¨€åŠå…¶æ–¹è¨€çš„æ•°æ®ç»“æ„ï¼Œå®ƒç”±åµŒå¥—çš„åˆ—è¡¨ç»„æˆã€‚ä¾‹å¦‚è¿™é‡Œæœ‰ä¸€ä¸ªåŒ…å«åˆ—è¡¨ 1ï¼Œ2ï¼Œ3 çš„ cons list çš„ä¼ªä»£ç è¡¨ç¤ºï¼Œå…¶æ¯ä¸€ä¸ªåˆ—è¡¨åœ¨ä¸€ä¸ªæ‹¬å·ä¸­ï¼š

```text
(1, (2, (3, Nil)))
```

cons list çš„æ¯ä¸€é¡¹éƒ½åŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼šå½“å‰é¡¹çš„å€¼å’Œä¸‹ä¸€é¡¹ã€‚å…¶æœ€åä¸€é¡¹å€¼åŒ…å«ä¸€ä¸ªå«åš `Nil` çš„å€¼ä¸”æ²¡æœ‰ä¸‹ä¸€é¡¹ã€‚cons list é€šè¿‡é€’å½’è°ƒç”¨ `cons` å‡½æ•°äº§ç”Ÿã€‚ä»£è¡¨é€’å½’çš„ç»ˆæ­¢æ¡ä»¶ï¼ˆbase caseï¼‰çš„è§„èŒƒåç§°æ˜¯ `Nil`ï¼Œå®ƒå®£å¸ƒåˆ—è¡¨çš„ç»ˆæ­¢ã€‚

å°è¯•å®šä¹‰ä¸€ä¸ªä»£è¡¨ `i32` å€¼çš„ cons list æ•°æ®ç»“æ„çš„æšä¸¾ï¼š

```rust
enum List {
    Cons(i32, List),
    Nil,
}
```

ä½¿ç”¨è¿™ä¸ª cons list æ¥å‚¨å­˜åˆ—è¡¨ `1, 2, 3` å°†çœ‹èµ·æ¥å¦‚ä¸‹æ‰€ç¤ºï¼š

```rust
use crate::List::{Cons, Nil};

fn main() {
    let list = Cons(1, Cons(2, Cons(3, Nil)));
}
```

ä½†å¦‚æœå°è¯•ç¼–è¯‘ä¸Šé¢çš„ä»£ç ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹é¢æ‰€ç¤ºçš„é”™è¯¯ï¼š

```console
error[E0072]: recursive type `List` has infinite size
 --> src/main.rs:1:1
  |
1 | enum List {
  | ^^^^^^^^^ recursive type has infinite size
2 |     Cons(i32, List),
  |               ---- recursive without indirection
  |
help: insert some indirection (e.g., a `Box`, `Rc`, or `&`) to make `List` representable
  |
2 |     Cons(i32, Box<List>),
  |               ++++    +
```

è¿™ä¸ªé”™è¯¯è¡¨æ˜è¿™ä¸ªç±»å‹ â€œæœ‰æ— é™çš„å¤§å°â€ã€‚å…¶åŸå› æ˜¯ `List` çš„ä¸€ä¸ªæˆå‘˜è¢«å®šä¹‰ä¸ºæ˜¯é€’å½’çš„ï¼šå®ƒç›´æ¥å­˜æ”¾äº†å¦ä¸€ä¸ªç›¸åŒç±»å‹çš„å€¼ã€‚è¿™æ„å‘³ç€ Rust æ— æ³•è®¡ç®—ä¸ºäº†å­˜æ”¾ `List` å€¼åˆ°åº•éœ€è¦å¤šå°‘ç©ºé—´ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Box<T>`ä¿®æ”¹ä»£ç ï¼Œè¿™æ˜¯å¯ä»¥ç¼–è¯‘çš„ï¼š

```rust
enum List {
    Cons(i32, Box<List>),
    Nil,
}

use crate::List::{Cons, Nil};

fn main() {
    let list = Cons(1, Box::new(Cons(2, Box::new(Cons(3, Box::new(Nil))))));
}
```

#####  `Deref` trait

å®ç° `Deref` trait å…è®¸æˆ‘ä»¬é‡è½½ **è§£å¼•ç”¨è¿ç®—ç¬¦**ï¼ˆ*dereference operator*ï¼‰`*`ã€‚é€šè¿‡è¿™ç§æ–¹å¼å®ç° `Deref` trait çš„æ™ºèƒ½æŒ‡é’ˆå¯ä»¥è¢«å½“ä½œå¸¸è§„å¼•ç”¨æ¥å¯¹å¾…ï¼Œå¯ä»¥ç¼–å†™æ“ä½œå¼•ç”¨çš„ä»£ç å¹¶ç”¨äºæ™ºèƒ½æŒ‡é’ˆã€‚

```rust
use std::ops::Deref;

impl<T> Deref for MyBox<T> {
    type Target = T;

    fn deref(&self) -> &Self::Target {
        &self.0
    }
}
```

`type Target = T;` è¯­æ³•å®šä¹‰äº†ç”¨äºæ­¤ trait çš„å…³è”ç±»å‹ã€‚å…³è”ç±»å‹æ˜¯ä¸€ä¸ªç¨æœ‰ä¸åŒçš„å®šä¹‰æ³›å‹å‚æ•°çš„æ–¹å¼ï¼Œç°åœ¨è¿˜æ— éœ€è¿‡å¤šçš„æ‹…å¿ƒå®ƒï¼›ç¬¬åä¹ç« ä¼šè¯¦ç»†ä»‹ç»ã€‚

`deref` æ–¹æ³•ä½“ä¸­å†™å…¥äº† `&self.0`ï¼Œè¿™æ · `deref` è¿”å›äº†æˆ‘å¸Œæœ›é€šè¿‡ `*` è¿ç®—ç¬¦è®¿é—®çš„å€¼çš„å¼•ç”¨ã€‚æ²¡æœ‰ `Deref` trait çš„è¯ï¼Œç¼–è¯‘å™¨åªä¼šè§£å¼•ç”¨ `&` å¼•ç”¨ç±»å‹ã€‚`deref` æ–¹æ³•å‘ç¼–è¯‘å™¨æä¾›äº†è·å–ä»»ä½•å®ç°äº† `Deref` trait çš„ç±»å‹çš„å€¼ï¼Œå¹¶ä¸”è°ƒç”¨è¿™ä¸ªç±»å‹çš„ `deref` æ–¹æ³•æ¥è·å–ä¸€ä¸ªå®ƒçŸ¥é“å¦‚ä½•è§£å¼•ç”¨çš„ `&` å¼•ç”¨çš„èƒ½åŠ›ã€‚

å½“æˆ‘ä»¬åœ¨ç¤ºä¾‹ä¸­è¾“å…¥ `*y` æ—¶ï¼ŒRust äº‹å®ä¸Šåœ¨åº•å±‚è¿è¡Œäº†å¦‚ä¸‹ä»£ç ï¼š

```rust
*(y.deref())
```

Rust å°† `*` è¿ç®—ç¬¦æ›¿æ¢ä¸ºå…ˆè°ƒç”¨ `deref` æ–¹æ³•å†è¿›è¡Œæ™®é€šè§£å¼•ç”¨çš„æ“ä½œï¼Œå¦‚æ­¤æˆ‘ä»¬ä¾¿ä¸ç”¨æ‹…å¿ƒæ˜¯å¦è¿˜éœ€æ‰‹åŠ¨è°ƒç”¨ `deref` æ–¹æ³•äº†ã€‚Rust çš„è¿™ä¸ªç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬å†™å‡ºè¡Œä¸ºä¸€è‡´çš„ä»£ç ï¼Œæ— è®ºæ˜¯é¢å¯¹çš„æ˜¯å¸¸è§„å¼•ç”¨è¿˜æ˜¯å®ç°äº† `Deref` çš„ç±»å‹ã€‚

##### éšå¼ Deref å¼ºåˆ¶è½¬æ¢

**Deref å¼ºåˆ¶è½¬æ¢**ï¼ˆ*deref coercions*ï¼‰å°†å®ç°äº† `Deref` trait çš„ç±»å‹çš„å¼•ç”¨è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹çš„å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°† `&String` è½¬æ¢ä¸º `&str`ï¼Œå› ä¸º `String` å®ç°äº† `Deref` trait å› æ­¤å¯ä»¥è¿”å› `&str`ã€‚

å¦‚æœ Rust æ²¡æœ‰å®ç° Deref å¼ºåˆ¶è½¬æ¢ï¼Œä¸ºäº†ä½¿ç”¨ `&MyBox<String>` ç±»å‹çš„å€¼è°ƒç”¨ `hello`ï¼Œåˆ™å¿…é¡»ç¼–å†™å¦‚ä¸‹çš„ä»£ç ï¼š

```rust
fn hello(name: &str) {
    println!("Hello, {name}!");
}

fn main() {
    let m = MyBox::new(String::from("Rust"));
    hello(&(*m)[..]);
}
```

å½“æ‰€æ¶‰åŠåˆ°çš„ç±»å‹å®šä¹‰äº† `Deref` traitï¼ŒRust ä¼šåˆ†æè¿™äº›ç±»å‹å¹¶ä½¿ç”¨ä»»æ„å¤šæ¬¡ `Deref::deref` è°ƒç”¨ä»¥è·å¾—åŒ¹é…å‚æ•°çš„ç±»å‹ã€‚è¿™äº›è§£æéƒ½å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ï¼Œæ‰€ä»¥åˆ©ç”¨ Deref å¼ºåˆ¶è½¬æ¢å¹¶æ²¡æœ‰è¿è¡Œæ—¶æŸè€—ï¼



ç±»ä¼¼äºå¦‚ä½•ä½¿ç”¨ `Deref` trait é‡è½½ä¸å¯å˜å¼•ç”¨çš„ `*` è¿ç®—ç¬¦ï¼ŒRust æä¾›äº† `DerefMut` trait ç”¨äºé‡è½½å¯å˜å¼•ç”¨çš„ `*` è¿ç®—ç¬¦ã€‚

Rust åœ¨å‘ç°ç±»å‹å’Œ trait å®ç°æ»¡è¶³ä¸‰ç§æƒ…å†µæ—¶ä¼šè¿›è¡Œ Deref å¼ºåˆ¶è½¬æ¢ï¼š

- å½“ `T: Deref<Target=U>` æ—¶ä» `&T` åˆ° `&U`ã€‚
- å½“ `T: DerefMut<Target=U>` æ—¶ä» `&mut T` åˆ° `&mut U`ã€‚
- å½“ `T: Deref<Target=U>` æ—¶ä» `&mut T` åˆ° `&U`ã€‚

å¤´ä¸¤ä¸ªæƒ…å†µé™¤äº†ç¬¬äºŒç§å®ç°äº†å¯å˜æ€§ä¹‹å¤–æ˜¯ç›¸åŒçš„ï¼šç¬¬ä¸€ç§æƒ…å†µè¡¨æ˜å¦‚æœæœ‰ä¸€ä¸ª `&T`ï¼Œè€Œ `T` å®ç°äº†è¿”å› `U` ç±»å‹çš„ `Deref`ï¼Œåˆ™å¯ä»¥ç›´æ¥å¾—åˆ° `&U`ã€‚ç¬¬äºŒç§æƒ…å†µè¡¨æ˜å¯¹äºå¯å˜å¼•ç”¨ä¹Ÿæœ‰ç€ç›¸åŒçš„è¡Œä¸ºã€‚

ç¬¬ä¸‰ä¸ªæƒ…å†µæœ‰äº›å¾®å¦™ï¼š**Rust ä¹Ÿä¼šå°†å¯å˜å¼•ç”¨å¼ºè½¬ä¸ºä¸å¯å˜å¼•ç”¨ï¼Œä½†æ˜¯åä¹‹æ˜¯ä¸å¯èƒ½çš„ï¼šä¸å¯å˜å¼•ç”¨æ°¸è¿œä¹Ÿä¸èƒ½å¼ºè½¬ä¸ºå¯å˜å¼•ç”¨ã€‚**å› ä¸ºæ ¹æ®å€Ÿç”¨è§„åˆ™ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œå…¶å¿…é¡»æ˜¯è¿™äº›æ•°æ®çš„å”¯ä¸€å¼•ç”¨ã€‚å°†ä¸€ä¸ªå¯å˜å¼•ç”¨è½¬æ¢ä¸ºä¸å¯å˜å¼•ç”¨æ°¸è¿œä¹Ÿä¸ä¼šæ‰“ç ´å€Ÿç”¨è§„åˆ™ã€‚å°†ä¸å¯å˜å¼•ç”¨è½¬æ¢ä¸ºå¯å˜å¼•ç”¨åˆ™éœ€è¦åˆå§‹çš„ä¸å¯å˜å¼•ç”¨æ˜¯æ•°æ®å”¯ä¸€çš„ä¸å¯å˜å¼•ç”¨ï¼Œè€Œå€Ÿç”¨è§„åˆ™æ— æ³•ä¿è¯è¿™ä¸€ç‚¹ã€‚å› æ­¤ï¼ŒRust æ— æ³•å‡è®¾å°†ä¸å¯å˜å¼•ç”¨è½¬æ¢ä¸ºå¯å˜å¼•ç”¨æ˜¯å¯èƒ½çš„ã€‚

#### `Rc<T>` å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆ

ä¸ºäº†å¯ç”¨å¤šæ‰€æœ‰æƒéœ€è¦æ˜¾å¼åœ°ä½¿ç”¨ Rust ç±»å‹ `Rc<T>`ï¼Œå…¶ä¸º **å¼•ç”¨è®¡æ•°**ï¼ˆ*reference counting*ï¼‰çš„ç¼©å†™ã€‚å¼•ç”¨è®¡æ•°æ„å‘³ç€è®°å½•ä¸€ä¸ªå€¼çš„å¼•ç”¨æ•°é‡æ¥çŸ¥æ™“è¿™ä¸ªå€¼æ˜¯å¦ä»åœ¨è¢«ä½¿ç”¨ã€‚å¦‚æœæŸä¸ªå€¼æœ‰é›¶ä¸ªå¼•ç”¨ï¼Œå°±ä»£è¡¨æ²¡æœ‰ä»»ä½•æœ‰æ•ˆå¼•ç”¨å¹¶å¯ä»¥è¢«æ¸…ç†ã€‚

`Rc<T>` ç”¨äºå½“æˆ‘ä»¬å¸Œæœ›åœ¨å †ä¸Šåˆ†é…ä¸€äº›å†…å­˜ä¾›ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†è¯»å–ï¼Œè€Œä¸”æ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šç¨‹åºçš„å“ªä¸€éƒ¨åˆ†ä¼šæœ€åç»“æŸä½¿ç”¨å®ƒçš„æ—¶å€™ã€‚å¦‚æœç¡®å®çŸ¥é“å“ªéƒ¨åˆ†æ˜¯æœ€åä¸€ä¸ªç»“æŸä½¿ç”¨çš„è¯ï¼Œå°±å¯ä»¥ä»¤å…¶æˆä¸ºæ•°æ®çš„æ‰€æœ‰è€…ï¼Œæ­£å¸¸çš„æ‰€æœ‰æƒè§„åˆ™å°±å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç”Ÿæ•ˆã€‚æ³¨æ„ `Rc<T>` åªèƒ½ç”¨äºå•çº¿ç¨‹åœºæ™¯ã€‚

è®©æˆ‘ä»¬å›åˆ°ä½¿ç”¨ `Box<T>` å®šä¹‰ cons list çš„ä¾‹å­ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸¤ä¸ªå…±äº«ç¬¬ä¸‰ä¸ªåˆ—è¡¨æ‰€æœ‰æƒçš„åˆ—è¡¨ï¼Œå…¶æ¦‚å¿µå°†ä¼šçœ‹èµ·æ¥å¦‚å›¾æ‰€ç¤ºï¼š

![Two lists that share ownership of a third list](https://kaisery.github.io/trpl-zh-cn/img/trpl15-03.svg)

å°è¯•ä½¿ç”¨ `Box<T>` å®šä¹‰çš„ `List` å®ç°å¹¶ä¸èƒ½å·¥ä½œï¼š

```rust
enum List {
    Cons(i32, Box<List>),
    Nil,
}

use crate::List::{Cons, Nil};

fn main() {
    let a = Cons(5, Box::new(Cons(10, Box::new(Nil))));
    let b = Cons(3, Box::new(a));
    let c = Cons(4, Box::new(a));
}
```

ç¼–è¯‘ä¼šå¾—å‡ºå¦‚ä¸‹é”™è¯¯ï¼ŒCons æˆå‘˜æ‹¥æœ‰å…¶å‚¨å­˜çš„æ•°æ®ï¼Œæ‰€ä»¥å½“åˆ›å»º b åˆ—è¡¨æ—¶ï¼Œa è¢«ç§»åŠ¨è¿›äº† bï¼Œè¿™æ · b å°±æ‹¥æœ‰äº† aã€‚æ¥ç€å½“å†æ¬¡å°è¯•ä½¿ç”¨ a åˆ›å»º c æ—¶ï¼Œè¿™ä¸è¢«å…è®¸ï¼Œå› ä¸º a çš„æ‰€æœ‰æƒå·²ç»è¢«ç§»åŠ¨ï¼š

```console
error[E0382]: use of moved value: `a`
  --> src/main.rs:11:30
   |
9  |     let a = Cons(5, Box::new(Cons(10, Box::new(Nil))));
   |         - move occurs because `a` has type `List`, which does not implement the `Copy` trait
10 |     let b = Cons(3, Box::new(a));
   |                              - value moved here
11 |     let c = Cons(4, Box::new(a));
   |                              ^ value used here after move

```

æˆ‘ä»¬ä¿®æ”¹ `List` çš„å®šä¹‰ä¸ºä½¿ç”¨ `Rc<T>` ä»£æ›¿ `Box<T>`ï¼Œç°åœ¨æ¯ä¸€ä¸ª `Cons` å˜é‡éƒ½åŒ…å«ä¸€ä¸ªå€¼å’Œä¸€ä¸ªæŒ‡å‘ `List` çš„ `Rc<T>`ã€‚å½“åˆ›å»º `b` æ—¶ï¼Œä¸åŒäºè·å– `a` çš„æ‰€æœ‰æƒï¼Œè¿™é‡Œä¼šå…‹éš† `a` æ‰€åŒ…å«çš„ `Rc<List>`ï¼Œè¿™ä¼šå°†å¼•ç”¨è®¡æ•°ä» 1 å¢åŠ åˆ° 2 å¹¶å…è®¸ `a` å’Œ `b` å…±äº« `Rc<List>` ä¸­æ•°æ®çš„æ‰€æœ‰æƒã€‚åˆ›å»º `c` æ—¶ä¹Ÿä¼šå…‹éš† `a`ï¼Œè¿™ä¼šå°†å¼•ç”¨è®¡æ•°ä» 2 å¢åŠ ä¸º 3ã€‚æ¯æ¬¡è°ƒç”¨ `Rc::clone`ï¼Œ`Rc<List>` ä¸­æ•°æ®çš„å¼•ç”¨è®¡æ•°éƒ½ä¼šå¢åŠ ï¼Œç›´åˆ°æœ‰é›¶ä¸ªå¼•ç”¨ä¹‹å‰å…¶æ•°æ®éƒ½ä¸ä¼šè¢«æ¸…ç†ã€‚`Rc::clone` çš„å®ç°å¹¶ä¸åƒå¤§éƒ¨åˆ†ç±»å‹çš„ `clone` å®ç°é‚£æ ·å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œ åªä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œè¿™å¹¶ä¸ä¼šèŠ±è´¹å¤šå°‘æ—¶é—´ã€‚

```rust
enum List {
    Cons(i32, Rc<List>),
    Nil,
}

use crate::List::{Cons, Nil};
use std::rc::Rc;

fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    let b = Cons(3, Rc::clone(&a));
    let c = Cons(4, Rc::clone(&a));
}
```

é€šè¿‡ä¸å¯å˜å¼•ç”¨ï¼Œ `Rc<T>` å…è®¸åœ¨ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†ä¹‹é—´**åªè¯»åœ°**å…±äº«æ•°æ®ã€‚å¦‚æœ `Rc<T>` ä¹Ÿå…è®¸å¤šä¸ªå¯å˜å¼•ç”¨ï¼Œåˆ™ä¼šè¿åç¬¬å››ç« è®¨è®ºçš„å€Ÿç”¨è§„åˆ™ä¹‹ä¸€ï¼šç›¸åŒä½ç½®çš„å¤šä¸ªå¯å˜å€Ÿç”¨å¯èƒ½é€ æˆæ•°æ®ç«äº‰å’Œä¸ä¸€è‡´ã€‚ä¸è¿‡å¯ä»¥ä¿®æ”¹æ•°æ®æ˜¯éå¸¸æœ‰ç”¨çš„ï¼åœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è®¨è®ºå†…éƒ¨å¯å˜æ€§æ¨¡å¼å’Œ `RefCell<T>` ç±»å‹ï¼Œå®ƒå¯ä»¥ä¸ `Rc<T>` ç»“åˆä½¿ç”¨æ¥å¤„ç†ä¸å¯å˜æ€§çš„é™åˆ¶ã€‚

#### `RefCell<T>` å’Œå†…éƒ¨å¯å˜æ€§æ¨¡å¼ â—

**å†…éƒ¨å¯å˜æ€§**ï¼ˆ*Interior mutability*ï¼‰æ˜¯ Rust ä¸­çš„ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼Œå®ƒå…è®¸ä½ å³ä½¿åœ¨æœ‰ä¸å¯å˜å¼•ç”¨æ—¶ä¹Ÿå¯ä»¥æ”¹å˜æ•°æ®ï¼Œè¿™é€šå¸¸æ˜¯å€Ÿç”¨è§„åˆ™æ‰€ä¸å…è®¸çš„ã€‚ä¸ºäº†æ”¹å˜æ•°æ®ï¼Œè¯¥æ¨¡å¼åœ¨æ•°æ®ç»“æ„ä¸­ä½¿ç”¨ `unsafe` ä»£ç æ¥æ¨¡ç³Š Rust é€šå¸¸çš„å¯å˜æ€§å’Œå€Ÿç”¨è§„åˆ™ã€‚ä¸å®‰å…¨ä»£ç è¡¨æ˜æˆ‘ä»¬åœ¨æ‰‹åŠ¨æ£€æŸ¥è¿™äº›è§„åˆ™è€Œä¸æ˜¯è®©ç¼–è¯‘å™¨æ›¿æˆ‘ä»¬æ£€æŸ¥ã€‚

ä¸åŒäº `Rc<T>`ï¼Œ`RefCell<T>` ä»£è¡¨å…¶æ•°æ®çš„å”¯ä¸€çš„æ‰€æœ‰æƒã€‚é‚£ä¹ˆæ˜¯ä»€ä¹ˆè®© `RefCell<T>` ä¸åŒäºåƒ `Box<T>` è¿™æ ·çš„ç±»å‹å‘¢ï¼Ÿå›å¿†ä¸€ä¸‹ç¬¬å››ç« æ‰€å­¦çš„å€Ÿç”¨è§„åˆ™ï¼š

1. åœ¨ä»»æ„ç»™å®šæ—¶åˆ»ï¼Œåªèƒ½æ‹¥æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨æˆ–ä»»æ„æ•°é‡çš„ä¸å¯å˜å¼•ç”¨ **ä¹‹ä¸€**ï¼ˆè€Œä¸æ˜¯ä¸¤è€…ï¼‰ã€‚
2. å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„ã€‚

å¯¹äºå¼•ç”¨å’Œ `Box<T>`ï¼Œå€Ÿç”¨è§„åˆ™çš„ä¸å¯å˜æ€§ä½œç”¨äºç¼–è¯‘æ—¶ã€‚å¯¹äº `RefCell<T>`ï¼Œè¿™äº›ä¸å¯å˜æ€§ä½œç”¨äº **è¿è¡Œæ—¶**ã€‚å¯¹äºå¼•ç”¨ï¼Œå¦‚æœè¿åè¿™äº›è§„åˆ™ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚è€Œå¯¹äº `RefCell<T>`ï¼Œå¦‚æœè¿åè¿™äº›è§„åˆ™ç¨‹åºä¼š panic å¹¶é€€å‡ºã€‚

ä¸‹é¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ª `MockMessenger` ç»“æ„ä½“ï¼Œå…¶ `sent_messages` å­—æ®µä¸ºä¸€ä¸ª `String` å€¼çš„ `Vec` ç”¨æ¥è®°å½•è¢«å‘ŠçŸ¥å‘é€çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªå…³è”å‡½æ•° `new` ä»¥ä¾¿äºæ–°å»ºä»ç©ºæ¶ˆæ¯åˆ—è¡¨å¼€å§‹çš„ `MockMessenger` å€¼ã€‚æ¥ç€ä¸º `MockMessenger` å®ç° `Messenger` trait è¿™æ ·å°±å¯ä»¥ä¸º `LimitTracker` æä¾›ä¸€ä¸ª `MockMessenger`ã€‚åœ¨ `send` æ–¹æ³•çš„å®šä¹‰ä¸­ï¼Œè·å–ä¼ å…¥çš„æ¶ˆæ¯ä½œä¸ºå‚æ•°å¹¶å‚¨å­˜åœ¨ `MockMessenger` çš„ `sent_messages` åˆ—è¡¨ä¸­ã€‚

åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æµ‹è¯•äº†å½“ `LimitTracker` è¢«å‘ŠçŸ¥å°† `value` è®¾ç½®ä¸ºè¶…è¿‡ `max` å€¼ 75% çš„æŸä¸ªå€¼ã€‚é¦–å…ˆæ–°å»ºä¸€ä¸ª `MockMessenger`ï¼Œå…¶ä»ç©ºæ¶ˆæ¯åˆ—è¡¨å¼€å§‹ã€‚æ¥ç€æ–°å»ºä¸€ä¸ª `LimitTracker` å¹¶ä¼ é€’æ–°å»º `MockMessenger` çš„å¼•ç”¨å’Œ `max` å€¼ 100ã€‚æˆ‘ä»¬ä½¿ç”¨å€¼ 80 è°ƒç”¨ `LimitTracker` çš„ `set_value` æ–¹æ³•ï¼Œè¿™è¶…è¿‡äº† 100 çš„ 75%ã€‚æ¥ç€æ–­è¨€ `MockMessenger` ä¸­è®°å½•çš„æ¶ˆæ¯åˆ—è¡¨åº”è¯¥æœ‰ä¸€æ¡æ¶ˆæ¯ï¼š

```rust
#[cfg(test)]
mod tests {
    use super::*;

    struct MockMessenger {
        sent_messages: Vec<String>,
    }

    impl MockMessenger {
        fn new() -> MockMessenger {
            MockMessenger {
                sent_messages: vec![],
            }
        }
    }

    impl Messenger for MockMessenger {
        fn send(&self, message: &str) {
            self.sent_messages.push(String::from(message));
        }
    }

    #[test]
    fn it_sends_an_over_75_percent_warning_message() {
        let mock_messenger = MockMessenger::new();
        let mut limit_tracker = LimitTracker::new(&mock_messenger, 100);

        limit_tracker.set_value(80);

        assert_eq!(mock_messenger.sent_messages.len(), 1);
    }
}
```

ç„¶è€Œï¼Œè¿™ä¸ªæµ‹è¯•æ˜¯æœ‰é—®é¢˜çš„ï¼š

```console
error[E0596]: cannot borrow `self.sent_messages` as mutable, as it is behind a `&` reference
  --> src/lib.rs:58:13
   |
2  |     fn send(&self, msg: &str);
   |             ----- help: consider changing that to be a mutable reference: `&mut self`
...
58 |             self.sent_messages.push(String::from(message));
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `self` is a `&` reference, so the data it refers to cannot be borrowed as mutable
```

ä¸èƒ½ä¿®æ”¹ `MockMessenger` æ¥è®°å½•æ¶ˆæ¯ï¼Œå› ä¸º `send` æ–¹æ³•è·å–äº† `self` çš„ä¸å¯å˜å¼•ç”¨ã€‚æˆ‘ä»¬ä¹Ÿä¸èƒ½å‚è€ƒé”™è¯¯æ–‡æœ¬çš„å»ºè®®ä½¿ç”¨ `&mut self` æ›¿ä»£ï¼Œå› ä¸ºè¿™æ · `send` çš„ç­¾åå°±ä¸ç¬¦åˆ `Messenger` trait å®šä¹‰ä¸­çš„ç­¾åäº†ã€‚

è¿™æ­£æ˜¯å†…éƒ¨å¯å˜æ€§çš„ç”¨æ­¦ä¹‹åœ°ï¼æˆ‘ä»¬å°†é€šè¿‡ `RefCell` æ¥å‚¨å­˜ `sent_messages`ï¼Œç„¶å `send` å°†èƒ½å¤Ÿä¿®æ”¹ `sent_messages` å¹¶å‚¨å­˜æ¶ˆæ¯ï¼š

```rust
#[cfg(test)]
mod tests {
    use super::*;
    use std::cell::RefCell;

    struct MockMessenger {
        sent_messages: RefCell<Vec<String>>,
    }

    impl MockMessenger {
        fn new() -> MockMessenger {
            MockMessenger {
                sent_messages: RefCell::new(vec![]),
            }
        }
    }

    impl Messenger for MockMessenger {
        fn send(&self, message: &str) {
            self.sent_messages.borrow_mut().push(String::from(message));
        }
    }

    #[test]
    fn it_sends_an_over_75_percent_warning_message() {
        // --snip--

        assert_eq!(mock_messenger.sent_messages.borrow().len(), 1);
    }
}
```

ç°åœ¨ `sent_messages` å­—æ®µçš„ç±»å‹æ˜¯ `RefCell<Vec<String>>` è€Œä¸æ˜¯ `Vec<String>`ã€‚åœ¨ `new` å‡½æ•°ä¸­æ–°å»ºäº†ä¸€ä¸ª `RefCell<Vec<String>>` å®ä¾‹æ›¿ä»£ç©º vectorã€‚

å¯¹äº `send` æ–¹æ³•çš„å®ç°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä»ä¸º `self` çš„ä¸å¯å˜å€Ÿç”¨ï¼Œè¿™æ˜¯ç¬¦åˆæ–¹æ³•å®šä¹‰çš„ã€‚æˆ‘ä»¬è°ƒç”¨ `self.sent_messages` ä¸­ `RefCell` çš„ `borrow_mut` æ–¹æ³•æ¥è·å– `RefCell` ä¸­å€¼çš„å¯å˜å¼•ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ª vectorã€‚æ¥ç€å¯ä»¥å¯¹ vector çš„å¯å˜å¼•ç”¨è°ƒç”¨ `push` ä»¥ä¾¿è®°å½•æµ‹è¯•è¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ¶ˆæ¯ã€‚

æœ€åå¿…é¡»åšå‡ºçš„ä¿®æ”¹ä½äºæ–­è¨€ä¸­ï¼šä¸ºäº†çœ‹åˆ°å…¶å†…éƒ¨ vector ä¸­æœ‰å¤šå°‘ä¸ªé¡¹ï¼Œéœ€è¦è°ƒç”¨ `RefCell` çš„ `borrow` ä»¥è·å– vector çš„ä¸å¯å˜å¼•ç”¨ã€‚

##### `RefCell` åœ¨è¿è¡Œæ—¶è®°å½•å€Ÿç”¨

ç°åœ¨æˆ‘ä»¬è§è¯†äº†å¦‚ä½•ä½¿ç”¨ `RefCell<T>`ï¼Œè®©æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹å®ƒæ€æ ·å·¥ä½œçš„ï¼

å½“åˆ›å»ºä¸å¯å˜å’Œå¯å˜å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ `&` å’Œ `&mut` è¯­æ³•ã€‚å¯¹äº `RefCell<T>` æ¥è¯´ï¼Œåˆ™æ˜¯ `borrow` å’Œ `borrow_mut` æ–¹æ³•ï¼Œè¿™å±äº `RefCell<T>` å®‰å…¨ API çš„ä¸€éƒ¨åˆ†ã€‚`borrow` æ–¹æ³•è¿”å› `Ref<T>` ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œ`borrow_mut` æ–¹æ³•è¿”å› `RefMut<T>` ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆã€‚è¿™ä¸¤ä¸ªç±»å‹éƒ½å®ç°äº† `Deref`ï¼Œæ‰€ä»¥å¯ä»¥å½“ä½œå¸¸è§„å¼•ç”¨å¯¹å¾…ã€‚

å¦‚æœæˆ‘ä»¬å°è¯•è¿åè¿™äº›è§„åˆ™ï¼Œç›¸æ¯”å¼•ç”¨æ—¶çš„ç¼–è¯‘æ—¶é”™è¯¯ï¼Œ`RefCell<T>` çš„å®ç°ä¼šåœ¨è¿è¡Œæ—¶å‡ºç° panicã€‚è¿™é‡Œæˆ‘ä»¬æ•…æ„å°è¯•åœ¨ç›¸åŒä½œç”¨åŸŸåˆ›å»ºä¸¤ä¸ªå¯å˜å€Ÿç”¨ä»¥ä¾¿æ¼”ç¤º `RefCell<T>` ä¸å…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶è¿™ä¹ˆåšï¼š

```rust
    impl Messenger for MockMessenger {
        fn send(&self, message: &str) {
            let mut one_borrow = self.sent_messages.borrow_mut();
            let mut two_borrow = self.sent_messages.borrow_mut();

            one_borrow.push(String::from(message));
            two_borrow.push(String::from(message));
        }
    }
____________________________________________________________________
panic !
```

##### ç»“åˆ `Rc` å’Œ `RefCell`

`RefCell<T>` çš„ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯ä¸ `Rc<T>` ç»“åˆã€‚å›å¿†ä¸€ä¸‹ `Rc<T>` å…è®¸å¯¹ç›¸åŒæ•°æ®æœ‰å¤šä¸ªæ‰€æœ‰è€…ï¼Œä¸è¿‡åªèƒ½æä¾›æ•°æ®çš„ä¸å¯å˜è®¿é—®ã€‚å¦‚æœæœ‰ä¸€ä¸ªå‚¨å­˜äº† `RefCell<T>` çš„ `Rc<T>` çš„è¯ï¼Œå°±å¯ä»¥å¾—åˆ°æœ‰å¤šä¸ªæ‰€æœ‰è€…å¹¶ä¸”å¯ä»¥ä¿®æ”¹çš„å€¼äº†ï¼

ä¾‹å¦‚ï¼Œå›å¿†cons list çš„ä¾‹å­ä¸­ä½¿ç”¨ `Rc<T>` ä½¿å¾—å¤šä¸ªåˆ—è¡¨å…±äº«å¦ä¸€ä¸ªåˆ—è¡¨çš„æ‰€æœ‰æƒã€‚å› ä¸º `Rc<T>` åªå­˜æ”¾ä¸å¯å˜å€¼ï¼Œæ‰€ä»¥ä¸€æ—¦åˆ›å»ºäº†è¿™äº›åˆ—è¡¨å€¼åå°±ä¸èƒ½ä¿®æ”¹ã€‚è®©æˆ‘ä»¬åŠ å…¥ `RefCell<T>` æ¥è·å¾—ä¿®æ”¹åˆ—è¡¨ä¸­å€¼çš„èƒ½åŠ›ã€‚ä¸‹é¢å±•ç¤ºäº†é€šè¿‡åœ¨ `Cons` å®šä¹‰ä¸­ä½¿ç”¨ `RefCell<T>`ï¼Œæˆ‘ä»¬å°±å…è®¸ä¿®æ”¹æ‰€æœ‰åˆ—è¡¨ä¸­çš„å€¼äº†ï¼š

```rust
#[derive(Debug)]
enum List {
    Cons(Rc<RefCell<i32>>, Rc<List>),
    Nil,
}

use crate::List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;

fn main() {
    let value = Rc::new(RefCell::new(5));

    let a = Rc::new(Cons(Rc::clone(&value), Rc::new(Nil)));

    let b = Cons(Rc::new(RefCell::new(3)), Rc::clone(&a));
    let c = Cons(Rc::new(RefCell::new(4)), Rc::clone(&a));

    *value.borrow_mut() += 10;

    println!("a after = {:?}", a);
    println!("b after = {:?}", b);
    println!("c after = {:?}", c);
}
```

å½“æˆ‘ä»¬æ‰“å°å‡º `a`ã€`b` å’Œ `c` æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å®ƒä»¬éƒ½æ‹¥æœ‰ä¿®æ”¹åçš„å€¼ 15 è€Œä¸æ˜¯ 5ï¼š

```console
$ cargo run
   Compiling cons-list v0.1.0 (file:///projects/cons-list)
    Finished dev [unoptimized + debuginfo] target(s) in 0.63s
     Running `target/debug/cons-list`
a after = Cons(RefCell { value: 15 }, Nil)
b after = Cons(RefCell { value: 3 }, Cons(RefCell { value: 15 }, Nil))
c after = Cons(RefCell { value: 4 }, Cons(RefCell { value: 15 }, Nil))
```

##### å¼•ç”¨å¾ªç¯ä¸å†…å­˜æ³„æ¼

Rust çš„å†…å­˜å®‰å…¨æ€§ä¿è¯ä½¿å…¶éš¾ä»¥æ„å¤–åœ°åˆ¶é€ æ°¸è¿œä¹Ÿä¸ä¼šè¢«æ¸…ç†çš„å†…å­˜ï¼ˆè¢«ç§°ä¸º **å†…å­˜æ³„æ¼**ï¼ˆ*memory leak*ï¼‰ï¼‰ï¼Œä½†å¹¶ä¸æ˜¯ä¸å¯èƒ½ã€‚Rust å¹¶ä¸ä¿è¯å®Œå…¨é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œè¿™æ„å‘³ç€å†…å­˜æ³„æ¼åœ¨ Rust ä¸­è¢«è®¤ä¸ºæ˜¯å†…å­˜å®‰å…¨çš„ã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ `Rc<T>` å’Œ `RefCell<T>` çœ‹å‡ºï¼šåˆ›å»ºå¼•ç”¨å¾ªç¯çš„å¯èƒ½æ€§æ˜¯å­˜åœ¨çš„ã€‚è¿™ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œå› ä¸ºæ¯ä¸€é¡¹çš„å¼•ç”¨è®¡æ•°æ°¸è¿œä¹Ÿåˆ°ä¸äº† 0ï¼ŒæŒæœ‰çš„æ•°æ®ä¹Ÿå°±æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹å¼•ç”¨å¾ªç¯æ˜¯å¦‚ä½•å‘ç”Ÿçš„ä»¥åŠå¦‚ä½•é¿å…å®ƒã€‚ä»¥ç¤ºä¾‹ 15-25 ä¸­çš„ `List` æšä¸¾å’Œ `tail` æ–¹æ³•çš„å®šä¹‰å¼€å§‹ï¼š

æ–‡ä»¶åï¼šsrc/main.rs

```rust
use crate::List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;

#[derive(Debug)]
enum List {
    Cons(i32, RefCell<Rc<List>>),
    Nil,
}

impl List {
    fn tail(&self) -> Option<&RefCell<Rc<List>>> {
        match self {
            Cons(_, item) => Some(item),
            Nil => None,
        }
    }
}

fn main() {}
```

ç¤ºä¾‹ 15-25: ä¸€ä¸ªå­˜æ”¾ `RefCell` çš„ cons list å®šä¹‰ï¼Œè¿™æ ·å¯ä»¥ä¿®æ”¹ `Cons` æˆå‘˜æ‰€å¼•ç”¨çš„æ•°æ®

è¿™é‡Œé‡‡ç”¨äº†ç¤ºä¾‹ 15-5 ä¸­ `List` å®šä¹‰çš„å¦ä¸€ç§å˜ä½“ã€‚ç°åœ¨ `Cons` æˆå‘˜çš„ç¬¬äºŒä¸ªå…ƒç´ æ˜¯ `RefCell<Rc<List>>`ï¼Œè¿™æ„å‘³ç€ä¸åŒäºåƒç¤ºä¾‹ 15-24 é‚£æ ·èƒ½å¤Ÿä¿®æ”¹ `i32` çš„å€¼ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä¿®æ”¹ `Cons` æˆå‘˜æ‰€æŒ‡å‘çš„ `List`ã€‚è¿™é‡Œè¿˜å¢åŠ äº†ä¸€ä¸ª `tail` æ–¹æ³•æ¥æ–¹ä¾¿æˆ‘ä»¬åœ¨æœ‰ `Cons` æˆå‘˜çš„æ—¶å€™è®¿é—®å…¶ç¬¬äºŒé¡¹ã€‚

åœ¨ç¤ºä¾‹ 15-26 ä¸­å¢åŠ äº†ä¸€ä¸ª `main` å‡½æ•°ï¼Œå…¶ä½¿ç”¨äº†ç¤ºä¾‹ 15-25 ä¸­çš„å®šä¹‰ã€‚è¿™äº›ä»£ç åœ¨ `a` ä¸­åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨ï¼Œä¸€ä¸ªæŒ‡å‘ `a` ä¸­åˆ—è¡¨çš„ `b` åˆ—è¡¨ï¼Œæ¥ç€ä¿®æ”¹ `a` ä¸­çš„åˆ—è¡¨æŒ‡å‘ `b` ä¸­çš„åˆ—è¡¨ï¼Œè¿™ä¼šåˆ›å»ºä¸€ä¸ªå¼•ç”¨å¾ªç¯ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹çš„å¤šä¸ªä½ç½®æœ‰ `println!` è¯­å¥å±•ç¤ºå¼•ç”¨è®¡æ•°ã€‚

```rust
fn main() {
    let a = Rc::new(Cons(5, RefCell::new(Rc::new(Nil))));

    println!("a initial rc count = {}", Rc::strong_count(&a));
    println!("a next item = {:?}", a.tail());

    let b = Rc::new(Cons(10, RefCell::new(Rc::clone(&a))));

    println!("a rc count after b creation = {}", Rc::strong_count(&a));
    println!("b initial rc count = {}", Rc::strong_count(&b));
    println!("b next item = {:?}", b.tail());

    if let Some(link) = a.tail() {
        *link.borrow_mut() = Rc::clone(&b);
    }

    println!("b rc count after changing a = {}", Rc::strong_count(&b));
    println!("a rc count after changing a = {}", Rc::strong_count(&a));

    // Uncomment the next line to see that we have a cycle;
    // it will overflow the stack
    // println!("a next item = {:?}", a.tail());
}
```

å¯ä»¥çœ‹åˆ°å°†åˆ—è¡¨ `a` ä¿®æ”¹ä¸ºæŒ‡å‘ `b` ä¹‹åï¼Œ `a` å’Œ `b` ä¸­çš„ `Rc<List>` å®ä¾‹çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯ 2ã€‚åœ¨ `main` çš„ç»“å°¾ï¼ŒRust ä¸¢å¼ƒ `b`ï¼Œè¿™ä¼šä½¿ `b` `Rc<List>` å®ä¾‹çš„å¼•ç”¨è®¡æ•°ä» 2 å‡ä¸º 1ã€‚ç„¶è€Œï¼Œ`b` `Rc<List>` ä¸èƒ½è¢«å›æ”¶ï¼Œå› ä¸ºå…¶å¼•ç”¨è®¡æ•°æ˜¯ 1 è€Œä¸æ˜¯ 0ã€‚æ¥ä¸‹æ¥ Rust ä¼šä¸¢å¼ƒ `a` å°† `a` `Rc<List>` å®ä¾‹çš„å¼•ç”¨è®¡æ•°ä» 2 å‡ä¸º 1ã€‚è¿™ä¸ªå®ä¾‹ä¹Ÿä¸èƒ½è¢«å›æ”¶ï¼Œå› ä¸º `b` `Rc<List>` å®ä¾‹ä¾ç„¶å¼•ç”¨å®ƒï¼Œæ‰€ä»¥å…¶å¼•ç”¨è®¡æ•°æ˜¯ 1ã€‚è¿™äº›åˆ—è¡¨çš„å†…å­˜å°†æ°¸è¿œä¿æŒæœªè¢«å›æ”¶çš„çŠ¶æ€ã€‚ä¸ºäº†æ›´å½¢è±¡çš„å±•ç¤ºï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¦‚å›¾æ‰€ç¤ºçš„å¼•ç”¨å¾ªç¯ï¼š

<img src="https://kaisery.github.io/trpl-zh-cn/img/trpl15-04.svg" alt="Reference cycle of lists" style="zoom:50%;" />

##### é¿å…å¼•ç”¨å¾ªç¯ï¼šå°† `Rc<T>` å˜ä¸º `Weak<T>`

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å±•ç¤ºäº†è°ƒç”¨ Rc::clone ä¼šå¢åŠ `Rc<T>` å®ä¾‹çš„ strong_countï¼Œå’Œåªåœ¨å…¶ strong_count ä¸º 0 æ—¶æ‰ä¼šè¢«æ¸…ç†çš„ `Rc<T>` å®ä¾‹ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ Rc::downgrade å¹¶ä¼ é€’ `Rc<T>` å®ä¾‹çš„å¼•ç”¨æ¥åˆ›å»ºå…¶å€¼çš„ å¼±å¼•ç”¨ï¼ˆweak referenceï¼‰ã€‚å¼ºå¼•ç”¨ä»£è¡¨å¦‚ä½•å…±äº« `Rc<T>` å®ä¾‹çš„æ‰€æœ‰æƒã€‚å¼±å¼•ç”¨å¹¶ä¸å±äºæ‰€æœ‰æƒå…³ç³»ï¼Œå½“ `Rc<T> `å®ä¾‹è¢«æ¸…ç†æ—¶å…¶è®¡æ•°æ²¡æœ‰å½±å“ã€‚å®ƒä»¬ä¸ä¼šé€ æˆå¼•ç”¨å¾ªç¯ï¼Œå› ä¸ºä»»ä½•æ¶‰åŠå¼±å¼•ç”¨çš„å¾ªç¯ä¼šåœ¨å…¶ç›¸å…³çš„å€¼çš„å¼ºå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶è¢«æ‰“æ–­ã€‚

è°ƒç”¨ Rc::downgrade æ—¶ä¼šå¾—åˆ° `Weak<T>` ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆã€‚ä¸åŒäºå°† `Rc<T>` å®ä¾‹çš„ strong_count åŠ  1ï¼Œè°ƒç”¨ Rc::downgrade ä¼šå°† weak_count åŠ  1ã€‚`Rc<T>`ç±»å‹ä½¿ç”¨ weak_count æ¥è®°å½•å…¶å­˜åœ¨å¤šå°‘ä¸ª `Weak<T>` å¼•ç”¨ï¼Œç±»ä¼¼äº strong_countã€‚å…¶åŒºåˆ«åœ¨äº weak_count æ— éœ€è®¡æ•°ä¸º 0 å°±èƒ½ä½¿ `Rc<T>` å®ä¾‹è¢«æ¸…ç†ã€‚

å› ä¸º `Weak<T>` å¼•ç”¨çš„å€¼å¯èƒ½å·²ç»è¢«ä¸¢å¼ƒäº†ï¼Œä¸ºäº†ä½¿ç”¨ `Weak<T>` æ‰€æŒ‡å‘çš„å€¼ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿å…¶å€¼ä»ç„¶æœ‰æ•ˆã€‚ä¸ºæ­¤å¯ä»¥è°ƒç”¨ `Weak<T>` å®ä¾‹çš„ `upgrade` æ–¹æ³•ï¼Œè¿™ä¼šè¿”å› `Option<Rc<T>>`ã€‚å¦‚æœ `Rc<T>` å€¼è¿˜æœªè¢«ä¸¢å¼ƒï¼Œåˆ™ç»“æœæ˜¯ `Some`ï¼›å¦‚æœ `Rc<T>` å·²è¢«ä¸¢å¼ƒï¼Œåˆ™ç»“æœæ˜¯ `None`ã€‚å› ä¸º `upgrade` è¿”å›ä¸€ä¸ª `Option<Rc<T>>`ï¼ŒRust ä¼šç¡®ä¿å¤„ç† `Some` å’Œ `None` çš„æƒ…å†µï¼Œæ‰€ä»¥å®ƒä¸ä¼šè¿”å›éæ³•æŒ‡é’ˆã€‚

ä¸‹é¢çš„ç¤ºä¾‹æ„å»ºä¸€ä¸ªå¸¦æœ‰å­èŠ‚ç‚¹çš„æ ‘ã€‚ä¸ºäº†ä½¿å­èŠ‚ç‚¹çŸ¥é“å…¶çˆ¶èŠ‚ç‚¹ï¼Œéœ€è¦åœ¨ `Node` ç»“æ„ä½“å®šä¹‰ä¸­å¢åŠ ä¸€ä¸ª `parent` å­—æ®µã€‚é—®é¢˜æ˜¯ `parent` çš„ç±»å‹åº”è¯¥æ˜¯ä»€ä¹ˆã€‚æˆ‘ä»¬çŸ¥é“å…¶ä¸èƒ½åŒ…å« `Rc<T>`ï¼Œå› ä¸ºè¿™æ · `leaf.parent` å°†ä¼šæŒ‡å‘ `branch` è€Œ `branch.children` ä¼šåŒ…å« `leaf` çš„æŒ‡é’ˆï¼Œè¿™ä¼šå½¢æˆå¼•ç”¨å¾ªç¯ï¼Œä¼šé€ æˆå…¶ `strong_count` æ°¸è¿œä¹Ÿä¸ä¼šä¸º 0ã€‚

ç°åœ¨æ¢ä¸€ç§æ–¹å¼æ€è€ƒè¿™ä¸ªå…³ç³»ï¼Œçˆ¶èŠ‚ç‚¹åº”è¯¥æ‹¥æœ‰å…¶å­èŠ‚ç‚¹ï¼šå¦‚æœçˆ¶èŠ‚ç‚¹è¢«ä¸¢å¼ƒäº†ï¼Œå…¶å­èŠ‚ç‚¹ä¹Ÿåº”è¯¥è¢«ä¸¢å¼ƒã€‚ç„¶è€Œå­èŠ‚ç‚¹ä¸åº”è¯¥æ‹¥æœ‰å…¶çˆ¶èŠ‚ç‚¹ï¼šå¦‚æœä¸¢å¼ƒå­èŠ‚ç‚¹ï¼Œå…¶çˆ¶èŠ‚ç‚¹åº”è¯¥ä¾ç„¶å­˜åœ¨ã€‚è¿™æ­£æ˜¯å¼±å¼•ç”¨çš„ä¾‹å­ï¼

æ‰€ä»¥ `parent` ä½¿ç”¨ `Weak<T>` ç±»å‹è€Œä¸æ˜¯ `Rc<T>`ï¼Œå…·ä½“æ¥è¯´æ˜¯ `RefCell<Weak<Node>>`ã€‚ç°åœ¨ `Node` ç»“æ„ä½“å®šä¹‰çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```rust
use std::cell::RefCell;
use std::rc::{Rc, Weak};

#[derive(Debug)]
struct Node {
    value: i32,
    parent: RefCell<Weak<Node>>,
    children: RefCell<Vec<Rc<Node>>>,
}
```

è¿™æ ·ï¼Œä¸€ä¸ªèŠ‚ç‚¹å°±èƒ½å¤Ÿå¼•ç”¨å…¶çˆ¶èŠ‚ç‚¹ï¼Œä½†ä¸æ‹¥æœ‰å…¶çˆ¶èŠ‚ç‚¹ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ›´æ–° `main` æ¥ä½¿ç”¨æ–°å®šä¹‰ä»¥ä¾¿ `leaf` èŠ‚ç‚¹å¯ä»¥é€šè¿‡ `branch` å¼•ç”¨å…¶çˆ¶èŠ‚ç‚¹ï¼š

```rust
fn main() {
    let leaf = Rc::new(Node {
        value: 3,
        parent: RefCell::new(Weak::new()),
        children: RefCell::new(vec![]),
    });

    println!("leaf parent = {:?}", leaf.parent.borrow().upgrade());

    let branch = Rc::new(Node {
        value: 5,
        parent: RefCell::new(Weak::new()),
        children: RefCell::new(vec![Rc::clone(&leaf)]),
    });

    *leaf.parent.borrow_mut() = Rc::downgrade(&branch);

    println!("leaf parent = {:?}", leaf.parent.borrow().upgrade());
}
```

### é—­åŒ…å’Œè¿­ä»£å™¨

#### é—­åŒ…

Rust çš„ **é—­åŒ…**ï¼ˆ*closures*ï¼‰æ˜¯å¯ä»¥ä¿å­˜åœ¨ä¸€ä¸ªå˜é‡ä¸­æˆ–ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–å‡½æ•°çš„åŒ¿åå‡½æ•°ã€‚å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹åˆ›å»ºé—­åŒ…ï¼Œç„¶ååœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œé—­åŒ…è¿ç®—ã€‚ä¸åŒäºå‡½æ•°ï¼Œé—­åŒ…å…è®¸æ•è·è¢«å®šä¹‰æ—¶æ‰€åœ¨ä½œç”¨åŸŸä¸­çš„å€¼ã€‚æˆ‘ä»¬å°†å±•ç¤ºé—­åŒ…çš„è¿™äº›åŠŸèƒ½å¦‚ä½•å¤ç”¨ä»£ç å’Œè‡ªå®šä¹‰è¡Œä¸ºã€‚

```rust
fn  add_one_v1   (x: u32) -> u32 { x + 1 }
let add_one_v2 = |x: u32| -> u32 { x + 1 };
let add_one_v3 = |x|             { x + 1 };
let add_one_v4 = |x|               x + 1  ;
```

ç¼–è¯‘å™¨ä¼šä¸ºé—­åŒ…å®šä¹‰ä¸­çš„æ¯ä¸ªå‚æ•°å’Œè¿”å›å€¼æ¨æ–­ä¸€ä¸ªå…·ä½“ç±»å‹ã€‚æ³¨æ„ä¸‹é¢è¿™ä¸ªå®šä¹‰æ²¡æœ‰å¢åŠ ä»»ä½•ç±»å‹æ³¨è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„ç±»å‹æ¥è°ƒç”¨è¿™ä¸ªé—­åŒ…ã€‚ä½†æ˜¯å¦‚æœå°è¯•è°ƒç”¨é—­åŒ…ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨ `String` ç±»å‹ä½œä¸ºå‚æ•°è€Œç¬¬äºŒæ¬¡ä½¿ç”¨ `u32`ï¼Œåˆ™ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼š

```rust
    let example_closure = |x| x;

    let s = example_closure(String::from("hello"));
    let n = example_closure(5);
```

```console
error[E0308]: mismatched types
 --> src/main.rs:5:29
  |
5 |     let n = example_closure(5);
  |             --------------- ^- help: try using a conversion method: `.to_string()`
  |             |               |
  |             |               expected struct `String`, found integer
  |             arguments to this function are incorrect
  |
note: closure parameter defined here
 --> src/main.rs:2:28
  |
2 |     let example_closure = |x| x;
  |                            ^
```

ç¬¬ä¸€æ¬¡ä½¿ç”¨ `String` å€¼è°ƒç”¨ `example_closure` æ—¶ï¼Œç¼–è¯‘å™¨æ¨æ–­è¿™ä¸ªé—­åŒ…ä¸­ `x` çš„ç±»å‹ä»¥åŠè¿”å›å€¼çš„ç±»å‹æ˜¯ `String`ã€‚æ¥ç€è¿™äº›ç±»å‹è¢«é”å®šè¿›é—­åŒ… `example_closure` ä¸­ï¼Œå¦‚æœå°è¯•å¯¹åŒä¸€é—­åŒ…ä½¿ç”¨ä¸åŒç±»å‹åˆ™å°±ä¼šå¾—åˆ°ç±»å‹é”™è¯¯ã€‚

#### æ•è·å¼•ç”¨

é—­åŒ…å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ•è·å…¶ç¯å¢ƒï¼Œå®ƒä»¬ç›´æ¥å¯¹åº”åˆ°å‡½æ•°è·å–å‚æ•°çš„ä¸‰ç§æ–¹å¼ï¼šä¸å¯å˜å€Ÿç”¨ï¼Œå¯å˜å€Ÿç”¨å’Œè·å–æ‰€æœ‰æƒã€‚é—­åŒ…ä¼šæ ¹æ®å‡½æ•°ä½“ä¸­å¦‚ä½•ä½¿ç”¨è¢«æ•è·çš„å€¼å†³å®šç”¨å“ªç§æ–¹å¼æ•è·ã€‚

ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªæ•è·åä¸º `list` çš„ vector çš„ä¸å¯å˜å¼•ç”¨çš„é—­åŒ…ï¼Œå› ä¸ºåªéœ€ä¸å¯å˜å¼•ç”¨å°±èƒ½æ‰“å°å…¶å€¼ï¼š

```rust
fn main() {
    let list = vec![1, 2, 3];
    println!("Before defining closure: {:?}", list);

    let only_borrows = || println!("From closure: {:?}", list);

    println!("Before calling closure: {:?}", list);
    only_borrows();
    println!("After calling closure: {:?}", list);
}
```

è¿™ä¸ªç¤ºä¾‹ä¹Ÿå±•ç¤ºäº†å˜é‡å¯ä»¥ç»‘å®šä¸€ä¸ªé—­åŒ…å®šä¹‰ï¼Œå¹¶ä¸”ä¹‹åå¯ä»¥ä½¿ç”¨å˜é‡åå’Œæ‹¬å·æ¥è°ƒç”¨é—­åŒ…ï¼Œå°±åƒå˜é‡åæ˜¯å‡½æ•°åä¸€æ ·ã€‚

å› ä¸ºåŒæ—¶å¯ä»¥æœ‰å¤šä¸ª `list` çš„ä¸å¯å˜å¼•ç”¨ï¼Œæ‰€ä»¥åœ¨é—­åŒ…å®šä¹‰ä¹‹å‰ï¼Œé—­åŒ…å®šä¹‰ä¹‹åè°ƒç”¨ä¹‹å‰ï¼Œé—­åŒ…è°ƒç”¨ä¹‹åä»£ç ä»ç„¶å¯ä»¥è®¿é—® `list`ã€‚ä»£ç å¯ä»¥ç¼–è¯‘ã€è¿è¡Œå¹¶æ‰“å°ï¼š

```console
$ cargo run
   Compiling closure-example v0.1.0 (file:///projects/closure-example)
    Finished dev [unoptimized + debuginfo] target(s) in 0.43s
     Running `target/debug/closure-example`
Before defining closure: [1, 2, 3]
Before calling closure: [1, 2, 3]
From closure: [1, 2, 3]
After calling closure: [1, 2, 3]
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹é—­åŒ…ä½“è®©å®ƒå‘ `list` vector å¢åŠ ä¸€ä¸ªå…ƒç´ ã€‚é—­åŒ…ç°åœ¨æ•è·ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼š

```rust
fn main() {
    let mut list = vec![1, 2, 3];
    println!("Before defining closure: {:?}", list);

    let mut borrows_mutably = || list.push(7);
    
    // println!("After defining closure: {:?}", list); immutable borrow occurs here
    
    borrows_mutably();
    println!("After calling closure: {:?}", list);
}
```

æ³¨æ„åœ¨ `borrows_mutably` é—­åŒ…çš„å®šä¹‰å’Œè°ƒç”¨ä¹‹é—´ä¸å†æœ‰ `println!`ï¼Œå½“ `borrows_mutably` å®šä¹‰æ—¶ï¼Œå®ƒæ•è·äº† `list` çš„å¯å˜å¼•ç”¨ã€‚é—­åŒ…åœ¨è¢«è°ƒç”¨åå°±ä¸å†è¢«ä½¿ç”¨ï¼Œè¿™æ—¶å¯å˜å€Ÿç”¨ç»“æŸã€‚å› ä¸ºå½“å¯å˜å€Ÿç”¨å­˜åœ¨æ—¶ä¸å…è®¸æœ‰å…¶å®ƒçš„å€Ÿç”¨ï¼Œæ‰€ä»¥åœ¨é—­åŒ…å®šä¹‰å’Œè°ƒç”¨ä¹‹é—´ä¸èƒ½æœ‰ä¸å¯å˜å¼•ç”¨æ¥è¿›è¡Œæ‰“å°ã€‚

#### ç§»åŠ¨æ‰€æœ‰æƒ

å³ä½¿é—­åŒ…ä½“ä¸ä¸¥æ ¼éœ€è¦æ‰€æœ‰æƒï¼Œå¦‚æœå¸Œæœ›å¼ºåˆ¶é—­åŒ…è·å–å®ƒç”¨åˆ°çš„ç¯å¢ƒä¸­å€¼çš„æ‰€æœ‰æƒï¼Œå¯ä»¥åœ¨å‚æ•°åˆ—è¡¨å‰ä½¿ç”¨ `move` å…³é”®å­—ã€‚åœ¨å°†é—­åŒ…ä¼ é€’åˆ°ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ—¶è¿™ä¸ªæŠ€å·§å¾ˆæœ‰ç”¨ï¼Œå®ƒå¯ä»¥ç§»åŠ¨æ•°æ®æ‰€æœ‰æƒç»™æ–°çº¿ç¨‹ã€‚ç°åœ¨æˆ‘ä»¬å…ˆç®€å•æ¢è®¨ç”¨ `move` å…³é”®å­—çš„é—­åŒ…æ¥ç”Ÿæˆæ–°çš„çº¿ç¨‹ï¼Œä½¿ç”¨ `move` æ¥å¼ºåˆ¶é—­åŒ…ä¸ºçº¿ç¨‹è·å– `list` çš„æ‰€æœ‰æƒï¼š

```rust
use std::thread;

fn main() {
    let list = vec![1, 2, 3];
    println!("Before defining closure: {:?}", list);

    thread::spawn(move || println!("From thread: {:?}", list))
        .join()
        .unwrap();
}
```

æˆ‘ä»¬ç”Ÿæˆäº†æ–°çš„çº¿ç¨‹ï¼Œç»™è¿™ä¸ªçº¿ç¨‹ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°è¿è¡Œï¼Œé—­åŒ…ä½“æ‰“å°å‡ºåˆ—è¡¨ã€‚å°½ç®¡é—­åŒ…ä½“ä¾ç„¶åªéœ€è¦ä¸å¯å˜å¼•ç”¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯åœ¨é—­åŒ…å®šä¹‰å‰å†™ä¸Š `move` å…³é”®å­—æ¥æŒ‡æ˜ `list` åº”å½“è¢«ç§»åŠ¨åˆ°é—­åŒ…ä¸­ã€‚æ–°çº¿ç¨‹å¯èƒ½åœ¨ä¸»çº¿ç¨‹å‰©ä½™éƒ¨åˆ†æ‰§è¡Œå®Œå‰æ‰§è¡Œå®Œï¼Œæˆ–è€…ä¹Ÿå¯èƒ½ä¸»çº¿ç¨‹å…ˆæ‰§è¡Œå®Œã€‚å¦‚æœä¸»çº¿ç¨‹ç»´æŠ¤äº† `list` çš„æ‰€æœ‰æƒä½†å´åœ¨æ–°çº¿ç¨‹ä¹‹å‰ç»“æŸå¹¶ä¸”ä¸¢å¼ƒäº† `list`ï¼Œåˆ™åœ¨çº¿ç¨‹ä¸­çš„ä¸å¯å˜å¼•ç”¨å°†å¤±æ•ˆã€‚å› æ­¤ï¼Œç¼–è¯‘å™¨è¦æ±‚ `list` è¢«ç§»åŠ¨åˆ°åœ¨æ–°çº¿ç¨‹ä¸­è¿è¡Œçš„é—­åŒ…ä¸­ï¼Œè¿™æ ·å¼•ç”¨å°±æ˜¯æœ‰æ•ˆçš„ã€‚

#### `Fn` trait

é—­åŒ…ä½“å¯ä»¥åšä»¥ä¸‹ä»»ä½•äº‹ï¼šå°†ä¸€ä¸ªæ•è·çš„å€¼ç§»å‡ºé—­åŒ…ï¼Œä¿®æ”¹æ•è·çš„å€¼ï¼Œæ—¢ä¸ç§»åŠ¨ä¹Ÿä¸ä¿®æ”¹å€¼ï¼Œæˆ–è€…ä¸€å¼€å§‹å°±ä¸ä»ç¯å¢ƒä¸­æ•è·å€¼ã€‚

>å°†ä¸€ä¸ªæ•è·çš„å€¼ç§»å‡ºé—­åŒ…æŒ‡çš„æ˜¯å°†é—­åŒ…æ•è·çš„å€¼çš„æ‰€æœ‰æƒä»é—­åŒ…ä¸­ç§»å‡ºï¼Œä½¿å…¶åœ¨é—­åŒ…å¤–éƒ¨å†æ¬¡å¯ç”¨ã€‚

é—­åŒ…æ•è·å’Œå¤„ç†ç¯å¢ƒä¸­çš„å€¼çš„æ–¹å¼å½±å“é—­åŒ…å®ç°çš„ traitã€‚Trait æ˜¯å‡½æ•°å’Œç»“æ„ä½“æŒ‡å®šå®ƒä»¬èƒ½ç”¨çš„é—­åŒ…çš„ç±»å‹çš„æ–¹å¼ã€‚å–å†³äºé—­åŒ…ä½“å¦‚ä½•å¤„ç†å€¼ï¼Œé—­åŒ…è‡ªåŠ¨ã€æ¸è¿›åœ°å®ç°ä¸€ä¸ªã€ä¸¤ä¸ªæˆ–ä¸‰ä¸ª `Fn` traitï¼š

1. `FnOnce` é€‚ç”¨äºèƒ½è¢«è°ƒç”¨ä¸€æ¬¡çš„é—­åŒ…ï¼Œæ‰€æœ‰é—­åŒ…éƒ½è‡³å°‘å®ç°äº†è¿™ä¸ª traitï¼Œå› ä¸ºæ‰€æœ‰é—­åŒ…éƒ½èƒ½è¢«è°ƒç”¨ã€‚ä¸€ä¸ªä¼šå°†æ•è·çš„å€¼ç§»å‡ºé—­åŒ…ä½“çš„é—­åŒ…åªå®ç° `FnOnce` traitï¼Œè¿™æ˜¯å› ä¸ºå®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚

2. `FnMut` é€‚ç”¨äºä¸ä¼šå°†æ•è·çš„å€¼ç§»å‡ºé—­åŒ…ä½“çš„é—­åŒ…ï¼Œä½†å®ƒå¯èƒ½ä¼šä¿®æ”¹è¢«æ•è·çš„å€¼ã€‚è¿™ç±»é—­åŒ…å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ã€‚

3. `Fn` é€‚ç”¨äºæ—¢ä¸å°†è¢«æ•è·çš„å€¼ç§»å‡ºé—­åŒ…ä½“ä¹Ÿä¸ä¿®æ”¹è¢«æ•è·çš„å€¼çš„é—­åŒ…ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ä¸ä»ç¯å¢ƒä¸­æ•è·å€¼çš„é—­åŒ…ã€‚è¿™ç±»é—­åŒ…å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡è€Œä¸æ”¹å˜å®ƒä»¬çš„ç¯å¢ƒï¼Œè¿™åœ¨ä¼šå¤šæ¬¡å¹¶å‘è°ƒç”¨é—­åŒ…çš„åœºæ™¯ä¸­ååˆ†é‡è¦ã€‚

4. `FnOnce` -> `FnMut` -> `Fn`æœ‰æ¸è¿›çš„ä¾èµ–å…³ç³»ï¼Œä¾‹å¦‚å®ç°`FnOnce`æ—¶ï¼Œ`Fn`å’Œ`FnMut`å¿…é¡»å®ç°ã€‚

   ![Rustçš„ä¸‰ç§é—­åŒ…ç±»å‹](assets\img\post-images\20240916-Rust-liwener\rust-closure.jpg)

è®©æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ `Option<T>` ä¸Šçš„ `unwrap_or_else` æ–¹æ³•çš„å®šä¹‰ï¼š

```rust
impl<T> Option<T> {
    pub fn unwrap_or_else<F>(self, f: F) -> T
    where
        F: FnOnce() -> T
    {
        match self {
            Some(x) => x,
            None => f(),
        }
    }
}
```

æ³›å‹ `F` çš„ trait bound æ˜¯ `FnOnce() -> T`ï¼Œè¿™æ„å‘³ç€ `F` å¿…é¡»èƒ½å¤Ÿè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ²¡æœ‰å‚æ•°å¹¶è¿”å›ä¸€ä¸ª `T`ã€‚åœ¨ trait bound ä¸­ä½¿ç”¨ `FnOnce` è¡¨ç¤º `unwrap_or_else` å°†æœ€å¤šè°ƒç”¨ `f` ä¸€æ¬¡ã€‚ç”±äºæ‰€æœ‰çš„é—­åŒ…éƒ½å®ç°äº† `FnOnce`ï¼Œ`unwrap_or_else` èƒ½æ¥æ”¶ç»å¤§å¤šæ•°ä¸åŒç±»å‹çš„é—­åŒ…ï¼Œååˆ†çµæ´»ã€‚

> æ³¨æ„ï¼šå‡½æ•°ä¹Ÿå¯ä»¥å®ç°æ‰€æœ‰çš„ä¸‰ç§ `Fn` traitsã€‚å¦‚æœæˆ‘ä»¬è¦åšçš„äº‹æƒ…ä¸éœ€è¦ä»ç¯å¢ƒä¸­æ•è·å€¼ï¼Œåˆ™å¯ä»¥åœ¨éœ€è¦æŸç§å®ç°äº† `Fn` trait çš„ä¸œè¥¿æ—¶ä½¿ç”¨å‡½æ•°è€Œä¸æ˜¯é—­åŒ…ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¯ä»¥åœ¨ `Option<Vec<T>>` çš„å€¼ä¸Šè°ƒç”¨ `unwrap_or_else(Vec::new)` ä»¥ä¾¿åœ¨å€¼ä¸º `None` æ—¶è·å–ä¸€ä¸ªæ–°çš„ç©ºçš„ vectorã€‚

ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹å®šä¹‰åœ¨ slice ä¸Šçš„æ ‡å‡†åº“æ–¹æ³• `sort_by_key`ï¼Œçœ‹çœ‹å®ƒä¸ `unwrap_or_else` çš„åŒºåˆ«ä»¥åŠä¸ºä»€ä¹ˆ `sort_by_key` ä½¿ç”¨ `FnMut` è€Œä¸æ˜¯ `FnOnce` trait boundã€‚è¿™ä¸ªé—­åŒ…ä»¥ä¸€ä¸ª slice ä¸­å½“å‰è¢«è€ƒè™‘çš„å…ƒç´ çš„å¼•ç”¨ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¯ä»¥ç”¨æ¥æ’åºçš„ `K` ç±»å‹çš„å€¼ã€‚å½“ä½ æƒ³æŒ‰ç…§ slice ä¸­å…ƒç´ çš„æŸä¸ªå±æ€§æ¥è¿›è¡Œæ’åºæ—¶è¿™ä¸ªå‡½æ•°å¾ˆæœ‰ç”¨ã€‚æˆ‘ä»¬ä½¿ç”¨ `sort_by_key` æŒ‰ `Rectangle` çš„ `width` å±æ€§å¯¹å®ƒä»¬ä»ä½åˆ°é«˜æ’åºï¼š

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let mut list = [
        Rectangle { width: 10, height: 1 },
        Rectangle { width: 3, height: 5 },
        Rectangle { width: 7, height: 12 },
    ];

    list.sort_by_key(|r| r.width);
    println!("{:#?}", list);
}
```

`sort_by_key` è¢«å®šä¹‰ä¸ºæ¥æ”¶ä¸€ä¸ª `FnMut` é—­åŒ…çš„åŸå› æ˜¯å®ƒä¼šå¤šæ¬¡è°ƒç”¨è¿™ä¸ªé—­åŒ…ï¼šæ¯ä¸ª slice ä¸­çš„å…ƒç´ è°ƒç”¨ä¸€æ¬¡ã€‚é—­åŒ… `|r| r.width` ä¸æ•è·ã€ä¿®æ”¹æˆ–å°†ä»»ä½•ä¸œè¥¿ç§»å‡ºå®ƒçš„ç¯å¢ƒï¼Œæ‰€ä»¥å®ƒæ»¡è¶³ trait bound çš„è¦æ±‚ã€‚

ä½œä¸ºå¯¹æ¯”ï¼Œä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªåªå®ç°äº† `FnOnce` trait çš„é—­åŒ…ï¼ˆå› ä¸ºå®ƒä»ç¯å¢ƒä¸­ç§»å‡ºäº†ä¸€ä¸ªå€¼ï¼‰çš„ä¾‹å­ã€‚ç¼–è¯‘å™¨ä¸å…è®¸æˆ‘ä»¬åœ¨ `sort_by_key` ä¸Šä½¿ç”¨è¿™ä¸ªé—­åŒ…ï¼š

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let mut list = [
        Rectangle { width: 10, height: 1 },
        Rectangle { width: 3, height: 5 },
        Rectangle { width: 7, height: 12 },
    ];

    let mut sort_operations = vec![];
    let value = String::from("by key called");

    list.sort_by_key(|r| {
        sort_operations.push(value);
        r.width
    });
    println!("{:#?}", list);
}
```

æŠ¥é”™æŒ‡å‘äº†é—­åŒ…ä½“ä¸­å°† `value` ç§»å‡ºç¯å¢ƒçš„é‚£ä¸€è¡Œã€‚è¦ä¿®å¤è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦æ”¹å˜é—­åŒ…ä½“è®©å®ƒä¸å°†å€¼ç§»å‡ºç¯å¢ƒã€‚åœ¨ç¯å¢ƒä¸­ä¿æŒä¸€ä¸ªè®¡æ•°å™¨å¹¶åœ¨é—­åŒ…ä½“ä¸­å¢åŠ å®ƒçš„å€¼æ˜¯è®¡ç®— `sort_by_key` è¢«è°ƒç”¨æ¬¡æ•°çš„ä¸€ä¸ªæ›´ç®€å•ç›´æ¥çš„æ–¹æ³•ã€‚ä¸‹é¢çš„é—­åŒ…å¯ä»¥åœ¨ `sort_by_key` ä¸­ä½¿ç”¨ï¼Œå› ä¸ºå®ƒåªæ•è·äº† `num_sort_operations` è®¡æ•°å™¨çš„å¯å˜å¼•ç”¨ï¼Œè¿™å°±å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ã€‚

```rust
#[derive(Debug)]
struct Rectangle {
    width: u32,
    height: u32,
}

fn main() {
    let mut list = [
        Rectangle { width: 10, height: 1 },
        Rectangle { width: 3, height: 5 },
        Rectangle { width: 7, height: 12 },
    ];

    let mut num_sort_operations = 0;
    list.sort_by_key(|r| {
        num_sort_operations += 1;
        r.width
    });
    println!("{:#?}, sorted in {num_sort_operations} operations", list);
}
```



### å¹¶å‘

#### çº¿ç¨‹

Rust æ ‡å‡†åº“ä½¿ç”¨ *1:1* çº¿ç¨‹å®ç°ï¼Œè¿™ä»£è¡¨ç¨‹åºçš„æ¯ä¸€ä¸ªè¯­è¨€çº§çº¿ç¨‹ä½¿ç”¨ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ã€‚

##### ä½¿ç”¨ `spawn` åˆ›å»ºæ–°çº¿ç¨‹

ä¸ºäº†åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œéœ€è¦è°ƒç”¨ `thread::spawn` å‡½æ•°å¹¶ä¼ é€’ä¸€ä¸ªé—­åŒ…ï¼ˆç¬¬åä¸‰ç« å­¦ä¹ äº†é—­åŒ…ï¼‰ï¼Œå¹¶åœ¨å…¶ä¸­åŒ…å«å¸Œæœ›åœ¨æ–°çº¿ç¨‹è¿è¡Œçš„ä»£ç ã€‚ä¸‹é¢çš„ä¾‹å­åœ¨ä¸»çº¿ç¨‹æ‰“å°äº†ä¸€äº›æ–‡æœ¬è€Œå¦ä¸€äº›æ–‡æœ¬åˆ™ç”±æ–°çº¿ç¨‹æ‰“å°ï¼š

```rust
use std::thread;
use std::time::Duration;

fn main() {
    thread::spawn(|| {
        for i in 1..10 {
            println!("hi number {} from the spawned thread!", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!("hi number {} from the main thread!", i);
        thread::sleep(Duration::from_millis(1));
    }
}
```

æ³¨æ„å½“ Rust ç¨‹åºçš„ä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œæ–°çº¿ç¨‹ä¹Ÿä¼šç»“æŸï¼Œè€Œä¸ç®¡å…¶æ˜¯å¦æ‰§è¡Œå®Œæ¯•ã€‚è¿™ä¸ªç¨‹åºçš„è¾“å‡ºå¯èƒ½æ¯æ¬¡éƒ½ç•¥æœ‰ä¸åŒï¼Œä¸è¿‡å®ƒå¤§ä½“ä¸Šçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```text
hi number 1 from the main thread!
hi number 1 from the spawned thread!
hi number 2 from the main thread!
hi number 2 from the spawned thread!
hi number 3 from the main thread!
hi number 3 from the spawned thread!
hi number 4 from the main thread!
hi number 4 from the spawned thread!
hi number 5 from the spawned thread!
```

##### ä½¿ç”¨ `join` ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ

ç”±äºä¸»çº¿ç¨‹ç»“æŸï¼Œä¸Šé¢çš„ä»£ç å¤§éƒ¨åˆ†æ—¶å€™ä¸å…‰ä¼šææ—©ç»“æŸæ–°å»ºçº¿ç¨‹ï¼Œå› ä¸ºæ— æ³•ä¿è¯çº¿ç¨‹è¿è¡Œçš„é¡ºåºï¼Œæˆ‘ä»¬ç”šè‡³ä¸èƒ½å®é™…ä¿è¯æ–°å»ºçº¿ç¨‹ä¼šè¢«æ‰§è¡Œï¼

å¯ä»¥é€šè¿‡å°† `thread::spawn` çš„è¿”å›å€¼å‚¨å­˜åœ¨å˜é‡ä¸­æ¥ä¿®å¤æ–°å»ºçº¿ç¨‹éƒ¨åˆ†æ²¡æœ‰æ‰§è¡Œæˆ–è€…å®Œå…¨æ²¡æœ‰æ‰§è¡Œçš„é—®é¢˜ã€‚`thread::spawn` çš„è¿”å›å€¼ç±»å‹æ˜¯ `JoinHandle`ã€‚`JoinHandle` æ˜¯ä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œå½“å¯¹å…¶è°ƒç”¨ `join` æ–¹æ³•æ—¶ï¼Œå®ƒä¼šç­‰å¾…å…¶çº¿ç¨‹ç»“æŸã€‚ä¸‹é¢å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨åˆ›å»ºçš„çº¿ç¨‹çš„ `JoinHandle` å¹¶è°ƒç”¨ `join` æ¥ç¡®ä¿æ–°å»ºçº¿ç¨‹åœ¨ `main` é€€å‡ºå‰ç»“æŸè¿è¡Œï¼š

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!("hi number {} from the spawned thread!", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!("hi number {} from the main thread!", i);
        thread::sleep(Duration::from_millis(1));
    }

    handle.join().unwrap();
}
```

é€šè¿‡è°ƒç”¨ handle çš„ `join` ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ° handle æ‰€ä»£è¡¨çš„çº¿ç¨‹ç»“æŸã€‚**é˜»å¡**ï¼ˆ*Blocking*ï¼‰çº¿ç¨‹æ„å‘³ç€é˜»æ­¢è¯¥çº¿ç¨‹æ‰§è¡Œå·¥ä½œæˆ–é€€å‡ºã€‚å› ä¸ºæˆ‘ä»¬å°† `join` è°ƒç”¨æ”¾åœ¨äº†ä¸»çº¿ç¨‹çš„ `for` å¾ªç¯ä¹‹åï¼Œè¿è¡Œåº”è¯¥ä¼šäº§ç”Ÿç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

```text
hi number 1 from the main thread!
hi number 2 from the main thread!
hi number 1 from the spawned thread!
hi number 3 from the main thread!
hi number 2 from the spawned thread!
hi number 4 from the main thread!
hi number 3 from the spawned thread!
hi number 4 from the spawned thread!
hi number 5 from the spawned thread!
hi number 6 from the spawned thread!
hi number 7 from the spawned thread!
hi number 8 from the spawned thread!
hi number 9 from the spawned thread!
```

è¿™ä¸¤ä¸ªçº¿ç¨‹ä»ç„¶ä¼šäº¤æ›¿æ‰§è¡Œï¼Œä¸è¿‡ä¸»çº¿ç¨‹ä¼šç”±äº `handle.join()` è°ƒç”¨ä¼šç­‰å¾…ç›´åˆ°æ–°å»ºçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚

##### å°† `move` é—­åŒ…ä¸çº¿ç¨‹ä¸€åŒä½¿ç”¨

`move` å…³é”®å­—ç»å¸¸ç”¨äºä¼ é€’ç»™ `thread::spawn` çš„é—­åŒ…ï¼Œå› ä¸ºé—­åŒ…ä¼šè·å–ä»ç¯å¢ƒä¸­å–å¾—çš„å€¼çš„æ‰€æœ‰æƒï¼Œå› æ­¤ä¼šå°†è¿™äº›å€¼çš„æ‰€æœ‰æƒä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

æ³¨æ„ç¤ºä¾‹ä¸­ä¼ é€’ç»™ `thread::spawn` çš„é—­åŒ…å¹¶æ²¡æœ‰ä»»ä½•å‚æ•°ï¼šå¹¶æ²¡æœ‰åœ¨æ–°å»ºçº¿ç¨‹ä»£ç ä¸­ä½¿ç”¨ä»»ä½•ä¸»çº¿ç¨‹çš„æ•°æ®ã€‚ä¸ºäº†åœ¨æ–°å»ºçº¿ç¨‹ä¸­ä½¿ç”¨æ¥è‡ªäºä¸»çº¿ç¨‹çš„æ•°æ®ï¼Œéœ€è¦æ–°å»ºçº¿ç¨‹çš„é—­åŒ…è·å–å®ƒéœ€è¦çš„å€¼ã€‚ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå°è¯•åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºä¸€ä¸ª vector å¹¶ç”¨äºæ–°å»ºçº¿ç¨‹çš„ä¾‹å­ï¼Œä¸è¿‡è¿™ä¹ˆå†™è¿˜ä¸èƒ½å·¥ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```rust
use std::thread;

fn main() {
    let v = vec![1, 2, 3];

    let handle = thread::spawn(|| {
        println!("Here's a vector: {:?}", v);
    });

    handle.join().unwrap();
}
```

é—­åŒ…ä½¿ç”¨äº† `v`ï¼Œæ‰€ä»¥é—­åŒ…ä¼šæ•è· `v` å¹¶ä½¿å…¶æˆä¸ºé—­åŒ…ç¯å¢ƒçš„ä¸€éƒ¨åˆ†ã€‚å› ä¸º `thread::spawn` åœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­è¿è¡Œè¿™ä¸ªé—­åŒ…ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ–°çº¿ç¨‹ä¸­è®¿é—® `v`ã€‚ç„¶è€Œå½“ç¼–è¯‘è¿™ä¸ªä¾‹å­æ—¶ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹é”™è¯¯ï¼š

```console
error[E0373]: closure may outlive the current function, but it borrows `v`, which is owned by the current function
 --> src/main.rs:6:32
  |
6 |     let handle = thread::spawn(|| {
  |                                ^^ may outlive borrowed value `v`
7 |         println!("Here's a vector: {:?}", v);
  |                                           - `v` is borrowed here
  |
note: function requires argument type to outlive `'static`
 --> src/main.rs:6:18
  |
6 |       let handle = thread::spawn(|| {
  |  __________________^
7 | |         println!("Here's a vector: {:?}", v);
8 | |     });
  | |______^
help: to force the closure to take ownership of `v` (and any other referenced variables), use the `move` keyword
  |
6 |     let handle = thread::spawn(move || {
  |                                ++++
```

Rustä¼šæ¨æ–­å¦‚ä½•æ•è· `v`ï¼Œå› ä¸º `println!` åªéœ€è¦ `v` çš„å¼•ç”¨ï¼Œé—­åŒ…å°è¯•å€Ÿç”¨ `v`ã€‚ç„¶è€Œè¿™æœ‰ä¸€ä¸ªé—®é¢˜ï¼šRust ä¸çŸ¥é“è¿™ä¸ªæ–°å»ºçº¿ç¨‹ä¼šæ‰§è¡Œå¤šä¹…ï¼Œæ‰€ä»¥æ— æ³•çŸ¥æ™“å¯¹ `v` çš„å¼•ç”¨æ˜¯å¦ä¸€ç›´æœ‰æ•ˆã€‚

é€šè¿‡åœ¨é—­åŒ…ä¹‹å‰å¢åŠ  `move` å…³é”®å­—ï¼Œæˆ‘ä»¬å¼ºåˆ¶é—­åŒ…è·å–å…¶ä½¿ç”¨çš„å€¼çš„æ‰€æœ‰æƒï¼Œè€Œä¸æ˜¯ä»»ç”± Rust æ¨æ–­å®ƒåº”è¯¥å€Ÿç”¨å€¼ã€‚ä¸‹é¢çš„ä¿®æ”¹ï¼Œå¯ä»¥æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸç¼–è¯‘å¹¶è¿è¡Œï¼š

```rust
use std::thread;

fn main() {
    let v = vec![1, 2, 3];

    let handle = thread::spawn(move || {
        println!("Here's a vector: {:?}", v);
    });

    handle.join().unwrap();
}
```

#### æ¶ˆæ¯ä¼ é€’

ä¸€ä¸ªæ—¥ç›Šæµè¡Œçš„ç¡®ä¿å®‰å…¨å¹¶å‘çš„æ–¹å¼æ˜¯ **æ¶ˆæ¯ä¼ é€’**ï¼ˆ*message passing*ï¼‰ï¼Œè¿™é‡Œçº¿ç¨‹é€šè¿‡å‘é€åŒ…å«æ•°æ®çš„æ¶ˆæ¯æ¥ç›¸äº’æ²Ÿé€šã€‚ä¸ºäº†å®ç°æ¶ˆæ¯ä¼ é€’å¹¶å‘ï¼ŒRust æ ‡å‡†åº“æä¾›äº†ä¸€ä¸ª **ä¿¡é“**ï¼ˆ*channel*ï¼‰å®ç°ã€‚ä¿¡é“æ˜¯ä¸€ä¸ªé€šç”¨ç¼–ç¨‹æ¦‚å¿µï¼Œè¡¨ç¤ºæ•°æ®ä»ä¸€ä¸ªçº¿ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å°†å¼€å‘ä¸€ä¸ªç¨‹åºï¼Œå®ƒä¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ç”Ÿæˆå€¼å‘ä¿¡é“å‘é€ï¼Œè€Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¼šæ¥æ”¶å€¼å¹¶æ‰“å°å‡ºæ¥ã€‚è¿™é‡Œä¼šé€šè¿‡ä¿¡é“åœ¨çº¿ç¨‹é—´å‘é€ç®€å•å€¼æ¥æ¼”ç¤ºè¿™ä¸ªåŠŸèƒ½ã€‚ä¸€æ—¦ä½ ç†Ÿæ‚‰äº†è¿™é¡¹æŠ€æœ¯ï¼Œä½ å°±å¯ä»¥å°†ä¿¡é“ç”¨äºä»»ä½•ç›¸äº’é€šä¿¡çš„ä»»ä½•çº¿ç¨‹ï¼Œä¾‹å¦‚ä¸€ä¸ªèŠå¤©ç³»ç»Ÿï¼Œæˆ–åˆ©ç”¨å¾ˆå¤šçº¿ç¨‹è¿›è¡Œåˆ†å¸ƒå¼è®¡ç®—å¹¶å°†éƒ¨åˆ†è®¡ç®—ç»“æœå‘é€ç»™ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œèšåˆã€‚

ä¸‹é¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä¿¡é“ï¼š

```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let val = String::from("hi");
        tx.send(val).unwrap();
    });
    let received = rx.recv().unwrap();
    println!("Got: {}", received);
}
```

è¿™é‡Œä½¿ç”¨ `mpsc::channel` å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿¡é“ï¼›`mpsc` æ˜¯ **å¤šä¸ªç”Ÿäº§è€…ï¼Œå•ä¸ªæ¶ˆè´¹è€…**ï¼ˆ*multiple producer, single consumer*ï¼‰çš„ç¼©å†™ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒRust æ ‡å‡†åº“å®ç°ä¿¡é“çš„æ–¹å¼æ„å‘³ç€ä¸€ä¸ªä¿¡é“å¯ä»¥æœ‰å¤šä¸ªäº§ç”Ÿå€¼çš„ **å‘é€**ï¼ˆ*sending*ï¼‰ç«¯ï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è¿™äº›å€¼çš„ **æ¥æ”¶**ï¼ˆ*receiving*ï¼‰ç«¯ã€‚

`mpsc::channel` å‡½æ•°è¿”å›ä¸€ä¸ªå…ƒç»„ï¼šç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å‘é€ç«¯ -- å‘é€è€…ï¼Œè€Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯æ¥æ”¶ç«¯ -- æ¥æ”¶è€…ã€‚ç”±äºå†å²åŸå› ï¼Œ`tx` å’Œ `rx` é€šå¸¸ä½œä¸º **å‘é€è€…**ï¼ˆ*transmitter*ï¼‰å’Œ **æ¥æ”¶è€…**ï¼ˆ*receiver*ï¼‰çš„ç¼©å†™ï¼Œæ‰€ä»¥è¿™å°±æ˜¯æˆ‘ä»¬å°†ç”¨æ¥ç»‘å®šè¿™ä¸¤ç«¯å˜é‡çš„åå­—ã€‚è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ª `let` è¯­å¥å’Œæ¨¡å¼æ¥è§£æ„æ­¤å…ƒç»„ã€‚

è¿™é‡Œä½¿ç”¨ `thread::spawn` æ¥åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å¹¶ä½¿ç”¨ `move` å°† `tx` ç§»åŠ¨åˆ°é—­åŒ…ä¸­è¿™æ ·æ–°å»ºçº¿ç¨‹å°±æ‹¥æœ‰ `tx` äº†ã€‚æ–°å»ºçº¿ç¨‹éœ€è¦æ‹¥æœ‰ä¿¡é“çš„å‘é€ç«¯ä»¥ä¾¿èƒ½å‘ä¿¡é“å‘é€æ¶ˆæ¯ã€‚ä¿¡é“çš„å‘é€ç«¯æœ‰ä¸€ä¸ª `send` æ–¹æ³•ç”¨æ¥è·å–éœ€è¦æ”¾å…¥ä¿¡é“çš„å€¼ã€‚`send` æ–¹æ³•è¿”å›ä¸€ä¸ª `Result<T, E>` ç±»å‹ï¼Œæ‰€ä»¥å¦‚æœæ¥æ”¶ç«¯å·²ç»è¢«ä¸¢å¼ƒäº†ï¼Œå°†æ²¡æœ‰å‘é€å€¼çš„ç›®æ ‡ï¼Œæ‰€ä»¥å‘é€æ“ä½œä¼šè¿”å›é”™è¯¯ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡ºé”™çš„æ—¶å€™è°ƒç”¨ `unwrap` äº§ç”Ÿ panicã€‚ä¸è¿‡å¯¹äºä¸€ä¸ªçœŸå®ç¨‹åºï¼Œéœ€è¦æ›´åˆç†åœ°å¤„ç†å®ƒã€‚

ä¿¡é“çš„æ¥æ”¶è€…æœ‰ä¸¤ä¸ªæœ‰ç”¨çš„æ–¹æ³•ï¼š`recv` å’Œ `try_recv`ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `recv`ï¼Œå®ƒæ˜¯ *receive* çš„ç¼©å†™ã€‚è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹æ‰§è¡Œç›´åˆ°ä»ä¿¡é“ä¸­æ¥æ”¶ä¸€ä¸ªå€¼ã€‚ä¸€æ—¦å‘é€äº†ä¸€ä¸ªå€¼ï¼Œ`recv` ä¼šåœ¨ä¸€ä¸ª `Result<T, E>` ä¸­è¿”å›å®ƒã€‚å½“ä¿¡é“å‘é€ç«¯å…³é—­ï¼Œ`recv` ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯è¡¨æ˜ä¸ä¼šå†æœ‰æ–°çš„å€¼åˆ°æ¥äº†ã€‚

`try_recv` ä¸ä¼šé˜»å¡ï¼Œç›¸åå®ƒç«‹åˆ»è¿”å›ä¸€ä¸ª `Result<T, E>`ï¼š`Ok` å€¼åŒ…å«å¯ç”¨çš„ä¿¡æ¯ï¼Œè€Œ `Err` å€¼ä»£è¡¨æ­¤æ—¶æ²¡æœ‰ä»»ä½•æ¶ˆæ¯ã€‚å¦‚æœçº¿ç¨‹åœ¨ç­‰å¾…æ¶ˆæ¯è¿‡ç¨‹ä¸­è¿˜æœ‰å…¶ä»–å·¥ä½œæ—¶ä½¿ç”¨ `try_recv` å¾ˆæœ‰ç”¨ï¼šå¯ä»¥ç¼–å†™ä¸€ä¸ªå¾ªç¯æ¥é¢‘ç¹è°ƒç”¨ `try_recv`ï¼Œåœ¨æœ‰å¯ç”¨æ¶ˆæ¯æ—¶è¿›è¡Œå¤„ç†ï¼Œå…¶ä½™æ—¶å€™åˆ™å¤„ç†ä¸€ä¼šå…¶ä»–å·¥ä½œç›´åˆ°å†æ¬¡æ£€æŸ¥ã€‚

##### é€šè¿‡å…‹éš†å‘é€è€…æ¥åˆ›å»ºå¤šä¸ªç”Ÿäº§è€…

ä¹‹å‰æˆ‘ä»¬æåˆ°äº†`mpsc`æ˜¯ *multiple producer, single consumer* çš„ç¼©å†™ã€‚å¯ä»¥è¿ç”¨ `mpsc` æ¥æ‰©å±•ä¸Šé¢çš„ä»£ç æ¥åˆ›å»ºå‘åŒä¸€æ¥æ”¶è€…å‘é€å€¼çš„å¤šä¸ªçº¿ç¨‹ã€‚è¿™å¯ä»¥é€šè¿‡å…‹éš†å‘é€è€…æ¥åšåˆ°ï¼š

```rust
    // --snip--

    let (tx, rx) = mpsc::channel();

    let tx1 = tx.clone();
    thread::spawn(move || {
        let vals = vec![
            String::from("hi"),
            String::from("from"),
            String::from("the"),
            String::from("thread"),
        ];

        for val in vals {
            tx1.send(val).unwrap();
            thread::sleep(Duration::from_secs(1));
        }
    });

    thread::spawn(move || {
        let vals = vec![
            String::from("more"),
            String::from("messages"),
            String::from("for"),
            String::from("you"),
        ];

        for val in vals {
            tx.send(val).unwrap();
            thread::sleep(Duration::from_secs(1));
        }
    });

    for received in rx {
        println!("Got: {}", received);
    }

    // --snip--
```

è¿™ä¸€æ¬¡ï¼Œåœ¨åˆ›å»ºæ–°çº¿ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¯¹å‘é€è€…è°ƒç”¨äº† `clone` æ–¹æ³•ã€‚è¿™ä¼šç»™æˆ‘ä»¬ä¸€ä¸ªå¯ä»¥ä¼ é€’ç»™ç¬¬ä¸€ä¸ªæ–°å»ºçº¿ç¨‹çš„å‘é€ç«¯å¥æŸ„ã€‚æˆ‘ä»¬ä¼šå°†åŸå§‹çš„ä¿¡é“å‘é€ç«¯ä¼ é€’ç»™ç¬¬äºŒä¸ªæ–°å»ºçº¿ç¨‹ã€‚è¿™æ ·å°±ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å°†å‘ä¿¡é“çš„æ¥æ”¶ç«¯å‘é€ä¸åŒçš„æ¶ˆæ¯ã€‚

å¦‚æœè¿è¡Œè¿™äº›ä»£ç ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼š

```text
Got: hi
Got: more
Got: from
Got: messages
Got: for
Got: the
Got: thread
Got: you
```

è™½ç„¶ä½ å¯èƒ½ä¼šçœ‹åˆ°è¿™äº›å€¼ä»¥ä¸åŒçš„é¡ºåºå‡ºç°ï¼›è¿™ä¾èµ–äºä½ çš„ç³»ç»Ÿã€‚è¿™ä¹Ÿå°±æ˜¯å¹¶å‘æ—¢æœ‰è¶£åˆå›°éš¾çš„åŸå› ã€‚å¦‚æœé€šè¿‡ `thread::sleep` åšå®éªŒï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æä¾›ä¸åŒçš„å€¼ï¼Œå°±ä¼šå‘ç°å®ƒä»¬çš„è¿è¡Œæ›´åŠ ä¸ç¡®å®šï¼Œä¸”æ¯æ¬¡éƒ½ä¼šäº§ç”Ÿä¸åŒçš„è¾“å‡ºã€‚

#### å…±äº«å†…å­˜

è™½ç„¶æ¶ˆæ¯ä¼ é€’æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤„ç†å¹¶å‘çš„æ–¹å¼ï¼Œä½†å¹¶ä¸æ˜¯å”¯ä¸€ä¸€ä¸ªã€‚å¦ä¸€ç§æ–¹å¼æ˜¯è®©å¤šä¸ªçº¿ç¨‹æ‹¥æœ‰ç›¸åŒçš„å…±äº«æ•°æ®ã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œä»»ä½•ç¼–ç¨‹è¯­è¨€ä¸­çš„ä¿¡é“éƒ½ç±»ä¼¼äºå•æ‰€æœ‰æƒï¼Œå› ä¸ºä¸€æ—¦å°†ä¸€ä¸ªå€¼ä¼ é€åˆ°ä¿¡é“ä¸­ï¼Œå°†æ— æ³•å†ä½¿ç”¨è¿™ä¸ªå€¼ã€‚å…±äº«å†…å­˜ç±»ä¼¼äºå¤šæ‰€æœ‰æƒï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ç›¸åŒçš„å†…å­˜ä½ç½®ã€‚ç¬¬åäº”ç« ä»‹ç»äº†æ™ºèƒ½æŒ‡é’ˆå¦‚ä½•ä½¿å¾—å¤šæ‰€æœ‰æƒæˆä¸ºå¯èƒ½ï¼Œç„¶è€Œè¿™ä¼šå¢åŠ é¢å¤–çš„å¤æ‚æ€§ï¼Œå› ä¸ºéœ€è¦ä»¥æŸç§æ–¹å¼ç®¡ç†è¿™äº›ä¸åŒçš„æ‰€æœ‰è€…ã€‚Rust çš„ç±»å‹ç³»ç»Ÿå’Œæ‰€æœ‰æƒè§„åˆ™æå¤§çš„ååŠ©äº†æ­£ç¡®åœ°ç®¡ç†è¿™äº›æ‰€æœ‰æƒã€‚ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹äº’æ–¥å™¨ï¼Œä¸€ä¸ªæ›´ä¸ºå¸¸è§çš„å…±äº«å†…å­˜å¹¶å‘åŸè¯­ã€‚

##### äº’æ–¥å™¨`Mutex<T>`

**äº’æ–¥å™¨**ï¼ˆ*mutex*ï¼‰æ˜¯ *mutual exclusion* çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»»æ„æ—¶åˆ»ï¼Œå…¶åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸäº›æ•°æ®ã€‚ä¸ºäº†è®¿é—®äº’æ–¥å™¨ä¸­çš„æ•°æ®ï¼Œçº¿ç¨‹é¦–å…ˆéœ€è¦é€šè¿‡è·å–äº’æ–¥å™¨çš„ **é”**ï¼ˆ*lock*ï¼‰æ¥è¡¨æ˜å…¶å¸Œæœ›è®¿é—®æ•°æ®ã€‚é”æ˜¯ä¸€ä¸ªä½œä¸ºäº’æ–¥å™¨ä¸€éƒ¨åˆ†çš„æ•°æ®ç»“æ„ï¼Œå®ƒè®°å½•è°æœ‰æ•°æ®çš„æ’ä»–è®¿é—®æƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬æè¿°äº’æ–¥å™¨ä¸ºé€šè¿‡é”ç³»ç»Ÿ **ä¿æŠ¤**ï¼ˆ*guarding*ï¼‰å…¶æ•°æ®ã€‚

äº’æ–¥å™¨ä»¥éš¾ä»¥ä½¿ç”¨è‘—ç§°ï¼Œå› ä¸ºä½ ä¸å¾—ä¸è®°ä½ï¼š

1. åœ¨ä½¿ç”¨æ•°æ®ä¹‹å‰å°è¯•è·å–é”ã€‚
2. å¤„ç†å®Œè¢«äº’æ–¥å™¨æ‰€ä¿æŠ¤çš„æ•°æ®ä¹‹åï¼Œå¿…é¡»è§£é”æ•°æ®ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æ‰èƒ½å¤Ÿè·å–é”ã€‚

æ­£ç¡®çš„ç®¡ç†äº’æ–¥å™¨å¼‚å¸¸å¤æ‚ï¼Œè¿™ä¹Ÿæ˜¯è®¸å¤šäººä¹‹æ‰€ä»¥çƒ­è¡·äºä¿¡é“çš„åŸå› ã€‚ç„¶è€Œï¼Œåœ¨ Rust ä¸­ï¼Œå¾—ç›Šäºç±»å‹ç³»ç»Ÿå’Œæ‰€æœ‰æƒï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨é”å’Œè§£é”ä¸Šå‡ºé”™ã€‚

ä½œä¸ºå±•ç¤ºå¦‚ä½•ä½¿ç”¨äº’æ–¥å™¨çš„ä¾‹å­ï¼Œè®©æˆ‘ä»¬ä»åœ¨å•çº¿ç¨‹ä¸Šä¸‹æ–‡ä½¿ç”¨äº’æ–¥å™¨å¼€å§‹ï¼š

```rust
use std::sync::Mutex;

fn main() {
    let m = Mutex::new(5);

    {
        let mut num = m.lock().unwrap();
        *num = 6;
    }

    println!("m = {:?}", m);
}
```

åƒå¾ˆå¤šç±»å‹ä¸€æ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨å…³è”å‡½æ•° `new` æ¥åˆ›å»ºä¸€ä¸ª `Mutex<T>`ã€‚ä½¿ç”¨ `lock` æ–¹æ³•è·å–é”ï¼Œä»¥è®¿é—®äº’æ–¥å™¨ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªè°ƒç”¨ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æˆ‘ä»¬æ‹¥æœ‰é”ä¸ºæ­¢ã€‚

å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰é”ï¼Œå¹¶ä¸”é‚£ä¸ªçº¿ç¨‹ panic äº†ï¼Œåˆ™ `lock` è°ƒç”¨ä¼šå¤±è´¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ²¡äººèƒ½å¤Ÿå†è·å–é”ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹© `unwrap` å¹¶åœ¨é‡åˆ°è¿™ç§æƒ…å†µæ—¶ä½¿çº¿ç¨‹ panicã€‚

ä¸€æ—¦è·å–äº†é”ï¼Œå°±å¯ä»¥å°†è¿”å›å€¼ï¼ˆåœ¨è¿™é‡Œæ˜¯`num`ï¼‰è§†ä¸ºä¸€ä¸ªå…¶å†…éƒ¨æ•°æ®çš„å¯å˜å¼•ç”¨äº†ã€‚ç±»å‹ç³»ç»Ÿç¡®ä¿äº†æˆ‘ä»¬åœ¨ä½¿ç”¨ `m` ä¸­çš„å€¼ä¹‹å‰è·å–é”ã€‚`m` çš„ç±»å‹æ˜¯ `Mutex<i32>` è€Œä¸æ˜¯ `i32`ï¼Œæ‰€ä»¥ **å¿…é¡»** è·å–é”æ‰èƒ½ä½¿ç”¨è¿™ä¸ª `i32` å€¼ã€‚æˆ‘ä»¬æ˜¯ä¸ä¼šå¿˜è®°è¿™ä¹ˆåšçš„ï¼Œå› ä¸ºåä¹‹ç±»å‹ç³»ç»Ÿä¸å…è®¸è®¿é—®å†…éƒ¨çš„ `i32` å€¼ã€‚

æ­£å¦‚ä½ æ‰€æ€€ç–‘çš„ï¼Œ**`Mutex<T>` æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ**ã€‚æ›´å‡†ç¡®çš„è¯´ï¼Œ`lock`è¿”å›ä¸€ä¸ªå«åš `MutexGuard` çš„æ™ºèƒ½æŒ‡é’ˆã€‚è¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆå®ç°äº† `Deref` æ¥æŒ‡å‘å…¶å†…éƒ¨æ•°æ®ï¼›å…¶ä¹Ÿæä¾›äº†ä¸€ä¸ª `Drop` å®ç°å½“ `MutexGuard` ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾é”ï¼Œè¿™æ­£å‘ç”Ÿäºç¤ºä¾‹å†…éƒ¨ä½œç”¨åŸŸçš„ç»“å°¾ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šå¿˜è®°é‡Šæ”¾é”å¹¶é˜»å¡äº’æ–¥å™¨ä¸ºå…¶å®ƒçº¿ç¨‹æ‰€ç”¨çš„é£é™©ï¼Œå› ä¸ºé”çš„é‡Šæ”¾æ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ã€‚ä¸¢å¼ƒäº†é”ä¹‹åï¼Œå¯ä»¥æ‰“å°å‡ºäº’æ–¥å™¨çš„å€¼ï¼Œå¹¶å‘ç°èƒ½å¤Ÿå°†å…¶å†…éƒ¨çš„ `i32` æ”¹ä¸º 6ã€‚

##### åœ¨çº¿ç¨‹é—´å…±äº« `Mutex<T>`

ç°åœ¨è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ `Mutex<T>` åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«å€¼ã€‚æˆ‘ä»¬å°†å¯åŠ¨åä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨å„ä¸ªçº¿ç¨‹ä¸­å¯¹åŒä¸€ä¸ªè®¡æ•°å™¨å€¼åŠ ä¸€ï¼Œè¿™æ ·è®¡æ•°å™¨å°†ä» 0 å˜ä¸º 10ã€‚ä¸‹é¢çš„ä¾‹å­ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œè€Œæˆ‘ä»¬å°†é€šè¿‡è¿™äº›é”™è¯¯æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ `Mutex<T>`ï¼Œä»¥åŠ Rust åˆæ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬æ­£ç¡®ä½¿ç”¨çš„ã€‚

```rust
use std::sync::Mutex;
use std::thread;

fn main() {
    let counter = Mutex::new(0);
    let mut handles = vec![];

    for _ in 0..10 {
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();

            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª `counter` å˜é‡æ¥å­˜æ”¾å†…å« `i32` çš„ `Mutex<T>`ã€‚æ¥ä¸‹æ¥éå† range åˆ›å»ºäº† 10 ä¸ªçº¿ç¨‹ã€‚ä½¿ç”¨äº† `thread::spawn` å¹¶å¯¹æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨äº†ç›¸åŒçš„é—­åŒ…ï¼šå®ƒä»¬æ¯ä¸€ä¸ªéƒ½å°†è°ƒç”¨ `lock` æ–¹æ³•æ¥è·å– `Mutex<T>` ä¸Šçš„é”ï¼Œæ¥ç€å°†äº’æ–¥å™¨ä¸­çš„å€¼åŠ ä¸€ã€‚å½“ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ‰§è¡Œï¼Œ`num` ä¼šç¦»å¼€é—­åŒ…ä½œç”¨åŸŸå¹¶é‡Šæ”¾é”ï¼Œè¿™æ ·å¦ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥è·å–å®ƒäº†ã€‚

åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ”¶é›†äº†æ‰€æœ‰çš„ join å¥æŸ„ï¼Œè°ƒç”¨å®ƒä»¬çš„ `join` æ–¹æ³•æ¥ç¡®ä¿æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šç»“æŸã€‚è¿™æ—¶ï¼Œä¸»çº¿ç¨‹ä¼šè·å–é”å¹¶æ‰“å°å‡ºç¨‹åºçš„ç»“æœã€‚

ä¹‹å‰æç¤ºè¿‡è¿™ä¸ªä¾‹å­ä¸èƒ½ç¼–è¯‘ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¸ºä»€ä¹ˆï¼

```console
error[E0382]: use of moved value: `counter`
  --> src/main.rs:9:36
   |
5  |     let counter = Mutex::new(0);
   |         ------- move occurs because `counter` has type `Mutex<i32>`, which does not implement the `Copy` trait
...
9  |         let handle = thread::spawn(move || {
   |                                    ^^^^^^^ value moved into closure here, in previous iteration of loop
10 |             let mut num = counter.lock().unwrap();
   |                           ------- use occurs due to use in closure
```

é”™è¯¯ä¿¡æ¯è¡¨æ˜ `counter` å€¼åœ¨ä¸Šä¸€æ¬¡å¾ªç¯ä¸­è¢«ç§»åŠ¨äº†ã€‚æ‰€ä»¥ Rust å‘Šè¯‰æˆ‘ä»¬ä¸èƒ½å°† `counter` é”çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°å¤šä¸ªçº¿ç¨‹ä¸­ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¬¬åäº”ç« è®¨è®ºè¿‡çš„å¤šæ‰€æœ‰æƒæ‰‹æ®µæ¥ä¿®å¤è¿™ä¸ªç¼–è¯‘é”™è¯¯ã€‚

##### å¤šçº¿ç¨‹å’Œå¤šæ‰€æœ‰æƒ

åœ¨ç¬¬åäº”ç« ä¸­ï¼Œé€šè¿‡ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ `Rc<T>` æ¥åˆ›å»ºå¼•ç”¨è®¡æ•°çš„å€¼ï¼Œä»¥ä¾¿æ‹¥æœ‰å¤šæ‰€æœ‰è€…ã€‚è®©æˆ‘ä»¬åœ¨è¿™ä¹Ÿè¿™ä¹ˆåšçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚å°†ä¸Šé¢çš„ `Mutex<T>` å°è£…è¿› `Rc<T>` ä¸­å¹¶åœ¨å°†æ‰€æœ‰æƒç§»å…¥çº¿ç¨‹ä¹‹å‰å…‹éš†äº† `Rc<T>`ã€‚

```rust
use std::rc::Rc;
use std::sync::Mutex;
use std::thread;

fn main() {
    let counter = Rc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Rc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();

            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

å†ä¸€æ¬¡ç¼–è¯‘å¹¶...å‡ºç°äº†ä¸åŒçš„é”™è¯¯ï¼ç¼–è¯‘å™¨çœŸæ˜¯æ•™ä¼šäº†æˆ‘ä»¬å¾ˆå¤šï¼

```console
error[E0277]: `Rc<Mutex<i32>>` cannot be sent between threads safely
  --> src/main.rs:11:36
   |
11 |           let handle = thread::spawn(move || {
   |                        ------------- ^------
   |                        |             |
   |  ______________________|_____________within this `[closure@src/main.rs:11:36: 11:43]`
   | |                      |
   | |                      required by a bound introduced by this call
12 | |             let mut num = counter.lock().unwrap();
13 | |
14 | |             *num += 1;
15 | |         });
   | |_________^ `Rc<Mutex<i32>>` cannot be sent between threads safely
   |
   = help: within `[closure@src/main.rs:11:36: 11:43]`, the trait `Send` is not implemented for `Rc<Mutex<i32>>`
note: required because it's used within this closure
  --> src/main.rs:11:36
   |
11 |         let handle = thread::spawn(move || {
   |                                    ^^^^^^^
note: required by a bound in `spawn`
```

å“‡å“¦ï¼Œé”™è¯¯ä¿¡æ¯å¤ªé•¿ä¸çœ‹ï¼è¿™é‡Œæ˜¯ä¸€äº›éœ€è¦æ³¨æ„çš„é‡è¦éƒ¨åˆ†ï¼šç¬¬ä¸€è¡Œé”™è¯¯è¡¨æ˜ `Rc<Mutex<i32>> cannot be sent between threads safely`ã€‚ç¼–è¯‘å™¨ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬åŸå›  `the trait â€˜Sendâ€™ is not implemented for Rc<Mutex<i32>>`ã€‚ä¸‹ä¸€éƒ¨åˆ†ä¼šè®²åˆ° Sendï¼šè¿™æ˜¯ç¡®ä¿æ‰€ä½¿ç”¨çš„ç±»å‹å¯ä»¥ç”¨äºå¹¶å‘ç¯å¢ƒçš„ trait ä¹‹ä¸€ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œ`Rc<T>` å¹¶ä¸èƒ½å®‰å…¨çš„åœ¨çº¿ç¨‹é—´å…±äº«ã€‚å½“ `Rc<T>` ç®¡ç†å¼•ç”¨è®¡æ•°æ—¶ï¼Œå®ƒå¿…é¡»åœ¨æ¯ä¸€ä¸ª `clone` è°ƒç”¨æ—¶å¢åŠ è®¡æ•°ï¼Œå¹¶åœ¨æ¯ä¸€ä¸ªå…‹éš†è¢«ä¸¢å¼ƒæ—¶å‡å°‘è®¡æ•°ã€‚`Rc<T>` å¹¶æ²¡æœ‰ä½¿ç”¨ä»»ä½•å¹¶å‘åŸè¯­ï¼Œæ¥ç¡®ä¿æ”¹å˜è®¡æ•°çš„æ“ä½œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚åœ¨è®¡æ•°å‡ºé”™æ—¶å¯èƒ½ä¼šå¯¼è‡´è¯¡å¼‚çš„ bugï¼Œæ¯”å¦‚å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œæˆ–åœ¨ä½¿ç”¨ç»“æŸä¹‹å‰å°±ä¸¢å¼ƒä¸€ä¸ªå€¼ã€‚æˆ‘ä»¬æ‰€éœ€è¦çš„æ˜¯ä¸€ä¸ªå®Œå…¨ç±»ä¼¼ `Rc<T>`ï¼Œåˆä»¥ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ”¹å˜å¼•ç”¨è®¡æ•°çš„ç±»å‹ã€‚

##### åŸå­å¼•ç”¨è®¡æ•° `Arc<T>`

æ‰€å¹¸ `Arc<T>` **æ­£æ˜¯** è¿™ä¹ˆä¸€ä¸ªç±»ä¼¼ `Rc<T>` å¹¶å¯ä»¥å®‰å…¨çš„ç”¨äºå¹¶å‘ç¯å¢ƒçš„ç±»å‹ã€‚å­—æ¯ â€œaâ€ ä»£è¡¨ **åŸå­æ€§**ï¼ˆ*atomic*ï¼‰ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ª **åŸå­å¼•ç”¨è®¡æ•°**ï¼ˆ*atomically reference counted*ï¼‰ç±»å‹ã€‚åŸå­æ€§æ˜¯å¦ä¸€ç±»è¿™é‡Œè¿˜æœªæ¶‰åŠåˆ°çš„å¹¶å‘åŸè¯­ï¼šè¯·æŸ¥çœ‹æ ‡å‡†åº“ä¸­ [`std::sync::atomic`](https://doc.rust-lang.org/std/sync/atomic/index.html) çš„æ–‡æ¡£æ¥è·å–æ›´å¤šç»†èŠ‚ã€‚ç›®å‰æˆ‘ä»¬åªéœ€è¦çŸ¥é“åŸå­ç±»å°±åƒåŸºæœ¬ç±»å‹ä¸€æ ·å¯ä»¥å®‰å…¨çš„åœ¨çº¿ç¨‹é—´å…±äº«ã€‚

å›åˆ°ä¹‹å‰çš„ä¾‹å­ï¼š`Arc<T>` å’Œ `Rc<T>` æœ‰ç€ç›¸åŒçš„ APIï¼Œæ‰€ä»¥ä¿®æ”¹ç¨‹åºä¸­çš„ `use` è¡Œå’Œ `new` è°ƒç”¨ã€‚ä¸‹é¢çš„ä»£ç æœ€ç»ˆå¯ä»¥ç¼–è¯‘å’Œè¿è¡Œï¼š

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();

            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

è¿™ä¼šæ‰“å°å‡ºï¼š

```text
Result: 10
```

##### `RefCell`/`Rc` ä¸ `Mutex`/`Arc` 

ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œå› ä¸º `counter` æ˜¯ä¸å¯å˜çš„ï¼Œä¸è¿‡å¯ä»¥è·å–å…¶å†…éƒ¨å€¼çš„å¯å˜å¼•ç”¨ï¼›è¿™æ„å‘³ç€ `Mutex<T>` æä¾›äº†å†…éƒ¨å¯å˜æ€§ï¼Œå°±åƒ `Cell` ç³»åˆ—ç±»å‹é‚£æ ·ã€‚æ­£å¦‚ç¬¬åäº”ç« ä¸­ä½¿ç”¨ `RefCell<T>` å¯ä»¥æ”¹å˜ `Rc<T>` ä¸­çš„å†…å®¹é‚£æ ·ï¼ŒåŒæ ·çš„å¯ä»¥ä½¿ç”¨ `Mutex<T>` æ¥æ”¹å˜ `Arc<T>` ä¸­çš„å†…å®¹ã€‚

å¦ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç»†èŠ‚æ˜¯ Rust ä¸èƒ½é¿å…ä½¿ç”¨ `Mutex<T>` çš„å…¨éƒ¨é€»è¾‘é”™è¯¯ã€‚å›å¿†ä¸€ä¸‹ç¬¬åäº”ç« ä½¿ç”¨ `Rc<T>` å°±æœ‰é€ æˆå¼•ç”¨å¾ªç¯çš„é£é™©ï¼Œè¿™æ—¶ä¸¤ä¸ª `Rc<T>` å€¼ç›¸äº’å¼•ç”¨ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚åŒç†ï¼Œ`Mutex<T>` ä¹Ÿæœ‰é€ æˆ **æ­»é”**ï¼ˆ*deadlock*ï¼‰çš„é£é™©ã€‚è¿™å‘ç”Ÿäºå½“ä¸€ä¸ªæ“ä½œéœ€è¦é”ä½ä¸¤ä¸ªèµ„æºè€Œä¸¤ä¸ªçº¿ç¨‹å„æŒä¸€ä¸ªé”ï¼Œè¿™ä¼šé€ æˆå®ƒä»¬æ°¸è¿œç›¸äº’ç­‰å¾…ã€‚å¦‚æœä½ å¯¹è¿™ä¸ªä¸»é¢˜æ„Ÿå…´è¶£ï¼Œå°è¯•ç¼–å†™ä¸€ä¸ªå¸¦æœ‰æ­»é”çš„ Rust ç¨‹åºï¼Œæ¥ç€ç ”ç©¶ä»»ä½•å…¶ä»–è¯­è¨€ä¸­ä½¿ç”¨äº’æ–¥å™¨çš„æ­»é”è§„é¿ç­–ç•¥å¹¶å°è¯•åœ¨ Rust ä¸­å®ç°å®ƒä»¬ã€‚æ ‡å‡†åº“ä¸­ `Mutex<T>` å’Œ `MutexGuard` çš„ API æ–‡æ¡£ä¼šæä¾›æœ‰ç”¨çš„ä¿¡æ¯ã€‚

####  `Sync` å’Œ `Send` trait

##### é€šè¿‡ `Send` å…è®¸åœ¨çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒ

`Send` æ ‡è®° trait è¡¨æ˜å®ç°äº† `Send` çš„ç±»å‹å€¼çš„æ‰€æœ‰æƒå¯ä»¥åœ¨çº¿ç¨‹é—´ä¼ é€ã€‚å‡ ä¹æ‰€æœ‰çš„ Rust ç±»å‹éƒ½æ˜¯`Send` çš„ï¼Œä¸è¿‡æœ‰ä¸€äº›ä¾‹å¤–ï¼ŒåŒ…æ‹¬ `Rc<T>`ï¼šè¿™æ˜¯ä¸èƒ½ `Send` çš„ï¼Œå› ä¸ºå¦‚æœå…‹éš†äº† `Rc<T>` çš„å€¼å¹¶å°è¯•å°†å…‹éš†çš„æ‰€æœ‰æƒè½¬ç§»åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½å¯èƒ½åŒæ—¶æ›´æ–°å¼•ç”¨è®¡æ•°ã€‚ä¸ºæ­¤ï¼Œ`Rc<T>` è¢«å®ç°ä¸ºç”¨äºå•çº¿ç¨‹åœºæ™¯ï¼Œè¿™æ—¶ä¸éœ€è¦ä¸ºæ‹¥æœ‰çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°è€Œä»˜å‡ºæ€§èƒ½ä»£ä»·ã€‚

å› æ­¤ï¼ŒRust ç±»å‹ç³»ç»Ÿå’Œ trait bound ç¡®ä¿æ°¸è¿œä¹Ÿä¸ä¼šæ„å¤–çš„å°†ä¸å®‰å…¨çš„ `Rc<T>` åœ¨çº¿ç¨‹é—´å‘é€ã€‚å½“å°è¯•åœ¨ç¤ºä¾‹ 16-14 ä¸­è¿™ä¹ˆåšçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°é”™è¯¯ `the trait Send is not implemented for Rc<Mutex<i32>>`ã€‚è€Œä½¿ç”¨æ ‡è®°ä¸º `Send` çš„ `Arc<T>` æ—¶ï¼Œå°±æ²¡æœ‰é—®é¢˜äº†ã€‚

ä»»ä½•å®Œå…¨ç”± `Send` çš„ç±»å‹ç»„æˆçš„ç±»å‹ä¹Ÿä¼šè‡ªåŠ¨è¢«æ ‡è®°ä¸º `Send`ã€‚å‡ ä¹æ‰€æœ‰åŸºæœ¬ç±»å‹éƒ½æ˜¯ `Send` çš„ï¼Œé™¤äº†ç¬¬åä¹ç« å°†ä¼šè®¨è®ºçš„è£¸æŒ‡é’ˆï¼ˆraw pointerï¼‰ã€‚

##### `Sync` å…è®¸å¤šçº¿ç¨‹è®¿é—®

`Sync` æ ‡è®° trait è¡¨æ˜ä¸€ä¸ªå®ç°äº† `Sync` çš„ç±»å‹å¯ä»¥å®‰å…¨çš„åœ¨å¤šä¸ªçº¿ç¨‹ä¸­æ‹¥æœ‰å…¶å€¼çš„å¼•ç”¨ã€‚æ¢ä¸€ç§æ–¹å¼æ¥è¯´ï¼Œå¯¹äºä»»æ„ç±»å‹ `T`ï¼Œ**å¦‚æœ `&T`æ˜¯ `Send` çš„è¯ `T` å°±æ˜¯ `Sync` çš„**ï¼Œè¿™æ„å‘³ç€å…¶å¼•ç”¨å°±å¯ä»¥å®‰å…¨çš„å‘é€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚ç±»ä¼¼äº `Send` çš„æƒ…å†µï¼ŒåŸºæœ¬ç±»å‹æ˜¯ `Sync` çš„ï¼Œå®Œå…¨ç”± `Sync` çš„ç±»å‹ç»„æˆçš„ç±»å‹ä¹Ÿæ˜¯ `Sync` çš„ã€‚

æ™ºèƒ½æŒ‡é’ˆ `Rc<T>` ä¹Ÿä¸æ˜¯ `Sync` çš„ï¼Œå‡ºäºå…¶ä¸æ˜¯ `Send` ç›¸åŒçš„åŸå› ã€‚`RefCell<T>`ï¼ˆç¬¬åäº”ç« è®¨è®ºè¿‡ï¼‰å’Œ `Cell<T>` ç³»åˆ—ç±»å‹ä¸æ˜¯ `Sync` çš„ã€‚`RefCell<T>` åœ¨è¿è¡Œæ—¶æ‰€è¿›è¡Œçš„å€Ÿç”¨æ£€æŸ¥ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚`Mutex<T>` æ˜¯ `Sync` çš„ï¼Œæ­£å¦‚ [â€œåœ¨çº¿ç¨‹é—´å…±äº« `Mutex`â€](https://kaisery.github.io/trpl-zh-cn/ch16-03-shared-state.html#åœ¨çº¿ç¨‹é—´å…±äº«-mutext) éƒ¨åˆ†æ‰€è®²çš„å®ƒå¯ä»¥è¢«ç”¨æ¥åœ¨å¤šçº¿ç¨‹ä¸­å…±äº«è®¿é—®ã€‚

##### æ‰‹åŠ¨å®ç° `Send` å’Œ `Sync` æ˜¯ä¸å®‰å…¨çš„

é€šå¸¸å¹¶ä¸éœ€è¦æ‰‹åŠ¨å®ç° `Send` å’Œ `Sync` traitï¼Œå› ä¸ºç”± `Send` å’Œ `Sync` çš„ç±»å‹ç»„æˆçš„ç±»å‹ï¼Œè‡ªåŠ¨å°±æ˜¯ `Send` å’Œ `Sync` çš„ã€‚å› ä¸ºå®ƒä»¬æ˜¯æ ‡è®° traitï¼Œç”šè‡³éƒ½ä¸éœ€è¦å®ç°ä»»ä½•æ–¹æ³•ã€‚å®ƒä»¬åªæ˜¯ç”¨æ¥åŠ å¼ºå¹¶å‘ç›¸å…³çš„ä¸å¯å˜æ€§çš„ã€‚

æ‰‹åŠ¨å®ç°è¿™äº›æ ‡è®° trait æ¶‰åŠåˆ°ç¼–å†™ä¸å®‰å…¨çš„ Rust ä»£ç ï¼Œç¬¬åä¹ç« å°†ä¼šè®²è¿°å…·ä½“çš„æ–¹æ³•ï¼›å½“å‰é‡è¦çš„æ˜¯ï¼Œåœ¨åˆ›å»ºæ–°çš„ç”±ä¸æ˜¯ `Send` å’Œ `Sync` çš„éƒ¨åˆ†æ„æˆçš„å¹¶å‘ç±»å‹æ—¶éœ€è¦å¤šåŠ å°å¿ƒï¼Œä»¥ç¡®ä¿ç»´æŒå…¶å®‰å…¨ä¿è¯ã€‚[â€œThe Rustonomiconâ€](https://doc.rust-lang.org/nomicon/index.html) ä¸­æœ‰æ›´å¤šå…³äºè¿™äº›ä¿è¯ä»¥åŠå¦‚ä½•ç»´æŒå®ƒä»¬çš„ä¿¡æ¯ã€‚



## Rusté«˜çº§ç‰¹æ€§

æœ¬èŠ‚å°†æ¶‰åŠå¦‚ä¸‹å†…å®¹ï¼š

- ä¸å®‰å…¨ Rustï¼šç”¨äºå½“éœ€è¦èˆå¼ƒ Rust çš„æŸäº›ä¿è¯å¹¶è´Ÿè´£æ‰‹åŠ¨ç»´æŒè¿™äº›ä¿è¯
- é«˜çº§ traitï¼šä¸ trait ç›¸å…³çš„å…³è”ç±»å‹ï¼Œé»˜è®¤ç±»å‹å‚æ•°ï¼Œå®Œå…¨é™å®šè¯­æ³•ï¼ˆfully qualified syntaxï¼‰ï¼Œè¶…ï¼ˆçˆ¶ï¼‰traitï¼ˆsupertraitsï¼‰å’Œ newtype æ¨¡å¼
- é«˜çº§ç±»å‹ï¼šå…³äº newtype æ¨¡å¼çš„æ›´å¤šå†…å®¹ï¼Œç±»å‹åˆ«åï¼Œnever ç±»å‹å’ŒåŠ¨æ€å¤§å°ç±»å‹
- é«˜çº§å‡½æ•°å’Œé—­åŒ…ï¼šå‡½æ•°æŒ‡é’ˆå’Œè¿”å›é—­åŒ…
- å®ï¼šå®šä¹‰åœ¨ç¼–è¯‘æ—¶å®šä¹‰æ›´å¤šä»£ç çš„æ–¹å¼

### è§£å¼•ç”¨è£¸æŒ‡é’ˆ

å›åˆ°ç¬¬å››ç« çš„ [â€œæ‚¬å‚å¼•ç”¨â€](https://kaisery.github.io/trpl-zh-cn/ch04-02-references-and-borrowing.html#æ‚¬å‚å¼•ç”¨dangling-references) éƒ¨åˆ†ï¼Œé‚£é‡Œæåˆ°äº†ç¼–è¯‘å™¨ä¼šç¡®ä¿å¼•ç”¨æ€»æ˜¯æœ‰æ•ˆçš„ã€‚ä¸å®‰å…¨ Rust æœ‰ä¸¤ä¸ªè¢«ç§°ä¸º**è£¸æŒ‡é’ˆ**ï¼ˆ*raw pointers*ï¼‰çš„ç±»ä¼¼äºå¼•ç”¨çš„æ–°ç±»å‹ã€‚å’Œå¼•ç”¨ä¸€æ ·ï¼Œè£¸æŒ‡é’ˆæ˜¯ä¸å¯å˜æˆ–å¯å˜çš„ï¼Œåˆ†åˆ«å†™ä½œ `*const T` å’Œ `*mut T`ã€‚è¿™é‡Œçš„æ˜Ÿå·ä¸æ˜¯è§£å¼•ç”¨è¿ç®—ç¬¦ï¼›å®ƒæ˜¯ç±»å‹åç§°çš„ä¸€éƒ¨åˆ†ã€‚åœ¨è£¸æŒ‡é’ˆçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ**ä¸å¯å˜**æ„å‘³ç€æŒ‡é’ˆè§£å¼•ç”¨ä¹‹åä¸èƒ½ç›´æ¥èµ‹å€¼ã€‚